(()=>{var e,t={914:(e,t,n)=>{"use strict";n.d(t,{$t:()=>l,DG:()=>d,Dv:()=>a,El:()=>g,F_:()=>k,G6:()=>h,H6:()=>w,LR:()=>y,W7:()=>u,X1:()=>r,Xv:()=>b,_D:()=>p,rT:()=>m,w_:()=>c,y6:()=>f});var o=n(815),s=n(226),i=n(901);let r,a,l,c,h,d,u,p,m,g,f,v=!1;const w={chatLimit:parseInt((0,s.CJ)("chatLimit",100),10),showProtected:!1};let b={};async function y(){let e;try{e=await async function(){const e=await fetch("/config.json");return await e.json()}()}catch(e){i.error("Failed to load config from server. Try to reload the page")}const t=document.location.pathname.replace(/[^\d^\w]/g,"");let n=e.canvases.findIndex((e=>e.name===t));r=-1===n?0:n;let s=e.canvases[r];a=s.name,l=s.chunkSize,c=s.boardWidth*l,h=s.boardHeight*l,d=s.palette,u=new Uint32Array(d.map((e=>(0,o.xP)(...e)))),p=d.map(o.CO),m=s.boardWidth,g=s.boardHeight,f=s.cooldown,Array.from(u.values()).forEach(((e,t)=>b[e]=t)),v=!0,x.forEach((e=>e())),x=[]}let x=[];function k(e){if(v)return e();x.push(e)}},584:e=>{e.exports={patterns:[[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,0,1,1,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,0,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,1,0,1,0,0,0,1,1,0,1,1,0,0,1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,0,1,1,0,1,0,1,0,1,1,0,1,1,1,0,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,1,1,0,0,1,1,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,1,1,0,0,1,1,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1,0,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1,1,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,1,1,1,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]],defaultPattern:[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]}},799:(e,t,n)=>{"use strict";const o=n.p+"/img/vk-logo.svg",s=n.p+"/img/discord-logo-circle.svg",i=n.p+"/img/fb-logo.svg";n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p;var r=n(187),a=n.n(r),l=n(591),c=n.n(l);function h(e,t,n){return(e<<12|t)<<7|n}function d(e){return[e>>>19,e>>>7&4095,127&e]}var u=n(914),p=n(496),m=n.n(p);function g(){return"INPUT"===document.activeElement.tagName}class f extends(a()){constructor(e){function t(e){let t=this.startedGesture;return"up"===e?(this.pointers=Math.max(this.pointers-1,0),0==this.pointers&&(this.startedGesture=!1)):"down"===e&&++this.pointers>=2&&(t=this.startedGesture=!0),t}super(),this.el=e,this._zoomed=!1,this.startedGesture=!1,this.pointers=0,t=t.bind(this);let n={};e.addEventListener("pointerdown",(e=>{e.gesture=t("down"),this.emit("mousedown",e)})),document.addEventListener("pointermove",(e=>{{Object.defineProperty(e,"movementX",{writable:!0}),Object.defineProperty(e,"movementY",{writable:!0});let t=n[e.pointerId];t?(e.movementX=e.clientX-t[0],e.movementY=e.clientY-t[1]):(e.movementX=0,e.movementY=0),n[e.pointerId]=[e.clientX,e.clientY]}t("move")||this.emit("mousemove",e)})),document.addEventListener("pointerup",(e=>{let o=this.pointers;e.gesture=t("up"),o&&this.emit("mouseup",e),delete n[e.pointerId]})),m()(e).gesturable({onmove:e=>{this.emit("zoom",e.ds),this.emit("mousemove",{buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,movementX:e.dx*devicePixelRatio,movementY:e.dy*devicePixelRatio,gesture:!0})}}),this.tickLoop=setInterval((()=>{this.emit("tick")}),1e3/60),document.addEventListener("keydown",(e=>{g()||this.emit("keydown",e)})),document.addEventListener("keyup",(e=>{g()||this.emit("keyup",e)})),e.addEventListener("wheel",(e=>this.emit("wheel",e))),e.addEventListener("mouseleave",(e=>this.emit("mouseleave",e)))}}var v=n(755);let w=[null,null];function b(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e}function y(e){let t={alt:!1,ctrl:!1,code:null};return e.split("+").forEach((e=>{"CTRL"===e?t.ctrl=!0:"ALT"===e?t.alt=!0:t.code=e})),t}function x(e){let t="";return e.altKey&&(t+="ALT+"),e.ctrlKey&&(t+="CTRL+"),t+e.code}function k(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function C(){if(D.mobile)return 24;const e=v("#palette");let t=Math.floor((window.innerWidth-14)/e.children().length);return t=Math.min(t,30),t}function E(e,t,n,o,s){let i,r,a=0;for(i=0,r=e-1;i<e;r=i++)n[i]>s!=n[r]>s&&o<(t[r]-t[i])*(s-n[i])/(n[r]-n[i])+t[i]&&(a=!a);return a}var I=n(755);const D={socket:null,chunkManager:null,renderer:null,fxRenderer:null,player:null,toolManager:null,events:new(a()),eventManager:new f(document.getElementById("board")),mainCtx:document.getElementById("board").getContext("2d"),fxCtx:document.getElementById("fx").getContext("2d"),mobile:b(),users:{},elements:{mainCanvas:I("#board")[0],fxCanvas:I("#fx")[0],palette:I("#palette")[0],online:I("#onlineCounter")[0],coords:I("#coords")[0],topMenu:I("#topMenu")[0],topMenuContent:I("#topMenu>.content")[0],chatInput:I("#chatInput")[0]}};var A=n(226);const R={x:null,y:null,zoom:null,minX:null,minY:null,maxX:null,maxY:null,minZoom:.25,maxZoom:64,noMoving:!1,init(){Object.assign(this,{x:+(0,A.CJ)("posX",0,!0),y:+(0,A.CJ)("posY",0,!0),zoom:+(0,A.CJ)("zoom",1,!0),minX:-u.w_/2,minY:-u.G6/2,maxX:u.w_/2,maxY:u.G6/2}),(isNaN(this.x)||isNaN(this.y)||isNaN(this.zoom))&&(this.x=0,this.y=0,this.zoom=1)},centerOn(e,t){D.renderer.needRender=!0,this.noMoving||(this.x=e-this.maxX,this.y=t-this.maxY,this.clampPos())},moveTo(e,t){D.renderer.needRender=!0,this.noMoving||(this.x+=e,this.y+=t,this.clampPos())},clampPos(){this.x=Math.min(Math.max(this.x,this.minX),this.maxX),this.y=Math.min(Math.max(this.y,this.minY),this.maxY)},zoomTo(e){this.zoom=e<0?2*this.zoom|0||1:this.zoom/2,this.checkZoom(),this.emit("zoom",this.zoom),D.renderer.needRender=!0,D.fxRenderer.needRender=!0,D.renderer.preRender()},checkZoom(){this.zoom=Math.min(Math.max(this.zoom,this.minZoom),this.maxZoom)},disableMove(){this.noMoving=!0},enableMove(){this.noMoving=!1},__proto__:new(a())};let S,M,L;setInterval((()=>{const e=R.x,t=R.y,n=R.zoom;S!=e&&(0,A.lx)("posX",e,!0),M!=t&&(0,A.lx)("posY",t,!0),L!=n&&(0,A.lx)("zoom",n,!0),S=e,M=t,L=n}),3e3);const P=window.camera=R,T={BANNED:-1,GUEST:0,USER:1,TRUSTED:2,MOD:3,ADMIN:4},F={};Object.keys(T).forEach((e=>F[T[e]]=e));var O=n(351),$=n(755),B=n.n($);const N=n.p+"/img/trash2.svg";n.p;var z=n(755);const U=document.createElement("div");U.style.cssText=`\n    width: 80px;\n    height: 80px;\n    line-height: 80px;\n    text-align: center;\n    border: solid 2px white;\n    border-radius: 50%;\n    opacity: .5;\n    position: absolute;\n    z-index: 8;\n    bottom: 10px;\n    right: 10px;\n    background-color: red;\n    color: white;\n    font-size: 68px;\n    padding-left: 3px; /* костыль из-за кривой иконки мусорки */\n    display: none;\n    user-select: none;\n    transition: all .2s ease;\n    background-image: url(${N});\n`;let G=document.createElement("div");G.style.cssText="\n    opacity: .1;\n    width: 300px;\n    height: 300px;\n    position: absolute;\n    border-radius: 50%;\n    z-index: 7;\n    bottom: -100px;\n    right: -100px;\n    background-color: red;\n    display: none;\n",U.onpointerenter=G.onpointerenter=()=>{U.style.opacity="1"},U.onpointerleave=G.onpointerleave=()=>{U.style.opacity=".5"};let H=[];window.windows=H;class _{static Exists(e){return H.some((t=>t.title===e))}static Find(e){return H.find((t=>t.title===e))}constructor(e){"string"==typeof e&&(e={title:e}),this.created=!1,this.x=0,this.y=0,this.title="",this.parent=document.body,this.moveable=!0,this.closeable=!0,this.closed=!1,this.center=!1,Object.assign(this,e),_.Exists(this.title)?this.oldWindow=_.Find(this.title):(this.created=!0,this.block||(this.block=this.createParentBlock(),this.moveTo(this.x,this.y),this.parent.appendChild(this.block)),this.center&&(this.moveToCenter(),setTimeout((()=>this.moveToCenter()))),this.addFeatures(),H.push(this))}updateTitle(e,t=!1){t||(this.title=e),z(".windowTitle",this.element).text(e)}createParentBlock(){let e=document.createElement("div");e.className="window",this.element=e;let t=document.createElement("div");if(t.className="windowHeader",t.innerHTML='<h3 class="windowTitle">'+this.title+"</h3>",e.appendChild(t),this.closeable){const e=document.createElement("div");e.className="closeWindow",e.innerHTML="<div></div>",e.addEventListener("pointerdown",(e=>{e.stopPropagation()})),e.addEventListener("click",this.close.bind(this)),t.appendChild(e)}let n=document.createElement("div");return n.className="windowBody",e.appendChild(n),this.body=n,e}moveTo(e,t){const n=this.block.getBoundingClientRect(),o=n.width,s=n.height;this.x=Math.max(10-o,e),this.y=Math.max(10-s,t),this.x=Math.min(window.innerWidth-10,this.x),this.y=Math.min(window.innerHeight-10,this.y),this.block.style.left=this.x+"px",this.block.style.top=this.y+"px"}moveBy(e,t){this.moveTo(this.x+e,this.y+t)}moveToCenter(){let e=window.innerWidth,t=window.innerHeight,n=this.block.offsetWidth,o=this.block.offsetHeight;this.moveTo(e/2-n/2,t/2-o/2)}addFeatures(){if(this.moveable){const e=window.devicePixelRatio||1;z(this.block).on("pointerdown",(()=>{let t=this;function n(n){let o=(n=n.originalEvent).movementX/e,s=n.movementY/e;t.moveBy(o,s)}B()(document).on("pointermove",n),this.closeable&&(U.style.display="block",G.style.display="block",B()([U,G]).one("pointerup",(()=>{this.close()}))),B()(document).one("pointerup pointerleave",(()=>{U.style.display="none",G.style.display="none",B()([U,G]).off("pointerup"),B()(document).off("pointermove",n)}))})),z(this.body).on("pointerdown",(e=>{e.stopPropagation()}))}window.addEventListener("orientationchange",(()=>{setTimeout((()=>{this.moveTo(this.x,this.y)}),500)}))}close(){B()(this.block).remove(),this.closed=!0,H.splice(H.indexOf(this),1)}}let W=!1;class j{static get isRunning(){return W}static set isRunning(e){return W=e}constructor(e={}){if(j.isRunning)throw new Error("Modal is running");this.body=null,Object.assign(this,e),this.init(),j.isRunning=!0}init(){const e=z('<div class="modalBg">\n            <div class="modalCont">\n            </div>\n        </div>');this.bgEl=e[0],this.contEl=this.bgEl.children[0],z("#ui").append(e)}close(){this.bgEl.remove()}}class K{constructor(e,t){this._allowance=0,this.delay=e,this.max=t,this.lastCheck=Date.now()}get allowance(){return 0===this.delay?1/0:(this._allowance+=(Date.now()-this.lastCheck)/this.delay,this.lastCheck=Date.now(),this._allowance>this.max&&(this._allowance=this.max),this._allowance)}set allowance(e){this._allowance=e}spend(e){if(0===this.delay)return!0;let t=this.allowance;return!(t<e||(this.allowance=t-e,0))}}var Y=n(755);const X={x:0,y:0,color:-1,brushSize:1,secondCol:-1,id:-1,init(){this.loadColors(),this.switchColor(this.color,!0),this.switchSecondColor(this.secondCol,!0)},loadColors(){this.color=+(0,A.CJ)("color1",-1,!0),this.secondCol=+(0,A.CJ)("color2",-1,!0)},switchColor(e,t=!1){this.color!==e||t?this.color=e:e=this.color=-1,D.fxRenderer.needRender=!0,D.renderer.preRender(),Y(".paletteColor.selected").removeClass("selected"),-1!==e&&Y("#col"+e).addClass("selected"),(0,A.lx)("color1",e,!0)},switchSecondColor(e,t){this.secondCol!==e||t?this.secondCol=e:e=this.secondCol=-1,D.fxRenderer.needRender=!0,D.renderer.preRender(),Y(".paletteColor.selectedSecond").removeClass("selectedSecond"),-1!==e&&Y("#col"+e).addClass("selectedSecond"),(0,A.lx)("color2",e,!0)},swapColors(){const e=this.color;this.switchColor(this.secondCol),this.switchSecondColor(e)},resetColors(){this.switchColor(-1),this.switchSecondColor(-1)},bucket:null,updateBucket([e,t]){this.bucket=new K(e,t)},placed:[],maxPlaced:isNaN(+localStorage.maxPlaced)?5e3:+localStorage.maxPlaced,placedCount:+(0,A.TA)("placedCount",!0)||0};function J(e,t){let n=(e-(D.renderer.canvas.width>>1))/P.zoom,o=(t-(D.renderer.canvas.height>>1))/P.zoom;return[0|P.x+w[0]+n,0|o+(P.y+w[1])]}function V(e,t){return e-=P.x+w[0],t-=P.y+w[1],e*=P.zoom,t*=P.zoom,e+=D.renderer.canvas.width>>1,t+=D.renderer.canvas.height>>1,[Math.floor(e),Math.floor(t)]}function q(e,t){return[e/u.$t|0,t/u.$t|0,e%u.$t,t%u.$t]}var Z=n(755);const Q=Z("#templateURL"),ee=Z("#templateX"),te=Z("#templateY"),ne=Z("#templateOpacity"),oe=(Z("#ui"),Z("#chat")),se=Z("#chatInput"),ie=(Z("#template"),Z("#topMenu"));let re=window.innerWidth/2,ae=window.innerHeight/2;window.addEventListener("resize",(()=>{re=window.innerWidth/2,ae=window.innerHeight/2}));const le=/width=(\d+)$/,ce={element:document.getElementById("template"),x:0,y:0,render(){let e=P.x+w[0]-this.x-re/P.zoom,t=P.y+w[1]-this.y-ae/P.zoom;e*=P.zoom,t*=P.zoom,this.element.style.left=-e+"px",this.element.style.top=-t+"px",this.element.style.transform="scale("+P.zoom+","+P.zoom+")"},update(){this.x=parseInt(ee.val(),10),this.y=parseInt(te.val(),10),this.element.style.opacity=ne.val();const e=Q.val();let t;(t=e.match(le))?this.element.style.width=t[1]+"px":this.element.style.width="unset",this.element.src=e},get url(){return Q.val()},get opacity(){return+ne.val()},set opacity(e){ne.val(e)}},he={ALICEBLUE:"#F0F8FF",ANTIQUEWHITE:"#FAEBD7",AQUA:"#00FFFF",AQUAMARINE:"#7FFFD4",AZURE:"#F0FFFF",BEIGE:"#F5F5DC",BISQUE:"#FFE4C4",BLACK:"#000000",BLANCHEDALMOND:"#FFEBCD",BLUE:"#0000FF",BLUEVIOLET:"#8A2BE2",BROWN:"#A52A2A",BURLYWOOD:"#DEB887",CADETBLUE:"#5F9EA0",CHARTREUSE:"#7FFF00",CHOCOLATE:"#D2691E",CORAL:"#FF7F50",CORNFLOWERBLUE:"#6495ED",CORNSILK:"#FFF8DC",CRIMSON:"#DC143C",CYAN:"#00FFFF",DARKBLUE:"#00008B",DARKCYAN:"#008B8B",DARKGOLDENROD:"#B8860B",DARKGRAY:"#A9A9A9",DARKGREY:"#A9A9A9",DARKGREEN:"#006400",DARKKHAKI:"#BDB76B",DARKMAGENTA:"#8B008B",DARKOLIVEGREEN:"#556B2F",DARKORANGE:"#FF8C00",DARKORCHID:"#9932CC",DARKRED:"#8B0000",DARKSALMON:"#E9967A",DARKSEAGREEN:"#8FBC8F",DARKSLATEBLUE:"#483D8B",DARKSLATEGRAY:"#2F4F4F",DARKSLATEGREY:"#2F4F4F",DARKTURQUOISE:"#00CED1",DARKVIOLET:"#9400D3",DEEPPINK:"#FF1493",DEEPSKYBLUE:"#00BFFF",DIMGRAY:"#696969",DIMGREY:"#696969",DODGERBLUE:"#1E90FF",FIREBRICK:"#B22222",FLORALWHITE:"#FFFAF0",FORESTGREEN:"#228B22",FUCHSIA:"#FF00FF",GAINSBORO:"#DCDCDC",GHOSTWHITE:"#F8F8FF",GOLD:"#FFD700",GOLDENROD:"#DAA520",GRAY:"#808080",GREY:"#808080",GREEN:"#008000",GREENYELLOW:"#ADFF2F",HONEYDEW:"#F0FFF0",HOTPINK:"#FF69B4",INDIANRED:"#CD5C5C",INDIGO:"#4B0082",IVORY:"#FFFFF0",KHAKI:"#F0E68C",LAVENDER:"#E6E6FA",LAVENDERBLUSH:"#FFF0F5",LAWNGREEN:"#7CFC00",LEMONCHIFFON:"#FFFACD",LIGHTBLUE:"#ADD8E6",LIGHTCORAL:"#F08080",LIGHTCYAN:"#E0FFFF",LIGHTGOLDENRODYELLOW:"#FAFAD2",LIGHTGRAY:"#D3D3D3",LIGHTGREY:"#D3D3D3",LIGHTGREEN:"#90EE90",LIGHTPINK:"#FFB6C1",LIGHTSALMON:"#FFA07A",LIGHTSEAGREEN:"#20B2AA",LIGHTSKYBLUE:"#87CEFA",LIGHTSLATEGRAY:"#778899",LIGHTSLATEGREY:"#778899",LIGHTSTEELBLUE:"#B0C4DE",LIGHTYELLOW:"#FFFFE0",LIME:"#00FF00",LIMEGREEN:"#32CD32",LINEN:"#FAF0E6",MAGENTA:"#FF00FF",MAROON:"#800000",MEDIUMAQUAMARINE:"#66CDAA",MEDIUMBLUE:"#0000CD",MEDIUMORCHID:"#BA55D3",MEDIUMPURPLE:"#9370DB",MEDIUMSEAGREEN:"#3CB371",MEDIUMSLATEBLUE:"#7B68EE",MEDIUMSPRINGGREEN:"#00FA9A",MEDIUMTURQUOISE:"#48D1CC",MEDIUMVIOLETRED:"#C71585",MIDNIGHTBLUE:"#191970",MINTCREAM:"#F5FFFA",MISTYROSE:"#FFE4E1",MOCCASIN:"#FFE4B5",NAVAJOWHITE:"#FFDEAD",NAVY:"#000080",OLDLACE:"#FDF5E6",OLIVE:"#808000",OLIVEDRAB:"#6B8E23",ORANGE:"#FFA500",ORANGERED:"#FF4500",ORCHID:"#DA70D6",PALEGOLDENROD:"#EEE8AA",PALEGREEN:"#98FB98",PALETURQUOISE:"#AFEEEE",PALEVIOLETRED:"#DB7093",PAPAYAWHIP:"#FFEFD5",PEACHPUFF:"#FFDAB9",PERU:"#CD853F",PINK:"#FFC0CB",PLUM:"#DDA0DD",POWDERBLUE:"#B0E0E6",PURPLE:"#800080",REBECCAPURPLE:"#663399",RED:"#FF0000",ROSYBROWN:"#BC8F8F",ROYALBLUE:"#4169E1",SADDLEBROWN:"#8B4513",SALMON:"#FA8072",SANDYBROWN:"#F4A460",SEAGREEN:"#2E8B57",SEASHELL:"#FFF5EE",SIENNA:"#A0522D",SILVER:"#C0C0C0",SKYBLUE:"#87CEEB",SLATEBLUE:"#6A5ACD",SLATEGRAY:"#708090",SLATEGREY:"#708090",SNOW:"#FFFAFA",SPRINGGREEN:"#00FF7F",STEELBLUE:"#4682B4",TAN:"#D2B48C",TEAL:"#008080",THISTLE:"#D8BFD8",TOMATO:"#FF6347",TURQUOISE:"#40E0D0",VIOLET:"#EE82EE",WHEAT:"#F5DEB3",WHITE:"#FFFFFF",WHITESMOKE:"#F5F5F5",YELLOW:"#FFFF00",YELLOWGREEN:"#9ACD32"};var de=n(755);function ue(e,t,n){return void 0===t?e:n?(e+t).slice(-e.length):(t+e).substring(0,e.length)}const pe=new RegExp(/\[(#?[A-Z0-9]{1,8})*?\]/gi),me=new RegExp(/http?s:\/\/.+?\.(png|jpg|jpeg|gif)(\?\S+)?/i),ge=D.chat=new class{constructor(){this.element=de("#chat"),this.logElem=de("#chatLog"),this.colorsEnabled=!JSON.parse((0,A.CJ)("disableColors",!1)),this.muted=JSON.parse((0,A.TA)("muted"))||[],this.initChatEvents()}mobileShow(){this.element.css("top","0")}mobileHide(){this.element.css("top","-100vh")}setColors(e){this.colorsEnabled=e,de(".chatColored").toggleClass("noColor",!e)}parseColors(e){let t=0,n=e.matchAll(pe);for(;;){let{value:o,done:s}=n.next();if(s)break;let i=o[1];if(i){if(i.startsWith("#")&&!/[G-Zg-z]/.test(i))i=ue(i.slice(-1).repeat(7),i);else if(!he[i])continue;e=e.replace(o[0],`<div class="chatColored${this.colorsEnabled?"":" noColor"}" style="color:${i}">`),t++}else t>0?(e=e.replace(o[0],"</div>"),t--):e=e.replace(o[0],"&#91;&#93;")}return t>0&&(e+="</div>".repeat(t)),e}parseCoords(e){return e.replace(/\((\d{1,5}), ?(\d{1,5})\)/g,'<a class="cordgo" onclick="camera.centerOn($1, $2)">$&</a>')}parseImage(e){let t=e.match(me);if(t){let n=t[0];e=e.replace(n,`<span class="imageLink" onclick="globals.chat.toggleImage(this)">${n}</span>`)}return e}toggleImage(e){const t=de(e),n=t.parent();if(de("img",n).length)de(".imageLink",n).css("cursor","zoom-in"),de("img",n).remove();else{de(".imageLink",n).css("cursor","zoom-out");const e=de(`<img src="${t.text()}" class="chatImg" onclick="globals.chat.toggleImage(this)">`);e.on("load",this.scroll.bind(this)),n.append(e)}}parseBB(e){let t=[],n=e.matchAll(/\[(\/?[bi])\]/gi);for(;;){let{value:o,done:s}=n.next();if(s)break;let i=o[1];e=e.replace(o[0],`<${i}>`),i.startsWith("/")?t=t.splice(t.indexOf(i.slice(1))):t.push(i)}for(;t.length;)e+=`</${t.shift()}>`;return e}addMessage(e){if(de(".showChat").addClass("showChat-notify"),e.server)return this.addServerMessage(e.msg);let t=k(e.msg),n=k(e.nick);const o=n;"Goroh"===n&&(n=`<span style="text-shadow:0 0 3px">[#00f986]${n}</span>`);try{t=this.parseColors(t),t=this.parseBB(t),t=this.parseCoords(t),t=this.parseImage(t),n=this.parseColors(n)}catch(e){console.log(e)}const s=~this.muted.indexOf(o),i=de(`<div class="chatMessage" ${s?'style="display:none"':""}>\n            <div class="messageNick" data-nick="${o}">${n}:</div>\n            <div class="messageText">${t}</div>\n        </div>`);de(".messageNick",i).on("click",(function(){const e=this.innerText.slice(0,-1);D.elements.chatInput.value+=e+", ",D.elements.chatInput.focus()})),this.logElem.append(i),this.afterAddingMessage()}addLocalMessage(e){e=this.parseColors(e),e=this.parseBB(e),e=this.parseCoords(e),e=this.parseImage(e);const t=de(`<div class="chatMessage">\n                <div class="messageText">${e}</div>\n            </div>`);this.logElem.append(t),this.afterAddingMessage()}addServerMessage(e){this.addLocalMessage(e)}afterAddingMessage(){this.logElem.children().length>u.H6.chatLimit&&this.logElem.children()[0].remove(),this.scroll()}handleMessage(e){e.startsWith("/")?this.handleCommand(e):D.socket.sendChatMessage(e,u.Dv)}sendWhisper(e,t){D.socket.sendChatWhisper(t,u.Dv,e)}handleCommand(e){let t=e.split(" ");const n=t[0];switch(t=t.slice(1),console.log(t),n){case"/mute":{const e=t.join(" ");this.mute(e);break}case"/unmute":{const e=t.join(" ");this.unmute(e);break}case"/w":{if(t.length<2)return this.addLocalMessage("Usage: /w &lt;targetAccountId&gt; &lt;message&gt;");const e=t[0],n=t.slice(1).join(" ");this.sendWhisper(e,n),se.val(`/w ${e} `);break}}}mute(e){const t="<b>mute:</b> ";return!e.length||e.length>32?this.addLocalMessage(t+(0,O.I)("Wrong nick length")):~this.muted.indexOf(e)?this.addLocalMessage(t+(0,O.I)("Player is already muted")):(this.muted.push(e),(0,A.lx)("muted",JSON.stringify(this.muted)),void de(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="none")})))}unmute(e){let t,n="<b>unmute:</b> ";return!e.length||e.length>32?this.addLocalMessage(n+(0,O.I)("Wrong nick length")):~(t=this.muted.indexOf(e))?(this.muted.splice(t,1),(0,A.lx)("muted",JSON.stringify(this.muted)),void de(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="block")}))):this.addLocalMessage(n+(0,O.I)("Player is not muted"))}initChatEvents(){se.on("input",(()=>{const e=se.val();me.test(e)?se.css("color","white"):se.css("color","")}))}scroll(){const e=this.logElem[0],t=this.logElem.children().slice(-1).innerHeight()||0;e.scrollHeight-e.scrollTop-e.clientHeight-t<=7&&e.scrollBy(0,999)}};var fe=n(584),ve=n(815);class we{constructor(e,t,n){this.x=e,this.y=t,this.width=u.$t,this.height=u.$t,this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=u.$t,this.ctx=this.canvas.getContext("2d"),this.imgData=this.ctx.createImageData(u.$t,u.$t),this.view=new Uint32Array(this.imgData.data.buffer),this.pCanvas=document.createElement("canvas"),this.pCanvas.width=this.pCanvas.height=u.$t,this.pCtx=this.pCanvas.getContext("2d"),this.pImgData=this.pCtx.createImageData(u.$t,u.$t),this.pView=new Uint32Array(this.pImgData.data.buffer),this.needRender=!0,this.fromBuffer(n)}render(){this.needRender&&(this.needRender=!1,this.ctx.putImageData(this.imgData,0,0),u.H6.showProtected&&(this.ctx.globalAlpha=.5,this.pCtx.putImageData(this.pImgData,0,0),this.ctx.drawImage(this.pCanvas,0,0),this.ctx.globalAlpha=1))}fromBuffer(e){let t,n;for(let o=0;o<e.byteLength;o++)t=e[o],n=128&t,n&&(this.pView[o]=4294901760),this.view[o]=u.W7[127&t]}get(e,t){return this.view[e+t*u.$t]}set(e,t,n){const o=e+t*u.$t;this.view[o]=n,this.needRender=!0}setProtect(e,t,n){const o=e+t*u.$t;this.pView[o]=n?4294901760:0,this.needRender=!0}getProtect(e,t){const n=e+t*u.$t;return!!this.pView[n]}}var be=n(901),ye=n(755);async function xe(e,t={}){t.body&&"object"==typeof t.body&&(t.headers||(t.headers={}),t.headers["Content-Type"]="application/json",t.body=JSON.stringify(t.body));const n=await fetch("/api"+e,t);if(n.headers.get("Content-Type")&&n.headers.get("Content-Type").includes("application/json"))try{const e=await n.json();e.errors&&e.errors.forEach((e=>{be.error(e)})),n.json=()=>e}catch(e){}return n}async function ke(){await We.load(),X.updateBucket(function(){const e=u.y6;return"ADMIN"==F[We.role]?[0,32]:e[F[We.role]]||u.y6.GUEST}()),We.registered?(se.removeAttr("disabled"),se.val(""),ye("#loginButtons").hide(),ye("#chatNick").text(We.name),ye(".authBtn").hide()):(se.attr("disabled"),se.val((0,O.I)("login to chat")),ye("#chatNick").hide(),ye(".authBtn").show())}function Ce(){(0,A.lx)("template.x",ce.x,!0),(0,A.lx)("template.y",ce.y,!0),(0,A.lx)("template.url",ce.url,!0),(0,A.lx)("template.opac",ce.opacity,!0)}function Ee(){ce.update(),ce.render(),Ce()}function Ie(e,t=!0){t&&e.forEach((([e,t])=>{X.placed.push([e,t,D.chunkManager.getChunkPixel(e,t)])})),D.socket.sendPixels(e,!1)}function De(e,t,n,o=!0){const s=D.chunkManager.getChunkPixel(e,t),i=D.chunkManager.getProtect(e,t);s!==n&&(!i||We.role>=T.MOD)&&D.socket.connected?(o&&(X.placed.push([e,t,D.chunkManager.getChunkPixel(e,t)]),X.placed.length>2*X.maxPlaced&&(X.placed=X.placed.slice(-X.maxPlaced))),D.chunkManager.setChunkPixel(e,t,n),D.socket.sendPixel(e,t,n),D.socket.pendingPixels[e+","+t]=setTimeout((()=>{D.chunkManager.setChunkPixel(e,t,s),D.renderer.needRender=!0}),3e3)):i&&We.role<T.MOD&&be.error((0,O.I)("This pixel is protected."),(0,O.I)("Error!"),{preventDuplicates:!0,timeOut:750})}function Ae(){"none"===ie.css("display")?(ie.show(),ie.css("margin-top","")):(ie.css("margin-top",-ie.height()-30),setTimeout((()=>ie.hide()),500))}function Re(e=!0){u.H6.showProtected=e,D.chunkManager.chunks.forEach((e=>{e.needRender=!0})),D.renderer.needRender=!0}function Se(e){void 0===e&&(e=C()),ye(".paletteColor").css("width",e).css("height",e)}function Me(e,t){let n;(n=document.getElementById("REPLACE-"+e))||(n=document.createElement("style"),n.id="REPLACE-"+e);let o=Object.keys(t).map((e=>e+":"+t[e]));n.innerText=`${e}{${o.join(";")}}`,document.head.appendChild(n)}function Le(e){e?ye("#emotions").show():ye("#emotions").hide()}function Pe(e){const t=ye("#emotions");let n="";for(let t of e)n+=`<div class="emotion">${t}</div>`;t.html(n),ye("div",t).on("click",(e=>{ye("#chatInput")[0].value+=e.target.innerText,ye("#chatInput").trigger("focus")}))}function Te(e){X.brushSize=+e,D.fxRenderer.needRender=!0,D.renderer.preRenderBrush(),ye("#brushSizeCounter").text(e-1)}function Fe(e){e?ye("#placedPixels").show():ye("#placedPixels").hide()}function Oe(e,t){ye("#placedPixels").text(e),t&&ye("#placedPixels").attr("title",t)}let $e=X.placedCount;function Be(){const e=(0,A.TA)("colorSize",!0),t=C();Se(+e||t),Ue()}function Ne(){const e=D.chunkManager.dumpAll(),t=document.createElement("a");t.download=`GX ${u.Dv} ${function(){const e=new Date;return`${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}.${e.getFullYear()} - ${e.getHours().toString().padStart(2,"0")}-${e.getMinutes().toString().padStart(2,"0")}-${e.getSeconds().toString().padStart(2,"0")}`}()}.png`,t.href=e.toDataURL(),t.click()}function ze(){ye(".paletteColor>img").remove()}function Ue(){const e=ye("#palette").innerHeight();ye("#chat").css("bottom",e+4)}setInterval((()=>{$e!==X.placedCount&&((0,A.lx)("placedCount",X.placedCount,!0),$e=X.placedCount)}),3e3);var Ge=n(755);let He=!1,_e=[];const We={registered:!1,name:null,id:null,role:T.GUEST,update(e){this.registered=e.registered,e.registered&&(this.name=e.name,this.role=e.role,this.id=e.id),this.updateRoleRelatedHtml()},updateRoleRelatedHtml(){switch(Ge(".minrole-admin").hide(),Ge(".minrole-mod").hide(),Ge(".minrole-trusted").hide(),Ge(".minrole-user").hide(),this.role){case T.ADMIN:Ge(".minrole-admin").show();case T.MOD:Ge(".minrole-mod").show();case T.TRUSTED:Ge(".minrole-trusted").show();case T.USER:Ge(".minrole-user").show()}},checkCanGetUserInfo(){return this.registered&&this.role>=T.TRUSTED},async load(){const e=await xe("/me"),t=await e.json();this.update(t),He=!0,this.callStacked()},callOnLoaded(e){if(this.loaded)return e();_e.push(e)},callStacked(){_e.forEach((e=>e())),_e=[]}};var je=n(901),Ke=n.n(je);class Ye extends(a()){constructor(e,t=null,n=null,o=T.GUEST){super(),this.name=e,this.icon=n,this.key=t?t.toString():void 0,this.requiredRole=o}}const Xe={line:function(e,t,n,o){let s=[],i=Math.abs(o-t)>Math.abs(n-e);i&&([e,t]=[t,e],[n,o]=[o,n]);let r=!1;e>n&&([t,o]=[o,t],[e,n]=[n,e],r=!0);let a=n-e,l=Math.abs(o-t),c=a/2,h=t<o?1:-1;for(;e<=n;e++)s.push([i?t:e,i?e:t]),c-=l,c<0&&(t+=h,c+=a);return r&&s.reverse(),s.reverse(),s},filledCircle:function(e,t,n){let o=[];const s=n*n;for(let s=-n+e;s<n+e;s++)for(let e=-n+t;e<n+t;e++)i(s,e)&&o.push([s,e]);function i(n,o){let i=n-e,r=o-t;return i*i+r*r<=.8*s}return o},square(e,t,n,o){const s=Math.min(e,n),i=Math.min(t,o),r=Math.max(e,n),a=Math.max(t,o);let l=[];for(let e=i;e<a+1;e++)for(let t=s;t<r+1;t++)l.push([t,e]);return l}};function Je(e,t){return!(e<0||e>=u.w_||t<0||t>=u.G6)}class Ve{constructor(e){this.renderFunc=e,this.removed=!1}render(e){return this.renderFunc(e)}remove(){this.removed=!0}}class qe{constructor(){this.fxList=[[],[],[]],this.ctx=D.fxCtx,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.oImageSmoothingEnabled=!1,this.needRender=!0,this.needClear=!1}add(e,t=0){this.fxList[t].push(e),this.needRender=!0}requestRender(){this.needRender=!0}render(){if(this.needRender){this.ctx.clearRect(0,0,window.innerWidth,window.innerHeight),this.needRender=!1;for(let e=0;e<this.fxList.length;e++)this.fxList[e].forEach((e=>{if(e.removed)return this.remove(e);let t=e.render(this.ctx);2==t?this.remove(e):0==t&&(this.needRender=!0)}))}}remove(e){for(let t=0;t<this.fxList.length;t++){let n=this.fxList[t].indexOf(e);if(-1!=n){this.fxList[t][n].remove(),this.fxList[t].splice(n,1),this.needRender=!0;break}}}}const Ze=n.p+"/img/clicker.png",Qe=n.p+"/img/move.png",et=n.p+"/img/floodfill.png",tt=n.p+"/img/line.png",nt=n.p+"/img/protect.png",ot=n.p+"/img/revert.png";var st=n(755);const it=D.mobile;function rt(e,t){return D.chunkManager.getChunkPixel(e,t)}function at(e,t){return D.chunkManager.getProtect(e,t)}function lt(e,t){return(e+t)%2==0}function ct(){return-1===X.secondCol?~X.color?X.color:-1:-1===X.color?X.secondCol:lt(X.x,X.y)?X.color:X.secondCol}function ht(e,t,n=X.color,o=X.secondCol){return-1===o?n:-1===n?o:lt(e,t)?n:o}function dt(e,t){return e>=0&&e<u.w_&&t>=0&&t<u.G6}let ut=!1,pt=setInterval((()=>{D.toolManager&&(clearInterval(pt),ut=!0,mt.forEach((e=>e(D.toolManager))),mt=[])}),5),mt=[];function gt(e){ut?e(D.toolManager):mt.push(e)}let ft=[];function vt(e,t){D.fxRenderer?D.fxRenderer.add(e,t):ft.push([e,t])}function wt(e){D.fxRenderer.remove(e)}let bt=setInterval((()=>{if(D.fxRenderer){clearInterval(bt);for(let[e,t]of ft)vt(e,t);ft=[]}}),5);function yt(){D.fxRenderer.needRender=!0}class xt extends Ye{constructor(...e){super(...e),this._pendingPixels={},this.minZoom=2,this.on("down",this.down),this.on("up",this.up),this.on("move",this.move),this.on("leave",this.up),this.on("_gesture",this.ongesture),gt((()=>{it||(D.eventManager.on("mousedown",this.mousedown.bind(this)),D.eventManager.on("mouseup",this.mouseup.bind(this)))})),this.clrInterval=setInterval((()=>{this.clearPending()&&yt()}),250),this.fx=new Ve(this.render.bind(this))}mousedown(e){0===e.button&&(this.screenPos=[e.clientX,e.clientY])}mouseup(e){if(0!==e.button||!this.screenPos)return;const t=Math.abs(e.clientX-this.screenPos[0]),n=Math.abs(e.clientY-this.screenPos[1]);if(t>5||n>5)return;const[o,s]=[X.x,X.y],i=ht(o,s);this.checkPixel(o,s)&&~i&&De(X.x,X.y,ht(o,s))}down(e){this.lastPos=[X.x,X.y],this.screenPos=[e.clientX,e.clientY],this.mouseIsDown||P.zoom<this.minZoom||(this.mouseIsDown=!0,it?this.pointerId=e.pointerId:this.emit("move",{}))}up(e){this.mouseIsDown&&(it&&this.emit("move",e,!0),this.mouseIsDown=!1)}ongesture(){this.mouseIsDown=!1,this.lastPos=null}checkPixel(e,t){const n=`${e},${t}`,o=ht(e,t),s=rt(e,t),i=at(e,t);if(!(s===o||-1===s||i&&We.role<T.MOD||this._pendingPixels[n]&&this._pendingPixels[n][0]===o))return this._pendingPixels[n]=[o,Date.now()],!0}move(e,t=!1){if(e.gesture)return void this.ongesture();if(!this.mouseIsDown||e.gesture||-1===ct())return;if(it&&this.pointerId!==e.pointerId)return;const n=e.clientX,o=e.clientY,s=Math.abs(n-this.screenPos[0]),i=Math.abs(o-this.screenPos[1]);if(s<5&&i<5&&!t)return;let[r,a]=[X.x,X.y],l=Xe.line(this.lastPos[0],this.lastPos[1],r,a);this.lastPos=[r,a];let c=[[0,0]];1!==X.brushSize&&(c=D.renderer.preRendered.brush.circle);for(let[e,t]of l){let n=[];if(!this.checkAllowance(c.length))return;c.forEach((([o,s])=>{let i=e+o,r=t+s;if(this.checkPixel(i,r)){const e=ht(i,r);n.push([i,r,e])}})),this.place(n)}}checkAllowance(e){return!(X.bucket.allowance<e)}place(e){0!==e.length&&(X.bucket.spend(e.length),1==e.length?De(...e[0]):Ie(e))}render(e){const t=P.zoom;e.lineWidth=t/5,e.globalAlpha=.5;for(let n of Object.keys(this._pendingPixels)){let[o,s]=n.split(",").map((e=>parseInt(e,10)));const i=this._pendingPixels[n][0];e.strokeStyle="#000000",e.fillStyle=u._D[i];const[r,a]=V(o,s);e.strokeRect(r,a,t,t)}return e.globalAlpha=1,1}clearPending(){let e=!1;return Object.keys(this._pendingPixels).forEach((t=>{let n=this._pendingPixels[t][1];Date.now()-n>500&&(delete this._pendingPixels[t],e=!0)})),e}}const kt=new xt("clicker","Space",Ze);class Ct extends xt{constructor(...e){super(...e),this.minZoom=1,this._alt=!1,this._mobileIsProtect=null}getProtectState(){return it?this._mobileIsProtect:!this._alt}mousedown(){}mouseup(){}down(e){this.mouseIsDown||(super.down(e),Re(),this._mobileIsProtect=!at(...this.lastPos))}checkPixel(e,t){const n=`${e},${t}`,o=this.getProtectState();if(at(e,t)!==o&&(!this._pendingPixels[n]||this._pendingPixels[n][0]!==o))return this._pendingPixels[n]=[o,Date.now()],!0}checkAllowance(){return!0}place(e){const t=this.getProtectState();e.forEach((e=>e[2]=t)),e.length&&function(e){D.socket.sendPixels(e,!0)}(e)}render(){}}const Et=new Ct("protector","KeyV",nt,T.MOD),It=new Ct("alt protector","ALT+KeyV",null,T.MOD);It._alt=!0;const Dt=new class extends Ye{constructor(...e){super(...e),this.handlers(),this.downPos=[0,0],this.lastPos=[0,0],this.lastPlayerPos=[0,0],it||(this.fx=new Ve(this.renderCursor),vt(this.fx))}handlers(){gt((()=>{this.on("down",this.down),this.on("up",this.up),D.toolManager.on("move",this.move.bind(this)),this.on("leave",this.up)}))}renderCursor(e){const t=P.zoom,n=ct();if(~n&&t>1)if(1==X.brushSize){let o,s,[i,r]=V(X.x,X.y);e.strokeStyle=u._D[n],e.lineWidth=t/5;let a=e.lineWidth/2;i+=a,r+=a,o=t-e.lineWidth,s=o,e.strokeRect(i,r,o+1,s+1)}else{const[t,n]=V(X.x-X.brushSize/2,X.y-X.brushSize/2);e.drawImage(D.renderer.preRendered.brush.canvas,t,n)}return 1}down(e){e.ctrlKey||(this.mousedown=!0,Me("#ui>div>*",{"pointer-events":"none"}),it||(this.downPos=this.lastPos=[e.clientX,e.clientY]))}up(e){e.ctrlKey||(this.mousedown=!1,Me("#ui>div>*",{"pointer-events":"all"}),!it&&this.moveThresold()&&"mouseleave"!==e.type&&e instanceof MouseEvent&&e.button)}move(e){e.ctrlKey||((this.lastPlayerPos[0]!=X.x||this.lastPlayerPos[1]!=X.y||this.mousedown)&&yt(),this.lastPlayerPos=[X.x,X.y],this.mousedown&&(!it&&(this.lastPos=[e.clientX,e.clientY],this.moveThresold())||P.moveTo(-e.movementX/P.zoom,-e.movementY/P.zoom)))}moveThresold(){return Math.abs(this.downPos[0]-this.lastPos[0])<5&&Math.abs(this.downPos[1]-this.lastPos[1])<5}}("mover",null,Qe),At=new class extends Ye{constructor(...e){super(...e),this.on("up",this.up),this.on("down",this.down),this.on("leave",this.up),this.on("tick",this.tick),this.previewing=!1,this.fx=null,this.prevStack=[]}up(e,t){if(this.active)return void(this.active=!1);if(!this.previewing)return;if(this.fx.remove(),yt(),this.previewing=!1,t)return;const n=J(e.clientX,e.clientY);-1!==ht(...n)&&Je(...n)&&"mouseleave"!==e.type&&(this.active=!0,this.stack=[[X.x,X.y]],this.playerCol=X.color,this.secondPlayerCol=X.secondCol,this.fillingCol=rt(X.x,X.y))}down(e){if(e.repeat||this.previewing||this.active)return;const t=J(e.clientX,e.clientY);if(-1===ht(...t)||!Je(...t))return;let n,o;i.apply(this),this.showedPixels=[],this.fillingCol=rt(X.x,X.y);let s=new Ve(function(e){if(D.mobile&&D.toolManager.tool!==this)return this.up({},!0),1;if(X.x==n&&X.y==o||i.call(this),-1===ct())return 1;let t=0;for(let e=0;e<700&&0==t;e++)t=r.call(this);return e.strokeWidth=P.zoom,e.clearRect(0,0,window.innerWidth,window.innerHeight),this.showedPixels.forEach(((t,n)=>{let[o,s]=t.split(",").map((e=>parseInt(e,10))),i=1,r=this.showedPixels.length;if(r>=100&&n<r/2&&(i=1-(r/2-n)/(r/2),i<=0))return;e.globalAlpha=i;const a=ht(o,s,this.playerCol,this.secondPlayerCol);e.strokeStyle=u._D[a];let[l,c]=V(o,s);e.strokeRect(l,c,P.zoom,P.zoom)})),t}.bind(this));function i(){this.prevStack=[[X.x,X.y]],this.showedPixels=[],n=X.x,o=X.y,this.playerCol=X.color,this.secondPlayerCol=X.secondCol,this.fillingCol=rt(X.x,X.y)}function r(){if(!this.prevStack.length)return 1;let[e,t]=this.prevStack.pop(),n=ht(e,t,this.playerCol,this.secondPlayerCol),o=rt(e,t);if(-1!==this.showedPixels.indexOf(e+","+t)||o===n||o!==this.fillingCol||!Je(e,t))return 0;this.showedPixels.push(e+","+t);let s=this.checkP(e,t-1),i=this.checkP(e,t+1),r=this.checkP(e-1,t),a=this.checkP(e+1,t);return s&&r&&this.checkP(e-1,t-1),s&&a&&this.checkP(e+1,t-1),i&&r&&this.checkP(e-1,t+1),i&&a&&this.checkP(e+1,t+1),0}vt(s,0),this.fx=s,this.previewing=!0}checkP(e,t){return rt(e,t)===this.fillingCol&&(this.prevStack.unshift([e,t]),!0)}tick(){if(this.active){for(let e=0;e<15&&this.stack.length&&X.bucket.spend(1);e++){let[e,t]=this.stack.pop(),n=ht(e,t,this.playerCol,this.secondPlayerCol),o=rt(e,t);if(o===n||o!==this.fillingCol||!Je(e,t))continue;let s=this.check(e,t-1),i=this.check(e,t+1),r=this.check(e-1,t),a=this.check(e+1,t);s&&r&&this.check(e-1,t-1),s&&a&&this.check(e+1,t-1),i&&r&&this.check(e-1,t+1),i&&a&&this.check(e+1,t+1),De(e,t,n)}return this.stack.length?void 0:this.active=!1}}check(e,t){return rt(e,t)===this.fillingCol&&(this.stack.unshift([e,t]),!0)}}("floodfill","KeyF",et);class Rt extends Ye{constructor(...e){super(...e),it||this.on("down",this.down)}down(e){const t=rt(X.x,X.y);-1!==t&&(e.__alt?X.switchSecondColor(t):X.switchColor(t),yt())}mobileDown(){this.downCord=[X.x,X.y],this.downTime=Date.now()}mobileUp(){X.x,X.y,Date.now(),this.downCord=null,this.downTime=null}}const St=new Rt("pipette","KeyC"),Mt=new Rt("alt pipette","ALT+KeyC");Mt.off("down",Mt.down),Mt.on("down",(e=>{e.__alt=!0,Mt.down.call(Mt,e)}));const Lt=new class extends Ye{constructor(...e){super(...e),this.drawLength=JSON.parse((0,A.CJ)("drawLineLen",!1)),gt((()=>{this.handlers()}))}handlers(){let e,t,n,o,s,i,r,a=[],l=!1;function c(){l||(l=!0,e=[X.x,X.y],[s,i]=[X.color,X.secondCol],r=1,1!==X.brushSize&&(r=D.renderer.preRendered.brush.circle.length))}function h(o){if(l&&e){if(o.gesture)return l=!1,e=null;if(t=[X.x,X.y],-1!==X.color||-1!==X.secondCol){if(t[0]!=a[0]||t[1]!=a[1]){a=t;const o=d(...e,...t);n&&wt(n),n=new Ve((e=>{e.globalAlpha=.5,o.forEach((([t,n])=>{const o=ht(t,n);e.fillStyle=u._D[o];let[s,i]=V(t,n);e.fillRect(s,i,P.zoom,P.zoom)})),e.strokeStyle="#000000",e.lineWidth=P.zoom/5;const t=V(...o[0]),n=V(...o[o.length-1]);if(e.beginPath(),e.lineCap="round",e.moveTo(...t.map((e=>e+P.zoom/2))),e.lineTo(...n.map((e=>e+P.zoom/2))),this.drawLength&&o.length>1){let[r,a]=t,[l,c]=n,h=Math.min(r,l),d=Math.min(a,c),u=Math.max(r,l),p=Math.max(a,c),[m,g]=[u-Math.abs(u-h)/2,p-Math.abs(p-d)/2];m+=.5*P.zoom,g+=.5*P.zoom;let f=(s=c-a,i=l-r,Math.atan2(s,i)*(180/Math.PI));f>90?f-=180:f<-90&&(f+=180);let v=f*(Math.PI/180),w=40*Math.sin(v),b=40*Math.cos(v);m+=w,g-=b,e.save(),e.globalAlpha=.7;const y=20;e.font=y+"px sans-serif",e.fillStyle="black",e.strokeStyle="white",e.textAlign="center",e.textBaseline="middle",e.lineWidth=y/6;const x=o.length,[k,C]=[m,g];e.strokeText(x,k,C),e.fillText(x,k,C),e.restore()}var s,i;return e.stroke(),e.globalAlpha=1,1})),vt(n)}}else n&&wt(n)}}function d(e,t,n,o){let s=[[0,0]];1!==X.brushSize&&(s=D.renderer.preRendered.brush.circle);const i=u.w_,r=new Set,a=[],l=Xe.line(e,t,n,o);for(let e=l.length-1;e>=0;e--){const[t,n]=l[e];s.forEach((([e,o])=>{const s=t+e,l=n+o,c=s+l*i;r.has(c)||(r.add(c),a.push([s,l]))}))}return a.reverse()}function p(){this.off("tick",m),l&&e&&(l=!1,n&&n.remove(),t||(t=[X.x,X.y]),o=d(...e,...t),e=null,t=null,yt(),this.on("tick",m))}function m(){-1===X.color&&-1===X.secondCol&&(o=null);let e=0;for(;;){if(!o||!o.length)return void this.off("tick",m);const[t,n]=o.pop(),a=ht(t,n,s,i);if(void 0===a||-1===a)return this.off("tick",m);if(dt(t,n)&&rt(t,n)!==a){if(!X.bucket.spend(1))return o.push([t,n]);if(De(t,n,a),e++,e>=r/2)return}}}c=c.bind(this),h=h.bind(this),p=p.bind(this),m=m.bind(this),this.on("down",c),D.toolManager.on("move",h),this.on("up",p)}}("line","ShiftLeft",tt),Pt=new Ye("coords to chat","KeyU");Pt.on("up",(function(){const e=st("#coords").text();e.length&&(se[0].value+=e+" ",se.trigger("focus"))}));const Tt=new Ye("swap colors","KeyX");Tt.on("up",X.swapColors.bind(X));const Ft=new Ye("left color","KeyA");Ft.on("down",(function(){let e=X.color;--e<0&&(e=u._D.length-1),X.switchColor(e)}));const Ot=new Ye("right color","KeyS");Ot.on("down",(function(){let e=X.color;++e>=u._D.length&&(e=0),X.switchColor(e)}));const $t=new Ye("toggle chat","KeyK");$t.on("down",(function(){"none"===oe.css("display")?(oe.show(),oe.css("left","")):(oe.css("left",-oe.width()-30),setTimeout((()=>oe.hide()),500))}));const Bt=new Ye("toggle menu","KeyL");Bt.on("down",(function(){Ae()}));const Nt=new Ye("toggle everything","Semicolon");Nt.on("down",(function(){ye("#ui").fadeToggle(100),Ue()}));const zt=new class extends Ye{constructor(...e){super(...e),this.handlers()}handlers(){let e=!1;function t(){e=!1,this.off("tick",l),r=i,a=0}t=t.bind(this);const n=function(n){if(n.preventDefault(),n.stopPropagation(),n.gesture)return t();e||(e=!0,l(),this.on("tick",l))}.bind(this),o=function(e){e.gesture&&t()}.bind(this),s=function(){t()}.bind(this),i=500;let r=i,a=0;const l=function(){const e=Date.now()-a;if(e<r)return;let t=e/r|0;t<0&&(t=1),a=Date.now();do{const e=D.toolManager.altDown?.2:1;if(r=Math.max(r/1.5,50*e),X.placed.length>X.maxPlaced&&(X.placed=X.placed.slice(-X.maxPlaced)),!X.placed.length)return;if(!X.bucket.spend(1))return;const[t,n,o]=X.placed.pop();De(t,n,o,!1)}while(--t)}.bind(this);this.on("down",n),D.eventManager.on("mousemove",o),this.on("up",s)}}("ctrlZ","KeyZ",ot),Ut=new class extends Ye{constructor(...e){super(...e),this.state=0,this.fx=null,this.isLight=JSON.parse((0,A.CJ)("lightGrid",!1)),this.pattern=null,P.on("zoom",(()=>{1==this.state&&this.tryRender()})),this.on("down",this.pressed.bind(this)),JSON.parse((0,A.CJ)("enableGrid",!1))&&this.show()}pressed(e){e.repeat||this.toggle()}drawGrid(e){let[t,n]=J(0,0),[o,s]=V(t,n),{width:i,height:r}=e.canvas;const a=P.zoom;let l;e.fillStyle="rgb(127,127,127)",e.globalAlpha=.8,l=u.$t%16==0?16:u.$t%10==0?10:null,l=null;let c=1;for(t--,n--;o<i;o+=a)t++,c=.7,t%u.$t==0&&(c=1),e.fillRect(o,0,c,r);for(;s<r;s+=a)n++,c=.7,n%u.$t==0&&(c=1),e.fillRect(0,s,i,c);e.globalAlpha=1}tryRender(){this.fx&&!this.fx.removed||(this.fx=new Ve(this.render.bind(this)),vt(this.fx,2))}toggle(){0==this.state?this.show():this.hide(),(0,A.lx)("enableGrid",(!!this.state).toString())}show(){this.state=1,this.tryRender()}hide(){this.state=0,this.fx&&wt(this.fx)}render(e){if(P.zoom<=4)return 1;this.drawGrid(e)}}("grid","KeyG"),Gt=new class extends Ye{constructor(...e){super(...e),this.state=0,this.moveFX=null,this.drawInterval=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}async down(){if(0==this.state||1==this.state){this.state=1;try{const e=await this.getImage();this.startPlace(e)}catch{this.state=0}}else 2==this.state||3==this.state&&(this.state=0,this.stopDraw())}async getImage(){const e=document.createElement("input");return e.type="file",e.accept="image/png",e.click(),new Promise(((t,n)=>{e.onchange=()=>{if(e.onchange=null,!e.files.length||""==e.files[0])return n();const o=new FileReader;o.readAsDataURL(e.files[0]),o.onload=()=>{const e=new Image;e.src=o.result,e.onload=()=>{const n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0),t(n)},e.onerror=n},o.onerror=n}}))}startPlace(e){X.resetColors(),this.state=2;let t,n,o=X.x,s=X.y;function i(){let e=X.x,t=X.y;e==o&&t==s||(o=e,s=t)}vt(this.moveFX=new Ve((function(t){const[n,i]=V(o,s),r=P.zoom;return t.globalAlpha=.5,t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=!1,t.save(),t.scale(r,r),t.drawImage(e,n/r,i/r),t.restore(),t.globalAlpha=1,1})));let r=function(e){t=e.clientX,n=e.clientY},a=function(i){if(2==i.button)return this.state=0,this.stopPlace(),void l();let[r,a]=[i.clientX,i.clientY];Math.abs(r-t)>5||Math.abs(a-n)>5||(l(),this.stopPlace(),this.startDraw(e,o,s))};function l(){D.eventManager.off("mousedown",r),D.eventManager.off("mouseup",a),D.toolManager.off("move",i)}a=a.bind(this),D.eventManager.on("mousedown",r),D.eventManager.on("mouseup",a),D.toolManager.on("move",i)}stopPlace(){wt(this.moveFX),this.removeAllListeners("move")}startDraw(e,t,n){this.state=3;const o=e.getContext("2d"),{width:s}=e;let i=o.getImageData(0,0,e.width,e.height).data,r=-4;this.drawInterval=setInterval(function(){let e=Math.floor(X.bucket.allowance);if(0==e)return;let o=[];for(;e>0&&r<i.length-4&&o.length<16e3;){r+=4;let a=[i[r],i[r+1],i[r+2],i[r+3]];if(a[3]<127)continue;let l=r/4;const c=t+l%s,h=n+(l/s|0);if(c<0||c>=u.w_||h<0||h>=u.G6)continue;const d=(0,ve.xV)(a,u.DG);D.chunkManager.getChunkPixel(c,h)!=d&&(e--,o.push([c,h,d]))}o.length&&(X.bucket.spend(o.length),D.socket.sendPixels(o)),r>=i.length-4&&(this.state=0,this.stopDraw())}.bind(this),50)}stopDraw(){clearInterval(this.drawInterval)}}("paste","CTRL+KeyV",null,T.MOD);let Ht=parseFloat((0,A.CJ)("template.opacity",.5,!0));const _t=new Ye("template 0/N opaq","KeyO");_t.on("down",(()=>{0==ce.opacity?ce.opacity=Ht:(Ht=ce.opacity,ce.opacity=0),Ee()}));const Wt=new Ye("template 1/N opaq","KeyP");Wt.on("down",(()=>{1==ce.opacity?ce.opacity=Ht:(Ht=ce.opacity,ce.opacity=1),Ee()}));const jt=new class extends Ye{constructor(...e){super(...e),this.handlers()}handlers(){let e,t,n,o,s,i,r=[],a=!1;function l(){a||(a=!0,e=[X.x,X.y],[s,i]=[X.color,X.secondCol],this.emit("move"))}function c(){if(a&&e&&(t=[X.x,X.y],t[0]!=r[0]||t[1]!=r[1])){r=t;const o=Xe.square(...e,...t);n&&wt(n),n=new Ve((e=>{e.globalAlpha=.5;for(let[t,n]of o){const[o,s]=V(t,n),i=ht(t,n);e.fillStyle=u._D[i],e.fillRect(o,s,P.zoom,P.zoom)}return e.globalAlpha=1,1})),vt(n)}}function h(){this.off("tick",d),a=!1,e&&(n&&n.remove(),t||(t=[X.x,X.y]),o=Xe.square(...e,...t),yt(),o.length<=1||this.on("tick",d))}function d(){let e=X.bucket.allowance===1/0;if(this.lastTick||(this.lastTick=Date.now()),e&&Date.now()-this.lastTick<50)return;this.lastTick=Date.now();let t=0,n=[];for(;t<1e3;){if(!o||!o.length){this.off("tick",d);break}const[r,a]=o.pop(),l=ht(r,a,s,i);if(void 0===l||-1===l)return this.off("tick",d);if(dt(r,a)&&rt(r,a)!==l){if(!X.bucket.spend(1))return o.push([r,a]);t++,e?n.push([r,a,l]):De(r,a,l)}}n.length&&Ie(n,!0)}l=l.bind(this),c=c.bind(this),h=h.bind(this),d=d.bind(this),this.on("down",l),this.on("move",c),this.on("up",h)}}("square","KeyJ"),Kt=new Ye("+brush size","BracketRight");Kt.on("down",(()=>{if(!(X.brushSize>=100))return 1==X.brushSize?Te(4):void Te(X.brushSize+2)}));const Yt=new Ye("-brush size","BracketLeft");Yt.on("down",(()=>{if(X.brushSize<=4)return Te(1);Te(X.brushSize-2)}));const Xt=new class extends Ye{constructor(...e){super(...e),this.state=0,this.selectFX=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}down(e){if(this.state>0||Gt.state>0)return;if("Range"===window.getSelection().type)return;let t,n,o,s,i;e.preventDefault(),e.stopPropagation(),P.disableMove(),X.resetColors(),D.elements.mainCanvas.style.cursor="crosshair",this.state=1;let r=!1,a=!1,l=[];function c(e){"Alt"===e.key&&(r=!0)}function h(){console.log({altPressed:r}),r?(a=!0,l=[[X.x,X.y]]):(n=X.x,o=X.y)}function d(){if(a){let e=X.x,t=X.y;l.push([e,t])}else s=X.x+1,i=X.y+1}function p(){D.elements.mainCanvas.style.cursor="",wt(t),D.eventManager.off("keydown",c),D.eventManager.off("mousedown",h),D.eventManager.off("mousemove",d),D.eventManager.off("mouseup",p),this.state=0,P.enableMove(),function(){let e,t,r,c;if(a){e=t=l[0][0],r=c=l[0][1];for(let n=0;n<l.length;n++){const o=l[n];o[0]<e&&(e=o[0]),o[0]>t&&(t=o[0]),o[1]<r&&(r=o[1]),o[1]>c&&(c=o[1])}}else{if([n,o,s,i].some((e=>void 0===e)))return;e=Math.min(n,s),t=Math.max(n,s)+1,r=Math.min(o,i),c=Math.max(o,i)+1}e=Math.max(e,0),t=Math.min(t,u.w_),r=Math.max(r,0),c=Math.min(c,u.G6);const h=t-e,d=c-r,p=document.createElement("canvas");p.width=h,p.height=d;const m=p.getContext("2d"),g=m.createImageData(h,d);let f,v;if(a){f=new Array(l.length),v=new Array(l.length);for(let e=0;e<l.length;e++){const t=l[e];f[e]=t[0],v[e]=t[1]}}for(let t=0;t<h;t++)for(let n=0;n<d;n++){const o=4*(t+n*h),s=e+t,i=r+n;if(a&&!E(l.length,f,v,s,i))continue;const c=D.chunkManager.getChunkPixel(s,i),d=u.DG[c];g.data[o]=d[0],g.data[o+1]=d[1],g.data[o+2]=d[2],g.data[o+3]=255}m.putImageData(g,0,0),Gt.startPlace(p)}()}t=new Ve((function(e){if(e.save(),e.strokeStyle="gray",e.lineWidth=2,e.setLineDash([3,3]),e.globalAlpha=1,a){e.beginPath();const t=V(l[0][0],l[0][1]);e.moveTo(...t);for(let t=1;t<l.length;t++){const n=l[t];e.lineTo(...V(...n))}e.closePath(),e.stroke()}else{const[t,r]=V(n,o),[a,l]=V(s,i);e.strokeRect(t,r,a-t,l-r)}return e.restore(),1})),vt(t),c=c.bind(this),h=h.bind(this),d=d.bind(this),p=p.bind(this),D.eventManager.on("keydown",c),D.eventManager.on("mousedown",h),D.eventManager.on("mousemove",d),D.eventManager.on("mouseup",p)}}("copy","CTRL+KeyC",null,T.MOD),Jt=new Ye("pixel info","KeyI");let Vt=null,qt=null;function Zt(){Vt&&(Vt.remove(),Vt=null),qt&&(qt.remove(),qt=null)}D.eventManager.on("mouseup",Zt),Jt.on("up",(async()=>{Zt();const[e,t]=[X.x,X.y],n=await xe(`/pixelInfo?canvas=${u.X1}&x=${e}&y=${t}`),o=await n.json();if(!o||!o.type)return;const s=st('<div class="infoBubble"><span style="user-select:text"></span></div>');Vt=s;const i=st("<div>");i[0].style.cssText="position: absolute;\n    top: -7px;\n    left: 0;\n    width: 100%;\n    font-size: 14px;\n    font-weight: bold;\n    text-shadow: rgb(255 255 255) -1px 1px 0px, rgb(255 255 255) 1px 1px 0px, rgb(255 255 255) 1px -1px 0px, rgb(255 255 255) -1px -1px 0px;\n    text-align: center;",i.text(`(${e}, ${t})`),s.append(i);let r="";if("UID"===o.type){const e=k(o.placer.nick);r+="<b>UID</b>&nbsp;"+o.placer.id+"<br>",r+="<b>name</b>&nbsp;"+e}else r+=`<b>${o.type}</b>`,o.placer&&(r+="&nbsp;"+o.placer);st("span",s).html(r),st("body").append(s);const a=s[0].clientWidth,l=s[0].clientHeight;function c(){const[n,o]=V(e,t),i=n+P.zoom/2-a/2,r=o-l-11;return s.css("top",r).css("left",i),1}c(),qt=new Ve((()=>{c()})),vt(qt,2)}));const Qt={clicker:kt,mover:Dt,floodfill:At,pipette:St,altPipette:Mt,line:Lt,colorInc:Ot,colorDec:Ft,colorSwap:Tt,chatOpac:$t,menuOpac:Bt,allOpac:Nt,ctrlZ:zt,protector:Et,altProtector:It,grid:Ut,copy:Xt,paste:Gt,cordAdd:Pt,templateOp1:_t,templateOp2:Wt,square:jt,incBrush:Kt,decBrush:Yt,pixelInfo:Jt},en=n.p+"/img/user2.png",tn=n.p+"/img/arrow.svg";function nn(e){return e.replace(/[А-я\w]+/g,(function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))}var on=n(755);function sn(e=[]){const t=on('<table class="columnTable"></table>');return e.forEach((([e,n])=>{let o=on(`\n                <tr>\n                    ${void 0===n?`<td colspan="2">${e}</td>`:`<td>${e}</td>\n                        <td>${n}</td>`}\n                </tr>`);t.append(o)})),t}function rn(){const e=new _({title:nn((0,O.I)("account settings")),center:!0});if(!e.created)return;let t=sn([[(0,O.I)("role"),F[We.role].toUpperCase()],[(0,O.I)("change name"),'<input type="text" id="name" style="width:50%"><button id="changeName">yes</button>'],[`<button id="logout">${(0,O.I)("logout")}</button>`]]);on(e.body).append(t),on("#name").val(We.name),on("#changeName").on("click",(()=>{const e=on("#name").val();return We.registered?e.length<0||e.length>32?Ke().error("Name length is not 0 < length < 32","Name change"):We.name===e?Ke().error("Name is the same as was","Name change"):void fetch("/api/changename",{method:"POST",body:JSON.stringify({name:e}),headers:{"Content-Type":"application/json"}}).then((async e=>{const t=await e.json();t.errors.length?t.errors.map((e=>{Ke().error(e,"Name change error")})):(D.socket.close(),Ke().success("Name successfully changed"),ke())})):Ke().error("Hey wtf","0_o")})),on("#logout").on("click",(async()=>{if(We.registered){const e=await xe("/auth/logout");await e.json()?location.pathname="/":Ke().error("Can't log out")}}))}function an(){const e=new _({title:nn((0,O.I)("toolbinds settings")),center:!0});if(!e.created)return;let t=sn();for(const e of Object.values(Qt)){if(!e.key)continue;if(e.requiredRole>We.role)continue;const n=on(`<tr>\n            <td>${e.name}</td>\n            <td>\n                <span id="MODS-${e.name}"></span>\n                <input id="KEY-${e.name}" class="key" style="width:130px">\n            </td>\n        </tr>`);t.append(n);const o=on("input",n),s=on("span",n);o.on("keydown",(t=>{if(t.preventDefault(),!t.code||"ControlLeft"===t.code||"AltLeft"===t.code)return;const n=t.altKey,i=t.ctrlKey;let r="";s.text(""),n&&(s.text("ALT + "),r+="ALT+"),i&&(s.text(s.text()+"CTRL + "),r+="CTRL+"),r+=t.code,o.val(t.code);for(let t of Object.values(Qt))e.name!=t.name&&t.key==r&&(on("#MODS-"+t.name).text(""),on("#KEY-"+t.name).val(""));D.toolManager.changeKey(e,r)})),o.on("keyup",(e=>{if(e.preventDefault(),!e.code||"ControlLeft"===e.code||"AltLeft"===e.code)return;let t={};for(const e of Object.values(Qt))e.key&&(t[e.name]=e.key);(0,A.lx)("keyBinds",JSON.stringify(t))}));const i=y(e.key);s.text((i.alt?"ALT + ":"")+(i.ctrl?"CTRL + ":"")),o.val(i.code)}on(e.body).append(t)}function ln(){const e=new _({title:nn((0,O.I)("ui settings")),center:!0});if(!e.created)return;const t=sn([[(0,O.I)("colors size"),'<input type="range" min="16", max="64" step="1" id="colSize"><div style="width:50px;"><div>'],[(0,O.I)("hide emojis"),'<input type="checkbox" id="toggleEmojis">'],[(0,O.I)("emoji list"),'<input type="text" id="emojiList">'],[`<button id="moreEmojis">${(0,O.I)("super secret button")}</button>`],[(0,O.I)("show placed pixels"),'<input type="checkbox" id="togglePlaced">'],[(0,O.I)("show patterns over the palette"),'<input type="checkbox" id="showPatterns">']]);on(e.body).append(t);const n=(0,A.CJ)("colorSize",24,!0);on("#colSize").next().text(n),on("#colSize").val(n),on("#colSize").on("input",(function(){const e=on("#colSize").val();Se(e),on("#colSize").next().text(e+"px"),(0,A.lx)("colorSize",e,!0),Ue()})),on("#toggleEmojis")[0].checked=1==(0,A.TA)("hideEmojis"),on("#toggleEmojis").on("click",(e=>{const t=!e.target.checked;(0,A.lx)("hideEmojis",t?0:1),Le(t)})),on("#emojiList").val((0,A.CJ)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐")),on("#emojiList").on("change",(e=>{(0,A.lx)("emojis",e.target.value),Pe(e.target.value.split(" "))})),on("#moreEmojis").on("click",(()=>{const e=new _((0,O.I)("more emojis!"));e.created&&(e.body.innerHTML="😁😂😃😄😅😆😉😊😋😌😍😏😒😓😔😖😘😚😜😝😞😠😡😢😣😤😥😨😩😪😫😭😰😱😲😳😵😷😸😹😺😻😼😽😾😿🙀🙅🙆🙇🙈🙉🙊🙋🙌🙍🙎🙏✂✅✈✉✊✋✌✏✒✔✖✨✳✴❄❇❌❎❓❔❕❗❤➕➖➗➡➰🚀🚃🚄🚅🚇🚉🚌🚏🚑🚒🚓🚕🚗🚙🚚🚢🚤🚥🚧🚨🚩🚪🚫🚬🚭🚲🚶🚹🚺🚻🚼🚽🚾🛀Ⓜ🅰🅱🅾🅿🆎🆑🆒🆓🆔🆕🆖🆗🆘🆙🆚🈁🈂🈚🈯🈲🈳🈴🈵🈶🈷🈸🈹🈺🉐🉑©®‼⁉™ℹ↔↕↖↗↘↙↩↪⌚⌛⏩⏪⏫⏬⏰⏳▪▫▶◀◻◼◽◾☀☁☎☑☔☕☝☺♈♉♊♋♌♍♎♏♐♑♒♓♠♣♥♦♨♻♿⚓⚠⚡⚪⚫⚽⚾⛄⛅⛎⛔⛪⛲⛳⛵⛺⛽⤴⤵⬅⬆⬇⬛⬜⭐⭕〰〽㊗㊙🀄🃏🌀🌁🌂🌃🌄🌅🌆🌇🌈🌉🌊🌋🌌🌏🌑🌓🌔🌕🌙🌛🌟🌠🌰🌱🌴🌵🌷🌸🌹🌺🌻🌼🌽🌾🌿🍀🍁🍂🍃🍄🍅🍆🍇🍈🍉🍊🍌🍍🍎🍏🍑🍒🍓🍔🍕🍖🍗🍘🍙🍚🍛🍜🍝🍞🍟🍠🍡🍢🍣🍤🍥🍦🍧🍨🍩🍪🍫🍬🍭🍮🍯🍰🍱🍲🍳🍴🍵🍶🍷🍸🍹🍺🍻🎀🎁🎂🎃🎄🎅🎆🎇🎈🎉🎊🎋🎌🎍🎎🎏🎐🎑🎒🎓🎠🎡🎢🎣🎤🎥🎦🎧🎨🎩🎪🎫🎬🎭🎮🎯🎰🎱🎲🎳🎴🎵🎶🎷🎸🎹🎺🎻🎼🎽🎾🎿🏀🏁🏂🏃🏄🏆🏈🏊🏠🏡🏢🏣🏥🏦🏧🏨🏩🏪🏫🏬🏭🏮🏯🏰🐌🐍🐎🐑🐒🐔🐗🐘🐙🐚🐛🐜🐝🐞🐟🐠🐡🐢🐣🐤🐥🐦🐧🐨🐩🐫🐬🐭🐮🐯🐰🐱🐲🐳🐴🐵🐶🐷🐸🐹🐺🐻🐼🐽🐾👀👂👃👄👅👆👇👈👉👊👋👌👍👎👏👐👑👒👓👔👕👖👗👘👙👚👛👜👝👞👟👠👡👢👣👤👦👧👨👩👪👫👮👯👰👱👲👳👴👵👶👷👸👹👺👻👼👽👾👿💀💁💂💃💄💅💆💇💈💉💊💋💌💍💎💏💐💑💒💓💔💕💖💗💘💙💚💛💜💝💞💟💠💡💢💣💤💥💦💧💨💩💪💫💬💮💯💰💱💲💳💴💵💸💹💺💻💼💽💾💿📀📁📂📃📄📅📆📇📈📉📊📋📌📍📎📏📐📑📒📓📔📕📖📗📘📙📚📛📜📝📞📟📠📡📢📣📤📥📦📧📨📩📪📫📮📰📱📲📳📴📶📷📹📺📻📼🔃🔊🔋🔌🔍🔎🔏🔐🔑🔒🔓🔔🔖🔗🔘🔙🔚🔛🔜🔝🔞🔟🔠🔡🔢🔣🔤🔥🔦🔧🔨🔩🔪🔫🔮🔯🔰🔱🔲🔳🔴🔵🔶🔷🔸🔹🔺🔻🔼🔽🕐🕑🕒🕓🕔🕕🕖🕗🕘🕙🕚🕛🗻🗼🗽🗾🗿😀😇😈😎😐😑😕😗😙😛😟😦😧😬😮😯😴😶🚁🚂🚆🚈🚊🚍🚎🚐🚔🚖🚘🚛🚜🚝🚞🚟🚠🚡🚣🚦🚮🚯🚰🚱🚳🚴🚵🚷🚸🚿🛁🛂🛃🛄🛅🌍🌎🌐🌒🌖🌗🌘🌚🌜🌝🌞🌲🌳🍋🍐🍼🏇🏉🏤🐀🐁🐂🐃🐄🐅🐆🐇🐈🐉🐊🐋🐏🐐🐓🐕🐖🐪👥👬👭💭💶💷📬📭📯📵🔀🔁🔂🔄🔅🔆🔇🔉🔕🔬🔭🕜🕝🕞🕟🕠🕡🕢🕣🕤🕥🕦🕧",e.body.style.userSelect="text")})),on("#togglePlaced")[0].checked=0==(0,A.CJ)("hidePlaced",1),on("#togglePlaced").on("click",(e=>{const t=e.target.checked;(0,A.lx)("hidePlaced",t?0:1),Fe(t)})),on("#showPatterns")[0].checked=D.showPatterns,on("#showPatterns").on("click",(e=>{const t=e.target.checked;D.showPatterns=t,t?(ze(),u.DG.forEach((([e,t,n],o)=>{const s=fe.patterns[o%fe.patterns.length],i=document.createElement("canvas");i.width=i.height=14;const r=i.getContext("2d");r.fillStyle=u._D[o];for(let e=0;e<49;e++){if(!s[e])continue;const t=e%7,n=e/7|0;r.fillRect(2*t,2*n,2,2)}function a(e,t){return 4*(e+14*t)}let l=r.getImageData(0,0,14,14).data;if((0,ve.jn)(e,t,n)){r.fillStyle="white";for(let e=0;e<14;e++)for(let t=0;t<14;t++){if(l[a(e,t)+3])continue;const n=l[a(e,t-1)+3],o=l[a(e,t+1)+3],s=l[a(e-1,t)+3],i=l[a(e+1,t)+3],c=l[a(e-1,t-1)+3],h=l[a(e+1,t-1)+3],d=l[a(e-1,t+1)+3],u=l[a(e+1,t+1)+3];(n||o||s||i||c||h||d||u)&&r.fillRect(e,t,1,1)}}l=r.getImageData(0,0,14,14).data,r.fillStyle="black";for(let e=0;e<196;e++)l[4*e+3]||r.fillRect(e%14,e/14|0,1,1);const c=i.toDataURL(),h=document.createElement("img");h.src=c,h.style.cssText="position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        image-rendering: pixelated;\n        width: inherit",ye(`#col${o}`).append(h)}))):ze()}))}function cn(){const e=new _({title:nn((0,O.I)("game settings")),center:!0});if(!e.created)return;let t=We.role===T.ADMIN?20:We.role<T.USER?1:10;const n=sn([[(0,O.I)("show protected"),`<input type="checkbox" id="showProtected" ${u.H6.showProtected?"checked":""}>`],[(0,O.I)("brush size"),`<input type="checkbox" id="customBrushSize" ${X.brushSize>1?"checked":""}>\n            <input id="brushSize" type="range" value="${X.brushSize}" `+(1==X.brushSize?"disabled":"")+' min="2" '+`max="${t}" step="2">`+`<span id="brushSizeCounter">${X.brushSize-1}<span>`],[(0,O.I)("max saved pixels"),`<input id="savePixelsInp" type="number" min="0" value="${X.maxPlaced}" style="width:4rem">`],[(0,O.I)("disable chat colors"),`<input type="checkbox" id="disableChatColors" ${ge.colorsEnabled?"":"checked"}>`],[(0,O.I)("chat messages limit"),`<input type="number" id="chatLimit" value="${u.H6.chatLimit}" title="maximum messages in chat">`],[(0,O.I)("light grid"),`<input type="checkbox" id="lightGridCB" ${Qt.grid.isLight?"checked":""} title="will grid be light?">`],[(0,O.I)("enable grid"),`<input type="checkbox" id="enableGridCB" ${1==Qt.grid.state?"checked":""}>`],[(0,O.I)("draw line length"),`<input type="checkbox" id="drawLineLenCB" ${Qt.line.drawLength?"checked":""} title="draw line length near it">`]]);on(e.body).append(n),on("#showProtected").on("change",(e=>{const t=e.target.checked;u.H6.showProtected=t,Re(t)})),on("#customBrushSize").on("change",(e=>{e.target.checked?(on("#brushSize").removeAttr("disabled"),Te(on("#brushSize").val())):(on("#brushSize").attr("disabled"),Te(1))})),on("#brushSize").on("input",(e=>{Te(e.target.value)})),on("#savePixelsInp").on("change",(e=>{+(e=e.target).value<0&&(e.value=0),X.maxPlaced=+e.value,(0,A.lx)("maxPlaced",X.maxPlaced)})),on("#disableChatColors").on("change",(e=>{const t=e.target.checked;(0,A.lx)("disableColors",t.toString()),ge.setColors(!t)})),on("#chatLimit").on("change",(e=>{const t=parseInt(e.target.value,10);isNaN(t)||t<1||((0,A.lx)("chatLimit",t.toString()),u.H6.chatLimit=t)})),on("#lightGridCB").on("change",(e=>{const t=e.target.checked;(0,A.lx)("lightGrid",t.toString()),Qt.grid.isLight=t})),on("#enableGridCB").on("change",(e=>{const t=e.target.checked;(0,A.lx)("enableGrid",t.toString()),t?Qt.grid.show():Qt.grid.hide()})),on("#drawLineLenCB").on("change",(e=>{const t=e.target.checked;(0,A.lx)("drawLineLen",t.toString()),Qt.line.drawLength=t}))}async function hn(){let e,t=new _({title:(0,O.I)("Captcha"),center:!0,closeable:!1});if(t.created){const[e,n,o]=on(`<div>${(0,O.I)("Case insensitive, 0/o i/l are same")}. <a href="#">${(0,O.I)("Can't recognize?")}</a></div><div class="captchaContainer"></div><input class="fullWidthInput" type="text"></input>`);e.children[0].onclick=hn;const[s]=on(`<div style="display:flex;justify-content:center">${(0,O.I)("Captcha").toUpperCase()}:&nbsp;&nbsp;</div>`);s.appendChild(o),t.body.appendChild(e),t.body.appendChild(n),t.body.appendChild(s),o.addEventListener("keydown",(async e=>{if("Enter"===e.key){if(0==o.value.length)return;let e=o.value;o.value="",await async function(e){const t=await xe("/captcha/solve",{method:"POST",body:{answer:e}}),n=await t.json();return void 0!==n.success&&n.success}(e)?t.close():hn()}}))}else t=t.oldWindow;try{e=await async function(){const e=await xe("/captcha/get");return await e.text()}()}catch(e){return console.error("error downloading captcha image: "+e),D.socket.close(),t.close()}e=e.replace('stroke="black"','stroke="white"'),on(".captchaContainer",t.body).html(e),t.moveToCenter(),on("input",t.body).trigger("focus")}function dn(){const e=new _({title:nn((0,O.I)("tools")),center:!0});if(!e.created)return;const t=[[`<a href="/convert" target="_blank">${(0,O.I)("convert image into palette")}</a>`],[`<button id="screenshot">${(0,O.I)("save canvas")}</button>`]];We.role>=T.MOD&&t.unshift([`<button id="searchUsersB">${(0,O.I)("search users")}</button>`]);const n=sn(t);on(e.body).append(n),on("#searchUsersB",n).on("click",(()=>{const e=new _({title:nn((0,O.I)("search users")),center:!0});if(!e.created)return;const t=sn([[`<input type="text" placeholder="nickname" id="userSearchText" max="32" style="width:250px"> ${(0,O.I)("OR")} <input type="text" placeholder="id" id="userSearchId" max="32" style="width:50px"><input type="checkbox" id="searchIsBanned"><label for="searchIsBanned">${(0,O.I)("banned?")}</label>`],['<div id="searchUsersBody">']]);console.log(t),on(e.body).append(t);const n=on("#userSearchText");function o(e){if(!e||!e.length)return void on("#searchUsersBody").html("");let t=document.createElement("table");t.className="innerTable",t.innerHTML+="<tr><th>NICK</th><th>ID</th><th>ROLE</th><th>&nbsp;</th></tr>";for(let n of e){const e=k(n.name),o=document.createElement("button");o.className="userInfoBtn",o.innerHTML=`<img src="${en}">`,o.addEventListener("click",(async()=>{const e=await xe(`/userInfo?id=${n.id}`),t=await e.json();await xn.CreateWindow(t)}));const s=on(`<tr>\n                        <td>${e}</td><td>${n.id}</td><td>${n.role}</td><td></td>\n                    </tr>`);s[0].lastElementChild.appendChild(o),t.appendChild(s[0])}on("#searchUsersBody").html(t)}async function s(e,t,n){if(!n&&!e&&!t)return;if(e&&t)return;e&&(e=encodeURIComponent(e));const o=await xe(`/admin/users/search?isBanned=${n?1:0}&${t?`id=${t}`:`t=${e}`}`);return await o.json()}on("#userSearchId").on("input",(async e=>{let t=e.target.value.trim();if(t=+t,isNaN(t)||t<1||t>Number.MAX_SAFE_INTEGER)return;const n=on("#searchIsBanned")[0].checked;o(await s(null,t,n))})),on("#userSearchText").on("input",(async e=>{let t=n.val().trim();t=t.slice(0,32);const i=on("#searchIsBanned")[0].checked;o(await s(t,null,i))}))})),on("#screenshot").on("click",Ne)}function un(){const e=new _({title:nn((0,O.I)("LOG IN")),center:!0});if(!e.created)return;const t=sn([[`<a href="/api/auth/vk"><img src="${o}" class="authLogo">VK</a>`],[`<a href="/api/auth/discord"><img src="${s}" class="authLogo">DISCORD</a>`],[`<a href="/api/auth/facebook"><img src="${i}" class="authLogo">FACEBOOK</a>`]]);on("td",t).css("text-align","left"),on("a",t).css("margin-left","15px"),on(e.body).append(t)}function pn(e,t,n=!0){const o=on("<div>");o[0].style.cssText="width: 100%;\n    height: 30px;\n    background-color: #5f5f5f;\n    position: relative;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    user-select: none;\n    cursor: pointer",o.append(`<div style="font-size:20px;text-transform:uppercase;">${e}</div>`);const s=on("<div>");s[0].style.cssText=`position: absolute;\n    top: 50%;\n    transform: translate(0, -50%);\n    left: 5px;\n    background-image: url(${tn});\n    background-size: 100%;\n    background-repeat: no-repeat;\n    transition: transform .2s ease-in-out;\n    width: 20px;\n    height: 20px;`,o.append(s);const i=on("<div>");i[0].style.cssText="max-height: 0;\n    overflow: hidden;\n    transition: max-height 0.3s linear;\n    font-size: 20px;";const r=on("<div>");r[0].style.cssText="padding:8px",r.html(t),i.append(r);const a=on("<div>");a[0].style.cssText="margin-bottom: 1px;",a.append(o,i);let l=0;function c(){l?(s.css("transform","translate(0px, -50%) rotate(0deg)"),i.css("max-height",0)):(s.css("transform","translate(0px, -50%) rotate(180deg)"),i.css("max-height",on(i)[0].scrollHeight)),l=!l}return n||setTimeout(c),o.on("click",c),a}function mn(){const e=new _({title:(0,O.I)("help"),center:!0});if(!e.created)return;e.body.style.width="90vw",e.body.style.height="90vh";const t=pn((0,O.I)("intro.introHeader"),`<div style="width:100%;text-align:center;"><img src="./img/goroxels.png" style="vertical-align: middle;">${(0,O.I)("intro.desc")}</div><br><br>\n    ${(0,O.I)("intro.desc2")}<br>\n    ${(0,O.I)("intro.desc3")}`,!1),n=pn((0,O.I)("how to play?"),`<div style="display:inline-flex">\n            <div>${(0,O.I)("intro.howToPlayDecs")}</div>\n            <div style="padding-left: 10px;">\n                <video autoplay loop muted style="height:196px"><source src="./video/clickerMouse.webm" type="video/webm"></video>\n            </div>\n        </div>`,!1),o=pn((0,O.I)("tools"),`${(0,O.I)("intro.toolsDecs")}<br><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.toolsClicker")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/clicker.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.toolsAS")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/as.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.toolC")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/toolC.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.brush")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/brush2.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.line")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/line.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.flood")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/flood.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.grid")}<br><br></div>\n        <div class="desktop">\n            <img src="./img/unavailable.png" style="height:196px">\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.ctrlZ")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/ctrlZ.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    ${(0,O.I)("intro.resetColors")}<br>`),s=pn((0,O.I)("intro.tools2header"),`<div style="width:100%;text-align:center;"><b>${(0,O.I)("intro.tools2desc")}</b></div><br><br>\n    ${(0,O.I)("intro.toolsHiders")}<br><br>\n    ${(0,O.I)("intro.multicol")}<br>\n    ${(0,O.I)("intro.multicol2")}<br>\n    ${(0,O.I)("intro.multicol3")}<br><br>\n    ${(0,O.I)("intro.sendCoords")}<br><br>\n    ${(0,O.I)("intro.templateTools")}<br>`),i=pn((0,O.I)("template"),`<div style="width:100%;text-align:center;"><b>${(0,O.I)("intro.templateIntro")}</b></div><br><br>\n    ${(0,O.I)("intro.templateDesc")}<br><br>\n    ${(0,O.I)("intro.templateDescConvert")}<br><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,O.I)("intro.templateDescReminder")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/patternDemo.webm" type="video/webm"></video>\n        </div>\n    </div><br>`),r=pn((0,O.I)("intro.authorHeader"),`${(0,O.I)("intro.authorText")}<br>\n        ${(0,O.I)("intro.authorContacts")}<br>\n        <div style="text-align:center"><img src="./img/3rdcf.png" title="ТРЕТЬЯ КОНФА"></div>`);on(e.body).append(t,n,o,s,i,r)}const gn=n.p+"/img/user.svg",fn=n.p+"/img/mod-badge.svg",vn=n.p+"/img/admin-badge.svg";n.p;var wn=n(901);const bn=n(755),yn=bn("#usersTable");class xn{static async CreateWindow(e,t){const n=new _({center:!0,title:`${e.name||(0,O.I)("PLAYER")+" "+(t||e.id)}`});if(e.ip&&e.cc&&"XX"!==e.cc){e._ip=e.ip;const t=e.cc;e.ip+=` [${t}]`,e.ip+=`<img src="${location.protocol}//www.countryflagicons.com/FLAT/16/${t}.png" style="margin-bottom:-5px;margin-left:1px;">`,delete e.cc}if(void 0!==e.role&&We.role===T.ADMIN&&We.id!==e.id){const t=e.role;let n="";Object.keys(T).forEach((e=>{n+=`<option ${e===t?"selected":""}>${e}</option>`})),e.role=`<select type="role">${n}<select>`}let o=Object.keys(e).map((t=>[t,e[t]])),s=[];o=o.filter((e=>!e[0].startsWith("_"))),We.role>=T.MOD&&(s=[['<input class="alertInput">',`<button class="sendAlert">${(0,O.I)("Send Alert")}</button>`],[`<button class="banByIp">${(0,O.I)("Ban by ip")}</button>`]]);let i=o.concat(s);bn(n.body).append(sn(i)),bn("select[type=role]",n.body).on("change",(async t=>{const n=t.target.value,o=e.id,s=await fetch("/api/admin/changerole",{method:"POST",body:JSON.stringify({id:o,role:n}),headers:{"Content-Type":"application/json"}}),i=await s.json();i.errors?i.errors.forEach((e=>{wn.error(e,(0,O.I)("ERROR"))})):wn.success((0,O.I)("Changed role to")+" "+n)})),bn(".sendAlert",n.body).on("click",(()=>{const e=bn(".alertInput",n.body).val();0!=e.length&&(bn(".alertInput",n.body).val(""),D.socket.sendAlert(t,e))})),bn(".banByIp",n.body).on("click",(async()=>{const t=e._ip||e.ip;if(!t)return wn.error((0,O.I)("No ip!"));const n=await xe(`/admin/banPlayer?ip=${t}`);(await n.json()).success&&wn.success((0,O.I)("Success"))}))}constructor(e,t,n,o,s){e||(e="ID "+t),this.name=e,this.id=t,this.userId=n,this.registered=o,this.role=s,this.conns=[t];const i=k(this.name);let r=D.chat.parseColors(i).replace(/<[^>]*>/g,"");const a=this.getRoleBadgeAndTitle();this.element=bn(`<tr class="tableRow">\n                <td title="id ${t}" class="user">\n                    ${a?`<img src="${a.icon}" title="${a.tooltip}" class="roleBadge">`:""}\n                    <button class="userInfoBtn minrole-trusted"><img style="height: 20px" src="${gn}"></button>\n                    <span class="name">${r} </span>\n                    <span class="xConns"></span>\n                </td>\n                <td></td>\n            </tr>`),this.nameEl=bn(".name",this.element),this.coordsEl=bn(this.element.children()[1]),this.nameEl.on("click",(function(){const e=this.innerText;D.elements.chatInput.value+=e+", ",D.elements.chatInput.focus()})),bn(".userInfoBtn",this.element).on("click",(async()=>{const e=this.registered,t=e?this.userId:this.id,n=await fetch(`/api/userInfo?id=${t}${e?"":"&unreg=1"}`),o=await n.json();await xn.CreateWindow(o,this.id)})),this.coordsEl.on("click",(()=>{const[e,t]=this.coordsEl.text().slice(1,-1).split(", ").map((e=>parseInt(e,10)));Number.isInteger(e)&&Number.isInteger(t)&&P.centerOn(e,t)})),yn[0].appendChild(this.element[0]),We.updateRoleRelatedHtml()}getRoleBadgeAndTitle(){if(!this.role)return null;let e,t;switch(this.role){case"MOD":e="mod",t=fn;break;case"ADMIN":e="admin",t=vn;break;default:return null}return{tooltip:e,icon:t}}updateCoords(e,t,n){this.coordsEl.css("color",u._D[e]),this.coordsEl.text(`(${t}, ${n})`)}close(e){this.conns.splice(this.conns.indexOf(e),1),0===this.conns.length?this.destroy():this.updateX(),delete D.users[e]}destroy(){this.element.remove()}newConnection(e){this.conns.push(e),this.updateX()}updateX(){const e=this.conns.length>1?`[x${this.conns.length}]`:"";bn(".xConns",this.element).text(e)}}var kn=n(901);class Cn extends(a()){constructor(e){super();const t=location.protocol.startsWith("https")?"wss":"ws",n=location.hostname||"localhost";this.url=`${t}://${n}:${e}`,this.pendingPixels={},this.connectedOnce=!1,this.connect()}get connected(){return this.socket&&this.socket.readyState===WebSocket.OPEN}connect(){this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.sendChatSubscribe(u.Dv,this.connectedOnce),this.sendCanvas(u.X1),this.emit("opened"),console.log("Socket has been connected"),this.connectedOnce||(this.connectedOnce=!0)},this.socket.onmessage=this.onmessage.bind(this),this.socket.onclose=()=>{this.emit("closed"),Object.values(D.users).forEach((e=>e.close(e.id))),setTimeout((()=>{console.log("reconnect"),this.reconnect()}),5e3*Math.random())}}close(){this.socket.close()}reconnect(){this.socket.onmessage=null,this.socket.onopen=null,this.socket.onclose=null,this.connect()}onmessage({data:e}){if("string"==typeof e)this.onStringMessage(e);else{if(!e.byteLength)return;this.onBinaryMessage(e)}}onStringMessage(e){let t;try{t=JSON.parse(e)}catch(t){return void console.log("onStringMessage message decoding error: "+t,"message: "+e)}switch(t.c){case"u":{const{nick:e,userId:n,id:o,registered:s,role:i}=t;let r;e&&(r=Object.values(D.users).find((t=>t.name===e))),r?(D.users[o]=r,r.newConnection(o)):D.users[o]=new xn(e,o,n,s,i);break}case"l":{const e=t.id;D.users[e]&&D.users[e].close(e);break}case"e":t.errors.forEach((e=>{"error.captcha"===e&&(_.Exists("Captcha")||hn()),kn.error(e,(0,O.I)("Error from the Socket:"),{preventDuplicates:!0})}));break;case"c":ge.addMessage(t);break;case"a":kn.info(t.msg,"ALERT",{timeOut:3e5,extendedTimeOut:3e5});break;case"m":X.id=t.id;break;case"r":location.reload();break;case"rc":D.chunkManager.reloadChunks()}}onBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case 5:hn();break;case 0:{const e=t.getUint8(1),n=t.getUint8(2),o=c().inflate(t.buffer.slice(3));this.emit("chunk",e,n,o);break}case 1:{const[e,n,o]=d(t.getUint32(1)),s=t.getUint32(5);this.onIncomingPixel([e,n,o],s);break}case 2:{const e=t.getUint16(1);this.emit("online",e);break}case 4:{const e=!!t.getUint8(1),n=t.getUint32(2,!1);let o,s,i;for(let r=6;r<t.byteLength;r+=4)[o,s,i]=d(t.getUint32(r)),e?this.emit("protect",o,s,i):this.emit("place",o,s,i,n);const r=D.users[n];r&&r.updateCoords(i,o,s);break}case 6:this.socket.send(new Uint8Array([6]));break;case 7:{const e=8;(t.byteLength-1)/e%1!=0&&console.warn("TotalPixels length is not integer");for(let n=1;n<t.byteLength;n+=e){const e=t.getUint32(n),o=t.getUint32(n+4),s=d(e);this.onIncomingPixel(s,o)}break}}}onIncomingPixel([e,t,n],o){const s=D.users[o];s&&s.updateCoords(n,e,t);const i=e+","+t;let r=this.pendingPixels[i];r&&(clearTimeout(r),delete this.pendingPixels[i]),this.emit("place",e,t,n,o),o===X.id&&Oe(X.placedCount++)}requestChunk(e,t){let n=new DataView(new ArrayBuffer(3));n.setUint8(0,0),n.setUint8(1,e),n.setUint8(2,t),this.socket.send(n.buffer)}sendPixel(e,t,n){let o=new DataView(new ArrayBuffer(5));o.setUint8(0,1),o.setUint32(1,h(0|e,0|t,n)),this.socket.send(o.buffer)}sendPixels(e,t=!1){let n=new DataView(new ArrayBuffer(6+4*e.length));n.setUint8(0,4),n.setUint8(1,t?1:0);for(let t=0;t<e.length;t++){let o=4*t+6;const[s,i,r]=e[t],a=h(s,i,r);n.setUint32(o,a)}this.socket.send(n.buffer)}sendCanvas(e){const t=new DataView(new ArrayBuffer(2));t.setUint8(0,3),t.setUint8(1,e),this.socket.send(t.buffer)}sendChatSubscribe(e,t){const n={c:"s",ch:e,reconnect:t};this.socket.send(JSON.stringify(n))}sendChatMessage(e,t,n=!1){const o={c:"c",msg:e,ch:t};n&&(o.whisper=n),this.socket.send(JSON.stringify(o))}sendChatWhisper(e,t,n){return this.sendChatMessage(e,t,n)}sendAlert(e,t){const n={c:"a",to:e,msg:t};this.socket.send(JSON.stringify(n))}}class En{constructor(){this.chunks=new Map,this.loadingChunks=new Set,D.socket.on("chunk",((e,t,n)=>{let o=this.getChunkKey(e,t);this.loadingChunks.has(o)&&this.loadingChunks.delete(o);let s=new we(e,t,n);this.chunks.set(o,s),D.renderer.needRender=!0})),D.socket.on("place",((e,t,n)=>{this.setChunkPixel(e,t,n),D.renderer.needRender=!0})),D.socket.on("protect",((e,t,n)=>{this.setProtect(e,t,n),D.renderer.needRender=!0}))}getChunkKey(e,t){return e<<4|t}reloadChunks(){this.test=!0;let e=[...this.chunks.values()];const t=setInterval((()=>{if(this.loadingChunks.size<3){const n=e.pop();if(!n)return clearInterval(t);this.loadChunk(n.x,n.y)}}),30)}loadChunk(e,t){let n=this.getChunkKey(e,t);D.socket.connected&&!this.loadingChunks.has(n)&&this.loadingChunks.size<3&&(D.socket.requestChunk(e,t),this.loadingChunks.add(n))}hasChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)}getChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)?this.chunks.get(n):0}getChunkPixel(e,t){let[n,o,s,i]=q(e,t),r=this.getChunk(n,o);if(!r||e<0||t<0)return-1;let a=r.get(s,i);return u.Xv[a]}setChunkPixel(e,t,n){let[o,s,i,r]=q(e,t),a=this.getChunkKey(o,s);this.chunks.has(a)&&this.chunks.get(a).set(i,r,u.W7[n])}setProtect(e,t,n){let[o,s,i,r]=q(e,t),a=this.getChunkKey(o,s);this.chunks.has(a)&&this.chunks.get(a).setProtect(i,r,n)}getProtect(e,t){let[n,o,s,i]=q(e,t),r=this.getChunk(n,o);return r?r.getProtect(s,i):-1}dumpAll(){const e=document.createElement("canvas");e.width=u.w_,e.height=u.G6;const t=e.getContext("2d");return this.chunks.forEach((e=>{if(!e.canvas)return;const n=e.x*u.$t,o=e.y*u.$t;t.drawImage(e.canvas,n,o)})),e}}const In=n.p+"/img/chunkPlaceholder.png";class Dn{constructor(e){this.url=e,this.loaded=!1,this.canvas=null,this._load()}_load(){const e=document.createElement("canvas"),t=new Image;t.src=this.url,t.onload=()=>{e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),this.canvas=e,this.loaded=!0,this.onload()}}onload(){}}const An=b();class Rn{constructor(e){this.ctx=e,this.canvas=this.ctx.canvas,this.chunkPlaceholderPattern=new Dn(In),this.chunkPlaceholderPattern.onload=()=>{this.needRender=!0},this.needRender=!0,this.preRendered={brush:{canvas:void 0,ctx:void 0,imageData:void 0,circle:void 0}},this.preRender()}preRender(){this.preRenderBrush()}preRenderBrush(){const e=X.brushSize,t=P.zoom;if(t<1)return;const n=document.createElement("canvas");n.width=n.height=t*(e+1);const o=n.getContext("2d"),s=(o.getImageData(0,0,n.width,n.height).data,e/2),i=Xe.filledCircle(0,0,s);let r=[];for(let t=0;t<e+1;t++)r.push(new Array(e+1).fill(0));i.forEach((([e,t])=>{r[e+s][t+s]=1})),o.beginPath(),o.lineWidth=t/4,o.strokeStyle=u._D[X.color],o.lineCap="square",o.fillStyle="blue";for(let n=0;n<e;n++)for(let s=0;s<e;s++){if(a(n,s))continue;let e=a(n,s-1),i=a(n-1,s),r=a(n+1,s),l=a(n,s+1);e&&(o.moveTo(n*t,s*t),o.lineTo((n+1)*t,s*t)),i&&(o.moveTo(n*t,s*t),o.lineTo(n*t,(s+1)*t)),r&&(o.moveTo((n+1)*t,s*t),o.lineTo((n+1)*t,(s+1)*t)),l&&(o.moveTo((n+1)*t,(s+1)*t),o.lineTo(n*t,(s+1)*t))}function a(t,n){return t<0||t>=e||n<0||n>=e||!r[t][n]}o.stroke(),o.closePath(),this.preRendered.brush.canvas=n,this.preRendered.brush.ctx=n,this.preRendered.brush.imageData=n,this.preRendered.brush.circle=i}requestRender(){this.needRender&&(this.needRender=!1,this.render()),D.fxRenderer.render()}correctSmoothing(){An||(P.zoom<1?(this.ctx.imageSmoothingEnabled=!0,this.ctx.canvas.style.imageRendering="auto"):(this.ctx.imageSmoothingEnabled=!1,this.ctx.canvas.style.imageRendering="pixelated"))}render(){this.correctSmoothing();let e=function(){let[e,t]=J(0,0),[n,o]=J(window.innerWidth,window.innerHeight),s=e/u.$t|0,i=n/u.$t+1|0,r=t/u.$t|0,a=o/u.$t+1|0,l=[];for(let e=Math.max(s,0);e<Math.min(i,u.rT);e++)for(let t=Math.max(r,0);t<Math.min(a,u.El);t++)l.push([e,t]);return l}();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);let t=P.x+w[0]-(this.canvas.width>>1)/P.zoom,n=P.y+w[1]-(this.canvas.height>>1)/P.zoom,o=P.zoom;1===o&&(t=Math.floor(t),n=Math.floor(n)),this.ctx.save(),this.ctx.scale(o,o),this.ctx.translate(-t,-n),e.forEach((e=>{let[t,n]=e,o=t*u.$t,s=n*u.$t;if(!D.chunkManager.hasChunk(t,n))return D.chunkManager.loadChunk(t,n),void(this.chunkPlaceholderPattern.loaded&&this.ctx.drawImage(this.chunkPlaceholderPattern.canvas,o,s,u.$t,u.$t));const i=D.chunkManager.getChunk(t,n);i.render(),this.ctx.drawImage(i.ctx.canvas,o,s)})),this.ctx.restore(),ce.render()}}var Sn=n(755),Mn=n(901);const Ln=D.elements.coords;function Pn(e,t){let[n,o]=J(e,t);n===X.x&&o===X.y||(X.x=n,X.y=o,Ln.innerText=`(${X.x}, ${X.y})`,-1!=X.color&&P.zoom>1&&(D.renderer.needRender=!0))}const Tn=b();class Fn extends(a()){constructor(){super(),this.tools=Qt,this.tool=Qt.mover,this._keyBinds={},this._colorBinds={},this.activeTools={},this.addTools(),this.loadBinds(),this.initEvents(),this.ctrlDown=!1,this.altDown=!1,We.callOnLoaded(this.filterTools.bind(this))}filterTools(){Object.keys(this.tools).forEach((e=>{this.tools[e].requiredRole>We.role&&(delete this._keyBinds[this.tools[e].key],Tn&&Sn(`#tool_${e}`).remove())}))}addTools(){const e=document.getElementById("tools");Object.keys(this.tools).forEach((t=>{const n=this.tools[t];if(Tn){if(!n.icon)return;let o=document.createElement("div");o.classList="toolContainer",o.id=`tool_${t}`;let s=document.createElement("img");function i(){let e=document.getElementsByClassName("toolContainer selected")[0];e&&(e.className="toolContainer"),o.classList=["toolContainer selected"],this.tool=n}s.className="toolIcon",s.src=n.icon,o.appendChild(s),e.appendChild(o),o.addEventListener("pointerdown",i.bind(this)),"mover"===n.name&&i.apply(this)}else X&&(this._keyBinds[n.key]=n)}))}initEvents(){let e=D.eventManager;function t(e){this.ctrlDown=e.ctrlKey,this.altDown=e.altKey}Tn?(e.on("zoom",(e=>{P.zoom*=e+1,P.checkZoom(),D.renderer.needRender=!0,D.fxRenderer.needRender=!0})),e.on("mousedown",(e=>{Pn(e.clientX,e.clientY)})),e.on("mousemove",(e=>{Pn(e.clientX,e.clientY)})),[["mousedown","down"],["mousemove","move"],["mouseup","up"]].forEach((t=>{const[n,o]=t;e.on(n,(e=>{let t=this.tool;e&&e.gesture&&(this.tool.emit("_gesture"),t=this.tools.mover),t&&(t.emit(o,e),this.emit(o,e))}))}))):(e.on("mousedown",(e=>{this.tools.mover.emit("down",e)})),e.on("mouseup",(e=>{2===e.button&&(X.switchColor(-1),X.switchSecondColor(-1)),this.tools.mover.emit("up",e)})),e.on("mousemove",(e=>{(0===e.buttons||P.noMoving)&&Pn(e.clientX,e.clientY),this.tool.emit("move",e),this.emit("move",e)})),e.on("keydown",(e=>{let t=x(e);if(!t)return;const n=this._keyBinds[t];n&&(this.tool=n,n.emit("down",e))})),e.on("keyup",(e=>{let t=x(e);if(!t)return;const n=this._keyBinds[t];for(let t of Object.keys(this.tools)){const o=this.tools[t];o.key&&o!==n&&(y(o.key).code===e.code&&o.emit("up",e))}n&&(e.preventDefault(),e.stopPropagation(),n.emit("up",e))})),e.on("wheel",(e=>{const t=P.zoom;P.zoomTo(e.deltaY);const n=e.clientX-window.innerWidth/2,o=e.clientY-window.innerHeight/2;P.moveTo(n/t,o/t),P.moveTo(-n/P.zoom,-o/P.zoom),"yes"===localStorage.getItem("iHaveProblems")&&(P.x=Math.round(P.x),P.y=Math.round(P.y),D.renderer.needRender=!0)}))),e.on("keydown",t.bind(this)),e.on("keyup",t.bind(this)),e.on("tick",(e=>{Object.keys(this.tools).forEach((t=>{const n=this.tools[t];n.listenerCount("tick")>0&&n.emit("tick",e)}))}))}changeKey(e,t){const n=e.key;delete this._keyBinds[n],e.key=t,this._keyBinds[t]=e}loadBinds(){const e=(0,A.TA)("keyBinds");let t,n;try{if(t=JSON.parse(e),!t)return}catch{return Mn.error("Error on parsing key binds from local storage"),void localStorage.removeItem("keyBinds")}for(let e of Object.keys(t))(n=this.findByName(e))&&this.changeKey(this.tools[n],t[e])}findByName(e){return Object.keys(this.tools).find((t=>this.tools[t].name===e))}initColorBinds(){}loadColorBinds(){}}var On=n(755);(async()=>{await u.LR();const{elements:e}=D;window.onresize=()=>{e.mainCanvas.width=window.innerWidth,e.mainCanvas.height=window.innerHeight,e.fxCanvas.width=window.innerWidth,e.fxCanvas.height=window.innerHeight,t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=!1,i.needRender=!0,D.mobile||function(){const e=v(".column",D.elements.topMenuContent),t=window.innerWidth/e.length;v(".column",D.elements.topMenuContent).css("width",t)}(),Be(),Ue()},window.oncontextmenu=function(e){e.target!==D.elements.mainCanvas&&"paletteColor"!==e.target.classList[0]&&"paletteColor"!==e.path[1].classList[0]||e.preventDefault()},P.init(),w=[u.w_/2,u.G6/2],u.DG.forEach(((t,n)=>{const o=document.createElement("div");o.style.backgroundColor=`rgb(${t.join(",")})`,o.classList=["paletteColor light"],o.id="col"+n;let s=0;var i=On(o);i.on("pointerdown",(()=>{s=Date.now()})),i.on("pointerleave",(()=>{s=0})),o.onclick=e=>{let t=!1;0!=s&&(Date.now()-s>700&&(t=!0),s=0),(t?X.switchSecondColor:X.switchColor).call(X,n)},o.oncontextmenu=()=>{X.switchSecondColor(n)},e.palette.appendChild(o)}));const t=e.mainCanvas.getContext("2d");t.imageSmoothingEnabled=!1;const n="https:"===location.protocol?443:location.port||80,o=new Cn(n);D.socket=o;const s=new En;D.chunkManager=s;const i=window.renderer=new Rn(t);D.renderer=i;const r=new qe;D.fxRenderer=r,D.toolManager=new Fn(document.getElementById("board")),D.player=X;const a=()=>{requestAnimationFrame((()=>{i.requestRender(),a()}))};a(),window.onresize(),o.on("opened",(()=>{})),o.on("online",(e=>{On(".online").text(e)})),o.on("closed",(()=>{On(".online").text("offline")})),window.globals=D,u.F_((()=>{if("nsfw"!==u.Dv)return;if("accepted"==(0,A.TA)("modal18"))return;const e=new j,t=On(`<div style="margin:0;padding:5px;text-align:center;">\n                <h1>${(0,O.I)("WARNING")}</h1>\n                <p>${(0,O.I)("This canvas may contain illustrations, inappropriate for people under age of 18, including:")}\n                <br>${(0,O.I)("Gore, furry, porn, hate, anime and all possible variations of these.")}</p>\n                <p><b>${(0,O.I)("Are you 18 y.o. and fully understanding what are you doing?")}</b></p>\n                <button style="padding: 8px;">${(0,O.I)("I am 18 years old and I take responsibility for my psyche on myself")}</button>\n            </div>`);e.contEl.appendChild(t[0]),On("button",t).on("click",(()=>{e.close(),(0,A.lx)("modal18","accepted")}))})),ke(),(0,O.S)(),function(){const e=(0,A.CJ)("template.url","https://i.imgur.com/4GQIMQ7.png",!0);Q.val(e);const t=(0,A.CJ)("template.x",0,!0);ee.val(parseInt(t,10));const n=(0,A.CJ)("template.y",0,!0);te.val(parseInt(n,10));const o=(0,A.CJ)("template.opac",.5,!0);ne.val(parseFloat(o))}(),Q.on("input",Ee),ee.on("input",Ee),te.on("input",Ee),ne.on("input",Ee),Ee(),ye("#accountSettings").on("click",rn),ye("#toolBinds").on("click",an),ye("#uiSettings").on("click",ln),ye("#canvasSettings").on("click",cn),ye("#toolsB").on("click",dn),ye(".authBtn").on("click",un),ye(document).on("keydown",(e=>{if("Enter"===e.key)if(ye("#chatInput").is(":focus")||D.mobile){const e=se.val();if(!e.length)return se.trigger("blur");se.val(""),ge.handleMessage(e)}else ye("#chatInput").trigger("focus")})),function(){function e(){document.documentElement.style.setProperty("--gorox-chat-height",ye(window).height()+"px")}ye(window).on("resize",e),e()}(),ye(document).on("mousedown",(e=>{if(!e.ctrlKey)return;e.stopPropagation(),e.preventDefault();let t=J(e.clientX,e.clientY).map((e=>0|e));function n(e){e.stopPropagation(),e.preventDefault();const n=J(e.clientX,e.clientY);n[0]|=0,n[1]|=0;let[o,s]=n;o===t[0]&&s===t[1]||(ee.val(ce.x-=t[0]-o),te.val(ce.y-=t[1]-s),ce.render(),t=n,Ce())}ye(document).on("mousemove",n),ye(document).one("mouseup mouseleave",(()=>{ye(document).off("mousemove",n)}))})),ye("#modMenu .title").on("click",(e=>{const t=ye("#modMenu");"open"===t.data("state")?(t.data("state","close"),t.css("right","")):(t.data("state","open"),t.css("right",ye("#modMenu .body").css("width")))})),ye("#sendAlerts").on("click",(()=>{const e=ye("#sendAlertsText").val();0==e.length||e.length>2e3||(ye("#sendAlertsText").val(""),D.socket.sendAlert("all",e))})),ye(".showMenu,.hideMenu").on("click",Ae),Be(),Le(1!=(0,A.TA)("hideEmojis")),Pe((0,A.CJ)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐").split(" ")),Fe(!+(0,A.CJ)("hidePlaced",1)),Oe((0,A.TA)("placedCount",!0)),ye(".showChat").on("click",(()=>{ye(".showChat").removeClass("showChat-notify"),ge.mobileShow()})),ye("#hideChat").on("click",(()=>{ye(".showChat").removeClass("showChat-notify"),ge.mobileHide()})),ye(".helpBtn").on("click",(()=>{mn()})),X.init(),D.elements.coords.addEventListener("click",(function(){D.elements.chatInput.value+=this.innerText,D.elements.chatInput.focus()})),ye("#onlineColumn .columnHeader").on("click",(async()=>{let e;try{const t=await fetch("/api/online");e=await t.json()}catch(e){return void be.error(e)}!function(e){let t=new _({title:nn((0,O.I)("online")),center:!0,closeable:!0});t.created||(t=t.oldWindow),t.body.style.width="325px",t.moveToCenter();const n=[];Object.keys(e).forEach((o=>{if("TOTAL"===o)return void t.updateTitle((0,O.I)("online")+` (${e[o]})`,!0);const s=`<a href="/${o}" target="_shagorox"><h3>${o}<h3></a>`,i=`<h2>${e[o]}</h2>`;n.push([s,i])}));const o=sn(n);on("*",t.body).remove(),on(t.body).append(o)}(e)})),function(){const e=ye("#menuResizer"),t=ye("#resizingStripes");let n,o=+(0,A.TA)("columnHeight");isNaN(o)||0==o?o=123:o<0?o=0:o>=window.screen.height-250&&(o=window.screen.height-250),ye(".columnContent").css("height",o);let s=!1;function i(){e.css("height","7px"),e.css("background-color","#4c4c4c"),t.css("opacity","1")}function r(){clearTimeout(n),e.css("height",""),e.css("background-color",""),t.css("opacity","")}e.on("mouseover",(()=>{clearTimeout(n),n=setTimeout((()=>{i()}),500)})),e.on("mouseout",(()=>{s||r()})),e.on("mousedown",(function(){function e(e){o+=e.originalEvent.movementY,ye(".columnContent").css("height",o),(0,A.lx)("columnHeight",o)}s=!0,i(),ye(document).on("mousemove",e),ye(document).one("mouseup",(function(){ye(document).off("mousemove",e),s=!1,r()}))}))}(),(0,A.TA)("helpShown")||((0,A.lx)("helpShown","1"),mn())})()},815:(e,t,n)=>{"use strict";function o(e,t,n){return 4278190080|n<<16|t<<8|e}function s(e){return e.toString(16).padStart(2,"0")}function i(e){return"#"+s(e[0])+s(e[1])+s(e[2])}function r(e,t){let n=-1,o=768;for(let s=0;s<t.length;s++){const i=t[s];let r=Math.abs(e[0]-i[0])+Math.abs(e[1]-i[1])+Math.abs(e[2]-i[2]);if(r<o&&(o=r,n=s),0==r)break}return n}function a(e,t,n){return 1-(.299*e+.587*t+.114*n)/255>.5}n.d(t,{CO:()=>i,jn:()=>a,xP:()=>o,xV:()=>r})},226:(e,t,n)=>{"use strict";n.d(t,{CJ:()=>s,TA:()=>i,lx:()=>r});var o=n(914);function s(e,t,n=!1){return n&&(e=o.Dv+"."+e),localStorage.getItem(e)||t}function i(e,t=!1){return t&&(e=o.Dv+"."+e),localStorage.getItem(e)}function r(e,t,n=!1){return n&&(e=o.Dv+"."+e),localStorage.setItem(e,t)}}},n={};function o(e){var s=n[e];if(void 0!==s)return s.exports;var i=n[e]={exports:{}};return t[e].call(i.exports,i,i.exports,o),i.exports}o.m=t,o.amdD=function(){throw new Error("define cannot be used indirect")},e=[],o.O=(t,n,s,i)=>{if(!n){var r=1/0;for(h=0;h<e.length;h++){for(var[n,s,i]=e[h],a=!0,l=0;l<n.length;l++)(!1&i||r>=i)&&Object.keys(o.O).every((e=>o.O[e](n[l])))?n.splice(l--,1):(a=!1,i<r&&(r=i));if(a){e.splice(h--,1);var c=s();void 0!==c&&(t=c)}}return t}i=i||0;for(var h=e.length;h>0&&e[h-1][2]>i;h--)e[h]=e[h-1];e[h]=[n,s,i]},o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.p=".",(()=>{var e={757:0};o.O.j=t=>0===e[t];var t=(t,n)=>{var s,i,[r,a,l]=n,c=0;if(r.some((t=>0!==e[t]))){for(s in a)o.o(a,s)&&(o.m[s]=a[s]);if(l)var h=l(o)}for(t&&t(n);c<r.length;c++)i=r[c],o.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return o.O(h)},n=self.webpackChunkgoroxels_client=self.webpackChunkgoroxels_client||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var s=o.O(void 0,[216,163],(()=>o(799)));s=o.O(s)})();