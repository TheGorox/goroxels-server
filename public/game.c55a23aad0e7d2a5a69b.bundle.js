(()=>{var e,t={9491:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/jimbo.png"},4805:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/ny24.png"},9064:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/pepe.png"},3236:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/pony.png"},4555:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/scream.png"},4972:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/star.png"},5564:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/umum.png"},3335:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/yoba.png"},4936:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/z.png"},5273:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/01.06.20.png"},3929:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/02.05.22.png"},1606:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/03.04.23.png"},6003:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/03.06.19.png"},1006:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/09.04.18.png"},3819:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/09.08.19.png"},886:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/10.07.17.png"},250:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/16.08.25.png"},8363:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/18.11.19.png"},8747:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/22.08.18.png"},253:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/22.11.18.png"},4163:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/25.02.19.png"},9044:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/26.02.20.png"},8648:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/26.10.23.png"},5413:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/bg.png"},8163:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/bg2.png"},9674:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/digits.png"},146:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/enableRadioBtn.png"},4175:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/hr-slider-btn-small.png"},5748:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});const s=n.p+"/img/slider-btn.png"},2924:(e,t,n)=>{var s={"./jimbo.png":9491,"./ny24.png":4805,"./pepe.png":9064,"./pony.png":3236,"./scream.png":4555,"./star.png":4972,"./umum.png":5564,"./yoba.png":3335,"./z.png":4936};function i(e){var t=o(e);return n(t)}function o(e){if(!n.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=o,e.exports=i,i.id=2924},5390:(e,t,n)=>{var s={"./01.06.20.png":5273,"./02.05.22.png":3929,"./03.04.23.png":1606,"./03.06.19.png":6003,"./09.04.18.png":1006,"./09.08.19.png":3819,"./10.07.17.png":886,"./16.08.25.png":250,"./18.11.19.png":8363,"./22.08.18.png":8747,"./22.11.18.png":253,"./25.02.19.png":4163,"./26.02.20.png":9044,"./26.10.23.png":8648};function i(e){var t=o(e);return n(t)}function o(e){if(!n.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=o,e.exports=i,i.id=5390},4536:(e,t,n)=>{var s={"./bg.png":5413,"./bg2.png":8163,"./digits.png":9674,"./enableRadioBtn.png":146,"./hr-slider-btn-small.png":4175,"./slider-btn.png":5748};function i(e){var t=o(e);return n(t)}function o(e){if(!n.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=o,e.exports=i,i.id=4536},1962:(e,t,n)=>{"use strict";n.d(t,{Av:()=>p,Ft:()=>u,GC:()=>C,K2:()=>f,LO:()=>v,MF:()=>d,OE:()=>a,OP:()=>r,RG:()=>y,TK:()=>b,Uf:()=>h,Wr:()=>g,ZL:()=>l,h:()=>c,iO:()=>x,k6:()=>E,p4:()=>m});var s=n(3603),i=n(3614),o=n(7959);let a,r,l,c,h,d,u,m,p,g,f,w=!1;const v={chatLimit:parseInt((0,i.Fh)("chatLimit",100),10),showProtected:!1};let b={};async function y(){let e;try{e=await async function(){const e=await fetch("/config.json");return await e.json()}()}catch(e){o.error("Failed to load config from server. Try to reload the page")}const t=document.location.pathname.replace(/[^\d^\w]/g,"");let n=e.canvases.findIndex((e=>e.name===t));a=-1===n?0:n;let i=e.canvases[a];r=i.name,l=i.chunkSize,c=i.boardWidth*l,h=i.boardHeight*l,d=i.palette,u=new Uint32Array(d.map((e=>(0,s.iG)(...e)))),m=d.map(s.v2),p=i.boardWidth,g=i.boardHeight,f=i.cooldown,Array.from(u.values()).forEach(((e,t)=>b[e]=t)),w=!0,k.forEach((e=>e())),k=[]}let k=[];function x(e){if(w)return e();k.push(e)}async function C(){return w?void 0:new Promise((e=>{const t=setInterval((()=>{w&&(clearInterval(t),e())}),10)}))}function E(e=!0){v.showProtected=e,globals.chunkManager.chunks.forEach((e=>{e.needRender=!0})),globals.renderer.needRender=!0}},7322:(e,t,n)=>{"use strict";const s=n.p+"/img/vk-logo.svg",i=n.p+"/img/discord-logo-circle.svg",o=n.p+"/img/gg-logo.svg";n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p;var a=n(7007),r=n.n(a),l=n(1668),c=n.n(l);var h=n(1962),d=n(2617),u=n.n(d);function m(){return"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName}class p extends(r()){constructor(e){function t(e){let t=this.startedGesture;return"up"===e?(this.pointers=Math.max(this.pointers-1,0),0==this.pointers&&(this.startedGesture=!1)):"down"===e&&++this.pointers>=2&&(t=this.startedGesture=!0),t}super(),this.el=e,this._zoomed=!1,this.startedGesture=!1,this.pointers=0,t=t.bind(this);let n={};e.addEventListener("pointerdown",(e=>{e.gesture=t("down"),this.emit("mousedown",e)})),document.addEventListener("pointermove",(e=>{{Object.defineProperty(e,"movementX",{writable:!0}),Object.defineProperty(e,"movementY",{writable:!0});let t=n[e.pointerId];t?(e.movementX=e.clientX-t[0],e.movementY=e.clientY-t[1]):(e.movementX=0,e.movementY=0),n[e.pointerId]=[e.clientX,e.clientY]}t("move")||this.emit("mousemove",e)})),document.addEventListener("pointerup",(e=>{let s=this.pointers;e.gesture=t("up"),s&&this.emit("mouseup",e),delete n[e.pointerId]})),u()(e).gesturable({onmove:e=>{this.emit("zoom",e.ds),this.emit("mousemove",{buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,movementX:e.dx*devicePixelRatio,movementY:e.dy*devicePixelRatio,gesture:!0})}}),this.tickLoop=setInterval((()=>{this.emit("tick")}),1e3/60),document.addEventListener("keydown",(e=>{m()||this.emit("keydown",e)})),document.addEventListener("keyup",(e=>{m()||this.emit("keyup",e)})),e.addEventListener("wheel",(e=>this.emit("wheel",e))),e.addEventListener("mouseleave",(e=>this.emit("mouseleave",e)))}}var g=n(4692);let f=[null,null];function w(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e}function v(e){let t={alt:!1,ctrl:!1,code:null};return e.split("+").forEach((e=>{"CTRL"===e?t.ctrl=!0:"ALT"===e?t.alt=!0:t.code=e})),t}function b(e){let t;if(e instanceof PointerEvent||e instanceof MouseEvent)switch(e.button){case 0:t="LMB";break;case 1:t="MMB";break;case 2:t="RMB";break;case 3:t="4MB";break;case 4:t="5MB"}else t=e.code;return t}function y(e){let t=b(e),n="";return e.altKey&&(n+="ALT+"),e.ctrlKey&&(n+="CTRL+"),n+t}function k(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function x(){if(L.mobile)return 24;const e=g("#palette");let t=Math.floor((window.innerWidth-14)/e.children().length);return t=Math.min(t,30),t}function C(e,t,n,s,i){let o,a,r=0;for(o=0,a=e-1;o<e;a=o++)n[o]>i!=n[a]>i&&s<(t[a]-t[o])*(i-n[o])/(n[a]-n[o])+t[o]&&(r=!r);return r}function E(e,t,n){const s=document.createElement("canvas"),i=s.getContext("2d");s.width=t,s.height=n,i.imageSmoothingEnabled=!1,i.drawImage(e,0,0,t,n);const o=document.createElement("canvas");o.width=t,o.height=n;const a=o.getContext("2d");return a.imageSmoothingEnabled=!1,a.drawImage(s,0,0,t,n),o}function R(e){return new Promise(((t,n)=>{const s=new Image;s.src=e,s.onerror=n,s.onload=()=>t(s)}))}function I(e){let t=setInterval((()=>{o()}),100);const n=document.createElement("canvas"),s=n.getContext("2d");function i(){n.width=window.innerWidth,n.height=window.innerHeight,o()}function o(){s.clearRect(0,0,n.width,n.height),s.fillStyle="black",s.globalAlpha=.8,s.fillRect(0,0,n.width,n.height);const t=e.getBoundingClientRect();s.clearRect(t.x,t.y,t.width,t.height)}return n.style.cssText="position: absolute;\n        z-index: 999",window.addEventListener("resize",i),i(),document.body.appendChild(n),function(){clearInterval(t),window.removeEventListener("resize",i),n.remove()}}function S(){const e=L.chunkManager.dumpAll(),t=document.createElement("a");t.download=`GX ${h.OP} ${function(){const e=new Date;return`${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}.${e.getFullYear()} - ${e.getHours().toString().padStart(2,"0")}-${e.getMinutes().toString().padStart(2,"0")}-${e.getSeconds().toString().padStart(2,"0")}`}()}.png`,t.href=e.toDataURL(),t.click()}var P=n(4692);const L={socket:null,chunkManager:null,renderer:null,fxRenderer:null,player:null,toolManager:null,events:new(r()),eventManager:new p(document.getElementById("board")),mainCtx:document.getElementById("board").getContext("2d"),fxCtx:document.getElementById("fx").getContext("2d"),mobile:w(),users:{},elements:{mainCanvas:P("#board")[0],fxCanvas:P("#fx")[0],palette:P("#palette")[0],online:P("#onlineCounter")[0],coords:P("#coords")[0],topMenu:P("#topMenu")[0],topMenuContent:P("#topMenu>.content")[0],chatInput:P("#chatInput")[0]},lockInputs:!1};var M=n(3614);const A={x:null,y:null,zoom:null,minX:null,minY:null,maxX:null,maxY:null,minZoom:.1,maxZoom:64,noMoving:!1,init(){Object.assign(this,{x:+(0,M.Fh)("posX",0,!0),y:+(0,M.Fh)("posY",0,!0),zoom:+(0,M.Fh)("zoom",1,!0),minX:-h.h/2,minY:-h.Uf/2,maxX:h.h/2,maxY:h.Uf/2}),(isNaN(this.x)||isNaN(this.y)||isNaN(this.zoom))&&(this.x=0,this.y=0,this.zoom=1)},centerOn(e,t){L.renderer.needRender=!0,this.noMoving||(this.x=e-this.maxX,this.y=t-this.maxY,this.clampPos())},moveTo(e,t){L.renderer.needRender=!0,this.noMoving||(this.x+=e,this.y+=t,this.clampPos())},clampPos(){this.x=Math.min(Math.max(this.x,this.minX),this.maxX),this.y=Math.min(Math.max(this.y,this.minY),this.maxY)},zoomTo(e){this.zoom=e<0?2*this.zoom|0||1:this.zoom/2,this.checkZoom(),this.emit("zoom",this.zoom),L.renderer.needRender=!0,L.fxRenderer.needRender=!0,L.renderer.preRender()},checkZoom(){this.zoom=Math.min(Math.max(this.zoom,this.minZoom),this.maxZoom)},disableMove(){this.noMoving=!0},enableMove(){this.noMoving=!1},__proto__:new(r())};let B,D,T;setInterval((()=>{const e=A.x,t=A.y,n=A.zoom;B!=e&&(0,M.UW)("posX",e,!0),D!=t&&(0,M.UW)("posY",t,!0),T!=n&&(0,M.UW)("zoom",n,!0),B=e,D=t,T=n}),3e3);const $=window.camera=A;var F=n(7959),O=n.n(F),N=n(4692);const _=N("#templateURL"),U=N("#templateX"),W=N("#templateY"),z=N("#templateOpacity"),H=(N("#ui"),N("#chat")),j=N("#chatInput"),G=(N("#template"),N("#topMenu"));function Y(e,t){let n;(n=document.getElementById("REPLACE-"+e))||(n=document.createElement("style"),n.id="REPLACE-"+e);let s=Object.keys(t).map((e=>e+":"+t[e]));n.innerText=`${e}{${s.join(";")}}`,document.head.appendChild(n)}var K=n(1603);const X={ALICEBLUE:"#F0F8FF",ANTIQUEWHITE:"#FAEBD7",AQUA:"#00FFFF",AQUAMARINE:"#7FFFD4",AZURE:"#F0FFFF",BEIGE:"#F5F5DC",BISQUE:"#FFE4C4",BLACK:"#000000",BLANCHEDALMOND:"#FFEBCD",BLUE:"#0000FF",BLUEVIOLET:"#8A2BE2",BROWN:"#A52A2A",BURLYWOOD:"#DEB887",CADETBLUE:"#5F9EA0",CHARTREUSE:"#7FFF00",CHOCOLATE:"#D2691E",CORAL:"#FF7F50",CORNFLOWERBLUE:"#6495ED",CORNSILK:"#FFF8DC",CRIMSON:"#DC143C",CYAN:"#00FFFF",DARKBLUE:"#00008B",DARKCYAN:"#008B8B",DARKGOLDENROD:"#B8860B",DARKGRAY:"#A9A9A9",DARKGREY:"#A9A9A9",DARKGREEN:"#006400",DARKKHAKI:"#BDB76B",DARKMAGENTA:"#8B008B",DARKOLIVEGREEN:"#556B2F",DARKORANGE:"#FF8C00",DARKORCHID:"#9932CC",DARKRED:"#8B0000",DARKSALMON:"#E9967A",DARKSEAGREEN:"#8FBC8F",DARKSLATEBLUE:"#483D8B",DARKSLATEGRAY:"#2F4F4F",DARKSLATEGREY:"#2F4F4F",DARKTURQUOISE:"#00CED1",DARKVIOLET:"#9400D3",DEEPPINK:"#FF1493",DEEPSKYBLUE:"#00BFFF",DIMGRAY:"#696969",DIMGREY:"#696969",DODGERBLUE:"#1E90FF",FIREBRICK:"#B22222",FLORALWHITE:"#FFFAF0",FORESTGREEN:"#228B22",FUCHSIA:"#FF00FF",GAINSBORO:"#DCDCDC",GHOSTWHITE:"#F8F8FF",GOLD:"#FFD700",GOLDENROD:"#DAA520",GRAY:"#808080",GREY:"#808080",GREEN:"#008000",GREENYELLOW:"#ADFF2F",HONEYDEW:"#F0FFF0",HOTPINK:"#FF69B4",INDIANRED:"#CD5C5C",INDIGO:"#4B0082",IVORY:"#FFFFF0",KHAKI:"#F0E68C",LAVENDER:"#E6E6FA",LAVENDERBLUSH:"#FFF0F5",LAWNGREEN:"#7CFC00",LEMONCHIFFON:"#FFFACD",LIGHTBLUE:"#ADD8E6",LIGHTCORAL:"#F08080",LIGHTCYAN:"#E0FFFF",LIGHTGOLDENRODYELLOW:"#FAFAD2",LIGHTGRAY:"#D3D3D3",LIGHTGREY:"#D3D3D3",LIGHTGREEN:"#90EE90",LIGHTPINK:"#FFB6C1",LIGHTSALMON:"#FFA07A",LIGHTSEAGREEN:"#20B2AA",LIGHTSKYBLUE:"#87CEFA",LIGHTSLATEGRAY:"#778899",LIGHTSLATEGREY:"#778899",LIGHTSTEELBLUE:"#B0C4DE",LIGHTYELLOW:"#FFFFE0",LIME:"#00FF00",LIMEGREEN:"#32CD32",LINEN:"#FAF0E6",MAGENTA:"#FF00FF",MAROON:"#800000",MEDIUMAQUAMARINE:"#66CDAA",MEDIUMBLUE:"#0000CD",MEDIUMORCHID:"#BA55D3",MEDIUMPURPLE:"#9370DB",MEDIUMSEAGREEN:"#3CB371",MEDIUMSLATEBLUE:"#7B68EE",MEDIUMSPRINGGREEN:"#00FA9A",MEDIUMTURQUOISE:"#48D1CC",MEDIUMVIOLETRED:"#C71585",MIDNIGHTBLUE:"#191970",MINTCREAM:"#F5FFFA",MISTYROSE:"#FFE4E1",MOCCASIN:"#FFE4B5",NAVAJOWHITE:"#FFDEAD",NAVY:"#000080",OLDLACE:"#FDF5E6",OLIVE:"#808000",OLIVEDRAB:"#6B8E23",ORANGE:"#FFA500",ORANGERED:"#FF4500",ORCHID:"#DA70D6",PALEGOLDENROD:"#EEE8AA",PALEGREEN:"#98FB98",PALETURQUOISE:"#AFEEEE",PALEVIOLETRED:"#DB7093",PAPAYAWHIP:"#FFEFD5",PEACHPUFF:"#FFDAB9",PERU:"#CD853F",PINK:"#FFC0CB",PLUM:"#DDA0DD",POWDERBLUE:"#B0E0E6",PURPLE:"#800080",REBECCAPURPLE:"#663399",RED:"#FF0000",ROSYBROWN:"#BC8F8F",ROYALBLUE:"#4169E1",SADDLEBROWN:"#8B4513",SALMON:"#FA8072",SANDYBROWN:"#F4A460",SEAGREEN:"#2E8B57",SEASHELL:"#FFF5EE",SIENNA:"#A0522D",SILVER:"#C0C0C0",SKYBLUE:"#87CEEB",SLATEBLUE:"#6A5ACD",SLATEGRAY:"#708090",SLATEGREY:"#708090",SNOW:"#FFFAFA",SPRINGGREEN:"#00FF7F",STEELBLUE:"#4682B4",TAN:"#D2B48C",TEAL:"#008080",THISTLE:"#D8BFD8",TOMATO:"#FF6347",TURQUOISE:"#40E0D0",VIOLET:"#EE82EE",WHEAT:"#F5DEB3",WHITE:"#FFFFFF",WHITESMOKE:"#F5F5F5",YELLOW:"#FFFF00",YELLOWGREEN:"#9ACD32"};var Z=n(4692);function q(e,t,n){return void 0===t?e:n?(e+t).slice(-e.length):(t+e).substring(0,e.length)}const V=new RegExp(/\[(#?[A-Z0-9]{1,8})*?\]/gi),J=new RegExp(/http?s:\/\/.+?\.(png|jpg|jpeg|gif)(\?\S+)?/i),Q=new RegExp(`^https?://${location.host}/.*`),ee=new class{constructor(){this.element=Z("#chat"),this.logElems={},this.colorsEnabled=!JSON.parse((0,M.Fh)("disableColors",!1)),this.muted=JSON.parse((0,M.yN)("muted"))||[],this.channel=void 0,this.initChatEvents()}loadChannelElements(){[...Z("#chatLog").children()].map((e=>{let t=e.dataset.channel;"local"===t&&(t=h.OP),this.logElems[t]=Z(e)}))}mobileShow(){this.element.css("top","0")}mobileHide(){this.element.css("top","-100vh")}setColors(e){this.colorsEnabled=e,Z(".chatColored").toggleClass("noColor",!e)}parseColors(e){let t=0,n=e.matchAll(V);for(;;){let{value:s,done:i}=n.next();if(i)break;let o=s[1];if(o){if(o.startsWith("#")&&!/[G-Zg-z]/.test(o))o=q(o.slice(-1).repeat(7),o);else if(!X[o])continue;e=e.replace(s[0],`<div class="chatColored${this.colorsEnabled?"":" noColor"}" style="color:${o}">`),t++}else t>0?(e=e.replace(s[0],"</div>"),t--):e=e.replace(s[0],"&#91;&#93;")}return t>0&&(e+="</div>".repeat(t)),e}parseCoords(e){return e.replace(/\((\d{1,5}), ?(\d{1,5})\)/g,'<a class="cordgo" onclick="camera.centerOn($1, $2)">$&</a>')}parseImage(e){let t=e.match(J);if(t){let n=t[0];e=e.replace(n,`<span class="imageLink" onclick="globals.chat.toggleImage(this)">${n}</span>`)}return e}toggleImage(e){const t=Z(e),n=t.parent();if(Z("img",n).length)Z(".imageLink",n).css("cursor","zoom-in"),Z("img",n).remove();else{Z(".imageLink",n).css("cursor","zoom-out");const e=Z(`<img src="${t.text()}" class="chatImg" onclick="globals.chat.toggleImage(this)">`);e.on("load",this.scroll.bind(this,this.channel)),n.append(e)}}parseGoroxelsLink(e){if(!e.split(" ")[0])return e;const t=e.match(Q);return t?e.replace(t[0],`<a href="${t[0]}">${t[0]}</a>`):e}parseBB(e){let t=[],n=e.matchAll(/\[(\/?[bi])\]/gi);for(;;){let{value:s,done:i}=n.next();if(i)break;let o=s[1];e=e.replace(s[0],`<${o}>`),o.startsWith("/")?t=t.splice(t.indexOf(o.slice(1))):t.push(o)}for(;t.length;)e+=`</${t.shift()}>`;return e}addMessage(e){Z(".showChat").addClass("showChat-notify"),Z(".chatNotif").addClass("active");const t=e.ch;if(e.server)return this.addServerMessage(e.msg,t);let n=k(e.msg),s=k(e.nick);const i=s;"Goroh"===s&&(s=`<span style="text-shadow:0 0 3px">[#00f986]${s}</span>`);try{n=this.parseColors(n),n=this.parseBB(n),n=this.parseCoords(n),n=this.parseGoroxelsLink(n),n=this.parseImage(n),s=this.parseColors(s)}catch(e){console.log(e)}const o=~this.muted.indexOf(i),a=Z(`<div class="chatMessage" ${o?'style="display:none"':""}>\n            <div class="messageNick" data-nick="${i}">${s}:</div>\n            <div class="messageText">${n}</div>\n        </div>`);Z(".messageNick",a).on("click",(function(){const e=this.innerText.slice(0,-1);L.elements.chatInput.value+=e+", ",L.elements.chatInput.focus()})),this.logElems[t].append(a),this.afterAddingMessage(t)}addLocalMessage(e,t){e=this.parseColors(e),e=this.parseBB(e),e=this.parseCoords(e),e=this.parseGoroxelsLink(e),e=this.parseImage(e);const n=Z(`<div class="chatMessage">\n                <div class="messageText">${e}</div>\n            </div>`);this.logElems[t].append(n),this.afterAddingMessage(t)}switchChannel(e){if(this.channel===e)return;const t=e;"local"===e&&(e=h.OP);for(let e of Object.values(this.logElems))e.hide();this.logElems[e].show(),Z("#chatChannels>div").removeClass("selected"),Z(`#chatChannels>div[data-channel="${t}"]`).addClass("selected"),this.scroll(e,!0),this.channel=e}addServerMessage(e,t){this.addLocalMessage(e,t)}afterAddingMessage(e){const t=this.logElems[e];t.children().length>h.LO.chatLimit&&t.children()[0].remove(),this.scroll(e)}handleMessage(e){if(e.startsWith("/"))this.handleCommand(e);else{if(!L.socket.connected)return void j.val(e);L.socket.sendChatMessage(e,this.channel)}}sendWhisper(e,t){L.socket.sendChatWhisper(t,this.channel,e)}handleCommand(e){let t=e.split(" ");const n=t[0];switch(t=t.slice(1),n){case"/mute":{const e=t.join(" ");this.mute(e);break}case"/unmute":{const e=t.join(" ");this.unmute(e);break}case"/w":{if(t.length<2)return this.addLocalMessage("Usage: /w &lt;targetAccountId&gt; &lt;message&gt;");const e=t[0],n=t.slice(1).join(" ");L.socket.connected&&(this.sendWhisper(e,n),this.addLocalMessage(`${(0,K.k)("chat.you")} -> id${e}: <i>${n}</i>`,this.channel),j.val(`/w ${e} `));break}case"/help":{const e=`/mute ${(0,K.k)("chat.muteDesc")}<br>/unmute ${(0,K.k)("chat.unmuteDesc")}<br>/w ${(0,K.k)("chat.wDesc")}`;this.addLocalMessage(e,this.channel)}}}mute(e){const t="<b>mute:</b> ";return!e.length||e.length>32?this.addLocalMessage(t+(0,K.k)("Wrong nick length")):~this.muted.indexOf(e)?this.addLocalMessage(t+(0,K.k)("Player is already muted")):(this.muted.push(e),(0,M.UW)("muted",JSON.stringify(this.muted)),void Z(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="none")})))}unmute(e){let t,n="<b>unmute:</b> ";return!e.length||e.length>32?this.addLocalMessage(n+(0,K.k)("Wrong nick length")):~(t=this.muted.indexOf(e))?(this.muted.splice(t,1),(0,M.UW)("muted",JSON.stringify(this.muted)),void Z(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="block")}))):this.addLocalMessage(n+(0,K.k)("Player is not muted"))}initChatEvents(){j.on("input",(()=>{const e=j.val();J.test(e)||Q.test(e)?j.css("color","white"):j.css("color","")}))}scroll(e="global",t=!1){const n=this.logElems[e],s=n.parent()[0],i=n.children().slice(-1).innerHeight()||0;(s.scrollHeight-s.scrollTop-s.clientHeight-i<=7||t)&&s.scrollBy(0,999)}};function te(){const e=Z("#palette").innerHeight();Z("#chat").css("bottom",e+4)}function ne(e){e?Z("#emotions").show():Z("#emotions").hide()}function se(e){const t=Z("#emotions");let n="";for(let t of e)n+=`<div class="emotion">${t}</div>`;t.html(n),Z("div",t).on("click",(e=>{Z("#chatInput")[0].value+=e.target.innerText,Z("#chatInput").trigger("focus")}))}const ie=L.chat=ee,oe={BANNED:-1,GUEST:0,USER:1,TRUSTED:2,MOD:3,ADMIN:4},ae={};Object.keys(oe).forEach((e=>ae[oe[e]]=e));class re{constructor(e){this.renderFunc=e,this.removed=!1}render(e){return this.renderFunc(e)}remove(){this.removed=!0}}class le{constructor(){this.fxList=[[],[],[]],this.ctx=L.fxCtx,this.needRender=!0,this.needClear=!1}add(e,t=0){this.fxList[t].push(e),this.needRender=!0}requestRender(){this.needRender=!0}render(){if(this.needRender){this.ctx.clearRect(0,0,window.innerWidth,window.innerHeight),this.needRender=!1;for(let e=0;e<this.fxList.length;e++)this.fxList[e].forEach((e=>{try{if(e.removed)return this.remove(e);let t=e.render(this.ctx);2==t?this.remove(e):0==t&&(this.needRender=!0)}catch(e){console.error(e)}}))}}remove(e){for(let t=0;t<this.fxList.length;t++){let n=this.fxList[t].indexOf(e);if(-1!=n){this.fxList[t][n].remove(),this.fxList[t].splice(n,1),this.needRender=!0;break}}}}let ce=[];function he(e,t){L.fxRenderer?L.fxRenderer.add(e,t):ce.push([e,t])}function de(e){L.fxRenderer.remove(e)}let ue=setInterval((()=>{if(L.fxRenderer){clearInterval(ue);for(let[e,t]of ce)he(e,t);ce=[]}}),5);function me(e,t){let n=(e-(L.renderer.canvas.width>>1))/$.zoom,s=(t-(L.renderer.canvas.height>>1))/$.zoom;return[0|$.x+f[0]+n,0|s+($.y+f[1])]}function pe(e,t){return e-=$.x+f[0],t-=$.y+f[1],e*=$.zoom,t*=$.zoom,e+=L.renderer.canvas.width>>1,t+=L.renderer.canvas.height>>1,[Math.floor(e),Math.floor(t)]}function ge(e,t){return[e/h.ZL|0,t/h.ZL|0,e%h.ZL,t%h.ZL]}const fe=n(5390),we=fe.keys().map((e=>{const t=fe(e).default;return[t.match(/([\.\d]+)\.png$/)[1],t]})).sort((([e],[t])=>{const[n,s,i]=e.split(".").map(Number),[o,a,r]=t.split(".").map(Number);return i!==r?r-i:s!==a?a-s:o-n})),ve=Object.fromEntries(we);let be,ye=null,ke=null;function xe(){if(globals.fxRenderer.remove(ye),ke&&(ke.canvas.style.backgroundColor="",ke=null),be){const{x:e,y:t,zoom:n,minX:s,minY:i,maxX:o,maxY:a}=be;Object.assign($,{x:e,y:t,zoom:n,minX:s,minY:i,maxX:o,maxY:a})}}var Ce=n(7959);function Ee(e){if(!e)return;if(Array.isArray(e))return e.map(Ee);const t=e;let n;n="object"==typeof t?`[${t.path}] ${t.msg}`:t,Ce.error(n,void 0,{preventDuplicates:!0})}async function Re(e,t={}){t.body&&"object"==typeof t.body&&(t.headers||(t.headers={}),t.headers["Content-Type"]="application/json",t.body=JSON.stringify(t.body));const n=await fetch("/api"+e,t);if(n.headers.get("Content-Type")&&n.headers.get("Content-Type").includes("application/json"))try{const e=await n.json();e.errors&&Ee(e.errors),n.json=()=>e}catch(e){}return n}var Ie=n(4692);let Se=!1,Pe=[];const Le={registered:!1,name:null,id:null,role:oe.GUEST,update(e){this.registered=e.registered,e.registered&&(this.name=e.name,this.role=e.role,this.id=e.id),this.updateRoleRelatedHtml()},updateRoleRelatedHtml(){switch(Ie(".minrole-admin").hide(),Ie(".minrole-mod").hide(),Ie(".minrole-trusted").hide(),Ie(".minrole-user").hide(),this.role){case oe.ADMIN:Ie(".minrole-admin").show();case oe.MOD:Ie(".minrole-mod").show();case oe.TRUSTED:Ie(".minrole-trusted").show();case oe.USER:Ie(".minrole-user").show()}},checkCanGetUserInfo(){return this.registered&&this.role>=oe.TRUSTED},async load(){const e=await Re("/me"),t=await e.json();this.update(t),Se=!0,this.callStacked()},callOnLoaded(e){if(this.loaded)return e();Pe.push(e)},callStacked(){Pe.forEach((e=>e())),Pe=[]}};class Me{constructor(e,t){this._allowance=0,this.delay=e,this.max=t,this.lastCheck=Date.now()}get allowance(){return 0===this.delay?1/0:(this._allowance+=(Date.now()-this.lastCheck)/this.delay,this.lastCheck=Date.now(),this._allowance>this.max&&(this._allowance=this.max),this._allowance)}set allowance(e){this._allowance=e}spend(e){if(0===this.delay)return!0;let t=this.allowance;return!(t<e||(this.allowance=t-e,0))}}var Ae=n(4692),Be=n(7959);const De={x:0,y:0,color:-1,brushSize:1,secondCol:-1,id:-1,init(){this.loadColors(),this.switchColor(this.color,!0),this.switchSecondColor(this.secondCol,!0)},loadColors(){this.color=+(0,M.Fh)("color1",-1,!0),this.secondCol=+(0,M.Fh)("color2",-1,!0)},switchColor(e,t=!1){this.secondCol===e&&-1!==e&&this.switchSecondColor(-1),this.color!==e||t?this.color=e:e=this.color=-1,L.fxRenderer.needRender=!0,L.renderer.preRender(),Ae(".paletteColor.selected").removeClass("selected"),-1!==e&&Ae("#col"+e).addClass("selected"),(0,M.UW)("color1",e,!0)},switchSecondColor(e,t){this.color===e&&-1!==e&&this.switchColor(-1),this.secondCol!==e||t?this.secondCol=e:e=this.secondCol=-1,L.fxRenderer.needRender=!0,L.renderer.preRender(),Ae(".paletteColor.selectedSecond").removeClass("selectedSecond"),-1!==e&&Ae("#col"+e).addClass("selectedSecond"),(0,M.UW)("color2",e,!0)},swapColors(){const e=this.color;this.switchColor(this.secondCol),this.switchSecondColor(e)},resetColors(){this.switchColor(-1),this.switchSecondColor(-1)},bucket:null,updateBucket([e,t]){this.bucket=new Me(e,t)},placed:[],maxPlaced:isNaN(+localStorage.maxPlaced)?5e3:+localStorage.maxPlaced,placedCount:+(0,M.yN)("placedCount",!0)||0};async function Te(){await Le.load(),De.updateBucket(function(){const e=h.K2;return"ADMIN"==ae[Le.role]?[0,32]:e[ae[Le.role]]||h.K2.GUEST}()),Le.registered?(j.removeAttr("disabled"),j.val(""),Ae("#loginButtons,.authBtn").hide(),Ae("#chatNick,#chatChannels").show(),Ae("#chatNick").text(Le.name),Ae("#chatHeader").addClass("logged")):(j.attr("disabled"),j.val((0,K.k)("login to chat")),Ae("#chatNick,#chatChannels").hide(),Ae("#loginButtons,.authBtn").show(),Ae("#chatHeader").removeClass("logged"))}function $e(e,t=!0){t&&e.forEach((([e,t])=>{De.placed.push([e,t,L.chunkManager.getChunkPixel(e,t)])})),L.socket.sendPixels(e,!1)}function Fe(e,t,n,s=!0){const i=L.chunkManager.getChunkPixel(e,t),o=L.chunkManager.getProtect(e,t);i!==n&&(!o||Le.role>=oe.TRUSTED)&&L.socket.connected?(s&&(De.placed.push([e,t,L.chunkManager.getChunkPixel(e,t)]),De.placed.length>2*De.maxPlaced&&(De.placed=De.placed.slice(-De.maxPlaced))),L.chunkManager.setChunkPixel(e,t,n),L.socket.sendPixel(e,t,n),L.socket.pendingPixels[e+","+t]=setTimeout((()=>{L.chunkManager.setChunkPixel(e,t,i),L.renderer.needRender=!0}),3e3)):o&&Le.role<oe.TRUSTED&&Be.error((0,K.k)("error.protected_pixel"),(0,K.k)("Error!"),{preventDuplicates:!0,timeOut:750})}function Oe(e){De.brushSize=+e,L.fxRenderer.needRender=!0,L.renderer.preRenderBrush(),Ae("#brushSizeCounter").text(e-1)}function Ne(e){e?Ae("#placedPixels").show():Ae("#placedPixels").hide()}function _e(e,t){Ae("#placedPixels").text(e),t&&Ae("#placedPixels").attr("title",t)}let Ue=De.placedCount;setInterval((()=>{Ue!==De.placedCount&&((0,M.UW)("placedCount",De.placedCount,!0),Ue=De.placedCount)}),3e3);const We=De;class ze extends(r()){constructor(e,t=null,n=null,s=oe.GUEST){super(),this.name=e,this.icon=n,this.defaultKey=t,this.key=t?t.toString():void 0,this.requiredRole=s}}const He={line:function(e,t,n,s){let i=[],o=Math.abs(s-t)>Math.abs(n-e);o&&([e,t]=[t,e],[n,s]=[s,n]);let a=!1;e>n&&([t,s]=[s,t],[e,n]=[n,e],a=!0);let r=n-e,l=Math.abs(s-t),c=r/2,h=t<s?1:-1;for(;e<=n;e++)i.push([o?t:e,o?e:t]),c-=l,c<0&&(t+=h,c+=r);return a&&i.reverse(),i.reverse(),i},filledCircle:function(e,t,n){let s=[];const i=n*n;for(let i=-n+e;i<n+e;i++)for(let e=-n+t;e<n+t;e++)o(i,e)&&s.push([i,e]);function o(n,s){let o=n-e,a=s-t;return o*o+a*a<=.8*i}return s},square(e,t,n,s){const i=Math.min(e,n),o=Math.min(t,s),a=Math.max(e,n),r=Math.max(t,s);let l=[];for(let e=o;e<r+1;e++)for(let t=i;t<a+1;t++)l.push([t,e]);return l}};function je(e,t){return!(e<0||e>=h.h||t<0||t>=h.Uf)}const Ge=n.p+"/img/clicker.png",Ye=n.p+"/img/move.png",Ke=n.p+"/img/floodfill.png",Xe=n.p+"/img/line.png",Ze=n.p+"/img/protect.png",qe=n.p+"/img/revert.png";var Ve=n(4692),Je=n(7959);let Qe=window.innerWidth/2,et=window.innerHeight/2;window.addEventListener("resize",(()=>{Qe=window.innerWidth/2,et=window.innerHeight/2}));const tt=/w(?:idth)?=(\d+)$/;class nt{constructor(){this.x=0,this.y=0,this.templateImg,this.templateResizeW=null,this._lastUrl=null,he(new re(this.renderFx.bind(this)))}get url(){return _.val()}get opacity(){return+z.val()}set opacity(e){z.val(e)}renderFx(e){if(!this.templateImg)return 1;e.imageSmoothingEnabled=!1;const[t,n]=pe(this.x,this.y),s=$.zoom;let i,o;if(this.templateResizeW)if(i=this.templateResizeW,this.templateImg.width/this.templateResizeW==7)o=Math.floor(this.templateImg.height/7);else{const e=this.templateImg.width/this.templateImg.height;o=Math.floor(this.templateResizeW/e)}else i=this.templateImg.width,o=this.templateImg.height;const a=e.globalAlpha;return e.globalAlpha=this.opacity,e.drawImage(this.templateImg,t,n,i*s|0,o*s|0),e.globalAlpha=a,1}update(){this.updatePosition(),this.updateImage()}updatePosition(){this.x=parseInt(U.val(),10),this.y=parseInt(W.val(),10),L.fxRenderer.requestRender()}static parseImageUrl(e){let t,n=null;if((t=e.match(tt))&&(n=+t[1]),e.startsWith("GRX")){const t=e.match(/f=(.+\.png)/)[1];e=`/api/template/img?t=orig&f=${t}`}return{url:e,width:n}}async updateImage(){if(this.url===this._lastUrl)return;const{url:e,width:t}=nt.parseImageUrl(this.url);this.templateImg=await R(e),this._lastUrl=this.url,this.templateResizeW=t,L.fxRenderer.requestRender()}}const st=new nt;function it(){(0,M.UW)("template.x",st.x,!0),(0,M.UW)("template.y",st.y,!0),(0,M.UW)("template.url",st.url,!0),(0,M.UW)("template.opac",st.opacity,!0)}function ot(){st.update(),it()}function at(){const e=_.val(),t=U.val(),n=W.val(),s=`${location.origin+location.pathname}?t_url=${encodeURIComponent(e)}&t_x=${t}&t_y=${n}`;j.val(s),j.trigger("focus");const i=new Event("input",{bubbles:!0,cancelable:!0});j[0].dispatchEvent(i)}async function rt(){if(!Le.registered)return Je.error("needs_login_to_use_templates");const e=await Re("/template/list"),t=await e.json();t.errors||function(e){let t=new wn({title:kn((0,K.k)("templates_title")),center:!0,closeable:!0});if(!t.created)return;t.body.classList.add("templatesBody"),t.body.style.maxWidth="min(495px, 90vw)",L.mobile&&(t.body.style.justifyContent="space-evenly");const n=e.slice().sort(((e,t)=>{const n=Le.id===e.userId;return n!==(Le.id===t.userId)?n?1:-1:new Date(e.createdAt)-new Date(t.createdAt)})),s=Le.role===oe.ADMIN;for(const e of n){const n=Le.id===e.userId,i=n||s,o=`api/template/img?t=thumb&f=${e.thumb}`,a=On(`<div class="templateItem ${n?"myTemplateItem":""}">\n                <button class="templateBtn ${i?"deleteBtn":""}"></button>\n                <button class="templateBtn infoBtn">i</button>\n                <img src="${o}" alt="thumbnail">\n                <div class="templateName">${e.name}</div>\n            </div>`);On(t.body).prepend(a),a.find(".deleteBtn").on("click",(async t=>{t.stopPropagation(),new yn((0,K.k)("confirm_template_deletion"),(async t=>{if(!t)return;const n=await Re(`/template/del?name=${encodeURIComponent(e.name)}`,{method:"POST"});(await n.json()).success&&a.remove()}))})),a.find(".infoBtn").on("click",(async t=>{t.stopPropagation();let n="???";try{const t=await Re(`/userInfo?id=${e.userId}`),s=await t.json();s&&s.name&&(n=k(s.name))}catch(t){console.error("Ошибка получения userInfo",t)}const s=Le.id===e.userId,i=new Date(e.createdAt).toLocaleString(),o=new wn({title:kn((0,K.k)("template_info")),center:!0,closeable:!0});o.created&&(o.body.style.width="280px",o.body.innerHTML=`\n                <ul class="templateInfoList">\n                    <li><b>${(0,K.k)("name")}:</b> ${e.name}</li>\n                    <li><b>${(0,K.k)("createdAt")}:</b> ${i}</li>\n                    <li><b>${(0,K.k)("owner")}:</b> ${n}</li>\n                    <li><b>${(0,K.k)("isMine")}:</b> ${s?(0,K.k)("yes"):(0,K.k)("no")}</li>\n                    <li><b>${(0,K.k)("public")}:</b> ${e.public?(0,K.k)("yes"):(0,K.k)("no")}</li>\n                </ul>\n            `)})),a.on("click",(()=>{let t=`GRX/f=${e.file}`;e.origWidth&&(t+=`&w=${e.origWidth}`),_.val(t),ot()}))}}(t)}const lt=st;var ct=n(3603);function ht(e,t,n,s,i){return(e-t)*(i-s)/(n-t)+s}const dt=n.p+"/font/min5.png",ut=n.p+"/font/min5.txt";var mt=n(4692);class pt extends(r()){constructor(e="",t=1){super(),this.title=e,this._closeButtons=t,this.element=null,this.bodyElement=null,this.closed=!1,this._create()}_create(){const e=mt(`\n        <div class="miniWindow">\n            <div class="miniWindowTitle">\n                ${this.title}\n            </div>\n            <div class="miniWindowBody">\n            </div>\n            <div class="miniWindowButtons">\n            </div>\n        </div>\n        `),t=[];if(this._closeButtons>=1){const e=mt("<button>ok</button>");e.on("click",this.buttonHandler.bind(this,"ok")),t.push(e)}if(this._closeButtons>=2){const e=mt("<button>cancel</button>");e.on("click",this.buttonHandler.bind(this,"cancel")),t.push(e)}t.forEach((t=>mt(".miniWindowButtons",e).append(t))),this.element=e,this.bodyElement=mt(".miniWindowBody",e)}buttonHandler(e){const t={_cancelledClose:!1,cancelClose:function(){this._cancelledClose=!0}};switch(e){case"ok":this.emit("okClicked",t);break;case"cancel":this.emit("cancelClicked",t)}t._cancelledClose||this.close()}close(){this.removeAllListeners(),this.element.remove(),this.closed=!0}}var gt=n(4692);function ft(){"none"===G.css("display")?(G.show(),G.css("margin-top","")):(G.css("margin-top",-G.height()-30),setTimeout((()=>G.hide()),500))}var wt=n(4692);const vt=L.mobile;function bt(e,t){return L.chunkManager.getChunkPixel(e,t)}function yt(e,t){return L.chunkManager.getProtect(e,t)}function kt(e,t){return(e+t)%2==0}function xt(){return-1===We.secondCol?~We.color?We.color:-1:-1===We.color?We.secondCol:kt(We.x,We.y)?We.color:We.secondCol}function Ct(e,t,n=We.color,s=We.secondCol){return-1===s?n:-1===n?s:kt(e,t)?n:s}function Et(e,t){return e>=0&&e<h.h&&t>=0&&t<h.Uf}let Rt=!1,It=setInterval((()=>{L.toolManager&&(clearInterval(It),Rt=!0,St.forEach((e=>e(L.toolManager))),St=[])}),5),St=[];function Pt(e){Rt?e(L.toolManager):St.push(e)}function Lt(){L.fxRenderer.needRender=!0}class Mt extends ze{constructor(...e){super(...e),this._pendingPixels={},this.minZoom=2,this.on("down",this.down),this.on("up",this.up),this.on("move",this.move),this.on("leave",this.up),this.on("_gesture",this.ongesture),Pt((()=>{vt||(L.eventManager.on("mousedown",this.mousedown.bind(this)),L.toolManager.on("move",this.move.bind(this)),L.eventManager.on("mouseup",this.mouseup.bind(this)))})),this.clrInterval=setInterval((()=>{this.clearPending()&&Lt()}),250),this.fx=new re(this.render.bind(this))}mousedown(e){0===e.button&&(this.screenPos=[e.clientX,e.clientY])}mouseup(e){if("LMB"!==L.toolManager.tools.mover.key)return;if(0!==e.button||!this.screenPos)return;const t=Math.abs(e.clientX-this.screenPos[0]),n=Math.abs(e.clientY-this.screenPos[1]);if(t>5||n>5)return;const[s,i]=[We.x,We.y],o=Ct(s,i);this.checkPixel(s,i)&&~o&&Fe(We.x,We.y,Ct(s,i))}down(e){this.lastPos=[We.x,We.y],this.screenPos=[e.clientX,e.clientY],this.mouseIsDown||$.zoom<this.minZoom||(this.mouseIsDown=!0,vt?this.pointerId=e.pointerId:this.emit("move",{}))}up(e){this.mouseIsDown&&(vt&&this.emit("move",e,!0),this.mouseIsDown=!1)}ongesture(){this.mouseIsDown=!1,this.lastPos=null}checkPixel(e,t){const n=`${e},${t}`,s=Ct(e,t),i=bt(e,t),o=yt(e,t);if(!(i===s||-1===i||o&&Le.role<oe.TRUSTED||this._pendingPixels[n]&&this._pendingPixels[n][0]===s))return this._pendingPixels[n]=[s,Date.now()],!0}move(e,t=!1){if(e.gesture)return void this.ongesture();if(!this.mouseIsDown||e.gesture||-1===xt())return;if(vt&&this.pointerId!==e.pointerId)return;const n=e.clientX,s=e.clientY,i=Math.abs(n-this.screenPos[0]),o=Math.abs(s-this.screenPos[1]);if(i<5&&o<5&&!t)return;let[a,r]=[We.x,We.y],l=He.line(this.lastPos[0],this.lastPos[1],a,r);this.lastPos=[a,r];let c=[[0,0]];1!==We.brushSize&&(c=L.renderer.preRendered.brush.circle);for(let[e,t]of l){let n=[];if(!this.checkAllowance(c.length))return;c.forEach((([s,i])=>{let o=e+s,a=t+i;if(this.checkPixel(o,a)){const e=Ct(o,a);n.push([o,a,e])}})),this.place(n)}}checkAllowance(e){return We.bucket.allowance>=e}place(e){0!==e.length&&(We.bucket.spend(e.length),1==e.length?Fe(...e[0]):$e(e))}render(e){const t=$.zoom;e.lineWidth=t/5,e.globalAlpha=.5;for(let n of Object.keys(this._pendingPixels)){let[s,i]=n.split(",").map((e=>parseInt(e,10)));const o=this._pendingPixels[n][0];e.strokeStyle="#000000",e.fillStyle=h.p4[o];const[a,r]=pe(s,i);e.strokeRect(a,r,t,t)}return e.globalAlpha=1,1}clearPending(){let e=!1;return Object.keys(this._pendingPixels).forEach((t=>{let n=this._pendingPixels[t][1];Date.now()-n>500&&(delete this._pendingPixels[t],e=!0)})),e}}const At=new Mt("clicker","Space",Ge);class Bt extends Mt{constructor(...e){super(...e),this.minZoom=1,this._alt=!1,this._mobileIsProtect=null}getProtectState(){return vt?this._mobileIsProtect:!this._alt}mousedown(){}mouseup(){}down(e){this.mouseIsDown||(super.down(e),(0,h.k6)(),this._mobileIsProtect=!yt(...this.lastPos))}checkPixel(e,t){const n=`${e},${t}`,s=this.getProtectState();if(yt(e,t)!==s&&(!this._pendingPixels[n]||this._pendingPixels[n][0]!==s))return this._pendingPixels[n]=[s,Date.now()],!0}checkAllowance(){return!0}place(e){const t=this.getProtectState();e.forEach((e=>e[2]=t)),e.length&&function(e){L.socket.sendPixels(e,!0)}(e)}render(){}}const Dt=new Bt("protector","KeyV",Ze,oe.MOD),Tt=new Bt("alt protector","ALT+KeyV",null,oe.MOD);Tt._alt=!0;const $t=new class extends ze{constructor(...e){super(...e),this.handlers(),this.downPos=[0,0],this.downTime=0,this.lastPos=[0,0],this.lastPlayerPos=[0,0],vt||(this.fx=new re(this.renderCursor),he(this.fx))}handlers(){Pt((()=>{this.on("down",this.down),this.on("up",this.up),L.toolManager.on("move",this.move.bind(this)),this.on("leave",this.up)}))}renderCursor(e){const t=$.zoom,n=xt();if(~n&&t>1)if(1==We.brushSize){let s,i,[o,a]=pe(We.x,We.y);e.strokeStyle=h.p4[n],e.lineWidth=t/5;let r=e.lineWidth/2;o+=r,a+=r,s=t-e.lineWidth,i=s,e.strokeRect(o,a,s+1,i+1)}else{const[t,n]=pe(We.x-We.brushSize/2,We.y-We.brushSize/2);e.drawImage(L.renderer.preRendered.brush.canvas,t,n)}return 1}down(e){e.ctrlKey||(this.mousedown=!0,Y("#ui>div>*",{"pointer-events":"none"}),this.downPos=this.lastPos=[e.clientX,e.clientY],this.downTime=Date.now())}up(e){if(!e.ctrlKey&&(this.mousedown=!1,Y("#ui>div>*",{"pointer-events":"all"}),vt&&this.moveThreshold()&&!e.gesture)){if(Date.now()-this.downTime<1e3)return;on.emit("up")}}move(e){e.ctrlKey||((this.lastPlayerPos[0]!=We.x||this.lastPlayerPos[1]!=We.y||this.mousedown)&&Lt(),this.lastPlayerPos=[We.x,We.y],this.mousedown&&(this.lastPos=[e.clientX,e.clientY],!vt&&this.moveThreshold()||$.moveTo(-e.movementX/$.zoom,-e.movementY/$.zoom)))}moveThreshold(){return Math.abs(this.downPos[0]-this.lastPos[0])<5&&Math.abs(this.downPos[1]-this.lastPos[1])<5}}("mover","LMB",Ye),Ft=new class extends ze{constructor(...e){super(...e),this.on("up",this.up),this.on("down",this.down),this.on("leave",this.up),this.on("tick",this.tick),this.previewing=!1,this.fx=null,this.prevStack=[]}up(e,t){if(this.active)return void(this.active=!1);if(!this.previewing)return;if(this.fx.remove(),Lt(),this.previewing=!1,t)return;const n=me(e.clientX,e.clientY);-1!==Ct(...n)&&je(...n)&&"mouseleave"!==e.type&&(this.active=!0,this.stack=[[We.x,We.y]],this.playerCol=We.color,this.secondPlayerCol=We.secondCol,this.fillingCol=bt(We.x,We.y))}down(e){if(e.repeat||this.previewing||this.active)return;const t=me(e.clientX,e.clientY);if(-1===Ct(...t)||!je(...t))return;let n,s;o.apply(this),this.showedPixels=[],this.fillingCol=bt(We.x,We.y);let i=new re(function(e){if(L.mobile&&L.toolManager.tool!==this)return this.up({},!0),1;if(We.x==n&&We.y==s||o.call(this),-1===xt())return 1;let t=0;for(let e=0;e<700&&0==t;e++)t=a.call(this);return e.strokeWidth=$.zoom,this.showedPixels.forEach(((t,n)=>{let[s,i]=t.split(",").map((e=>parseInt(e,10))),o=1,a=this.showedPixels.length;if(a>=100&&n<a/2&&(o=1-(a/2-n)/(a/2),o<=0))return;e.globalAlpha=o;const r=Ct(s,i,this.playerCol,this.secondPlayerCol);e.strokeStyle=h.p4[r];let[l,c]=pe(s,i);e.strokeRect(l,c,$.zoom,$.zoom)})),t}.bind(this));function o(){this.prevStack=[[We.x,We.y]],this.showedPixels=[],n=We.x,s=We.y,this.playerCol=We.color,this.secondPlayerCol=We.secondCol,this.fillingCol=bt(We.x,We.y)}function a(){if(!this.prevStack.length)return 1;let[e,t]=this.prevStack.pop(),n=Ct(e,t,this.playerCol,this.secondPlayerCol),s=bt(e,t);if(-1!==this.showedPixels.indexOf(e+","+t)||s===n||s!==this.fillingCol||!je(e,t))return 0;this.showedPixels.push(e+","+t);let i=this.checkP(e,t-1),o=this.checkP(e,t+1),a=this.checkP(e-1,t),r=this.checkP(e+1,t);return i&&a&&this.checkP(e-1,t-1),i&&r&&this.checkP(e+1,t-1),o&&a&&this.checkP(e-1,t+1),o&&r&&this.checkP(e+1,t+1),0}he(i,0),this.fx=i,this.previewing=!0}checkP(e,t){return bt(e,t)===this.fillingCol&&(this.prevStack.unshift([e,t]),!0)}tick(){if(this.active){for(let e=0;e<15&&this.stack.length&&(this.stack[this.stack.length-1][0],We.bucket.spend(1));e++){let[e,t]=this.stack.pop(),n=Ct(e,t,this.playerCol,this.secondPlayerCol),s=bt(e,t);if(s===n||s!==this.fillingCol||!je(e,t))continue;let i=this.check(e,t-1),o=this.check(e,t+1),a=this.check(e-1,t),r=this.check(e+1,t);i&&a&&this.check(e-1,t-1),i&&r&&this.check(e+1,t-1),o&&a&&this.check(e-1,t+1),o&&r&&this.check(e+1,t+1),Fe(e,t,n)}return this.stack.length?void 0:this.active=!1}}check(e,t){return bt(e,t)===this.fillingCol&&(this.stack.unshift([e,t]),!0)}}("floodfill","KeyF",Ke);class Ot extends ze{constructor(...e){super(...e),vt||this.on("down",this.down)}down(e){const t=bt(We.x,We.y);-1!==t&&(e.__alt?We.switchSecondColor(t):We.switchColor(t),Lt())}mobileDown(){this.downCord=[We.x,We.y],this.downTime=Date.now()}mobileUp(){We.x,We.y,Date.now(),this.downCord=null,this.downTime=null}}const Nt=new Ot("pipette","KeyC"),_t=new Ot("alt pipette","ALT+KeyC");_t.off("down",_t.down),_t.on("down",(e=>{e.__alt=!0,_t.down.call(_t,e)}));const Ut=new class extends ze{constructor(...e){super(...e),this.drawLength=JSON.parse((0,M.Fh)("drawLineLen",!1)),Pt((()=>{this.handlers()}))}handlers(){let e,t,n,s,i,o,a,r=[],l=!1;function c(){l||(l=!0,e=[We.x,We.y],[i,o]=[We.color,We.secondCol],a=1,1!==We.brushSize&&(a=L.renderer.preRendered.brush.circle.length))}function d(s){if(l&&e){if(s.gesture)return l=!1,e=null;if(t=[We.x,We.y],-1!==We.color||-1!==We.secondCol){if(t[0]!=r[0]||t[1]!=r[1]){r=t;const s=u(...e,...t);n&&de(n),n=new re((e=>{e.globalAlpha=.5,s.forEach((([t,n])=>{const s=Ct(t,n);e.fillStyle=h.p4[s];let[i,o]=pe(t,n);e.fillRect(i,o,$.zoom,$.zoom)})),e.strokeStyle="#000000",e.lineWidth=$.zoom/5;const t=pe(...s[0]),n=pe(...s[s.length-1]);if(e.beginPath(),e.lineCap="round",e.moveTo(...t.map((e=>e+$.zoom/2))),e.lineTo(...n.map((e=>e+$.zoom/2))),this.drawLength&&s.length>1){let[a,r]=t,[l,c]=n,h=Math.min(a,l),d=Math.min(r,c),u=Math.max(a,l),m=Math.max(r,c),[p,g]=[u-Math.abs(u-h)/2,m-Math.abs(m-d)/2];p+=.5*$.zoom,g+=.5*$.zoom;let f=(i=c-r,o=l-a,Math.atan2(i,o)*(180/Math.PI));f>90?f-=180:f<-90&&(f+=180);let w=f*(Math.PI/180);p+=40*Math.sin(w),g-=40*Math.cos(w),e.save(),e.globalAlpha=.7;const v=20;e.font=v+"px sans-serif",e.fillStyle="black",e.strokeStyle="white",e.textAlign="center",e.textBaseline="middle",e.lineWidth=v/6;const b=s.length,[y,k]=[p,g];e.strokeText(b,y,k),e.fillText(b,y,k),e.restore()}var i,o;return e.stroke(),e.globalAlpha=1,1})),he(n)}}else n&&de(n)}}function u(e,t,n,s){let i=[[0,0]];1!==We.brushSize&&(i=L.renderer.preRendered.brush.circle);const o=h.h,a=new Set,r=[],l=He.line(e,t,n,s);for(let e=l.length-1;e>=0;e--){const[t,n]=l[e];i.forEach((([e,s])=>{const i=t+e,l=n+s,c=i+l*o;a.has(c)||(a.add(c),r.push([i,l]))}))}return r.reverse()}function m(){this.off("tick",p),l&&e&&(l=!1,n&&n.remove(),t||(t=[We.x,We.y]),s=u(...e,...t),e=null,t=null,Lt(),this.on("tick",p))}function p(){-1===We.color&&-1===We.secondCol&&(s=null);let e=0;for(;;){if(!s||!s.length)return void this.off("tick",p);const[t,n]=s.pop(),r=Ct(t,n,i,o);if(void 0===r||-1===r)return this.off("tick",p);if(Et(t,n)&&bt(t,n)!==r){if(!We.bucket.spend(1))return s.push([t,n]);if(Fe(t,n,r),e++,e>=a/2)return}}}c=c.bind(this),d=d.bind(this),m=m.bind(this),p=p.bind(this),this.on("down",c),L.toolManager.on("move",d),this.on("up",m)}}("line","ShiftLeft",Xe),Wt=new ze("coords to chat","KeyU");Wt.on("up",(function(){const e=wt("#coords").text();e.length&&(j[0].value+=e+" ",j.trigger("focus"))}));const zt=new ze("swap colors","KeyX");zt.on("up",We.swapColors.bind(We));const Ht=new ze("left color","KeyA");Ht.on("down",(function(){let e=We.color;--e<0&&(e=h.p4.length-1),We.switchColor(e)}));const jt=new ze("right color","KeyS");jt.on("down",(function(){let e=We.color;++e>=h.p4.length&&(e=0),We.switchColor(e)}));const Gt=new ze("toggle chat","KeyK");Gt.on("down",(function(){Z(".chatNotif").removeClass("active"),"none"===H.css("display")?(H.show(),H.css("left",""),Z(".chatNotif").hide()):(H.css("left",-H.width()-30),setTimeout((()=>H.hide()),500),Z(".chatNotif").show())}));const Yt=new ze("toggle menu","KeyL");Yt.on("down",(function(){ft()}));const Kt=new ze("toggle everything","Semicolon");Kt.on("down",(function(){gt("#ui").fadeToggle(100),te()}));const Xt=new class extends ze{constructor(...e){super(...e),this.handlers()}handlers(){let e=!1;function t(){e=!1,this.off("tick",l),a=o,r=0}t=t.bind(this);const n=function(n){if(n.preventDefault(),n.stopPropagation(),n.gesture)return t();e||(e=!0,l(),this.on("tick",l))}.bind(this),s=function(e){e.gesture&&t()}.bind(this),i=function(){t()}.bind(this),o=500;let a=o,r=0;const l=function(){const e=Date.now()-r;if(e<a)return;let t=e/a|0;t<0&&(t=1),r=Date.now();do{const e=L.toolManager.altDown?.2:1;if(a=Math.max(a/1.5,50*e),We.placed.length>We.maxPlaced&&(We.placed=We.placed.slice(-We.maxPlaced)),!We.placed.length)return;if(!We.bucket.spend(1))return;const[t,n,s]=We.placed.pop();Fe(t,n,s,!1)}while(--t)}.bind(this);this.on("down",n),L.eventManager.on("mousemove",s),this.on("up",i)}}("ctrlZ","KeyZ",qe),Zt=new class extends ze{constructor(...e){super(...e),this.state=0,this.fx=null,this.pattern=null,$.on("zoom",(()=>{1==this.state&&this.tryRender()})),this.on("down",this.pressed.bind(this)),JSON.parse((0,M.Fh)("enableGrid",!1))&&this.show()}pressed(e){e.repeat||this.toggle()}drawGrid(e){let[t,n]=me(0,0),[s,i]=pe(t,n),{width:o,height:a}=e.canvas;const r=$.zoom;e.fillStyle="rgb(127,127,127)";const l=r>16?.5:ht(r,24,5,.5,0);let c;e.globalAlpha=l,c=h.ZL%16==0?16:h.ZL%10==0?10:null,c=null;let d=1;for(t--,n--;s<o;s+=r)t++,d=1,t%h.ZL==0&&(d=1),e.fillRect(0|s,0,d,a);for(;i<a;i+=r)n++,d=1,n%h.ZL==0&&(d=1),e.fillRect(0,0|i,o,d);e.globalAlpha=1}tryRender(){this.fx&&!this.fx.removed||(this.fx=new re(this.render.bind(this)),he(this.fx,2))}toggle(){0==this.state?this.show():this.hide(),(0,M.UW)("enableGrid",(!!this.state).toString())}show(){this.state=1,this.tryRender()}hide(){this.state=0,this.fx&&de(this.fx)}render(e){if($.zoom<=5)return 1;this.drawGrid(e)}}("grid","KeyG"),qt=new class extends ze{constructor(...e){super(...e),this.state=0,this.moveFX=null,this.drawInterval=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}async down(){if(0==this.state||1==this.state){this.state=1;try{const e=await this.getImage();this.startPlace(e)}catch{this.state=0}}else 2==this.state||3==this.state&&(this.state=0,this.stopDraw())}async getImage(){const e=document.createElement("input");return e.type="file",e.accept="image/png",e.click(),new Promise(((t,n)=>{e.onchange=()=>{if(e.onchange=null,!e.files.length||""==e.files[0])return n();const s=new FileReader;s.readAsDataURL(e.files[0]),s.onload=()=>{const e=new Image;e.src=s.result,e.onload=()=>{const n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0),t(n)},e.onerror=n},s.onerror=n}}))}startPlace(e){We.resetColors(),this.state=2;let t,n,s=We.x,i=We.y;function o(){let e=We.x,t=We.y;e==s&&t==i||(s=e,i=t)}he(this.moveFX=new re((function(t){const[n,o]=pe(s,i),a=$.zoom,r=ht(Math.sin(Date.now()/400),-1,1,.5,1);return t.globalAlpha=r,t.save(),t.scale(a,a),t.drawImage(e,n/a,o/a),t.restore(),t.globalAlpha=1,0})));let a=function(e){t=e.clientX,n=e.clientY},r=function(o){if(2==o.button)return this.state=0,this.stopPlace(),void l();let[a,r]=[o.clientX,o.clientY];Math.abs(a-t)>5||Math.abs(r-n)>5||(l(),this.stopPlace(),this.startDraw(e,s,i))};function l(){L.eventManager.off("mousedown",a),L.eventManager.off("mouseup",r),L.toolManager.off("move",o)}r=r.bind(this),L.eventManager.on("mousedown",a),L.eventManager.on("mouseup",r),L.toolManager.on("move",o)}stopPlace(){de(this.moveFX),this.removeAllListeners("move")}startDraw(e,t,n){this.state=3;const s=e.getContext("2d"),{width:i}=e;let o=s.getImageData(0,0,e.width,e.height).data,a=-4;this.drawInterval=setInterval(function(){let e=Math.floor(We.bucket.allowance);if(0==e)return;let s=[],r=13106;for("polkovnik"===(0,M.yN)("ya",!1)&&(r=52441);e>0&&a<o.length-4&&s.length<13106;){a+=4;let r=[o[a],o[a+1],o[a+2],o[a+3]];if(r[3]<127)continue;let l=a/4;const c=t+l%i,d=n+(l/i|0);if(c<0||c>=h.h||d<0||d>=h.Uf)continue;const u=(0,ct.Py)(r,h.MF);L.chunkManager.getChunkPixel(c,d)!=u&&(e--,s.push([c,d,u]))}s.length&&(We.bucket.spend(s.length),L.socket.sendPixels(s)),a>=o.length-4&&(this.state=0,this.stopDraw())}.bind(this),50)}stopDraw(){clearInterval(this.drawInterval)}}("paste","CTRL+KeyV",null,oe.MOD);let Vt=parseFloat((0,M.Fh)("template.opacity",.5,!0));const Jt=new ze("template 0/N opaq","KeyO");Jt.on("down",(()=>{0==lt.opacity?lt.opacity=Vt:(Vt=lt.opacity,lt.opacity=0),ot()}));const Qt=new ze("template 1/N opaq","KeyP");Qt.on("down",(()=>{1==lt.opacity?lt.opacity=Vt:(Vt=lt.opacity,lt.opacity=1),ot()}));const en=new class extends ze{constructor(...e){super(...e),this.handlers()}handlers(){let e,t,n,s,i,o,a=[],r=!1;function l(){r||(r=!0,e=[We.x,We.y],[i,o]=[We.color,We.secondCol],this.emit("move"))}function c(){if(r&&e&&(t=[We.x,We.y],t[0]!=a[0]||t[1]!=a[1])){a=t;const s=He.square(...e,...t);n&&de(n),n=new re((e=>{e.globalAlpha=.5;for(let[t,n]of s){const[s,i]=pe(t,n),o=Ct(t,n);e.fillStyle=h.p4[o],e.fillRect(s,i,$.zoom,$.zoom)}return e.globalAlpha=1,1})),he(n)}}function d(){this.off("tick",u),r=!1,e&&(n&&n.remove(),t||(t=[We.x,We.y]),s=He.square(...e,...t),Lt(),s.length<=1||this.on("tick",u))}function u(){let e=We.bucket.allowance===1/0;if(this.lastTick||(this.lastTick=Date.now()),e&&Date.now()-this.lastTick<50)return;this.lastTick=Date.now();let t=0,n=[];for(;t<1e3;){if(!s||!s.length){this.off("tick",u);break}const[a,r]=s.pop(),l=Ct(a,r,i,o);if(void 0===l||-1===l)return this.off("tick",u);if(Et(a,r)&&bt(a,r)!==l){if(!We.bucket.spend(1))return s.push([a,r]);t++,e?n.push([a,r,l]):Fe(a,r,l)}}n.length&&$e(n,!0)}l=l.bind(this),c=c.bind(this),d=d.bind(this),u=u.bind(this),this.on("down",l),this.on("move",c),this.on("up",d)}}("square","KeyJ"),tn=new ze("+brush size","BracketRight");tn.on("down",(()=>{if(!(We.brushSize>=100))return 1==We.brushSize?Oe(4):void Oe(We.brushSize+2)}));const nn=new ze("-brush size","BracketLeft");nn.on("down",(()=>{if(We.brushSize<=4)return Oe(1);Oe(We.brushSize-2)}));const sn=new class extends ze{constructor(...e){super(...e),this.state=0,this.selectFX=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}down(e){if(this.state>0||qt.state>0)return;if("Range"===window.getSelection().type)return;let t,n,s,i,o;e.preventDefault(),e.stopPropagation(),$.disableMove(),We.resetColors(),L.elements.mainCanvas.style.cursor="crosshair",this.state=1;let a=!1,r=!1,l=[];function c(e){"Alt"===e.key&&(a=!0)}function d(){a?(r=!0,l=[[We.x,We.y]]):(n=We.x,s=We.y)}function u(){if(r){let e=We.x,t=We.y;l.push([e,t])}else i=We.x+1,o=We.y+1}function m(){L.elements.mainCanvas.style.cursor="",de(t),L.eventManager.off("keydown",c),L.eventManager.off("mousedown",d),L.eventManager.off("mousemove",u),L.eventManager.off("mouseup",m),this.state=0,$.enableMove(),function(){let e,t,a,c;if(r){e=t=l[0][0],a=c=l[0][1];for(let n=0;n<l.length;n++){const s=l[n];s[0]<e&&(e=s[0]),s[0]>t&&(t=s[0]),s[1]<a&&(a=s[1]),s[1]>c&&(c=s[1])}}else{if([n,s,i,o].some((e=>void 0===e)))return;e=Math.min(n,i),t=Math.max(n,i)+1,a=Math.min(s,o),c=Math.max(s,o)+1}e=Math.max(e,0),t=Math.min(t,h.h),a=Math.max(a,0),c=Math.min(c,h.Uf);const d=t-e,u=c-a,m=document.createElement("canvas");m.width=d,m.height=u;const p=m.getContext("2d"),g=p.createImageData(d,u);let f,w;if(r){f=new Array(l.length),w=new Array(l.length);for(let e=0;e<l.length;e++){const t=l[e];f[e]=t[0],w[e]=t[1]}}for(let t=0;t<d;t++)for(let n=0;n<u;n++){const s=4*(t+n*d),i=e+t,o=a+n;if(r&&!C(l.length,f,w,i,o))continue;const c=L.chunkManager.getChunkPixel(i,o),u=h.MF[c];g.data[s]=u[0],g.data[s+1]=u[1],g.data[s+2]=u[2],g.data[s+3]=255}p.putImageData(g,0,0),qt.startPlace(m)}()}t=new re((function(e){if(e.save(),e.strokeStyle="gray",e.lineWidth=2,e.setLineDash([3,3]),e.globalAlpha=1,r){e.beginPath();const t=pe(l[0][0],l[0][1]);e.moveTo(...t);for(let t=1;t<l.length;t++){const n=l[t];e.lineTo(...pe(...n))}e.closePath(),e.stroke()}else{const[t,a]=pe(n,s),[r,l]=pe(i,o);e.strokeRect(t,a,r-t,l-a)}return e.restore(),1})),he(t),c=c.bind(this),d=d.bind(this),u=u.bind(this),m=m.bind(this),L.eventManager.on("keydown",c),L.eventManager.on("mousedown",d),L.eventManager.on("mousemove",u),L.eventManager.on("mouseup",m)}}("copy","CTRL+KeyC",null,oe.MOD),on=new ze("pixel info","KeyI");let an=null,rn=null;function ln(){an&&(an.remove(),an=null),rn&&(rn.remove(),rn=null)}L.eventManager.on("mouseup",ln),on.on("up",(async()=>{ln();const[e,t]=[We.x,We.y],n=await Re(`/pixelInfo?canvas=${h.OE}&x=${e}&y=${t}`),s=await n.json();if(!s||!s.type)return;const i=wt('<div class="infoBubble"><span style="user-select:text"></span></div>');an=i;const o=wt("<div>");o[0].style.cssText="position: absolute;\n    top: -7px;\n    left: 0;\n    width: 100%;\n    font-size: 14px;\n    font-weight: bold;\n    text-shadow: rgb(255 255 255) -1px 1px 0px, rgb(255 255 255) 1px 1px 0px, rgb(255 255 255) 1px -1px 0px, rgb(255 255 255) -1px -1px 0px;\n    text-align: center;",o.text(`(${e}, ${t})`),i.append(o);let a="";if("UID"===s.type){const e=k(s.placer.nick);a+="<b>UID</b>&nbsp;"+s.placer.id+"<br>",a+="<b>name</b>&nbsp;"+e}else a+=`<b>${s.type}</b>`,s.placer&&(a+="&nbsp;"+s.placer);wt("span",i).html(a),wt("body").append(i);const r=i[0].clientWidth,l=i[0].clientHeight;function c(){const[n,s]=pe(e,t),o=n+$.zoom/2-r/2,a=s-l-11;return i.css("top",a).css("left",o),1}c(),rn=new re((()=>{c()})),he(rn,2)}));class cn{static defaultVSpacing=1;constructor(e,t){this.imagePath=e,this.infoPath=t,this.defaultWidth=null,this.defaultHeight=null,this.letters={},this.loaded=!1,this._isLoading=!1}async load(){if(!this._isLoading){this._isLoading=!0;try{const e=await new Promise(((e,t)=>{const n=new Image;n.onload=()=>{const t=document.createElement("canvas");t.width=n.width,t.height=n.height,t.getContext("2d").drawImage(n,0,0),e(t)},n.onerror=t,n.src=this.imagePath})),t=await fetch(this.infoPath),n=await t.json(),s=n.defaultWidth;this.defaultWidth=s;const i=n.fixedHeight;this.defaultHeight=i;const o=e.getContext("2d");this.letters={};let a=0;for(let e of n.letters){const{letter:t,width:n=s}=e,r=o.getImageData(a,0,n,i);this.letters[t]=r,a+=n+1}}catch(e){throw this._isLoading=!1,e}this._isLoading=!1,this.loaded=!0}}drawText(e,t="black"){if(!this.loaded)throw new Error("font not loaded");e=e.toUpperCase();const{width:n,height:s}=this.measureText(e);if(0==n||0==s)return null;const i=document.createElement("canvas"),o=document.createElement("canvas");i.width=o.width=n,i.height=o.height=s;const a=i.getContext("2d"),r=o.getContext("2d"),l=e.split("");let c=0,h=0;for(let e of l){if("\n"==e){h+=this.defaultHeight+cn.defaultVSpacing,c=0;continue}if(" "==e){c+=this.defaultWidth;continue}let t=this.letters[e];t?(r.putImageData(t,c,h),c+=t.width+1):c+=this.defaultWidth}return a.fillStyle=t,a.fillRect(0,0,n,s),a.globalCompositeOperation="destination-atop",a.drawImage(o,0,0),i}measureText(e){if(!this.loaded)throw new Error("font not loaded");const t=(e=e.toUpperCase()).split("");let n=0,s=0,i=this.defaultHeight;for(let e of t)"\n"!=e?" "!=e?this.letters[e]&&(n+=(this.letters[e].width||this.defaultWidth)+1):n+=this.defaultWidth:(i+=this.defaultHeight+cn.defaultVSpacing,s=Math.max(n,s),n=0);return{width:Math.max(n,s),height:i}}}const hn=new class extends ze{constructor(...e){super(...e),this.fonts=[new cn(dt,ut)],this.fonts.forEach((e=>e.load())),this.miniWindow=null,this.on("down",this.down.bind(this))}down(e){if(this.miniWindow&&!this.miniWindow.closed)return;L.lockInputs=!0,this.miniWindow=new pt("Draw text",2);const t=this.miniWindow.element;vt?t.css("left",0).css("top",0):t.css("left",window.screen.width/3).css("top",window.screen.height/3);const n=wt('\n            <textarea style="width: 100%;"></textarea>\n            <div style="display:flex; margin: 2px 0">\n                <div style="display: flex">\n                    <div>x:</div> <input type="number" class="textXCord" style="width: 100%">\n                </div>\n                <div style="display: flex; margin-left: 2px">\n                    <div>y:</div> <input type="number" class="textYCord" style="width: 100%">\n                </div>\n            </div>\n        ');this.miniWindow.bodyElement.css("max-width",200).css("display","flex").css("flex-direction","column"),this.miniWindow.bodyElement.append(n),document.body.appendChild(t[0]);const s=wt("textarea",this.miniWindow.bodyElement),i=wt(".textXCord",this.miniWindow.bodyElement),o=wt(".textYCord",this.miniWindow.bodyElement),a=[We.x,We.y];i.val(a[0]),o.val(a[1]);const r=this.fonts[0];let l=null,c=We.color,d=null;const u=new re((e=>{const t=s.val();if(!t)return 0;if(!r.loaded)return 0;e.globalAlpha=ht(Math.sin(Date.now()/400),-1,1,.2,.9);const n=i.val(),a=o.val();l===t&&c===We.color||(l=t,c=We.color,d=r.drawText(l,h.p4[c]));const[u,m]=pe(n,a);e.save(),e.scale($.zoom,$.zoom),e.imageSmoothingEnabled=!1;const p=u/$.zoom,g=m/$.zoom;return~We.secondCol&&(e.fillStyle=h.p4[We.secondCol],e.fillRect(p,g,d.width,d.height)),e.drawImage(d,p,g),e.restore(),0}));he(u),this.miniWindow.on("okClicked",(()=>{if(L.lockInputs=!1,de(u),!s.val()||!d)return;if(~We.secondCol){const e=d.getContext("2d");e.globalCompositeOperation="destination-over",e.fillStyle=h.p4[We.secondCol],e.fillRect(0,0,d.width,d.height)}const e=+i.val(),t=+o.val();qt.startDraw(d,e,t)})),this.miniWindow.on("cancelClicked",(()=>{L.lockInputs=!1,de(u)}))}}("text","KeyT",null,oe.USER),dn=new ze("reset colors","RMB");dn.on("up",(()=>{We.resetColors()}));const un={clicker:At,mover:$t,floodfill:Ft,pipette:Nt,altPipette:_t,line:Ut,colorInc:jt,colorDec:Ht,colorSwap:zt,chatOpac:Gt,menuOpac:Yt,allOpac:Kt,ctrlZ:Xt,protector:Dt,altProtector:Tt,grid:Zt,copy:sn,paste:qt,cordAdd:Wt,templateOp1:Jt,templateOp2:Qt,square:en,incBrush:tn,decBrush:nn,pixelInfo:on,text:hn,resetColors:dn};var mn=n(4692),pn=n.n(mn);n.p;var gn=n(4692);let fn=[];window.windows=fn;class wn{static Exists(e){return fn.some((t=>t.title===e))}static Find(e){return fn.find((t=>t.title===e))}constructor(e){"string"==typeof e&&(e={title:e}),this.created=!1,this.x=0,this.y=0,this.title="",this.parent=document.body,this.moveable=!0,this.closeable=!0,this.closed=!1,this.center=!1,Object.assign(this,e),wn.Exists(this.title)?this.oldWindow=wn.Find(this.title):(this.created=!0,this.block||(this.block=this.createParentBlock(),this.moveTo(this.x,this.y),this.parent.appendChild(this.block)),this.center&&(this.moveToCenter(),setTimeout((()=>this.moveToCenter()))),this.addFeatures(),fn.push(this))}get width(){return this.element?.getBoundingClientRect().width}get height(){return this.element?.getBoundingClientRect().height}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}updateTitle(e,t=!1){t||(this.title=e),gn(".windowTitle",this.element).text(e)}createParentBlock(){let e=document.createElement("div");e.className="window",this.element=e;let t=document.createElement("div");if(t.className="windowHeader",t.innerHTML='<h3 class="windowTitle">'+this.title+"</h3>",e.appendChild(t),this.closeable){const e=document.createElement("div");e.className="closeWindow",e.innerHTML="<div></div>",e.addEventListener("pointerdown",(e=>{e.stopPropagation()})),e.addEventListener("click",(()=>this.close())),t.appendChild(e)}let n=document.createElement("div");return n.className="windowBody",e.appendChild(n),this.body=n,e}moveTo(e,t){const n=this.block.getBoundingClientRect(),s=n.width,i=n.height;this.x=Math.max(10-s,e),this.y=Math.max(10-i,t),this.x=Math.min(window.innerWidth-10,this.x),this.y=Math.min(window.innerHeight-10,this.y),this.block.style.left=this.x+"px",this.block.style.top=this.y+"px"}moveBy(e,t){this.moveTo(this.x+e,this.y+t)}moveToCenter(){let e=window.innerWidth,t=window.innerHeight,n=this.block.offsetWidth,s=this.block.offsetHeight;this.moveTo(e/2-n/2,t/2-s/2)}addFeatures(){this.moveable&&(gn(this.block).on("pointerdown",(e=>{let t=this,n=e.clientX,s=e.clientY;function i(e){let i=(e=e.originalEvent).clientX-n,o=e.clientY-s;n=e.clientX,s=e.clientY,t.moveBy(i,o)}pn()(document).on("pointermove",i),pn()(document).one("pointerup pointerleave",(()=>{pn()(document).off("pointermove",i)}))})),gn(this.body).on("pointerdown",(e=>{e.stopPropagation()}))),window.addEventListener("orientationchange",(()=>{setTimeout((()=>{this.moveTo(this.x,this.y)}),500)}))}close(){pn()(this.block).remove(),this.closed=!0,fn.splice(fn.indexOf(this),1)}}let vn=!1;class bn{static get isRunning(){return vn}static set isRunning(e){return vn=e}constructor(){if(bn.isRunning)throw new Error("Modal is running");this.body=null}init(){const e=gn('<div class="modalBg">\n            <div class="modalCont">\n            </div>\n            </div>');this.bgEl=e[0],this.contEl=this.bgEl.children[0],gn(document.body).append(e),bn.isRunning=!0}close(){bn.isRunning=!1,this.bgEl.remove()}}class yn extends bn{constructor(e,t=null){super(),this.msg=e,this.cb=t,this.init()}init(){super.init();const e=gn(`<div style="margin:0;padding:5px;text-align:center;color:var(--light-text)">\n                <p>${this.msg}</p>\n                <button class='confirmBtn' style="padding: 8px;">${(0,K.k)("OK")}</button>\n                <button class='cancelBtn' style="padding: 8px;">${(0,K.k)("Cancel")}</button>\n            </div>`);this.contEl.appendChild(e[0]),gn("button",e).on("click",(()=>{this.close()})),gn(".confirmBtn",e).on("click",(()=>{this.cb&&this.cb(!0)})),gn(".cancelBtn",e).on("click",(()=>{this.cb&&this.cb(!1)}))}}function kn(e){return e.replace(/[А-я\w]+/g,(function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))}const xn=n.p+"/img/arrow.svg",Cn=n.p+"/img/icon-desktop.svg",En=n.p+"/img/icon-phone.svg",Rn=n.p+"/img/user2.png",In=n.p+"/img/mouse-lmb.png",Sn=n.p+"/img/mouse-rmb.png",Pn=n.p+"/img/mouse-mmb.png",Ln=n.p+"/img/mouse-4mb.png",Mn=n.p+"/img/mouse-5mb.png",An=[[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,0,1,1,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,0,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,1,0,1,0,0,0,1,1,0,1,1,0,0,1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,0,1,1,0,1,0,1,0,1,1,0,1,1,1,0,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,1,1,0,0,1,1,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,1,1,0,0,1,1,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1,0,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,1,0,1,1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1,1,1,0,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,1,1,1,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]];var Bn=n(4692);function Dn(){const e=(0,M.yN)("colorSize",!0),t=x();Tn(+e||t),te()}function Tn(e){void 0===e&&(e=x()),Bn(".paletteColor").css("width",e).css("height",e)}function $n(){Fn(),h.MF.forEach((([e,t,n],s)=>{const i=An[s%An.length],o=document.createElement("canvas");o.width=o.height=14;const a=o.getContext("2d");a.fillStyle=h.p4[s];for(let e=0;e<49;e++){if(!i[e])continue;const t=e%7,n=e/7|0;a.fillRect(2*t,2*n,2,2)}function r(e,t){return 4*(e+14*t)}let l=a.getImageData(0,0,14,14).data;if((0,ct.cP)(e,t,n)){a.fillStyle="white";for(let e=0;e<14;e++)for(let t=0;t<14;t++){if(l[r(e,t)+3])continue;const n=l[r(e,t-1)+3],s=l[r(e,t+1)+3],i=l[r(e-1,t)+3],o=l[r(e+1,t)+3],c=l[r(e-1,t-1)+3],h=l[r(e+1,t-1)+3],d=l[r(e-1,t+1)+3],u=l[r(e+1,t+1)+3];(n||s||i||o||c||h||d||u)&&a.fillRect(e,t,1,1)}}l=a.getImageData(0,0,14,14).data,a.fillStyle="black";for(let e=0;e<196;e++)l[4*e+3]||a.fillRect(e%14,e/14|0,1,1);const c=o.toDataURL(),d=document.createElement("img");d.src=c,Bn(`#col${s}`).append(d)})),Bn(".paletteColor").addClass("patternColor")}function Fn(){Bn(".paletteColor>img").remove(),Bn(".paletteColor").removeClass("patternColor")}var On=n(4692);const Nn={LMB:In,RMB:Sn,MMB:Pn,"4MB":Ln,"5MB":Mn};function _n(e,t,n=!0){const s=On("<div>");s[0].style.cssText="width: 100%;\n    height: 30px;\n    background-color: #5f5f5f;\n    position: relative;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    user-select: none;\n    cursor: pointer",s.append(`<div style="font-size:20px;text-transform:uppercase;">${e}</div>`);const i=On("<div>");i[0].style.cssText=`position: absolute;\n    top: 50%;\n    transform: translate(0, -50%);\n    left: 5px;\n    background-image: url(${xn});\n    background-size: 100%;\n    background-repeat: no-repeat;\n    transition: transform .2s ease-in-out;\n    width: 20px;\n    height: 20px;`,s.append(i);const o=On("<div>");o[0].style.cssText="max-height: 0;\n    overflow: hidden;\n    transition: max-height 0.3s linear;\n    font-size: 20px;";const a=On("<div>");a[0].style.cssText="padding:8px",a.html(t),o.append(a);const r=On("<div>");r[0].style.cssText="margin-bottom: 1px;",r.append(s,o);let l=0,c=null;function h(){clearTimeout(c),l?(i.css("transform","translate(0px, -50%) rotate(0deg)"),o.css("max-height",0)):(i.css("transform","translate(0px, -50%) rotate(180deg)"),requestAnimationFrame((()=>{o[0].offsetHeight,o.css("max-height",o[0].scrollHeight),c=setTimeout((()=>{o.css("max-height",o[0].scrollHeight)}),300)}))),l=!l}return n||setTimeout(h),s.on("click",h),r}function Un(e=[]){const t=On('<table class="columnTable"></table>');return e.forEach((([e,n])=>{let s=On(`\n                <tr>\n                    ${void 0===n?`<td colspan="2">${e}</td>`:`<td>${e}</td>\n                        <td>${n}</td>`}\n                </tr>`);t.append(s)})),t}function Wn(){const e=new wn({title:kn((0,K.k)("account settings")),center:!0});if(!e.created)return;let t=Un([[(0,K.k)("role"),ae[Le.role].toUpperCase()],[(0,K.k)("change name"),'<input type="text" id="name" style="width:50%"><button id="changeName">yes</button>'],[`<button id="logout">${(0,K.k)("logout")}</button>`]]);On(e.body).append(t),On("#name").val(Le.name),On("#changeName").on("click",(()=>{const e=On("#name").val();return Le.registered?e.length<0||e.length>32?O().error("Name length is not 0 < length < 32","Name change"):Le.name===e?O().error("Name is the same as was","Name change"):void fetch("/api/changename",{method:"POST",body:JSON.stringify({name:e}),headers:{"Content-Type":"application/json"}}).then((async e=>{const t=await e.json();t.errors.length?t.errors.map((e=>{O().error(e,"Name change error")})):(L.socket.close(),O().success("Name successfully changed"),Te())})):O().error("Hey wtf","0_o")})),On("#logout").on("click",(async()=>{if(Le.registered){const e=await Re("/auth/logout");await e.json()?location.pathname="/":O().error("Can't log out")}}))}function zn(){const e=new wn({title:kn((0,K.k)("toolbinds settings")),center:!0});if(!e.created)return;let t=Un();for(const n of Object.values(un)){if(!n.key)continue;if(n.requiredRole>Le.role)continue;const s=On(`<tr>\n            <td>${(0,K.k)("toolName."+n.name)}</td>\n            <td>\n                <div class="toolKeys" id="KEYS-${n.name}">\n                </div>\n                <button class="resetKeyBtn" id="RESET-${n.name}">🔄</button>\n                <button class="changeKeyBtn" "id="CHANGE-${n.name}">🔧</button>\n            </td>\n        </tr>`);t.append(s);const i=On(".toolKeys",s),o=On(".changeKeyBtn",s),a=On(".resetKeyBtn",s);function r(e){const t=e.alt??e.altKey,n=e.ctrl??e.ctrlKey,s=b(e);if(i.html(""),t&&i.append("<kbd>ALT</kbd> + "),n&&i.append("<kbd>CTRL</kbd> + "),l(s))i.append(`<kbd>${s}</kbd>`);else if(c(s)){const e=`<img src="${Nn[s]}"/>`;i.append(`<kbd>${e}</kbd>`)}}function l(e){return e&&!e.startsWith("Control")&&!e.startsWith("Alt")&&!c(e)}function c(e){return Object.keys(Nn).includes(e)}o.on("click",(()=>{if(L.lockInputs)return;L.lockInputs=!0,i.html("<span>...</span>");let e=I(s[0]);const t=e=>{e.preventDefault(),e.stopPropagation(),r(e);const t=b(e);(l(t)||c(t))&&L.toolManager.changeKey(n,y(e))};document.addEventListener("keydown",t),document.addEventListener("pointerdown",t);const o=n=>{(c(b(n))||n.code)&&"ControlLeft"!==n.code&&"AltLeft"!==n.code&&(n.preventDefault(),n.stopPropagation(),e?.call(),document.removeEventListener("keydown",t),document.removeEventListener("pointerdown",t),document.removeEventListener("keyup",o),document.removeEventListener("pointerup",o),L.lockInputs=!1,L.toolManager.saveBinds())};document.addEventListener("keyup",o),document.addEventListener("pointerup",o)})),a.on("click",(()=>{L.lockInputs||(r(v(n.defaultKey)),L.toolManager.changeKey(n,n.defaultKey),L.toolManager.saveBinds())})),r(v(n.key))}On(e.body).append(t)}function Hn(){const e=new wn({title:kn((0,K.k)("ui settings")),center:!0});if(!e.created)return;const t=Un([[(0,K.k)("colors size"),'<input type="range" min="16", max="64" step="1" id="colSize"><div style="width:50px;"><div>'],[(0,K.k)("hide emojis"),'<input type="checkbox" id="toggleEmojis">'],[(0,K.k)("emoji list"),'<input type="text" id="emojiList">'],[`<button id="moreEmojis">${(0,K.k)("super secret button")}</button>`],[(0,K.k)("show placed pixels"),'<input type="checkbox" id="togglePlaced">'],[(0,K.k)("show patterns over the palette"),'<input type="checkbox" id="showPatterns">']]);On(e.body).append(t);const n=(0,M.Fh)("colorSize",24,!0);On("#colSize").next().text(n),On("#colSize").val(n),On("#colSize").on("input",(function(){const e=On("#colSize").val();Tn(e),On("#colSize").next().text(e+"px"),(0,M.UW)("colorSize",e,!0),te()})),On("#toggleEmojis")[0].checked=1==(0,M.yN)("hideEmojis"),On("#toggleEmojis").on("click",(e=>{const t=!e.target.checked;(0,M.UW)("hideEmojis",t?0:1),ne(t)})),On("#emojiList").val((0,M.Fh)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐")),On("#emojiList").on("change",(e=>{(0,M.UW)("emojis",e.target.value),se(e.target.value.split(" "))})),On("#moreEmojis").on("click",(()=>{const e=new wn((0,K.k)("more emojis!"));e.created&&(e.body.innerHTML="😁😂😃😄😅😆😉😊😋😌😍😏😒😓😔😖😘😚😜😝😞😠😡😢😣😤😥😨😩😪😫😭😰😱😲😳😵😷😸😹😺😻😼😽😾😿🙀🙅🙆🙇🙈🙉🙊🙋🙌🙍🙎🙏✂✅✈✉✊✋✌✏✒✔✖✨✳✴❄❇❌❎❓❔❕❗❤➕➖➗➡➰🚀🚃🚄🚅🚇🚉🚌🚏🚑🚒🚓🚕🚗🚙🚚🚢🚤🚥🚧🚨🚩🚪🚫🚬🚭🚲🚶🚹🚺🚻🚼🚽🚾🛀Ⓜ🅰🅱🅾🅿🆎🆑🆒🆓🆔🆕🆖🆗🆘🆙🆚🈁🈂🈚🈯🈲🈳🈴🈵🈶🈷🈸🈹🈺🉐🉑©®‼⁉™ℹ↔↕↖↗↘↙↩↪⌚⌛⏩⏪⏫⏬⏰⏳▪▫▶◀◻◼◽◾☀☁☎☑☔☕☝☺♈♉♊♋♌♍♎♏♐♑♒♓♠♣♥♦♨♻♿⚓⚠⚡⚪⚫⚽⚾⛄⛅⛎⛔⛪⛲⛳⛵⛺⛽⤴⤵⬅⬆⬇⬛⬜⭐⭕〰〽㊗㊙🀄🃏🌀🌁🌂🌃🌄🌅🌆🌇🌈🌉🌊🌋🌌🌏🌑🌓🌔🌕🌙🌛🌟🌠🌰🌱🌴🌵🌷🌸🌹🌺🌻🌼🌽🌾🌿🍀🍁🍂🍃🍄🍅🍆🍇🍈🍉🍊🍌🍍🍎🍏🍑🍒🍓🍔🍕🍖🍗🍘🍙🍚🍛🍜🍝🍞🍟🍠🍡🍢🍣🍤🍥🍦🍧🍨🍩🍪🍫🍬🍭🍮🍯🍰🍱🍲🍳🍴🍵🍶🍷🍸🍹🍺🍻🎀🎁🎂🎃🎄🎅🎆🎇🎈🎉🎊🎋🎌🎍🎎🎏🎐🎑🎒🎓🎠🎡🎢🎣🎤🎥🎦🎧🎨🎩🎪🎫🎬🎭🎮🎯🎰🎱🎲🎳🎴🎵🎶🎷🎸🎹🎺🎻🎼🎽🎾🎿🏀🏁🏂🏃🏄🏆🏈🏊🏠🏡🏢🏣🏥🏦🏧🏨🏩🏪🏫🏬🏭🏮🏯🏰🐌🐍🐎🐑🐒🐔🐗🐘🐙🐚🐛🐜🐝🐞🐟🐠🐡🐢🐣🐤🐥🐦🐧🐨🐩🐫🐬🐭🐮🐯🐰🐱🐲🐳🐴🐵🐶🐷🐸🐹🐺🐻🐼🐽🐾👀👂👃👄👅👆👇👈👉👊👋👌👍👎👏👐👑👒👓👔👕👖👗👘👙👚👛👜👝👞👟👠👡👢👣👤👦👧👨👩👪👫👮👯👰👱👲👳👴👵👶👷👸👹👺👻👼👽👾👿💀💁💂💃💄💅💆💇💈💉💊💋💌💍💎💏💐💑💒💓💔💕💖💗💘💙💚💛💜💝💞💟💠💡💢💣💤💥💦💧💨💩💪💫💬💮💯💰💱💲💳💴💵💸💹💺💻💼💽💾💿📀📁📂📃📄📅📆📇📈📉📊📋📌📍📎📏📐📑📒📓📔📕📖📗📘📙📚📛📜📝📞📟📠📡📢📣📤📥📦📧📨📩📪📫📮📰📱📲📳📴📶📷📹📺📻📼🔃🔊🔋🔌🔍🔎🔏🔐🔑🔒🔓🔔🔖🔗🔘🔙🔚🔛🔜🔝🔞🔟🔠🔡🔢🔣🔤🔥🔦🔧🔨🔩🔪🔫🔮🔯🔰🔱🔲🔳🔴🔵🔶🔷🔸🔹🔺🔻🔼🔽🕐🕑🕒🕓🕔🕕🕖🕗🕘🕙🕚🕛🗻🗼🗽🗾🗿😀😇😈😎😐😑😕😗😙😛😟😦😧😬😮😯😴😶🚁🚂🚆🚈🚊🚍🚎🚐🚔🚖🚘🚛🚜🚝🚞🚟🚠🚡🚣🚦🚮🚯🚰🚱🚳🚴🚵🚷🚸🚿🛁🛂🛃🛄🛅🌍🌎🌐🌒🌖🌗🌘🌚🌜🌝🌞🌲🌳🍋🍐🍼🏇🏉🏤🐀🐁🐂🐃🐄🐅🐆🐇🐈🐉🐊🐋🐏🐐🐓🐕🐖🐪👥👬👭💭💶💷📬📭📯📵🔀🔁🔂🔄🔅🔆🔇🔉🔕🔬🔭🕜🕝🕞🕟🕠🕡🕢🕣🕤🕥🕦🕧",e.body.style.userSelect="text")})),On("#togglePlaced")[0].checked=0==(0,M.Fh)("hidePlaced",1),On("#togglePlaced").on("click",(e=>{const t=e.target.checked;(0,M.UW)("hidePlaced",t?0:1),Ne(t)})),On("#showPatterns")[0].checked=L.showPatterns,On("#showPatterns").on("click",(e=>{const t=e.target.checked;L.showPatterns=t,(0,M.UW)("showPalettePatterns",t?"1":"0"),t?$n():Fn()}))}function jn(){const e=new wn({title:kn((0,K.k)("game settings")),center:!0});if(!e.created)return;let t=Le.role===oe.ADMIN?20:Le.role<oe.USER?1:10;const n=Un([[(0,K.k)("show protected"),`<input type="checkbox" id="showProtected" ${h.LO.showProtected?"checked":""}>`],[(0,K.k)("brush size"),`<input type="checkbox" id="customBrushSize" ${We.brushSize>1?"checked":""}>\n            <input id="brushSize" type="range" value="${We.brushSize}" `+(1==We.brushSize?"disabled":"")+' min="2" '+`max="${t}" step="2">`+`<span id="brushSizeCounter">${We.brushSize-1}<span>`],[(0,K.k)("max saved pixels"),`<input id="savePixelsInp" type="number" min="0" value="${We.maxPlaced}" style="width:4rem">`],[(0,K.k)("disable chat colors"),`<input type="checkbox" id="disableChatColors" ${ie.colorsEnabled?"":"checked"}>`],[(0,K.k)("chat messages limit"),`<input type="number" id="chatLimit" value="${h.LO.chatLimit}" title="maximum messages in chat">`],[(0,K.k)("enable grid"),`<input type="checkbox" id="enableGridCB" ${1==un.grid.state?"checked":""}>`],[(0,K.k)("draw line length"),`<input type="checkbox" id="drawLineLenCB" ${un.line.drawLength?"checked":""} title="draw line length near it">`]]);On(e.body).append(n),On("#showProtected").on("change",(e=>{const t=e.target.checked;h.LO.showProtected=t,(0,h.k6)(t)})),On("#customBrushSize").on("change",(e=>{e.target.checked?(On("#brushSize").removeAttr("disabled"),Oe(On("#brushSize").val())):(On("#brushSize").attr("disabled"),Oe(1))})),On("#brushSize").on("input",(e=>{Oe(e.target.value)})),On("#savePixelsInp").on("change",(e=>{+(e=e.target).value<0&&(e.value=0),We.maxPlaced=+e.value,(0,M.UW)("maxPlaced",We.maxPlaced)})),On("#disableChatColors").on("change",(e=>{const t=e.target.checked;(0,M.UW)("disableColors",t.toString()),ie.setColors(!t)})),On("#chatLimit").on("change",(e=>{const t=parseInt(e.target.value,10);isNaN(t)||t<1||((0,M.UW)("chatLimit",t.toString()),h.LO.chatLimit=t)})),On("#enableGridCB").on("change",(e=>{const t=e.target.checked;(0,M.UW)("enableGrid",t.toString()),t?un.grid.show():un.grid.hide()})),On("#drawLineLenCB").on("change",(e=>{const t=e.target.checked;(0,M.UW)("drawLineLen",t.toString()),un.line.drawLength=t}))}async function Gn(){let e,t=new wn({title:(0,K.k)("Captcha"),center:!0,closeable:!1});if(t.created){const[e,n,s]=On(`<div>${(0,K.k)("Case insensitive, 0/o i/l are same")}. <a href="#">${(0,K.k)("Can't recognize?")}</a></div><div class="captchaContainer"></div><input class="fullWidthInput" type="text"></input>`);e.children[0].onclick=Gn;const[i]=On(`<div style="display:flex;justify-content:center">${(0,K.k)("Captcha").toUpperCase()}:&nbsp;&nbsp;</div>`);i.appendChild(s),t.body.appendChild(e),t.body.appendChild(n),t.body.appendChild(i),s.addEventListener("keydown",(async e=>{if("Enter"===e.key){if(0==s.value.length)return;let e=s.value;s.value="",await async function(e){const t=await Re("/captcha/solve",{method:"POST",body:{answer:e}}),n=await t.json();return void 0!==n.success&&n.success}(e)?t.close():Gn()}}))}else t=t.oldWindow;try{e=await async function(){const e=await Re("/captcha/get");return await e.text()}()}catch(e){return console.error("error downloading captcha image: "+e),L.socket.close(),t.close()}e=e.replace('stroke="black"','stroke="white"'),On(".captchaContainer",t.body).html(e),t.moveToCenter(),On("input",t.body).trigger("focus")}function Yn(){const e=new wn({title:kn((0,K.k)("tools")),center:!0});if(!e.created)return;const t=[[`<a href="/convert" target="_blank">${(0,K.k)("convert image into palette")}</a>`],[`<button id="screenshot">${(0,K.k)("save canvas")}</button>`],[`<button id="showPrevWipes">${(0,K.k)("tools.showPrevWipesBtn")}</button>`]];Le.role>=oe.MOD&&t.unshift([`<button id="searchUsersB">${(0,K.k)("search users")}</button>`]);const n=Un(t);On(e.body).append(n),On("#searchUsersB",n).on("click",(()=>{const e=new wn({title:kn((0,K.k)("search users")),center:!0});if(!e.created)return;const t=Un([[`<input type="text" placeholder="nickname" id="userSearchText" max="32" style="width:250px"> ${(0,K.k)("OR")} <input type="text" placeholder="id" id="userSearchId" max="32" style="width:50px"><input type="checkbox" id="searchIsBanned"><label for="searchIsBanned">${(0,K.k)("banned?")}</label>`],['<div id="searchUsersBody">']]);On(e.body).append(t);const n=On("#userSearchText");function s(e){if(!e||!e.length)return void On("#searchUsersBody").html("");let t=document.createElement("table");t.className="innerTable",t.innerHTML+="<tr><th>NICK</th><th>ID</th><th>ROLE</th><th>&nbsp;</th></tr>";for(let n of e){const e=k(n.name),s=document.createElement("button");s.className="userInfoBtn",s.innerHTML=`<img src="${Rn}">`,s.addEventListener("click",(async()=>{const e=await Re(`/userInfo?id=${n.id}`),t=await e.json();await ss.CreateWindow(t)}));const i=On(`<tr>\n                        <td>${e}</td><td>${n.id}</td><td>${n.role}</td><td></td>\n                    </tr>`);i[0].lastElementChild.appendChild(s),t.appendChild(i[0])}On("#searchUsersBody").html(t)}async function i(e,t,n){if(!n&&!e&&!t)return;if(e&&t)return;e&&(e=encodeURIComponent(e));const s=await Re(`/admin/users/search?isBanned=${n?1:0}&${t?`id=${t}`:`t=${e}`}`);return await s.json()}On("#userSearchId").on("input",(async e=>{let t=e.target.value.trim();if(t=+t,isNaN(t)||t<1||t>Number.MAX_SAFE_INTEGER)return;const n=On("#searchIsBanned")[0].checked;s(await i(null,t,n))})),On("#userSearchText").on("input",(async e=>{let t=n.val().trim();t=t.slice(0,32);const o=On("#searchIsBanned")[0].checked;s(await i(t,null,o))}))})),On("#screenshot").on("click",S),On("#showPrevWipes").on("click",(()=>{const t=new wn({title:kn((0,K.k)("prevWipesWinTitle"))});if(!t.created)return;t.body.style.maxHeight="200px",L.mobile?t.moveToCenter():t.moveTo(e.right+5,e.top);const n=Un(Object.keys(ve).map((function(e){return[`<button data-name="${e}" class="showWipeBtn">${e}</button>`]})));On(t.body).append(n),On(".showWipeBtn",t.body).on("click",(e=>{!async function(e){xe();const t=await async function(e){return new Promise(((t,n)=>{const s=new Image;s.style.imageRendering="pixelated",s.onload=()=>t(s),s.onerror=n,s.src=e}))}(ve[e]);be=function(){const{x:e,y:t,zoom:n,minX:s,minY:i,maxX:o,maxY:a}=$;return{x:e,y:t,zoom:n,minX:s,minY:i,maxX:o,maxY:a}}(),$.minX=-t.width/2,$.minY=-t.height/2,$.maxX=t.width/2,$.maxY=t.height/2,$.x=0,$.y=0,$.zoom=$.minZoom,globals.renderer.needRender=!0;const n=h.h/2-t.width/2,s=h.Uf/2-t.height/2;ye=new re((e=>{null===ke&&(ke=e,e.canvas.style.backgroundColor="gray");const i=$.zoom,o=pe(n,s);return e.drawImage(t,...o,t.width*i,t.height*i),1})),globals.fxRenderer.add(ye,1)}(e.target.dataset.name)}));const s=t.close;t.close=(...e)=>{xe(),s.call(t,...e)}}))}function Kn(){const e=new wn({title:kn((0,K.k)("LOG IN")),center:!0});if(!e.created)return;const t=Un([[`<a href="/api/auth/vk"><img src="${s}" class="authLogo">VK</a>`],[`<a href="/api/auth/discord"><img src="${i}" class="authLogo">DISCORD</a>`],[`<a href="/api/auth/google"><img src="${o}" class="authLogo">GOOGLE</a>`]]);On("td",t).css("text-align","left"),On("a",t).css("margin-left","15px"),On(e.body).append(t)}function Xn(){const e=new wn({title:(0,K.k)("help"),center:!0});if(!e.created)return;e.body.style.maxWidth="800px",e.body.style.width="90vw",e.body.style.height="90vh";const t=`<img class="smallSvgIcon" src="${Cn}">`,n=`<img class="smallSvgIcon" src="${En}">`,s=_n((0,K.k)("intro.introHeader"),`<div style="width:100%;text-align:center;"><img src="./img/goroxels.png" style="vertical-align: middle;">${(0,K.k)("intro.desc")}</div><br><br>\n    ${(0,K.k)("intro.desc2")}`,!1),i=_n((0,K.k)("how to play?"),`<div style="display:inline-flex">\n            <div>${(0,K.k)("intro.howToPlayDecs")}</div>\n            <div style="padding-left: 10px;">\n                <div class="desktop">\n                <video autoplay loop muted style="height:196px"><source src="./video/clickerMouse.webm" type="video/webm"></video>\n                </div>\n                <div class="mobile">\n                <video autoplay loop muted style="height:196px"><source src="./video/phoneDrawing.mp4" type="video/mp4"></video>\n                </div>\n            </div>\n        </div>`),o=_n((0,K.k)("tools"),`${(0,K.k)("intro.toolsDecs")}<br><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.toolsClicker")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/clicker.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${(0,K.k)("intro.toolsAS")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/as.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${(0,K.k)("intro.toolC")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/toolC.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.brush")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/brush2.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.line")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/line.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.flood")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/flood.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.grid")}<br><br></div>\n        <div class="desktop">\n            <img src="./img/unavailable.png" style="height:196px">\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${t}${n}${(0,K.k)("intro.ctrlZ")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/ctrlZ.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    ${t}${n}${(0,K.k)("intro.resetColors")}<br>`),a=_n((0,K.k)("intro.tools2header"),`<div style="width:100%;text-align:center;"><b>${(0,K.k)("intro.tools2desc")}</b></div><br><br>\n    ${t}${(0,K.k)("intro.toolsHiders")}<br><br>\n    ${t}${n}${(0,K.k)("intro.multicol")}<br>\n    ${(0,K.k)("intro.multicol2")}<br>\n    ${(0,K.k)("intro.multicol3")}<br><br>\n    ${t}${(0,K.k)("intro.sendCoords")}<br><br>\n    ${t}${(0,K.k)("intro.templateTools")}<br>`),r=_n((0,K.k)("template"),`<div style="width:100%;text-align:center;"><b>${(0,K.k)("intro.templateIntro")}</b></div><br><br>\n    ${(0,K.k)("intro.templateDesc")}<br><br>\n    ${(0,K.k)("intro.templateDescConvert")}<br><br>\n    <div class="helpWithVideoCont mobile">\n        <video autoplay loop muted style="height:196px"><source src="./video/patternDemo.webm" type="video/webm"></video>\n    </div>\n    <div class="helpWithVideoCont">\n        <div>${(0,K.k)("intro.templateDescReminder")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/patternDemo.webm" type="video/webm"></video>\n        </div>\n    </div><br>`),l=_n((0,K.k)("intro.authorHeader"),`${(0,K.k)("intro.authorText")}<br>\n        ${(0,K.k)("intro.authorContacts")}<br>\n        ${(0,K.k)("intro.telegram_channel")}: <a href="https://t.me/goroxels">t.me/goroxels</a><br>\n        ${(0,K.k)("intro.my_boosty")} <a href="https://boosty.to/gorox">https://boosty.to/gorox</a>\n        <div style="text-align:center"><img src="./img/3rdcf.png" title="ТРЕТЬЯ КОНФА"></div>`);On(e.body).append(s,i,o,a,r,l)}const Zn=n.p+"/img/user.svg",qn=n.p+"/img/mod-badge.svg",Vn=n.p+"/img/admin-badge.svg";n.p;var Jn=n(7959);const Qn=n(4692),es=n(2924),ts={};es.keys().map(es).forEach((e=>{const t=e.default.match(/([\w\d_]+)\.png$/);ts[t[1]]=e.default}));const ns=Qn("#usersTable");class ss{static async CreateWindow(e,t){const n=new wn({center:!0,title:`${e.name||(0,K.k)("PLAYER")+" "+(t||e.id)}`}),s=new Map;if(e.registered&&(s.set("name",k(e.name)),s.set("mail",k(e.email))),s.set("id",e.id||t),e.ip)if(e.cc&&"XX"!==e.cc){const t=e.cc;s.set("ip",e.ip+` [${t}]`),s.set("ip",s.get("ip")+`<img src="${location.protocol}//flagcdn.com/h20/${t.toLowerCase()}.png" style="margin-left:1px;height:13px;">`)}else s.set("ip",e.ip);if(s.set("role",e.role),void 0!==e.role&&Le.role===oe.ADMIN){if(Le.id!==e.id){const t=e.role;let n="";Object.keys(oe).forEach((e=>{n+=`<option ${e===t?"selected":""}>${e}</option>`})),e.role=t?oe[t]:null,s.set("role",`<select type="role">${n}</select>`)}const t=e.badges||[];requestAnimationFrame((()=>{t.forEach((e=>r(e.name)))}));let n=Qn('<div class="badgesList"></div><button class="addBadgeBtn" title="Add Badge">+</button>');s.set("badges",n.map((function(){return this.outerHTML})).get().join(""))}let i=[...s.keys(s)].map((e=>[e,s.get(e)])),o=[];i=i.filter((([e,t])=>!!t)),Le.role>=oe.MOD&&(o=[['<input class="alertInput">',`<button class="sendAlert">${(0,K.k)("btn.sendAlert")}</button>`],['<input class="modalInput">',`<button class="sendModal">${(0,K.k)("btn.sendModal")}</button>`],[`<input type="checkbox" id="${e.id}-shadow-cb" class="shadowCheckbox" ${e.shadowBanned?"checked":""}>`,`<label for="${e.id}-shadow-cb">${(0,K.k)("label.shadowBanned")}</label>`]],e.role||Le.id===e.id||o.push([`<button class="banByIp">${(0,K.k)("Ban by ip")}</button>`]));let a=i.concat(o);function r(t){const s=Qn(`<div class="badge" title="${t}">\n                            <img src="${ts[t]}" alt="${t}">\n                        </div>`);Qn(".badgesList",n.body).append(s),s.on("click",(()=>{Re(`/badges/del?userId=${e.id}&badge=${t}`,{method:"POST"}).then((async e=>{(await e.json()).ok&&s.remove()}))}))}Qn(n.body).append(Un(a)),Qn("select[type=role]",n.body).on("change",(async t=>{const n=t.target.value,s=e.id,i=await fetch("/api/admin/changerole",{method:"POST",body:JSON.stringify({id:s,role:n}),headers:{"Content-Type":"application/json"}}),o=await i.json();o.errors?o.errors.forEach((e=>{Jn.error(e,(0,K.k)("ERROR"))})):Jn.success((0,K.k)("Changed role to")+" "+n)})),Qn(".sendAlert",n.body).on("click",(()=>{const e=Qn(".alertInput",n.body).val();0!=e.length&&(Qn(".alertInput",n.body).val(""),L.socket.sendAlert(t,e))})),Qn(".sendModal",n.body).on("click",(()=>{const e=Qn(".modalInput",n.body).val();0!=e.length&&(Qn(".modalInput",n.body).val(""),L.socket.sendAlert(t,e,!0))})),Qn(".banByIp",n.body).on("click",(async()=>{const t=e.ip;if(!t)return Jn.error((0,K.k)("No ip!"));const n=await Re(`/admin/banPlayer?ip=${t}`);(await n.json()).success&&Jn.success((0,K.k)("Success"))})),Qn(".shadowCheckbox",n.body).on("click",(async t=>{const n=t.target.checked,s=e.id,i=await Re(`/admin/banPlayer/shadow?uid=${s}&banned=${n}`,{method:"POST"});(await i.json()).success&&Jn.success((0,K.k)("Success"))})),Qn(".addBadgeBtn",n.body).on("click",(async()=>{const t=new wn({title:"Badges for "+e.id,x:n.x+n.width+5,y:n.y});if(t.created){t.body.style.display="flex",t.body.style.gap="2px";for(const[n,s]of Object.entries(ts)){const i=Qn(`<div style="padding: 3px; background: gray; border-radius: 4px; max-width: fit-content;">\n                <img src="${s}">\n                </div>`);i.on("click",(()=>{Re(`/badges/add?userId=${e.id}&badge=${n}`,{method:"POST"}).then((async e=>{(await e.json()).ok&&r(n)}))})),Qn(t.body).append(i)}}}))}constructor(e,t,n,s,i,o=null){e||(e="ID "+t),this.name=e,this.id=t,this.userId=n,this.registered=s,this.role=i,this.conns=[t],this.badges=o;const a=k(this.name);let r=L.chat.parseColors(a).replace(/<[^>]*>/g,"");const l=this.getRoleBadgeAndTitle();this.element=Qn(`<tr class="tableRow">\n                <td title="id ${t}" class="user">\n                    ${l?`<img src="${l.icon}" title="${l.tooltip}" class="roleBadge">`:""}\n                    <button class="userInfoBtn minrole-trusted"><img style="height: 20px" src="${Zn}"></button>\n                    <span class="name">${r}</span>\n                    <span class="badges"></span>\n                    <span class="xConns"></span>\n                </td>\n                <td></td>\n            </tr>`),this.nameEl=Qn(".name",this.element),this.coordsEl=Qn(this.element.children()[1]),this.nameEl.on("click",(function(){const e=this.innerText;L.elements.chatInput.value+=e+", ",L.elements.chatInput.focus()})),Qn(".userInfoBtn",this.element).on("click",(async()=>{const e=this.registered,t=e?this.userId:this.id,n=await fetch(`/api/userInfo?id=${t}${e?"":"&unreg=1"}`),s=await n.json();await ss.CreateWindow(s,this.id)})),this.coordsEl.on("click",(()=>{const[e,t]=this.coordsEl.text().slice(1,-1).split(", ").map((e=>parseInt(e,10)));Number.isInteger(e)&&Number.isInteger(t)&&$.centerOn(e,t)})),ns[0].appendChild(this.element[0]),Le.updateRoleRelatedHtml()}async loadBadges(){if(null===this.userId)return;const e=await Re(`/userInfo/badges?id=${this.userId}`),t=await e.json();this.badges=t}updateBadges(){Qn(".badges",this.element).append(this.getAchieveBadgesHtml())}getAchieveBadgesHtml(){if(!this.badges)return"";let e="";for(let t of this.badges){const{name:n,width:s,height:i}=t,o=s?`width: ${s}px;`:"",a=i?`height: ${i}px;`:"";e+=`<img src="${ts[n]}" style="${o}${a}">`}return e}getRoleBadgeAndTitle(){if(!this.role)return null;let e,t;switch(this.role){case"MOD":e="mod",t=qn;break;case"ADMIN":e="admin",t=Vn;break;default:return null}return{tooltip:e,icon:t}}updateCoords(e,t,n){this.coordsEl.css("color",h.p4[e]),this.coordsEl.text(`(${t}, ${n})`)}close(e){this.conns.splice(this.conns.indexOf(e),1),0===this.conns.length?this.destroy():this.updateX(),delete L.users[e]}destroy(){this.element.remove()}newConnection(e){this.conns.push(e),this.updateX()}updateX(){const e=this.conns.length>1?`[x${this.conns.length}]`:"";Qn(".xConns",this.element).text(e)}}var is=n(7959),os=n(4692);class as extends(r()){constructor(e){super();const t=location.protocol.startsWith("https")?"wss":"ws",n=location.hostname||"localhost";this.url=`${t}://${n}:${e}`,this.pendingPixels={},this.connectedOnce=!1,this.connect()}get connected(){return this.socket&&this.socket.readyState===WebSocket.OPEN}connect(){this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.sendChatSubscribe("global",this.connectedOnce),this.sendChatSubscribe(h.OP,this.connectedOnce),this.sendCanvas(h.OE),this.emit("opened"),console.log("Socket has been connected"),this.connectedOnce||(this.connectedOnce=!0)},this.socket.onmessage=this.onmessage.bind(this),this.socket.onclose=()=>{this.emit("closed"),Object.values(L.users).forEach((e=>e.close(e.id))),L.users={},L.chunkManager.clearLoadingChunks(),setTimeout((()=>{console.log("reconnect"),this.reconnect()}),1e3*Math.random())}}close(){this.socket.close()}reconnect(){this.socket.onmessage=null,this.socket.onopen=null,this.socket.onclose=null,this.connect()}onmessage({data:e}){if("string"==typeof e)this.onStringMessage(e);else{if(!e.byteLength)return;this.onBinaryMessage(e)}}onStringMessage(e){let t;try{t=JSON.parse(e)}catch(t){return void console.log("onStringMessage message decoding error: "+t,"message: "+e)}switch(t.c){case"u":{const{nick:e,userId:n,id:s,registered:i,role:o}=t;let a;if(e&&(a=Object.values(L.users).find((t=>t.name===e))),a)L.users[s]=a,a.newConnection(s);else{const t=L.users[s]=new ss(e,s,n,i,o);t.loadBadges().then(t.updateBadges.bind(t)).catch((e=>console.error("failed to load badges",e)))}break}case"l":{const e=t.id;L.users[e]&&L.users[e].close(e);break}case"e":t.errors.forEach((e=>{"error.captcha"===e&&(wn.Exists("Captcha")||Gn()),is.error(e,(0,K.k)("Error from the Socket:"),{preventDuplicates:!0})}));break;case"c":ie.addMessage(t);break;case"a":if(0===t.type)is.info(t.msg,"ALERT",{timeOut:3e5,extendedTimeOut:3e5});else{const e=k(t.msg),n=new bn;n.init();const s=os(`<div style="margin:0;padding:5px;text-align:center;">\n                            <h1>ADMIN:</h1>\n                            <p>${e}</p>\n                            <button style="padding: 8px;">OK</button>\n                        </div>`);n.contEl.appendChild(s[0]),os("button",s).on("click",(()=>{n.close()}))}break;case"m":We.id=t.id;break;case"r":location.reload();break;case"rc":{const e=t.chunks;L.chunkManager.reloadChunks(e);break}}}onBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case 5:Gn();break;case 0:{const e=t.getUint8(1),n=t.getUint8(2),s=c().inflate(t.buffer.slice(3));this.emit("chunk",e,n,s);break}case 1:{const e=t.getUint16(1),n=t.getUint16(3),s=t.getUint8(5),i=t.getUint32(5);this.onIncomingPixel([e,n,s],i);break}case 2:{const e=t.getUint16(1);this.emit("online",e);break}case 4:{const e=!!t.getUint8(1),n=t.getUint32(2,!1);let s,i,o;for(let a=6;a<t.byteLength;a+=5)s=t.getUint16(a),i=t.getUint16(a+2),o=t.getUint8(a+4),e?this.emit("protect",s,i,o):this.emit("place",s,i,o,n);const a=L.users[n];a&&a.updateCoords(o,s,i);break}case 6:this.socket.send(new Uint8Array([6]));break;case 7:{const e=9;(t.byteLength-1)/e%1!=0&&console.warn("TotalPixels length is not integer");for(let n=1;n<t.byteLength;n+=e){const e=t.getUint16(n),s=t.getUint16(n+2),i=t.getUint8(n+4),o=t.getUint32(n+5);this.onIncomingPixel([e,s,i],o)}break}case 8:{const e=t.getUint8(1);this.emit("radio",e);break}}}onIncomingPixel([e,t,n],s){const i=L.users[s];i&&i.updateCoords(n,e,t);const o=e+","+t;let a=this.pendingPixels[o];a&&(clearTimeout(a),delete this.pendingPixels[o]),this.emit("place",e,t,n,s),s===We.id&&_e(We.placedCount++)}requestChunk(e,t){let n=new DataView(new ArrayBuffer(3));n.setUint8(0,0),n.setUint8(1,e),n.setUint8(2,t),this.socket.send(n.buffer)}sendPixel(e,t,n){let s=new DataView(new ArrayBuffer(6));s.setUint8(0,1),s.setUint16(1,e),s.setUint16(3,t),s.setUint8(5,n),this.socket.send(s.buffer)}sendPixels(e,t=!1){let n=new DataView(new ArrayBuffer(6+5*e.length));n.setUint8(0,4),n.setUint8(1,t?1:0);for(let t=0;t<e.length;t++){let s=5*t+6;const[i,o,a]=e[t];n.setUint16(s,i),n.setUint16(s+2,o),n.setUint8(s+4,a)}this.socket.send(n.buffer)}sendCanvas(e){const t=new DataView(new ArrayBuffer(2));t.setUint8(0,3),t.setUint8(1,e),this.socket.send(t.buffer)}sendChatSubscribe(e,t){const n={c:"s",ch:e,reconnect:t};this.socket.send(JSON.stringify(n))}sendChatMessage(e,t,n=!1){const s={c:"c",msg:e,ch:t};n&&(s.whisper=n),this.socket.send(JSON.stringify(s))}sendChatWhisper(e,t,n){return this.sendChatMessage(e,t,n)}sendAlert(e,t,n=!1){const s={c:"a",to:e,msg:t,type:n?1:0};this.socket.send(JSON.stringify(s))}}class rs{constructor(e){this.url=e,this.loaded=!1,this.canvas=null,this._load()}_load(){const e=document.createElement("canvas"),t=new Image;t.src=this.url,t.onload=()=>{e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),this.canvas=e,this.loaded=!0,this.onload()}}createFilledCanvas(e,t,n,s){const i=this.canvas.getContext("2d").createPattern(this.canvas,"repeat"),o=document.createElement("canvas");o.width=e,o.height=t;const a=o.getContext("2d");return a.fillStyle=i,a.save(),a.translate(n,s),a.fillRect(-n,-s,e,t),a.restore(),o}onload(){}}const ls=n.p+"/img/protectedPattern.png";class cs{constructor(e,t,n){this.x=e,this.y=t,this.width=h.ZL,this.height=h.ZL,this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=h.ZL,this.ctx=this.canvas.getContext("2d"),this.imgData=this.ctx.createImageData(h.ZL,h.ZL),this.view=new Uint32Array(this.imgData.data.buffer),this.protectedPatternChunkSized=null,this._protectedPattern=new rs(ls),this._protectedPattern.onload=()=>{this.needRender=!0;const e=[this.x*this.width%this._protectedPattern.canvas.width,this.y*this.height%this._protectedPattern.canvas.height];this.protectedPatternChunkSized=this._protectedPattern.createFilledCanvas(this.width,this.height,e[0],e[1])},this.pCanvas=document.createElement("canvas"),this.pCanvas.width=this.pCanvas.height=h.ZL,this.pCtx=this.pCanvas.getContext("2d"),this.pImgData=this.pCtx.createImageData(h.ZL,h.ZL),this.pView=new Uint32Array(this.pImgData.data.buffer),this.needRender=!0,this.fromBuffer(n)}render(){this.needRender&&(this.needRender=!1,this.ctx.putImageData(this.imgData,0,0),h.LO.showProtected&&(this.ctx.globalAlpha=.7,this.pCtx.putImageData(this.pImgData,0,0),null!==this.protectedPatternChunkSized&&(this.pCtx.globalCompositeOperation="source-in",this.pCtx.drawImage(this.protectedPatternChunkSized,0,0),this.pCtx.globalCompositeOperation="source-over"),this.ctx.drawImage(this.pCanvas,0,0),this.ctx.globalAlpha=1))}fromBuffer(e){let t,n;for(let s=0;s<e.byteLength;s++)t=e[s],n=128&t,n&&(this.pView[s]=4294901760),this.view[s]=h.Ft[127&t]}get(e,t){return this.view[e+t*h.ZL]}set(e,t,n){const s=e+t*h.ZL;this.view[s]=n,this.needRender=!0}setProtect(e,t,n){const s=e+t*h.ZL;this.pView[s]=n?4294901760:0,this.needRender=!0}getProtect(e,t){const n=e+t*h.ZL;return!!this.pView[n]}}let hs=!1,ds=null,us=[];function ms(e){hs?e(ds):us.push(e)}class ps{constructor(e,t){this.x=e,this.y=t}async load(){return new Promise(((e,t)=>{const n=`${h.OE}-${this.x}-${this.y}`;ms((async()=>{try{const t=await this._loadFromDb(n),s=this._fromData(t);e(s)}catch(e){t(e)}}))}))}async _loadFromDb(e){return new Promise(((t,n)=>{let s=ds.transaction("chunkPlaceholders","readonly"),i=s.objectStore("chunkPlaceholders").get(e);i.onsuccess=function(){const e=i.result;return t(void 0===e?null:e)},i.onerror=function(e){n(i.error)},s.onabort=function(){n(i.error)}}))}_fromData(e){const t=document.createElement("canvas");if(e){t.width=e.width,t.height=e.height;const n=t.getContext("2d"),s=n.createImageData(t.width,t.height);s.data.set(e.data),n.putImageData(s,0,0)}return E(t,h.ZL,h.ZL)}async save(e){return new Promise(((t,n)=>{const s=`${h.OE}-${this.x}-${this.y}`;ms((async()=>{try{await this._saveToDb(s,e),t()}catch(e){n(e)}}))}))}async _saveToDb(e,t){return new Promise(((n,s)=>{const i=E(t,50,50).getContext("2d").getImageData(0,0,50,50);let o=ds.transaction("chunkPlaceholders","readwrite"),a=o.objectStore("chunkPlaceholders").put({chunk_key:e,width:i.width,height:i.height,data:i.data});a.onsuccess=function(){n()},a.onerror=function(e){s(a.error)},o.onabort=function(){s(a.error)}}))}}class gs{constructor(){this.chunks=new Map,this.loadingChunks=new Set,L.socket.on("place",((e,t,n)=>{this.setChunkPixel(e,t,n),L.renderer.needRender=!0})),L.socket.on("protect",((e,t,n)=>{this.setProtect(e,t,n),L.renderer.needRender=!0}))}clearChunks(){this.chunks.clear()}getChunkKey(e,t){return e<<4|t}reloadChunks(e){if(e)for(const{x:t,y:n}of e)this.chunks.delete(this.getChunkKey(t,n));else this.clearChunks();let t=[...this.chunks.values()];const n=setInterval((()=>{if(this.loadingChunks.size<3){const e=t.pop();if(!e)return clearInterval(n);this.loadChunk(e.x,e.y)}}),30)}loadChunk(e,t){let n=this.getChunkKey(e,t);L.socket.connected&&!this.loadingChunks.has(n)&&this.loadingChunks.size<5&&(this.loadingChunks.add(n),Re(`/getchunk?canvas=${h.OE}&x=${e}&y=${t}`,{credentials:"omit"}).then((async n=>{let s=this.getChunkKey(e,t);this.loadingChunks.has(s)&&this.loadingChunks.delete(s);const i=await n.arrayBuffer();let o=new cs(e,t,new Uint8Array(i));this.chunks.set(s,o),o.render(),new ps(e,t).save(o.canvas),L.renderer.needRender=!0})))}clearLoadingChunks(){this.loadingChunks=new Set}hasChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)}getChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)?this.chunks.get(n):0}getChunkPixel(e,t){let[n,s,i,o]=ge(e,t),a=this.getChunk(n,s);if(!a||e<0||t<0)return-1;let r=a.get(i,o);return h.TK[r]}setChunkPixel(e,t,n){let[s,i,o,a]=ge(e,t),r=this.getChunkKey(s,i);this.chunks.has(r)&&this.chunks.get(r).set(o,a,h.Ft[n])}setProtect(e,t,n){let[s,i,o,a]=ge(e,t),r=this.getChunkKey(s,i);this.chunks.has(r)&&this.chunks.get(r).setProtect(o,a,n)}getProtect(e,t){let[n,s,i,o]=ge(e,t),a=this.getChunk(n,s);return a?a.getProtect(i,o):-1}dumpAll(){const e=document.createElement("canvas");e.width=h.h,e.height=h.Uf;const t=e.getContext("2d");return this.chunks.forEach((e=>{if(!e.canvas)return;const n=e.x*h.ZL,s=e.y*h.ZL;t.drawImage(e.canvas,n,s)})),e}}const fs=n.p+"/img/chunkPlaceholder.png",ws=w();class vs{constructor(e){this.ctx=e,this.canvas=this.ctx.canvas,this.chunkPlaceholderPattern=new rs(fs),this.chunkPlaceholderPattern.onload=()=>{this.needRender=!0},this.chunkPreviews={},this.needRender=!0,this.preRendered={brush:{canvas:void 0,ctx:void 0,imageData:void 0,circle:void 0}},this.preRender()}preRender(){this.preRenderBrush()}preRenderBrush(){const e=We.brushSize,t=$.zoom;if(t<1)return;const n=document.createElement("canvas");n.width=n.height=t*(e+1);const s=n.getContext("2d"),i=(s.getImageData(0,0,n.width,n.height).data,e/2),o=He.filledCircle(0,0,i);let a=[];for(let t=0;t<e+1;t++)a.push(new Array(e+1).fill(0));o.forEach((([e,t])=>{a[e+i][t+i]=1})),s.beginPath(),s.lineWidth=t/4,s.strokeStyle=h.p4[We.color],s.lineCap="square",s.fillStyle="blue";for(let n=0;n<e;n++)for(let i=0;i<e;i++){if(r(n,i))continue;let e=r(n,i-1),o=r(n-1,i),a=r(n+1,i),l=r(n,i+1);e&&(s.moveTo(n*t,i*t),s.lineTo((n+1)*t,i*t)),o&&(s.moveTo(n*t,i*t),s.lineTo(n*t,(i+1)*t)),a&&(s.moveTo((n+1)*t,i*t),s.lineTo((n+1)*t,(i+1)*t)),l&&(s.moveTo((n+1)*t,(i+1)*t),s.lineTo(n*t,(i+1)*t))}function r(t,n){return t<0||t>=e||n<0||n>=e||!a[t][n]}s.stroke(),s.closePath(),this.preRendered.brush.canvas=n,this.preRendered.brush.ctx=n,this.preRendered.brush.imageData=n,this.preRendered.brush.circle=o}requestRender(){this.needRender&&(this.needRender=!1,this.render()),L.fxRenderer.render()}correctSmoothing(){ws||($.zoom<1?(this.ctx.imageSmoothingEnabled=!0,this.ctx.canvas.style.imageRendering="auto"):(this.ctx.imageSmoothingEnabled=!1,this.ctx.canvas.style.imageRendering="pixelated"))}render(){this.correctSmoothing();let e=function(){let[e,t]=me(0,0),[n,s]=me(window.innerWidth,window.innerHeight),i=e/h.ZL|0,o=n/h.ZL+1|0,a=t/h.ZL|0,r=s/h.ZL+1|0,l=[];for(let e=Math.max(i,0);e<Math.min(o,h.Av);e++)for(let t=Math.max(a,0);t<Math.min(r,h.Wr);t++)l.push([e,t]);return l}();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);let t=$.x+f[0]-(this.canvas.width>>1)/$.zoom,n=$.y+f[1]-(this.canvas.height>>1)/$.zoom,s=$.zoom;1===s&&(t=Math.floor(t),n=Math.floor(n)),this.ctx.save(),this.ctx.translate(Math.floor(-t*s),Math.floor(-n*s)),this.ctx.scale(s,s),e.forEach((e=>{let[t,n]=e,s=t*h.ZL,i=n*h.ZL;if(!L.chunkManager.hasChunk(t,n)){L.chunkManager.loadChunk(t,n);let e=this.chunkPreviews[`${t}-${n}`];return void(e?e.loaded&&null!==e.data?(this.ctx.drawImage(e.data,s,i,h.ZL,h.ZL),this.chunkPlaceholderPattern.loaded&&(this.ctx.globalAlpha=.5,this.ctx.drawImage(this.chunkPlaceholderPattern.canvas,s,i,h.ZL,h.ZL),this.ctx.globalAlpha=1)):this.chunkPlaceholderPattern.loaded&&this.ctx.drawImage(this.chunkPlaceholderPattern.canvas,s,i,h.ZL,h.ZL):(e=this.chunkPreviews[`${t}-${n}`]={loaded:!1,data:null},new ps(t,n).load().then((t=>{e.data=t,e.loaded=!0,this.needRender=!0}))))}const o=L.chunkManager.getChunk(t,n);o.render(),this.ctx.drawImage(o.ctx.canvas,s,i)})),this.ctx.restore()}}var bs=n(4692),ys=n(7959);const ks=L.elements.coords;function xs(e,t){let[n,s]=me(e,t);n===We.x&&s===We.y||(We.x=n,We.y=s,ks.innerText=`(${We.x}, ${We.y})`,-1!=We.color&&$.zoom>1&&(L.renderer.needRender=!0))}const Cs=w();class Es extends(r()){constructor(){super(),this.tools=un,this.tool=un.mover,this._keyBinds={},this._colorBinds={},this.activeTools={},this.addTools(),this.loadBinds(),this.initEvents(),this.ctrlDown=!1,this.altDown=!1,this.toolChangeBlocked=!1,Le.callOnLoaded(this.filterTools.bind(this))}filterTools(){Object.keys(this.tools).forEach((e=>{this.tools[e].requiredRole>Le.role&&(delete this._keyBinds[this.tools[e].key],Cs&&bs(`#tool_${e}`).remove())}))}addTools(){const e=document.getElementById("tools");Object.keys(this.tools).forEach((t=>{const n=this.tools[t];if(Cs){if(!n.icon)return;let s=document.createElement("div");s.classList="toolContainer",s.id=`tool_${t}`;let i=document.createElement("img");i.className="toolIcon",i.src=n.icon,s.appendChild(i),e.appendChild(s),s.addEventListener("pointerdown",this.selectTool.bind(this,n)),"mover"===n.name&&this.selectTool(n)}else We&&(this._keyBinds[n.key]=n)}))}getToolKey(e){for(const[t,n]of Object.entries(this.tools))if(e===n)return t;return null}selectTool(e){if(this.toolChangeBlocked)return;let t=document.getElementsByClassName("toolContainer selected")[0];t&&(t.className="toolContainer");const n=this.getToolKey(e);document.getElementById(`tool_${n}`).classList=["toolContainer selected"],this.tool=e}blockToolChange(){this.toolChangeBlocked=!0}unblockToolChange(){this.toolChangeBlocked=!1}initEvents(){let e=L.eventManager;if(Cs)e.on("zoom",(e=>{$.zoom*=e+1,$.checkZoom(),L.renderer.needRender=!0,L.fxRenderer.needRender=!0})),e.on("mousedown",(e=>{xs(e.clientX,e.clientY)})),e.on("mousemove",(e=>{xs(e.clientX,e.clientY)})),[["mousedown","down"],["mousemove","move"],["mouseup","up"]].forEach((t=>{const[n,s]=t;e.on(n,(e=>{let t=this.tool;e&&e.gesture&&(this.tool.emit("_gesture"),t=this.tools.mover),t&&(t.emit(s,e),this.emit(s,e))}))}));else{e.on("mouseup",(e=>{})),e.on("mousemove",(e=>{xs(e.clientX,e.clientY),this.tool.emit("move",e),this.emit("move",e)}));const t=e=>{if(L.lockInputs)return;let t=y(e);if(!t)return;const n=this._keyBinds[t];n&&(this.tool=n,n.emit("down",e))};e.on("keydown",t),e.on("mousedown",t);const n=e=>{if(L.lockInputs)return;let t=y(e);if(!t)return;const n=this._keyBinds[t];for(let s of Object.keys(this.tools)){const i=this.tools[s];i.key&&i!==n&&t===i.key&&i.emit("up",e)}n&&(e.preventDefault(),e.stopPropagation(),n.emit("up",e))};e.on("keyup",n),e.on("mouseup",n),e.on("wheel",(e=>{const t=$.zoom;$.zoomTo(e.deltaY);const n=e.clientX-window.innerWidth/2,s=e.clientY-window.innerHeight/2;$.moveTo(n/t,s/t),$.moveTo(-n/$.zoom,-s/$.zoom),"yes"===localStorage.getItem("iHaveProblems")&&($.x=Math.round($.x),$.y=Math.round($.y),L.renderer.needRender=!0)}))}function t(e){this.ctrlDown=e.ctrlKey,this.altDown=e.altKey}e.on("keydown",t.bind(this)),e.on("keyup",t.bind(this)),e.on("tick",(e=>{Object.keys(this.tools).forEach((t=>{const n=this.tools[t];n.listenerCount("tick")>0&&n.emit("tick",e)}))}))}changeKey(e,t,n=!0){if(n){const t=e.key;delete this._keyBinds[t]}e.key=t,this._keyBinds[t]=e}loadBinds(){const e=(0,M.yN)("keyBinds");let t,n;try{if(t=JSON.parse(e),!t)return}catch{return ys.error("Error on parsing key binds from local storage"),void localStorage.removeItem("keyBinds")}this._keyBinds={};for(let e of Object.keys(t))(n=this.findByName(e))&&this.changeKey(this.tools[n],t[e],!1)}saveBinds(){let e={};for(const t of Object.values(un))t.key&&(e[t.name]=t.key);(0,M.UW)("keyBinds",JSON.stringify(e))}findByName(e){return Object.keys(this.tools).find((t=>this.tools[t].name===e))}initColorBinds(){}loadColorBinds(){}}const Rs=n.p+"/font/winamp.png",Is=n.p+"/font/winamp.txt";var Ss=n(146);class Ps{constructor(e,t,n,s){Object.assign(this,{x:e,y:t,w:n,h:s})}}let Ls;function Ms(){We.switchColor(Ls[0]),We.switchSecondColor(Ls[1])}function As(){const e=new $s;e.init(),window.wPlayer=e}let Bs=!1,Ds=[];async function Ts(){const e=await R(Ss.default),t=e.width,n=e.height,s=-e.width-5,i=0;let o=new re((function(t){const n=$.zoom,[o,a]=pe(s,i);return this.needRender&&this.redraw(),t.save(),t.scale(n,n),t.drawImage(e,o/n,a/n),t.restore(),1}));L.fxRenderer.add(o,2);let a=0,r=[];function l(e){h(...me(e.clientX,e.clientY))&&(a=Date.now())}async function c(e){h(...me(e.clientX,e.clientY))&&Date.now()-a<500&&await async function(){(function(){o&&(L.fxRenderer.remove(o),o=null);for(const[e,t]of r)L.eventManager.off(e,t);r=[]})(),As()}()}function h(e,o){return e>=s&&e<s+t&&o>=i&&o<i+n}L.eventManager.on("mousedown",l),L.eventManager.on("mouseup",c),r.push(["mousedown",l]),r.push(["mouseup",c])}document.addEventListener("click",(()=>{Bs=!0,Ds.forEach((e=>e())),Ds.length=0}));class $s{constructor(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.playerPosition=JSON.parse((0,M.yN)("winamp.position",!0)||"[-275,0]"),this.sndBalance=0,this.volumeLvl=+((0,M.yN)("winamp.volume",!0)||"0.5"),this.queue=null,this.currentTrack=null,this.images=null,this.needRender=!0,this.startPolling(),this.config={width:275,height:348,headerRect:new Ps(2,2,262,12),closeBtnRect:new Ps(265,4,7,7),volumeBoundsRect:new Ps(108,61,63,4),soundBalanceBoundsRect:new Ps(178,61,35,4),volumeSliderRect:new Ps(-1,-1,-1,-1),balanceSliderRect:new Ps(-1,-1,-1,-1),titleRect:new Ps(111,24,155,12),kbpsRect:new Ps(111,41,16,10),khzRect:new Ps(156,41,11,10),mm1Rect:new Ps(48,26,9,13),mm2Rect:new Ps(60,26,9,13),ss1Rect:new Ps(78,26,9,13),ss2Rect:new Ps(90,26,9,13),progressSliderBndRect:new Ps(16,72,249,10),queueBoxRect:new Ps(18,257,238,48)},this._cache={},this._holdingButton=null,this._lastHoldPos=null,this._destroyed=!1,this.noFeed=!1,this.title=null,this.visibleTitle=null,this._boundHandlers={},this._socketHandlers={}}addAudioStoppedListeners(){this.audio.addEventListener("pause",(()=>{this.audio._destroyed||this.audio.play().catch((e=>{console.warn("Resume blocked until user interaction:",e)}))})),this.audio.addEventListener("stalled",(()=>{console.warn("Stream stalled"),this.restartStream()})),this.audio.addEventListener("error",(e=>{console.error("Audio error",e),this.restartStream()})),this.audio.addEventListener("ended",(()=>{console.warn("Stream ended"),this.restartStream()}))}async init(){(0,M.UW)("radioLover","1"),await this.loadMaterials(),this.recalculateButtons(),this.initTouchControls(),this.setTitle("Goroxels Radio 1.0 alpha"),this.canvas.width=this.config.width,this.canvas.height=this.config.height,this._fx=new re(this.render.bind(this)),L.fxRenderer.add(this._fx,2),await this.updateSong(),this.startPolling(),this._socketHandlers.radio=e=>{switch(e){case 0:this.updateSong();break;case 1:this.updateQueue()}},this._socketHandlers.opened=()=>{this.updateSong()},L.socket.on("radio",this._socketHandlers.radio),L.socket.on("opened",this._socketHandlers.opened),this.ackRender(),this.initAutoRender()}volume(e){this.volumeLvl=e,this.gainNode.gain.value=e,(0,M.UW)("winamp.volume",e.toString(),!0)}balance(e){this.sndBalance=e,this.pannerNode.pan.value=e}initAutoRender(){setInterval((()=>this.ackRender()),1e3)}initTouchControls(){const e=this;function t(t){e._lastHoldPos=null,$.enableMove(),e._holdingButton&&(e.onObjMouseup.call(e,e._holdingButton,t),e._holdingButton=!1,setTimeout(Ms))}this._boundHandlers.mousedown=n=>{if(!this._destroyed)return n.gesture?t(n):void function(n){e._holdingButton&&t(n);let s=e.getObjectAtPosition(n.clientX,n.clientY);s&&(Ls=[We.color,We.secondCol],We.switchColor(-1),We.switchSecondColor(-1),$.disableMove(),e.onObjMousedown.call(e,s,n),e._lastHoldPos=me(n.clientX,n.clientY))}(n)},this._boundHandlers.mouseup=e=>{this._destroyed||t(e)},this._boundHandlers.mousemove=t=>{this._destroyed||t.gesture||function(t){e._holdingButton&&(e.onObjMousemove.call(e,e._holdingButton,t),e._lastHoldPos=me(t.clientX,t.clientY))}(t)},L.eventManager.on("mousedown",this._boundHandlers.mousedown),L.eventManager.on("mouseup",this._boundHandlers.mouseup),L.eventManager.on("mousemove",this._boundHandlers.mousemove)}close(){(0,M.UW)("radioLover","0"),this.audio&&(this.audio._destroyed=!0,this.audio.pause(),this.audio.src="",this.audio.remove()),this.audioCtx&&this.audioCtx.close(),clearTimeout(this.__pollTimeout),clearInterval(this._titleRollerInterval),L.fxRenderer.remove(this._fx),this._boundHandlers&&(L.eventManager.off("mousedown",this._boundHandlers.mousedown),L.eventManager.off("mouseup",this._boundHandlers.mouseup),L.eventManager.off("mousemove",this._boundHandlers.mousemove),this._boundHandlers={}),this._socketHandlers&&(L.socket.off("radio",this._socketHandlers.radio),L.socket.off("opened",this._socketHandlers.opened),this._socketHandlers={}),this._destroyed=!0,Ts()}getObjectAtPosition(e,t){const n=[this.config.headerRect,this.config.closeBtnRect,this.config.volumeSliderRect,this.config.balanceSliderRect],[s,i]=me(e,t),[o,a]=this.getRelPos(s,i);for(let e of n)if(o>=e.x&&o<e.x+e.w&&a>=e.y&&a<e.y+e.h)return e}onObjMousedown(e){this._holdingButton=e}onObjMouseup(e,t){e===this.config.closeBtnRect&&this.getObjectAtPosition(t.clientX,t.clientY)===this.config.closeBtnRect&&this.close()}onObjMousemove(e,t){const[n,s]=this.calcMovement(t);switch(e){case this.config.headerRect:this.playerPosition[0]+=n,this.playerPosition[1]+=s,(0,M.UW)("winamp.position",JSON.stringify(this.playerPosition),!0),this.ackRender();break;case this.config.volumeSliderRect:{const[e]=this.getRelPos(...me(t.clientX,t.clientY)),n=this.config.volumeBoundsRect,s=this.images.hrSlider,[i,o]=this.clampHrSliderPos(e,n,s);this.config.volumeSliderRect.x=i,this.config.volumeSliderRect.y=o;const a=this.mapHrSliderPos(i,n,s,0,1);this.volume(a),this.ackRender();break}case this.config.balanceSliderRect:{const[e]=this.getRelPos(...me(t.clientX,t.clientY)),n=this.config.soundBalanceBoundsRect,s=this.images.hrSlider,[i,o]=this.clampHrSliderPos(e,n,s);this.config.balanceSliderRect.x=i,this.config.balanceSliderRect.y=o;const a=this.mapHrSliderPos(i,n,s,-1,1);this.balance(a),this.ackRender();break}}}clampHrSliderPos(e,t,n){var s,i,o;return[0|(s=e-=n.width/2,i=t.x,o=t.x+t.w-n.width,Math.max(Math.min(s,o),i)),0|t.y+t.h/2-n.height/2+1]}mapHrSliderPos(e,t,n,s,i){return ht(e,t.x,t.x+t.w-n.width,s,i)}reverseMapHrSliderPos(e,t,n,s,i){return 0|ht(e,s,i,t.x,t.x+t.w-n.width)}getRelPos(e,t){return[e-this.playerPosition[0],t-this.playerPosition[1]]}calcMovement(e){if(!this._lastHoldPos)return null;const t=me(e.clientX,e.clientY);return[t[0]-this._lastHoldPos[0],t[1]-this._lastHoldPos[1]]}async loadMaterials(){const{images:e,fonts:t}=await async function(){n(4536);const e={bg:await Promise.resolve().then(n.bind(n,8163)),hrSlider:await Promise.resolve().then(n.bind(n,4175)),hrSliderBig:await Promise.resolve().then(n.bind(n,5748)),digits:await Promise.resolve().then(n.bind(n,9674))},t=new cn(Rs,Is);return await t.load(),{images:e,fonts:{winamp:t}}}(),s={};for(let t of Object.keys(e)){let n=e[t].default;s[t]=await R(n)}this.images=s,this.fonts=t}ackRender(){this.needRender=!0,L.fxRenderer.requestRender()}render(e){if(this._destroyed)return 2;const[t,n]=pe(this.playerPosition[0],this.playerPosition[1]),s=$.zoom;return this.needRender&&this.redraw(),e.save(),e.scale(s,s),e.drawImage(this.canvas,t/s,n/s),e.restore(),1}generateQueueText(){return this.queue?[...this.queue.queue,...this.queue.defaultQueue].slice(0,7).map((e=>{let t=function(e,t){let n=0,s="";for(const t of e){if(n>=181){s+="...";break}" "===t||/[А-я]/.test(t)?n+=5:/[A-z]/.test(t)?n+=4:n+="."===t?2:4,n+=1,s+=t}return s}(e.title);return`${e.id??"x"}. ${t} <${e.duration/60|0}:${Fs(e.duration%60|0)}>`})).join("\n"):""}redraw(){if(this.needRender=!1,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images.bg,0,0),this.ctx.drawImage(this.images.hrSlider,this.config.volumeSliderRect.x,this.config.volumeSliderRect.y),this.ctx.drawImage(this.images.hrSlider,this.config.balanceSliderRect.x,this.config.balanceSliderRect.y),this.drawTextInInput(this.title,this.config.titleRect,"#00E200"),this.currentTrack){const e=4*this.currentTrack.sampleRate/1e3|0,t=this.currentTrack.sampleRate/1e3|0;this.drawTextInInput(e.toString(),this.config.kbpsRect,"#00E200"),this.drawTextInInput(t.toString(),this.config.khzRect,"#00E200");const n=(Date.now()-this.currentTrack.startedAt)/1e3,s=Fs((n/60|0).toString()),i=Fs((n%60|0).toString());this.drawBigDigit(this.config.mm1Rect,s[0]),this.drawBigDigit(this.config.mm2Rect,s[1]),this.drawBigDigit(this.config.ss1Rect,i[0]),this.drawBigDigit(this.config.ss2Rect,i[1]);const o=this.reverseMapHrSliderPos(n,this.config.progressSliderBndRect,this.images.hrSliderBig,0,this.currentTrack.duration),a=this.config.progressSliderBndRect.y;this.ctx.drawImage(this.images.hrSliderBig,o,a)}const e=this.generateQueueText();if(e&&e!==this._cache.queueText){const t=this.fonts.winamp.drawText(e,"#00E200");t&&(this._cache.queueTextImg=t,this._cache.queueText=e,this.ctx.drawImage(t,this.config.queueBoxRect.x,this.config.queueBoxRect.y))}else e&&this.ctx.drawImage(this._cache.queueTextImg,this.config.queueBoxRect.x,this.config.queueBoxRect.y)}drawBigDigit(e,t){const n=e.w;this.ctx.drawImage(this.images.digits,n*t,0,e.w,e.h,e.x,e.y,e.w,e.h)}drawTextInInput(e,t,n){const s=this.fonts.winamp.drawText(e,n);this.ctx.drawImage(s,0,0,t.w,s.height,t.x,t.y+t.h/2-s.height/2|0,t.w,s.height)}recalculateButtons(){const e=this.images.hrSlider.width,t=this.images.hrSlider.height,n=this.config.volumeBoundsRect,s=ht(this.volumeLvl,0,1,n.x,n.x+n.w-e),i=n.y+n.h/2-t/2+1;this.config.volumeSliderRect.x=0|s,this.config.volumeSliderRect.y=0|i,this.config.volumeSliderRect.w=e,this.config.volumeSliderRect.h=t;const o=this.config.soundBalanceBoundsRect,a=ht(this.sndBalance,-1,1,o.x,o.x+o.w-e),r=o.y+o.h/2-t/2+1;this.config.balanceSliderRect.x=0|a,this.config.balanceSliderRect.y=0|r,this.config.balanceSliderRect.w=e,this.config.balanceSliderRect.h=t}initAudioChain(){if(this.audioCtx&&"closed"!==this.audioCtx.state||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext)),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=this.volumeLvl,this.pannerNode=this.audioCtx.createStereoPanner(),this.pannerNode.pan.value=this.sndBalance,this.audio){try{this.audio._destroyed=!0}catch{}try{this.audio.pause()}catch{}try{this.audio.remove()}catch{}}this.audio=document.createElement("audio"),this.audio.autoplay=!0,this.audio.controls=!1,this.audio._destroyed=!1,this.addAudioStoppedListeners(),this.audioCtx.createMediaElementSource(this.audio).connect(this.gainNode).connect(this.pannerNode).connect(this.audioCtx.destination)}async startStream(){if(this._destroyed)return;if(this._streaming)return;this._streaming=!0;const e=()=>{try{this.audio&&!this.audio._destroyed||this.initAudioChain(),this.audio.src=`${location.protocol}//${location.hostname}/api/radio/stream`,this.audio.autoplay=!0;const e=this.audio.play();e&&e.catch((e=>console.warn("Playback blocked until user interaction:",e)))}catch(e){console.error("Failed to start stream:",e),this._streaming=!1,this._destroyed||setTimeout((()=>this.startStream()),5e3)}};Bs?e():Ds.push(e)}async restartStream(){this._destroyed||(this._streaming=!1,console.info("Restarting radio stream..."),await this.startStream())}async startPolling(){this._destroyed||await this.startStream()}async updateSong(){if(this._destroyed)return;this.noFeed=!0;const e=await this.fetchCurTrack();this.currentTrack=e;const t=e.duration/60|0,n=e.duration%60|0;this.setTitle(this.currentTrack.title+` <${t}:${Fs(n)}>`),this.noFeed=!1,this.ackRender(),this.updateQueue().then((()=>this.ackRender()))}async updateQueue(){const e=await this.fetchQueue();e&&(this.queue=e,this.ackRender())}async fetchCurTrack(){const e=await Re("/radio/current-song"),t=await e.json();if(t.success)return t.song}async fetchQueue(){const e=await Re("/radio/get-queue"),t=await e.json();if(t.success)return t.queues}setTitle(e){this._titleSet=Date.now(),this.title=e,clearInterval(this._titleRollerInterval),this.fonts.winamp.measureText(this.title).width>this.config.titleRect.w&&(this._titleRollerInterval=setInterval((()=>{const e=this.title.split("");e.push(e.shift()),this.title=e.join(""),this.ackRender()}),300))}}function Fs(e){return e.toString().padStart(2,"0")}var Os=n(4692);function Ns(){!function(){const e=(0,M.Fh)("template.url","https://i.imgur.com/4GQIMQ7.png",!0);_.val(e);const t=(0,M.Fh)("template.x",0,!0);U.val(parseInt(t,10));const n=(0,M.Fh)("template.y",0,!0);W.val(parseInt(n,10));const s=(0,M.Fh)("template.opac",.5,!0);z.val(parseFloat(s))}(),_.on("input",ot),U.on("input",ot),W.on("input",ot),z.on("input",ot),ot(),On("#accountSettings").on("click",Wn),On("#toolBinds").on("click",zn),On("#uiSettings").on("click",Hn),On("#canvasSettings").on("click",jn),On("#toolsB").on("click",Yn),On(".authBtn").on("click",Kn),On("#showTemplates").on("click",rt),On("#shareTemplate").on("click",at),Z(document).on("keydown",(e=>{if(!L.lockInputs&&"Enter"===e.key)if(Z("#chatInput").is(":focus")||L.mobile){const e=j.val();if(!e.length)return j.trigger("blur");j.val(""),ee.handleMessage(e)}else Z("#chatInput").trigger("focus")})),Z("#chatChannels>div").on("click",(e=>{const t=e.target.dataset.channel;ee.switchChannel(t),(0,M.UW)("chatChannel",t)})),(0,h.GC)().then((()=>{ee.loadChannelElements(),ee.switchChannel((0,M.yN)("chatChannel")||"global")})),function(){function e(){document.documentElement.style.setProperty("--gorox-chat-height",Z(window).height()+"px")}Z(window).on("resize",e),e()}()}function _s(){(function(){const e=Ve("#manualMoveBtn");let t,n,s,i=!1;function o(e){if(e.gesture)return;const n=me(e.clientX,e.clientY);n[0]|=0,n[1]|=0;let[s,i]=n;s===t[0]&&i===t[1]||(console.log({lastX:s,lastY:i,boardPos:n,lastPressCord:t}),U.val(st.x-=t[0]-s),W.val(st.y-=t[1]-i),st.updatePosition(),t=n,it())}function a(){L.eventManager.off("mousemove",o)}L.eventManager.on("mousedown",(function(e){i&&(t=me(e.clientX,e.clientY).map((e=>0|e)),a(),L.eventManager.on("mousemove",o))})),L.eventManager.on("mouseup",a),e.on("click",(()=>{i?(e.removeClass("active"),a(),L.toolManager.unblockToolChange(),L.toolManager.selectTool(n),[We.color,We.secondCol]=s):(e.addClass("active"),n=L.toolManager.tool,s=[We.color,We.secondCol],L.toolManager.selectTool(L.toolManager.tools.clicker),We.resetColors(),L.toolManager.blockToolChange()),i=!i}))})(),function(){const e=new URLSearchParams(window.location.search),t=e.get("t_url"),n=e.get("t_x"),s=e.get("t_y");t&&n&&s&&(_.val(decodeURIComponent(t)),U.val(+n),W.val(+s),ot(),function(){const e=new URL(window.location);e.search="",window.history.replaceState(null,"",e)}())}(),Ve(document).on("mousedown",(e=>{if(!e.ctrlKey)return;e.stopPropagation(),e.preventDefault();let t=me(e.clientX,e.clientY).map((e=>0|e));function n(e){e.stopPropagation(),e.preventDefault();const n=me(e.clientX,e.clientY);n[0]|=0,n[1]|=0;let[s,i]=n;s===t[0]&&i===t[1]||(U.val(st.x-=t[0]-s),W.val(st.y-=t[1]-i),st.updatePosition(),t=n,it())}Ve(document).on("mousemove",n),Ve(document).one("mouseup mouseleave",(()=>{Ve(document).off("mousemove",n)}))})),Os("#modMenu .title").on("click",(e=>{const t=Os("#modMenu");"open"===t.data("state")?(t.data("state","close"),t.css("right","")):(t.data("state","open"),t.css("right",Os("#modMenu .body").css("width")))})),Os("#sendAlerts").on("click",(()=>{const e=Os("#sendAlertsText").val();0==e.length||e.length>2e3||(Os("#sendAlertsText").val(""),L.socket.sendAlert("all",e))})),gt(".showMenu,.hideMenu").on("click",ft),Dn(),ne(1!=(0,M.yN)("hideEmojis")),se((0,M.Fh)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐").split(" ")),Ne(!+(0,M.Fh)("hidePlaced",1)),_e((0,M.yN)("placedCount",!0)),1==(0,M.yN)("showPalettePatterns")&&($n(),L.showPatterns=!0),Z(".showChat").on("click",(()=>{Z(".showChat").removeClass("showChat-notify"),ee.mobileShow()})),Z("#hideChat").on("click",(()=>{Z(".showChat").removeClass("showChat-notify"),ee.mobileHide()})),On(".helpBtn").on("click",(()=>{Xn()})),We.init(),L.elements.coords.addEventListener("click",(function(){L.elements.chatInput.value+=this.innerText,L.elements.chatInput.focus()})),On("#onlineColumn .columnHeader").on("click",(async()=>{let e;try{const t=await fetch("/api/online");e=await t.json()}catch(e){return void O().error(e)}!function(e){let t=new wn({title:kn((0,K.k)("online")),center:!0,closeable:!0});t.created||(t=t.oldWindow),t.body.style.width="325px",t.moveToCenter();const n=[];Object.keys(e).forEach((s=>{if("TOTAL"===s)return void t.updateTitle((0,K.k)("online")+` (${e[s]})`,!0);const i=`<a href="/${s}" target="_shagorox"><h3>${s}<h3></a>`,o=`<h2>${e[s]}</h2>`;n.push([i,o])}));const s=Un(n);On("*",t.body).remove(),On(t.body).append(s)}(e)})),function(){const e=gt("#menuResizer"),t=gt("#resizingStripes");let n,s=+(0,M.yN)("columnHeight");isNaN(s)||0==s?s=123:s<0?s=0:s>=window.screen.height-250&&(s=window.screen.height-250),gt(".columnContent").css("height",s);let i=!1;function o(){e.css("height","7px"),e.css("background-color","#4c4c4c"),t.css("opacity","1")}function a(){clearTimeout(n),e.css("height",""),e.css("background-color",""),t.css("opacity","")}e.on("mouseover",(()=>{clearTimeout(n),n=setTimeout((()=>{o()}),500)})),e.on("mouseout",(()=>{i||a()})),e.on("mousedown",(function(){function e(e){s+=e.originalEvent.movementY,gt(".columnContent").css("height",s),setLS("columnHeight",s)}i=!0,o(),gt(document).on("mousemove",e),gt(document).one("mouseup",(function(){gt(document).off("mousemove",e),i=!1,a()}))}))}(),(0,M.yN)("helpShown")||((0,M.UW)("helpShown","1"),Xn()),"1"===(0,M.yN)("radioLover")?As():Ts()}var Us=n(4692);(async()=>{(function(){let e=indexedDB.open("db",1);function t(){hs=!0,us.forEach((e=>{try{e(ds)}catch(e){console.error(e)}})),us.length=0}e.onupgradeneeded=function(){ds=e.result,ds.objectStoreNames.contains("chunkPlaceholders")||ds.createObjectStore("chunkPlaceholders",{keyPath:"chunk_key"}),t()},e.onsuccess=()=>{ds=e.result,t()}})(),await h.RG();const{elements:e}=L;window.onresize=()=>{e.mainCanvas.width=window.innerWidth,e.mainCanvas.height=window.innerHeight,e.fxCanvas.width=window.innerWidth,e.fxCanvas.height=window.innerHeight;const n=e.fxCanvas.getContext("2d");t.imageSmoothingEnabled=n.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=n.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=n.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=n.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=n.oImageSmoothingEnabled=!1,o.needRender=!0,a.needRender=!0,L.mobile||function(){const e=g(".column",L.elements.topMenuContent),t=window.innerWidth/e.length;g(".column",L.elements.topMenuContent).css("width",t)}(),Dn(),te()},window.oncontextmenu=function(e){(e.target===L.elements.mainCanvas||"paletteColor"===e.target.classList[0]||e.path&&"paletteColor"===e.path[1].classList[0])&&e.preventDefault()},$.init(),f=[h.h/2,h.Uf/2],h.MF.forEach(((t,n)=>{const s=document.createElement("div");s.style.backgroundColor=`rgb(${t.join(",")})`,s.classList=["paletteColor light"],s.id="col"+n;let i=0;var o=Us(s);o.on("pointerdown",(()=>{i=Date.now()})),o.on("pointerleave",(()=>{i=0})),s.onclick=e=>{let t=!1;0!=i&&(Date.now()-i>700&&(t=!0),i=0),(t?We.switchSecondColor:We.switchColor).call(We,n)},s.oncontextmenu=()=>{We.switchSecondColor(n)},e.palette.appendChild(s)}));const t=e.mainCanvas.getContext("2d");t.imageSmoothingEnabled=!1;const n="https:"===location.protocol?443:location.port||80,s=new as(n);L.socket=s;const i=new gs;L.chunkManager=i;const o=window.renderer=new vs(t);L.renderer=o;const a=new le;L.fxRenderer=a,L.toolManager=new Es(document.getElementById("board")),L.player=We;const r=()=>{requestAnimationFrame((()=>{o.requestRender(),r()}))};r(),window.onresize(),s.on("opened",(()=>{})),s.on("online",(e=>{Us(".online").text(e)})),s.on("closed",(()=>{Us(".online").text("offline")})),window.globals=L,h.iO((()=>{if("nsfw"!==h.OP)return;if("accepted"==(0,M.yN)("modal18"))return;const e=new bn;e.init();const t=Us(`<div style="margin:0;padding:5px;text-align:center;">\n                <h1>${(0,K.k)("WARNING")}</h1>\n                <p>${(0,K.k)("This canvas may contain illustrations, inappropriate for people under age of 18, including:")}\n                <br>${(0,K.k)("Gore, furry, porn, hate, anime and all possible variations of these.")}</p>\n                <p><b>${(0,K.k)("Are you 18 y.o. and fully understanding what are you doing?")}</b></p>\n                <button style="padding: 8px;">${(0,K.k)("I am 18 years old and I take responsibility for my psyche on myself")}</button>\n            </div>`);e.contEl.appendChild(t[0]),Us("button",t).on("click",(()=>{e.close(),(0,M.UW)("modal18","accepted")}))})),Te(),(0,K.T)(),Ns(),_s(),L.mobile&&ft()})()},3603:(e,t,n)=>{"use strict";function s(e,t,n){return 4278190080|n<<16|t<<8|e}function i(e){return e.toString(16).padStart(2,"0")}function o(e){return"#"+i(e[0])+i(e[1])+i(e[2])}function a(e,t){let n=-1,s=768;for(let i=0;i<t.length;i++){const o=t[i];let a=Math.abs(e[0]-o[0])+Math.abs(e[1]-o[1])+Math.abs(e[2]-o[2]);if(a<s&&(s=a,n=i),0==a)break}return n}function r(e,t,n){return 1-(.299*e+.587*t+.114*n)/255>.5}n.d(t,{Py:()=>a,cP:()=>r,iG:()=>s,v2:()=>o})},3614:(e,t,n)=>{"use strict";n.d(t,{Fh:()=>i,UW:()=>a,yN:()=>o});var s=n(1962);function i(e,t,n=!1){return n&&(e=s.OP+"."+e),localStorage.getItem(e)||t}function o(e,t=!1){return t&&(e=s.OP+"."+e),localStorage.getItem(e)}function a(e,t,n=!1){return n&&(e=s.OP+"."+e),localStorage.setItem(e,t)}}},n={};function s(e){var i=n[e];if(void 0!==i)return i.exports;var o=n[e]={exports:{}};return t[e].call(o.exports,o,o.exports,s),o.exports}s.m=t,s.amdD=function(){throw new Error("define cannot be used indirect")},e=[],s.O=(t,n,i,o)=>{if(!n){var a=1/0;for(h=0;h<e.length;h++){for(var[n,i,o]=e[h],r=!0,l=0;l<n.length;l++)(!1&o||a>=o)&&Object.keys(s.O).every((e=>s.O[e](n[l])))?n.splice(l--,1):(r=!1,o<a&&(a=o));if(r){e.splice(h--,1);var c=i();void 0!==c&&(t=c)}}return t}o=o||0;for(var h=e.length;h>0&&e[h-1][2]>o;h--)e[h]=e[h-1];e[h]=[n,i,o]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.p=".",(()=>{var e={485:0};s.O.j=t=>0===e[t];var t=(t,n)=>{var i,o,[a,r,l]=n,c=0;if(a.some((t=>0!==e[t]))){for(i in r)s.o(r,i)&&(s.m[i]=r[i]);if(l)var h=l(s)}for(t&&t(n);c<a.length;c++)o=a[c],s.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return s.O(h)},n=self.webpackChunkgoroxels_client=self.webpackChunkgoroxels_client||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=s.O(void 0,[96,200],(()=>s(7322)));i=s.O(i)})();