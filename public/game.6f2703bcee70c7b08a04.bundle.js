(()=>{"use strict";var e,t={914:(e,t,n)=>{n.d(t,{$t:()=>l,DG:()=>d,Dv:()=>r,El:()=>g,F_:()=>k,G6:()=>h,H6:()=>w,LR:()=>y,W7:()=>u,X1:()=>a,Xv:()=>b,_D:()=>p,ku:()=>v,rT:()=>m,w_:()=>c,y6:()=>f});var o=n(815),s=n(226),i=n(901);let a,r,l,c,h,d,u,p,m,g,f,v=!1;const w={chatLimit:parseInt((0,s.CJ)("chatLimit",100),10),showProtected:!1};let b={};async function y(){let e;try{e=await async function(){const e=await fetch("/config.json");return await e.json()}()}catch(e){i.error("Failed to load config from server. Try to reload the page")}const t=document.location.pathname.replace(/[^\d^\w]/g,"");let n=e.canvases.findIndex((e=>e.name===t));a=-1===n?0:n;let s=e.canvases[a];r=s.name,l=s.chunkSize,c=s.boardWidth*l,h=s.boardHeight*l,d=s.palette,u=new Uint32Array(d.map((e=>(0,o.xP)(...e)))),p=d.map(o.CO),m=s.boardWidth,g=s.boardHeight,f=s.cooldown,Array.from(u.values()).forEach(((e,t)=>b[e]=t)),v=!0,x.forEach((e=>e())),x=[]}let x=[];function k(e){if(v)return e();x.push(e)}},995:(e,t,n)=>{const o=n.p+"/img/vk-logo.svg",s=n.p+"/img/discord-logo-circle.svg",i=n.p+"/img/fb-logo.svg";n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p,n.p;var a=n(187),r=n.n(a),l=n(591),c=n.n(l);var h=n(914),d=n(496),u=n.n(d);function p(){return"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName}class m extends(r()){constructor(e){function t(e){let t=this.startedGesture;return"up"===e?(this.pointers=Math.max(this.pointers-1,0),0==this.pointers&&(this.startedGesture=!1)):"down"===e&&++this.pointers>=2&&(t=this.startedGesture=!0),t}super(),this.el=e,this._zoomed=!1,this.startedGesture=!1,this.pointers=0,t=t.bind(this);let n={};e.addEventListener("pointerdown",(e=>{e.gesture=t("down"),this.emit("mousedown",e)})),document.addEventListener("pointermove",(e=>{{Object.defineProperty(e,"movementX",{writable:!0}),Object.defineProperty(e,"movementY",{writable:!0});let t=n[e.pointerId];t?(e.movementX=e.clientX-t[0],e.movementY=e.clientY-t[1]):(e.movementX=0,e.movementY=0),n[e.pointerId]=[e.clientX,e.clientY]}t("move")||this.emit("mousemove",e)})),document.addEventListener("pointerup",(e=>{let o=this.pointers;e.gesture=t("up"),o&&this.emit("mouseup",e),delete n[e.pointerId]})),u()(e).gesturable({onmove:e=>{this.emit("zoom",e.ds),this.emit("mousemove",{buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,movementX:e.dx*devicePixelRatio,movementY:e.dy*devicePixelRatio,gesture:!0})}}),this.tickLoop=setInterval((()=>{this.emit("tick")}),1e3/60),document.addEventListener("keydown",(e=>{p()||this.emit("keydown",e)})),document.addEventListener("keyup",(e=>{p()||this.emit("keyup",e)})),e.addEventListener("wheel",(e=>this.emit("wheel",e))),e.addEventListener("mouseleave",(e=>this.emit("mouseleave",e)))}}var g=n(755);let f=[null,null];function v(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e}function w(e){let t={alt:!1,ctrl:!1,code:null};return e.split("+").forEach((e=>{"CTRL"===e?t.ctrl=!0:"ALT"===e?t.alt=!0:t.code=e})),t}function b(e){let t="";return e.altKey&&(t+="ALT+"),e.ctrlKey&&(t+="CTRL+"),t+e.code}function y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function x(){if(E.mobile)return 24;const e=g("#palette");let t=Math.floor((window.innerWidth-14)/e.children().length);return t=Math.min(t,30),t}function k(e,t,n,o,s){let i,a,r=0;for(i=0,a=e-1;i<e;a=i++)n[i]>s!=n[a]>s&&o<(t[a]-t[i])*(s-n[i])/(n[a]-n[i])+t[i]&&(r=!r);return r}var C=n(755);const E={socket:null,chunkManager:null,renderer:null,fxRenderer:null,player:null,toolManager:null,events:new(r()),eventManager:new m(document.getElementById("board")),mainCtx:document.getElementById("board").getContext("2d"),fxCtx:document.getElementById("fx").getContext("2d"),mobile:v(),users:{},elements:{mainCanvas:C("#board")[0],fxCanvas:C("#fx")[0],palette:C("#palette")[0],online:C("#onlineCounter")[0],coords:C("#coords")[0],topMenu:C("#topMenu")[0],topMenuContent:C("#topMenu>.content")[0],chatInput:C("#chatInput")[0]}};var I=n(226);const D={x:null,y:null,zoom:null,minX:null,minY:null,maxX:null,maxY:null,minZoom:.1,maxZoom:64,noMoving:!1,init(){Object.assign(this,{x:+(0,I.CJ)("posX",0,!0),y:+(0,I.CJ)("posY",0,!0),zoom:+(0,I.CJ)("zoom",1,!0),minX:-h.w_/2,minY:-h.G6/2,maxX:h.w_/2,maxY:h.G6/2}),(isNaN(this.x)||isNaN(this.y)||isNaN(this.zoom))&&(this.x=0,this.y=0,this.zoom=1)},centerOn(e,t){E.renderer.needRender=!0,this.noMoving||(this.x=e-this.maxX,this.y=t-this.maxY,this.clampPos())},moveTo(e,t){E.renderer.needRender=!0,this.noMoving||(this.x+=e,this.y+=t,this.clampPos())},clampPos(){this.x=Math.min(Math.max(this.x,this.minX),this.maxX),this.y=Math.min(Math.max(this.y,this.minY),this.maxY)},zoomTo(e){this.zoom=e<0?2*this.zoom|0||1:this.zoom/2,this.checkZoom(),this.emit("zoom",this.zoom),E.renderer.needRender=!0,E.fxRenderer.needRender=!0,E.renderer.preRender()},checkZoom(){this.zoom=Math.min(Math.max(this.zoom,this.minZoom),this.maxZoom)},disableMove(){this.noMoving=!0},enableMove(){this.noMoving=!1},__proto__:new(r())};let A,R,S;setInterval((()=>{const e=D.x,t=D.y,n=D.zoom;A!=e&&(0,I.lx)("posX",e,!0),R!=t&&(0,I.lx)("posY",t,!0),S!=n&&(0,I.lx)("zoom",n,!0),A=e,R=t,S=n}),3e3);const P=window.camera=D,M={BANNED:-1,GUEST:0,USER:1,TRUSTED:2,MOD:3,ADMIN:4},L={};Object.keys(M).forEach((e=>L[M[e]]=e));var T=n(351),F=n(755),O=n.n(F);const $=n.p+"/img/trash2.svg";n.p;var B=n(755);const N=document.createElement("div");N.style.cssText=`\n    width: 80px;\n    height: 80px;\n    line-height: 80px;\n    text-align: center;\n    border: solid 2px white;\n    border-radius: 50%;\n    opacity: .5;\n    position: absolute;\n    z-index: 8;\n    bottom: 10px;\n    right: 10px;\n    background-color: red;\n    color: white;\n    font-size: 68px;\n    padding-left: 3px; /* костыль из-за кривой иконки мусорки */\n    display: none;\n    user-select: none;\n    transition: all .2s ease;\n    background-image: url(${$});\n`;let z=document.createElement("div");z.style.cssText="\n    opacity: .1;\n    width: 300px;\n    height: 300px;\n    position: absolute;\n    border-radius: 50%;\n    z-index: 7;\n    bottom: -100px;\n    right: -100px;\n    background-color: red;\n    display: none;\n",N.onpointerenter=z.onpointerenter=()=>{N.style.opacity="1"},N.onpointerleave=z.onpointerleave=()=>{N.style.opacity=".5"};let U=[];window.windows=U;class W{static Exists(e){return U.some((t=>t.title===e))}static Find(e){return U.find((t=>t.title===e))}constructor(e){"string"==typeof e&&(e={title:e}),this.created=!1,this.x=0,this.y=0,this.title="",this.parent=document.body,this.moveable=!0,this.closeable=!0,this.closed=!1,this.center=!1,Object.assign(this,e),W.Exists(this.title)?this.oldWindow=W.Find(this.title):(this.created=!0,this.block||(this.block=this.createParentBlock(),this.moveTo(this.x,this.y),this.parent.appendChild(this.block)),this.center&&(this.moveToCenter(),setTimeout((()=>this.moveToCenter()))),this.addFeatures(),U.push(this))}updateTitle(e,t=!1){t||(this.title=e),B(".windowTitle",this.element).text(e)}createParentBlock(){let e=document.createElement("div");e.className="window",this.element=e;let t=document.createElement("div");if(t.className="windowHeader",t.innerHTML='<h3 class="windowTitle">'+this.title+"</h3>",e.appendChild(t),this.closeable){const e=document.createElement("div");e.className="closeWindow",e.innerHTML="<div></div>",e.addEventListener("pointerdown",(e=>{e.stopPropagation()})),e.addEventListener("click",this.close.bind(this)),t.appendChild(e)}let n=document.createElement("div");return n.className="windowBody",e.appendChild(n),this.body=n,e}moveTo(e,t){const n=this.block.getBoundingClientRect(),o=n.width,s=n.height;this.x=Math.max(10-o,e),this.y=Math.max(10-s,t),this.x=Math.min(window.innerWidth-10,this.x),this.y=Math.min(window.innerHeight-10,this.y),this.block.style.left=this.x+"px",this.block.style.top=this.y+"px"}moveBy(e,t){this.moveTo(this.x+e,this.y+t)}moveToCenter(){let e=window.innerWidth,t=window.innerHeight,n=this.block.offsetWidth,o=this.block.offsetHeight;this.moveTo(e/2-n/2,t/2-o/2)}addFeatures(){if(this.moveable){const e=window.devicePixelRatio||1;B(this.block).on("pointerdown",(()=>{let t=this;function n(n){let o=(n=n.originalEvent).movementX/e,s=n.movementY/e;t.moveBy(o,s)}O()(document).on("pointermove",n),this.closeable&&(N.style.display="block",z.style.display="block",O()([N,z]).one("pointerup",(()=>{this.close()}))),O()(document).one("pointerup pointerleave",(()=>{N.style.display="none",z.style.display="none",O()([N,z]).off("pointerup"),O()(document).off("pointermove",n)}))})),B(this.body).on("pointerdown",(e=>{e.stopPropagation()}))}window.addEventListener("orientationchange",(()=>{setTimeout((()=>{this.moveTo(this.x,this.y)}),500)}))}close(){O()(this.block).remove(),this.closed=!0,U.splice(U.indexOf(this),1)}}let G=!1;class _{static get isRunning(){return G}static set isRunning(e){return G=e}constructor(e={}){if(_.isRunning)throw new Error("Modal is running");this.body=null,Object.assign(this,e),this.init(),_.isRunning=!0}init(){const e=B('<div class="modalBg">\n            <div class="modalCont">\n            </div>\n        </div>');this.bgEl=e[0],this.contEl=this.bgEl.children[0],B("#ui").append(e)}close(){this.bgEl.remove()}}class H{constructor(e,t){this._allowance=0,this.delay=e,this.max=t,this.lastCheck=Date.now()}get allowance(){return 0===this.delay?1/0:(this._allowance+=(Date.now()-this.lastCheck)/this.delay,this.lastCheck=Date.now(),this._allowance>this.max&&(this._allowance=this.max),this._allowance)}set allowance(e){this._allowance=e}spend(e){if(0===this.delay)return!0;let t=this.allowance;return!(t<e||(this.allowance=t-e,0))}}var j=n(755);const K={x:0,y:0,color:-1,brushSize:1,secondCol:-1,id:-1,init(){this.loadColors(),this.switchColor(this.color,!0),this.switchSecondColor(this.secondCol,!0)},loadColors(){this.color=+(0,I.CJ)("color1",-1,!0),this.secondCol=+(0,I.CJ)("color2",-1,!0)},switchColor(e,t=!1){this.color!==e||t?this.color=e:e=this.color=-1,E.fxRenderer.needRender=!0,E.renderer.preRender(),j(".paletteColor.selected").removeClass("selected"),-1!==e&&j("#col"+e).addClass("selected"),(0,I.lx)("color1",e,!0)},switchSecondColor(e,t){this.secondCol!==e||t?this.secondCol=e:e=this.secondCol=-1,E.fxRenderer.needRender=!0,E.renderer.preRender(),j(".paletteColor.selectedSecond").removeClass("selectedSecond"),-1!==e&&j("#col"+e).addClass("selectedSecond"),(0,I.lx)("color2",e,!0)},swapColors(){const e=this.color;this.switchColor(this.secondCol),this.switchSecondColor(e)},resetColors(){this.switchColor(-1),this.switchSecondColor(-1)},bucket:null,updateBucket([e,t]){this.bucket=new H(e,t)},placed:[],maxPlaced:isNaN(+localStorage.maxPlaced)?5e3:+localStorage.maxPlaced,placedCount:+(0,I.TA)("placedCount",!0)||0};function Y(e,t){let n=(e-(E.renderer.canvas.width>>1))/P.zoom,o=(t-(E.renderer.canvas.height>>1))/P.zoom;return[0|P.x+f[0]+n,0|o+(P.y+f[1])]}function X(e,t){return e-=P.x+f[0],t-=P.y+f[1],e*=P.zoom,t*=P.zoom,e+=E.renderer.canvas.width>>1,t+=E.renderer.canvas.height>>1,[Math.floor(e),Math.floor(t)]}function V(e,t){return[e/h.$t|0,t/h.$t|0,e%h.$t,t%h.$t]}var J=n(755);const q=J("#templateURL"),Z=J("#templateX"),Q=J("#templateY"),ee=J("#templateOpacity"),te=(J("#ui"),J("#chat")),ne=J("#chatInput"),oe=(J("#template"),J("#topMenu"));let se=window.innerWidth/2,ie=window.innerHeight/2;window.addEventListener("resize",(()=>{se=window.innerWidth/2,ie=window.innerHeight/2}));const ae=/width=(\d+)$/,re={element:document.getElementById("template"),x:0,y:0,render(){let e=P.x+f[0]-this.x-se/P.zoom,t=P.y+f[1]-this.y-ie/P.zoom;e=Math.floor(e*P.zoom),t=Math.floor(t*P.zoom),this.element.style.left=-e+"px",this.element.style.top=-t+"px",this.element.style.transform="scale("+P.zoom+","+P.zoom+")"},update(){this.x=parseInt(Z.val(),10),this.y=parseInt(Q.val(),10),this.element.style.opacity=ee.val();const e=q.val();let t;(t=e.match(ae))?this.element.style.width=t[1]+"px":this.element.style.width="unset",this.element.src=e},get url(){return q.val()},get opacity(){return+ee.val()},set opacity(e){ee.val(e)}},le={ALICEBLUE:"#F0F8FF",ANTIQUEWHITE:"#FAEBD7",AQUA:"#00FFFF",AQUAMARINE:"#7FFFD4",AZURE:"#F0FFFF",BEIGE:"#F5F5DC",BISQUE:"#FFE4C4",BLACK:"#000000",BLANCHEDALMOND:"#FFEBCD",BLUE:"#0000FF",BLUEVIOLET:"#8A2BE2",BROWN:"#A52A2A",BURLYWOOD:"#DEB887",CADETBLUE:"#5F9EA0",CHARTREUSE:"#7FFF00",CHOCOLATE:"#D2691E",CORAL:"#FF7F50",CORNFLOWERBLUE:"#6495ED",CORNSILK:"#FFF8DC",CRIMSON:"#DC143C",CYAN:"#00FFFF",DARKBLUE:"#00008B",DARKCYAN:"#008B8B",DARKGOLDENROD:"#B8860B",DARKGRAY:"#A9A9A9",DARKGREY:"#A9A9A9",DARKGREEN:"#006400",DARKKHAKI:"#BDB76B",DARKMAGENTA:"#8B008B",DARKOLIVEGREEN:"#556B2F",DARKORANGE:"#FF8C00",DARKORCHID:"#9932CC",DARKRED:"#8B0000",DARKSALMON:"#E9967A",DARKSEAGREEN:"#8FBC8F",DARKSLATEBLUE:"#483D8B",DARKSLATEGRAY:"#2F4F4F",DARKSLATEGREY:"#2F4F4F",DARKTURQUOISE:"#00CED1",DARKVIOLET:"#9400D3",DEEPPINK:"#FF1493",DEEPSKYBLUE:"#00BFFF",DIMGRAY:"#696969",DIMGREY:"#696969",DODGERBLUE:"#1E90FF",FIREBRICK:"#B22222",FLORALWHITE:"#FFFAF0",FORESTGREEN:"#228B22",FUCHSIA:"#FF00FF",GAINSBORO:"#DCDCDC",GHOSTWHITE:"#F8F8FF",GOLD:"#FFD700",GOLDENROD:"#DAA520",GRAY:"#808080",GREY:"#808080",GREEN:"#008000",GREENYELLOW:"#ADFF2F",HONEYDEW:"#F0FFF0",HOTPINK:"#FF69B4",INDIANRED:"#CD5C5C",INDIGO:"#4B0082",IVORY:"#FFFFF0",KHAKI:"#F0E68C",LAVENDER:"#E6E6FA",LAVENDERBLUSH:"#FFF0F5",LAWNGREEN:"#7CFC00",LEMONCHIFFON:"#FFFACD",LIGHTBLUE:"#ADD8E6",LIGHTCORAL:"#F08080",LIGHTCYAN:"#E0FFFF",LIGHTGOLDENRODYELLOW:"#FAFAD2",LIGHTGRAY:"#D3D3D3",LIGHTGREY:"#D3D3D3",LIGHTGREEN:"#90EE90",LIGHTPINK:"#FFB6C1",LIGHTSALMON:"#FFA07A",LIGHTSEAGREEN:"#20B2AA",LIGHTSKYBLUE:"#87CEFA",LIGHTSLATEGRAY:"#778899",LIGHTSLATEGREY:"#778899",LIGHTSTEELBLUE:"#B0C4DE",LIGHTYELLOW:"#FFFFE0",LIME:"#00FF00",LIMEGREEN:"#32CD32",LINEN:"#FAF0E6",MAGENTA:"#FF00FF",MAROON:"#800000",MEDIUMAQUAMARINE:"#66CDAA",MEDIUMBLUE:"#0000CD",MEDIUMORCHID:"#BA55D3",MEDIUMPURPLE:"#9370DB",MEDIUMSEAGREEN:"#3CB371",MEDIUMSLATEBLUE:"#7B68EE",MEDIUMSPRINGGREEN:"#00FA9A",MEDIUMTURQUOISE:"#48D1CC",MEDIUMVIOLETRED:"#C71585",MIDNIGHTBLUE:"#191970",MINTCREAM:"#F5FFFA",MISTYROSE:"#FFE4E1",MOCCASIN:"#FFE4B5",NAVAJOWHITE:"#FFDEAD",NAVY:"#000080",OLDLACE:"#FDF5E6",OLIVE:"#808000",OLIVEDRAB:"#6B8E23",ORANGE:"#FFA500",ORANGERED:"#FF4500",ORCHID:"#DA70D6",PALEGOLDENROD:"#EEE8AA",PALEGREEN:"#98FB98",PALETURQUOISE:"#AFEEEE",PALEVIOLETRED:"#DB7093",PAPAYAWHIP:"#FFEFD5",PEACHPUFF:"#FFDAB9",PERU:"#CD853F",PINK:"#FFC0CB",PLUM:"#DDA0DD",POWDERBLUE:"#B0E0E6",PURPLE:"#800080",REBECCAPURPLE:"#663399",RED:"#FF0000",ROSYBROWN:"#BC8F8F",ROYALBLUE:"#4169E1",SADDLEBROWN:"#8B4513",SALMON:"#FA8072",SANDYBROWN:"#F4A460",SEAGREEN:"#2E8B57",SEASHELL:"#FFF5EE",SIENNA:"#A0522D",SILVER:"#C0C0C0",SKYBLUE:"#87CEEB",SLATEBLUE:"#6A5ACD",SLATEGRAY:"#708090",SLATEGREY:"#708090",SNOW:"#FFFAFA",SPRINGGREEN:"#00FF7F",STEELBLUE:"#4682B4",TAN:"#D2B48C",TEAL:"#008080",THISTLE:"#D8BFD8",TOMATO:"#FF6347",TURQUOISE:"#40E0D0",VIOLET:"#EE82EE",WHEAT:"#F5DEB3",WHITE:"#FFFFFF",WHITESMOKE:"#F5F5F5",YELLOW:"#FFFF00",YELLOWGREEN:"#9ACD32"};var ce=n(755);function he(e,t,n){return void 0===t?e:n?(e+t).slice(-e.length):(t+e).substring(0,e.length)}const de=new RegExp(/\[(#?[A-Z0-9]{1,8})*?\]/gi),ue=new RegExp(/http?s:\/\/.+?\.(png|jpg|jpeg|gif)(\?\S+)?/i),pe=E.chat=new class{constructor(){this.element=ce("#chat"),this.logElems={},this.colorsEnabled=!JSON.parse((0,I.CJ)("disableColors",!1)),this.muted=JSON.parse((0,I.TA)("muted"))||[],this.channel=void 0,this.initChatEvents()}loadChannelElements(){[...ce("#chatLog").children()].map((e=>{let t=e.dataset.channel;"local"===t&&(t=h.Dv),this.logElems[t]=ce(e)}))}mobileShow(){this.element.css("top","0")}mobileHide(){this.element.css("top","-100vh")}setColors(e){this.colorsEnabled=e,ce(".chatColored").toggleClass("noColor",!e)}parseColors(e){let t=0,n=e.matchAll(de);for(;;){let{value:o,done:s}=n.next();if(s)break;let i=o[1];if(i){if(i.startsWith("#")&&!/[G-Zg-z]/.test(i))i=he(i.slice(-1).repeat(7),i);else if(!le[i])continue;e=e.replace(o[0],`<div class="chatColored${this.colorsEnabled?"":" noColor"}" style="color:${i}">`),t++}else t>0?(e=e.replace(o[0],"</div>"),t--):e=e.replace(o[0],"&#91;&#93;")}return t>0&&(e+="</div>".repeat(t)),e}parseCoords(e){return e.replace(/\((\d{1,5}), ?(\d{1,5})\)/g,'<a class="cordgo" onclick="camera.centerOn($1, $2)">$&</a>')}parseImage(e){let t=e.match(ue);if(t){let n=t[0];e=e.replace(n,`<span class="imageLink" onclick="globals.chat.toggleImage(this)">${n}</span>`)}return e}toggleImage(e){const t=ce(e),n=t.parent();if(ce("img",n).length)ce(".imageLink",n).css("cursor","zoom-in"),ce("img",n).remove();else{ce(".imageLink",n).css("cursor","zoom-out");const e=ce(`<img src="${t.text()}" class="chatImg" onclick="globals.chat.toggleImage(this)">`);e.on("load",this.scroll.bind(this,this.channel)),n.append(e)}}parseBB(e){let t=[],n=e.matchAll(/\[(\/?[bi])\]/gi);for(;;){let{value:o,done:s}=n.next();if(s)break;let i=o[1];e=e.replace(o[0],`<${i}>`),i.startsWith("/")?t=t.splice(t.indexOf(i.slice(1))):t.push(i)}for(;t.length;)e+=`</${t.shift()}>`;return e}addMessage(e){ce(".showChat").addClass("showChat-notify");const t=e.ch;if(e.server)return this.addServerMessage(e.msg,t);let n=y(e.msg),o=y(e.nick);const s=o;"Goroh"===o&&(o=`<span style="text-shadow:0 0 3px">[#00f986]${o}</span>`);try{n=this.parseColors(n),n=this.parseBB(n),n=this.parseCoords(n),n=this.parseImage(n),o=this.parseColors(o)}catch(e){console.log(e)}const i=~this.muted.indexOf(s),a=ce(`<div class="chatMessage" ${i?'style="display:none"':""}>\n            <div class="messageNick" data-nick="${s}">${o}:</div>\n            <div class="messageText">${n}</div>\n        </div>`);ce(".messageNick",a).on("click",(function(){const e=this.innerText.slice(0,-1);E.elements.chatInput.value+=e+", ",E.elements.chatInput.focus()})),this.logElems[t].append(a),this.afterAddingMessage(t)}addLocalMessage(e,t){e=this.parseColors(e),e=this.parseBB(e),e=this.parseCoords(e),e=this.parseImage(e);const n=ce(`<div class="chatMessage">\n                <div class="messageText">${e}</div>\n            </div>`);this.logElems[t].append(n),this.afterAddingMessage(t)}switchChannel(e){if(this.channel===e)return;const t=e;"local"===e&&(e=h.Dv);for(let e of Object.values(this.logElems))e.hide();this.logElems[e].show(),ce("#chatChannels>div").removeClass("selected"),ce(`#chatChannels>div[data-channel="${t}"]`).addClass("selected"),this.scroll(e,!0),this.channel=e}addServerMessage(e,t){this.addLocalMessage(e,t)}afterAddingMessage(e){const t=this.logElems[e];t.children().length>h.H6.chatLimit&&t.children()[0].remove(),this.scroll(e)}handleMessage(e){e.startsWith("/")?this.handleCommand(e):E.socket.sendChatMessage(e,this.channel)}sendWhisper(e,t){E.socket.sendChatWhisper(t,this.channel,e)}handleCommand(e){let t=e.split(" ");const n=t[0];switch(t=t.slice(1),console.log(t),n){case"/mute":{const e=t.join(" ");this.mute(e);break}case"/unmute":{const e=t.join(" ");this.unmute(e);break}case"/w":{if(t.length<2)return this.addLocalMessage("Usage: /w &lt;targetAccountId&gt; &lt;message&gt;");const e=t[0],n=t.slice(1).join(" ");this.sendWhisper(e,n),ne.val(`/w ${e} `);break}}}mute(e){const t="<b>mute:</b> ";return!e.length||e.length>32?this.addLocalMessage(t+(0,T.I)("Wrong nick length")):~this.muted.indexOf(e)?this.addLocalMessage(t+(0,T.I)("Player is already muted")):(this.muted.push(e),(0,I.lx)("muted",JSON.stringify(this.muted)),void ce(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="none")})))}unmute(e){let t,n="<b>unmute:</b> ";return!e.length||e.length>32?this.addLocalMessage(n+(0,T.I)("Wrong nick length")):~(t=this.muted.indexOf(e))?(this.muted.splice(t,1),(0,I.lx)("muted",JSON.stringify(this.muted)),void ce(".messageNick").each(((t,n)=>{n.dataset.nick===e&&(n.parentElement.style.display="block")}))):this.addLocalMessage(n+(0,T.I)("Player is not muted"))}initChatEvents(){ne.on("input",(()=>{const e=ne.val();ue.test(e)?ne.css("color","white"):ne.css("color","")}))}scroll(e="global",t=!1){const n=this.logElems[e],o=n.parent()[0],s=n.children().slice(-1).innerHeight()||0;(o.scrollHeight-o.scrollTop-o.clientHeight-s<=7||t)&&o.scrollBy(0,999)}};var me=n(584),ge=n(815);class fe{constructor(e){this.url=e,this.loaded=!1,this.canvas=null,this._load()}_load(){const e=document.createElement("canvas"),t=new Image;t.src=this.url,t.onload=()=>{e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),this.canvas=e,this.loaded=!0,this.onload()}}createFilledCanvas(e,t,n,o){const s=this.canvas.getContext("2d").createPattern(this.canvas,"repeat"),i=document.createElement("canvas");i.width=e,i.height=t;const a=i.getContext("2d");return a.fillStyle=s,a.save(),a.translate(n,o),a.fillRect(-n,-o,e,t),a.restore(),i}onload(){}}const ve=n.p+"/img/protectedPattern.png";class we{constructor(e,t,n){this.x=e,this.y=t,this.width=h.$t,this.height=h.$t,this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=h.$t,this.ctx=this.canvas.getContext("2d"),this.imgData=this.ctx.createImageData(h.$t,h.$t),this.view=new Uint32Array(this.imgData.data.buffer),this.protectedPatternChunkSized=null,this._protectedPattern=new fe(ve),this._protectedPattern.onload=()=>{this.needRender=!0;const e=[this.x*this.width%this._protectedPattern.canvas.width,this.y*this.height%this._protectedPattern.canvas.height];this.protectedPatternChunkSized=this._protectedPattern.createFilledCanvas(this.width,this.height,e[0],e[1])},this.pCanvas=document.createElement("canvas"),this.pCanvas.width=this.pCanvas.height=h.$t,this.pCtx=this.pCanvas.getContext("2d"),this.pImgData=this.pCtx.createImageData(h.$t,h.$t),this.pView=new Uint32Array(this.pImgData.data.buffer),this.needRender=!0,this.fromBuffer(n)}render(){this.needRender&&(this.needRender=!1,this.ctx.putImageData(this.imgData,0,0),h.H6.showProtected&&(this.ctx.globalAlpha=.7,this.pCtx.putImageData(this.pImgData,0,0),null!==this.protectedPatternChunkSized&&(this.pCtx.globalCompositeOperation="source-in",this.pCtx.drawImage(this.protectedPatternChunkSized,0,0),this.pCtx.globalCompositeOperation="source-over"),this.ctx.drawImage(this.pCanvas,0,0),this.ctx.globalAlpha=1))}fromBuffer(e){let t,n;for(let o=0;o<e.byteLength;o++)t=e[o],n=128&t,n&&(this.pView[o]=4294901760),this.view[o]=h.W7[127&t]}get(e,t){return this.view[e+t*h.$t]}set(e,t,n){const o=e+t*h.$t;this.view[o]=n,this.needRender=!0}setProtect(e,t,n){const o=e+t*h.$t;this.pView[o]=n?4294901760:0,this.needRender=!0}getProtect(e,t){const n=e+t*h.$t;return!!this.pView[n]}}var be=n(901),ye=n(755);async function xe(e,t={}){t.body&&"object"==typeof t.body&&(t.headers||(t.headers={}),t.headers["Content-Type"]="application/json",t.body=JSON.stringify(t.body));const n=await fetch("/api"+e,t);if(n.headers.get("Content-Type")&&n.headers.get("Content-Type").includes("application/json"))try{const e=await n.json();e.errors&&e.errors.forEach((e=>{be.error(e)})),n.json=()=>e}catch(e){}return n}async function ke(){await je.load(),K.updateBucket(function(){const e=h.y6;return"ADMIN"==L[je.role]?[0,32]:e[L[je.role]]||h.y6.GUEST}()),je.registered?(ne.removeAttr("disabled"),ne.val(""),ye("#loginButtons,.authBtn").hide(),ye("#chatNick,#chatChannels").show(),ye("#chatNick").text(je.name),ye("#chatHeader").addClass("logged")):(ne.attr("disabled"),ne.val((0,T.I)("login to chat")),ye("#chatNick,#chatChannels").hide(),ye("#loginButtons,.authBtn").show(),ye("#chatHeader").removeClass("logged"))}function Ce(){(0,I.lx)("template.x",re.x,!0),(0,I.lx)("template.y",re.y,!0),(0,I.lx)("template.url",re.url,!0),(0,I.lx)("template.opac",re.opacity,!0)}function Ee(){re.update(),re.render(),Ce()}function Ie(e,t=!0){t&&e.forEach((([e,t])=>{K.placed.push([e,t,E.chunkManager.getChunkPixel(e,t)])})),E.socket.sendPixels(e,!1)}function De(e,t,n,o=!0){const s=E.chunkManager.getChunkPixel(e,t),i=E.chunkManager.getProtect(e,t);s!==n&&(!i||je.role>=M.MOD)&&E.socket.connected?(o&&(K.placed.push([e,t,E.chunkManager.getChunkPixel(e,t)]),K.placed.length>2*K.maxPlaced&&(K.placed=K.placed.slice(-K.maxPlaced))),E.chunkManager.setChunkPixel(e,t,n),E.socket.sendPixel(e,t,n),E.socket.pendingPixels[e+","+t]=setTimeout((()=>{E.chunkManager.setChunkPixel(e,t,s),E.renderer.needRender=!0}),3e3)):i&&je.role<M.MOD&&be.error((0,T.I)("This pixel is protected."),(0,T.I)("Error!"),{preventDuplicates:!0,timeOut:750})}function Ae(){"none"===oe.css("display")?(oe.show(),oe.css("margin-top","")):(oe.css("margin-top",-oe.height()-30),setTimeout((()=>oe.hide()),500))}function Re(e=!0){h.H6.showProtected=e,E.chunkManager.chunks.forEach((e=>{e.needRender=!0})),E.renderer.needRender=!0}function Se(e){void 0===e&&(e=x()),ye(".paletteColor").css("width",e).css("height",e)}function Pe(e,t){let n;(n=document.getElementById("REPLACE-"+e))||(n=document.createElement("style"),n.id="REPLACE-"+e);let o=Object.keys(t).map((e=>e+":"+t[e]));n.innerText=`${e}{${o.join(";")}}`,document.head.appendChild(n)}function Me(e){e?ye("#emotions").show():ye("#emotions").hide()}function Le(e){const t=ye("#emotions");let n="";for(let t of e)n+=`<div class="emotion">${t}</div>`;t.html(n),ye("div",t).on("click",(e=>{ye("#chatInput")[0].value+=e.target.innerText,ye("#chatInput").trigger("focus")}))}function Te(e){K.brushSize=+e,E.fxRenderer.needRender=!0,E.renderer.preRenderBrush(),ye("#brushSizeCounter").text(e-1)}function Fe(e){e?ye("#placedPixels").show():ye("#placedPixels").hide()}function Oe(e,t){ye("#placedPixels").text(e),t&&ye("#placedPixels").attr("title",t)}let $e=K.placedCount;function Be(){const e=(0,I.TA)("colorSize",!0),t=x();Se(+e||t),We()}function Ne(){const e=E.chunkManager.dumpAll(),t=document.createElement("a");t.download=`GX ${h.Dv} ${function(){const e=new Date;return`${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}.${e.getFullYear()} - ${e.getHours().toString().padStart(2,"0")}-${e.getMinutes().toString().padStart(2,"0")}-${e.getSeconds().toString().padStart(2,"0")}`}()}.png`,t.href=e.toDataURL(),t.click()}function ze(){Ue(),h.DG.forEach((([e,t,n],o)=>{const s=me.patterns[o%me.patterns.length],i=document.createElement("canvas");i.width=i.height=14;const a=i.getContext("2d");a.fillStyle=h._D[o];for(let e=0;e<49;e++){if(!s[e])continue;const t=e%7,n=e/7|0;a.fillRect(2*t,2*n,2,2)}function r(e,t){return 4*(e+14*t)}let l=a.getImageData(0,0,14,14).data;if((0,ge.jn)(e,t,n)){a.fillStyle="white";for(let e=0;e<14;e++)for(let t=0;t<14;t++){if(l[r(e,t)+3])continue;const n=l[r(e,t-1)+3],o=l[r(e,t+1)+3],s=l[r(e-1,t)+3],i=l[r(e+1,t)+3],c=l[r(e-1,t-1)+3],h=l[r(e+1,t-1)+3],d=l[r(e-1,t+1)+3],u=l[r(e+1,t+1)+3];(n||o||s||i||c||h||d||u)&&a.fillRect(e,t,1,1)}}l=a.getImageData(0,0,14,14).data,a.fillStyle="black";for(let e=0;e<196;e++)l[4*e+3]||a.fillRect(e%14,e/14|0,1,1);const c=i.toDataURL(),d=document.createElement("img");d.src=c,d.style.cssText="position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        image-rendering: pixelated;\n        width: inherit",ye(`#col${o}`).append(d)}))}function Ue(){ye(".paletteColor>img").remove()}function We(){const e=ye("#palette").innerHeight();ye("#chat").css("bottom",e+4)}setInterval((()=>{$e!==K.placedCount&&((0,I.lx)("placedCount",K.placedCount,!0),$e=K.placedCount)}),3e3);var Ge=n(755);let _e=!1,He=[];const je={registered:!1,name:null,id:null,role:M.GUEST,update(e){this.registered=e.registered,e.registered&&(this.name=e.name,this.role=e.role,this.id=e.id),this.updateRoleRelatedHtml()},updateRoleRelatedHtml(){switch(Ge(".minrole-admin").hide(),Ge(".minrole-mod").hide(),Ge(".minrole-trusted").hide(),Ge(".minrole-user").hide(),this.role){case M.ADMIN:Ge(".minrole-admin").show();case M.MOD:Ge(".minrole-mod").show();case M.TRUSTED:Ge(".minrole-trusted").show();case M.USER:Ge(".minrole-user").show()}},checkCanGetUserInfo(){return this.registered&&this.role>=M.TRUSTED},async load(){const e=await xe("/me"),t=await e.json();this.update(t),_e=!0,this.callStacked()},callOnLoaded(e){if(this.loaded)return e();He.push(e)},callStacked(){He.forEach((e=>e())),He=[]}};var Ke=n(901),Ye=n.n(Ke);class Xe extends(r()){constructor(e,t=null,n=null,o=M.GUEST){super(),this.name=e,this.icon=n,this.key=t?t.toString():void 0,this.requiredRole=o}}const Ve={line:function(e,t,n,o){let s=[],i=Math.abs(o-t)>Math.abs(n-e);i&&([e,t]=[t,e],[n,o]=[o,n]);let a=!1;e>n&&([t,o]=[o,t],[e,n]=[n,e],a=!0);let r=n-e,l=Math.abs(o-t),c=r/2,h=t<o?1:-1;for(;e<=n;e++)s.push([i?t:e,i?e:t]),c-=l,c<0&&(t+=h,c+=r);return a&&s.reverse(),s.reverse(),s},filledCircle:function(e,t,n){let o=[];const s=n*n;for(let s=-n+e;s<n+e;s++)for(let e=-n+t;e<n+t;e++)i(s,e)&&o.push([s,e]);function i(n,o){let i=n-e,a=o-t;return i*i+a*a<=.8*s}return o},square(e,t,n,o){const s=Math.min(e,n),i=Math.min(t,o),a=Math.max(e,n),r=Math.max(t,o);let l=[];for(let e=i;e<r+1;e++)for(let t=s;t<a+1;t++)l.push([t,e]);return l}};function Je(e,t){return!(e<0||e>=h.w_||t<0||t>=h.G6)}class qe{constructor(e){this.renderFunc=e,this.removed=!1}render(e){return this.renderFunc(e)}remove(){this.removed=!0}}class Ze{constructor(){this.fxList=[[],[],[]],this.ctx=E.fxCtx,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.oImageSmoothingEnabled=!1,this.needRender=!0,this.needClear=!1}add(e,t=0){this.fxList[t].push(e),this.needRender=!0}requestRender(){this.needRender=!0}render(){if(this.needRender){this.ctx.clearRect(0,0,window.innerWidth,window.innerHeight),this.needRender=!1;for(let e=0;e<this.fxList.length;e++)this.fxList[e].forEach((e=>{if(e.removed)return this.remove(e);let t=e.render(this.ctx);2==t?this.remove(e):0==t&&(this.needRender=!0)}))}}remove(e){for(let t=0;t<this.fxList.length;t++){let n=this.fxList[t].indexOf(e);if(-1!=n){this.fxList[t][n].remove(),this.fxList[t].splice(n,1),this.needRender=!0;break}}}}const Qe=n.p+"/img/clicker.png",et=n.p+"/img/move.png",tt=n.p+"/img/floodfill.png",nt=n.p+"/img/line.png",ot=n.p+"/img/protect.png",st=n.p+"/img/revert.png";function it(e,t,n,o,s){return(e-t)*(s-o)/(n-t)+o}const at=n.p+"/font/min 5.png",rt=n.p+"/font/min 5.txt";var lt=n(755);class ct extends(r()){constructor(e="",t=1){super(),this.title=e,this._closeButtons=t,this.element=null,this.bodyElement=null,this.closed=!1,this._create()}_create(){const e=lt(`\n        <div class="miniWindow">\n            <div class="miniWindowTitle">\n                ${this.title}\n            </div>\n            <div class="miniWindowBody">\n            </div>\n            <div class="miniWindowButtons">\n            </div>\n        </div>\n        `),t=[];if(this._closeButtons>=1){const e=lt("<button>ok</button>");e.on("click",this.buttonHandler.bind(this,"ok")),t.push(e)}if(this._closeButtons>=2){const e=lt("<button>cancel</button>");e.on("click",this.buttonHandler.bind(this,"cancel")),t.push(e)}t.forEach((t=>lt(".miniWindowButtons",e).append(t))),this.element=e,this.bodyElement=lt(".miniWindowBody",e)}buttonHandler(e){const t={_cancelledClose:!1,cancelClose:function(){this._cancelledClose=!0}};switch(e){case"ok":this.emit("okClicked",t);break;case"cancel":this.emit("cancelClicked",t)}t._cancelledClose||this.close()}close(){this.removeAllListeners(),this.element.remove(),this.closed=!0}}var ht=n(755);const dt=E.mobile;function ut(e,t){return E.chunkManager.getChunkPixel(e,t)}function pt(e,t){return E.chunkManager.getProtect(e,t)}function mt(e,t){return(e+t)%2==0}function gt(){return-1===K.secondCol?~K.color?K.color:-1:-1===K.color?K.secondCol:mt(K.x,K.y)?K.color:K.secondCol}function ft(e,t,n=K.color,o=K.secondCol){return-1===o?n:-1===n?o:mt(e,t)?n:o}function vt(e,t){return e>=0&&e<h.w_&&t>=0&&t<h.G6}let wt=!1,bt=setInterval((()=>{E.toolManager&&(clearInterval(bt),wt=!0,yt.forEach((e=>e(E.toolManager))),yt=[])}),5),yt=[];function xt(e){wt?e(E.toolManager):yt.push(e)}let kt=[];function Ct(e,t){E.fxRenderer?E.fxRenderer.add(e,t):kt.push([e,t])}function Et(e){E.fxRenderer.remove(e)}let It=setInterval((()=>{if(E.fxRenderer){clearInterval(It);for(let[e,t]of kt)Ct(e,t);kt=[]}}),5);function Dt(){E.fxRenderer.needRender=!0}class At extends Xe{constructor(...e){super(...e),this._pendingPixels={},this.minZoom=2,this.on("down",this.down),this.on("up",this.up),this.on("move",this.move),this.on("leave",this.up),this.on("_gesture",this.ongesture),xt((()=>{dt||(E.eventManager.on("mousedown",this.mousedown.bind(this)),E.eventManager.on("mouseup",this.mouseup.bind(this)))})),this.clrInterval=setInterval((()=>{this.clearPending()&&Dt()}),250),this.fx=new qe(this.render.bind(this))}mousedown(e){0===e.button&&(this.screenPos=[e.clientX,e.clientY])}mouseup(e){if(0!==e.button||!this.screenPos)return;const t=Math.abs(e.clientX-this.screenPos[0]),n=Math.abs(e.clientY-this.screenPos[1]);if(t>5||n>5)return;const[o,s]=[K.x,K.y],i=ft(o,s);this.checkPixel(o,s)&&~i&&De(K.x,K.y,ft(o,s))}down(e){this.lastPos=[K.x,K.y],this.screenPos=[e.clientX,e.clientY],this.mouseIsDown||P.zoom<this.minZoom||(this.mouseIsDown=!0,dt?this.pointerId=e.pointerId:this.emit("move",{}))}up(e){this.mouseIsDown&&(dt&&this.emit("move",e,!0),this.mouseIsDown=!1)}ongesture(){this.mouseIsDown=!1,this.lastPos=null}checkPixel(e,t){const n=`${e},${t}`,o=ft(e,t),s=ut(e,t),i=pt(e,t);if(!(s===o||-1===s||i&&je.role<M.MOD||this._pendingPixels[n]&&this._pendingPixels[n][0]===o))return this._pendingPixels[n]=[o,Date.now()],!0}move(e,t=!1){if(e.gesture)return void this.ongesture();if(!this.mouseIsDown||e.gesture||-1===gt())return;if(dt&&this.pointerId!==e.pointerId)return;const n=e.clientX,o=e.clientY,s=Math.abs(n-this.screenPos[0]),i=Math.abs(o-this.screenPos[1]);if(s<5&&i<5&&!t)return;let[a,r]=[K.x,K.y],l=Ve.line(this.lastPos[0],this.lastPos[1],a,r);this.lastPos=[a,r];let c=[[0,0]];1!==K.brushSize&&(c=E.renderer.preRendered.brush.circle);for(let[e,t]of l){let n=[];if(!this.checkAllowance(c.length))return;c.forEach((([o,s])=>{let i=e+o,a=t+s;if(this.checkPixel(i,a)){const e=ft(i,a);n.push([i,a,e])}})),this.place(n)}}checkAllowance(e){return!(K.bucket.allowance<e)}place(e){0!==e.length&&(K.bucket.spend(e.length),1==e.length?De(...e[0]):Ie(e))}render(e){const t=P.zoom;e.lineWidth=t/5,e.globalAlpha=.5;for(let n of Object.keys(this._pendingPixels)){let[o,s]=n.split(",").map((e=>parseInt(e,10)));const i=this._pendingPixels[n][0];e.strokeStyle="#000000",e.fillStyle=h._D[i];const[a,r]=X(o,s);e.strokeRect(a,r,t,t)}return e.globalAlpha=1,1}clearPending(){let e=!1;return Object.keys(this._pendingPixels).forEach((t=>{let n=this._pendingPixels[t][1];Date.now()-n>500&&(delete this._pendingPixels[t],e=!0)})),e}}const Rt=new At("clicker","Space",Qe);class St extends At{constructor(...e){super(...e),this.minZoom=1,this._alt=!1,this._mobileIsProtect=null}getProtectState(){return dt?this._mobileIsProtect:!this._alt}mousedown(){}mouseup(){}down(e){this.mouseIsDown||(super.down(e),Re(),this._mobileIsProtect=!pt(...this.lastPos))}checkPixel(e,t){const n=`${e},${t}`,o=this.getProtectState();if(pt(e,t)!==o&&(!this._pendingPixels[n]||this._pendingPixels[n][0]!==o))return this._pendingPixels[n]=[o,Date.now()],!0}checkAllowance(){return!0}place(e){const t=this.getProtectState();e.forEach((e=>e[2]=t)),e.length&&function(e){E.socket.sendPixels(e,!0)}(e)}render(){}}const Pt=new St("protector","KeyV",ot,M.MOD),Mt=new St("alt protector","ALT+KeyV",null,M.MOD);Mt._alt=!0;const Lt=new class extends Xe{constructor(...e){super(...e),this.handlers(),this.downPos=[0,0],this.lastPos=[0,0],this.lastPlayerPos=[0,0],dt||(this.fx=new qe(this.renderCursor),Ct(this.fx))}handlers(){xt((()=>{this.on("down",this.down),this.on("up",this.up),E.toolManager.on("move",this.move.bind(this)),this.on("leave",this.up)}))}renderCursor(e){const t=P.zoom,n=gt();if(~n&&t>1)if(1==K.brushSize){let o,s,[i,a]=X(K.x,K.y);e.strokeStyle=h._D[n],e.lineWidth=t/5;let r=e.lineWidth/2;i+=r,a+=r,o=t-e.lineWidth,s=o,e.strokeRect(i,a,o+1,s+1)}else{const[t,n]=X(K.x-K.brushSize/2,K.y-K.brushSize/2);e.drawImage(E.renderer.preRendered.brush.canvas,t,n)}return 1}down(e){e.ctrlKey||(this.mousedown=!0,Pe("#ui>div>*",{"pointer-events":"none"}),dt||(this.downPos=this.lastPos=[e.clientX,e.clientY]))}up(e){e.ctrlKey||(this.mousedown=!1,Pe("#ui>div>*",{"pointer-events":"all"}),!dt&&this.moveThresold()&&"mouseleave"!==e.type&&e instanceof MouseEvent&&e.button)}move(e){e.ctrlKey||((this.lastPlayerPos[0]!=K.x||this.lastPlayerPos[1]!=K.y||this.mousedown)&&Dt(),this.lastPlayerPos=[K.x,K.y],this.mousedown&&(!dt&&(this.lastPos=[e.clientX,e.clientY],this.moveThresold())||P.moveTo(-e.movementX/P.zoom,-e.movementY/P.zoom)))}moveThresold(){return Math.abs(this.downPos[0]-this.lastPos[0])<5&&Math.abs(this.downPos[1]-this.lastPos[1])<5}}("mover",null,et),Tt=new class extends Xe{constructor(...e){super(...e),this.on("up",this.up),this.on("down",this.down),this.on("leave",this.up),this.on("tick",this.tick),this.previewing=!1,this.fx=null,this.prevStack=[]}up(e,t){if(this.active)return void(this.active=!1);if(!this.previewing)return;if(this.fx.remove(),Dt(),this.previewing=!1,t)return;const n=Y(e.clientX,e.clientY);-1!==ft(...n)&&Je(...n)&&"mouseleave"!==e.type&&(this.active=!0,this.stack=[[K.x,K.y]],this.playerCol=K.color,this.secondPlayerCol=K.secondCol,this.fillingCol=ut(K.x,K.y))}down(e){if(e.repeat||this.previewing||this.active)return;const t=Y(e.clientX,e.clientY);if(-1===ft(...t)||!Je(...t))return;let n,o;i.apply(this),this.showedPixels=[],this.fillingCol=ut(K.x,K.y);let s=new qe(function(e){if(E.mobile&&E.toolManager.tool!==this)return this.up({},!0),1;if(K.x==n&&K.y==o||i.call(this),-1===gt())return 1;let t=0;for(let e=0;e<700&&0==t;e++)t=a.call(this);return e.strokeWidth=P.zoom,e.clearRect(0,0,window.innerWidth,window.innerHeight),this.showedPixels.forEach(((t,n)=>{let[o,s]=t.split(",").map((e=>parseInt(e,10))),i=1,a=this.showedPixels.length;if(a>=100&&n<a/2&&(i=1-(a/2-n)/(a/2),i<=0))return;e.globalAlpha=i;const r=ft(o,s,this.playerCol,this.secondPlayerCol);e.strokeStyle=h._D[r];let[l,c]=X(o,s);e.strokeRect(l,c,P.zoom,P.zoom)})),t}.bind(this));function i(){this.prevStack=[[K.x,K.y]],this.showedPixels=[],n=K.x,o=K.y,this.playerCol=K.color,this.secondPlayerCol=K.secondCol,this.fillingCol=ut(K.x,K.y)}function a(){if(!this.prevStack.length)return 1;let[e,t]=this.prevStack.pop(),n=ft(e,t,this.playerCol,this.secondPlayerCol),o=ut(e,t);if(-1!==this.showedPixels.indexOf(e+","+t)||o===n||o!==this.fillingCol||!Je(e,t))return 0;this.showedPixels.push(e+","+t);let s=this.checkP(e,t-1),i=this.checkP(e,t+1),a=this.checkP(e-1,t),r=this.checkP(e+1,t);return s&&a&&this.checkP(e-1,t-1),s&&r&&this.checkP(e+1,t-1),i&&a&&this.checkP(e-1,t+1),i&&r&&this.checkP(e+1,t+1),0}Ct(s,0),this.fx=s,this.previewing=!0}checkP(e,t){return ut(e,t)===this.fillingCol&&(this.prevStack.unshift([e,t]),!0)}tick(){if(this.active){for(let e=0;e<15&&this.stack.length&&(this.stack[this.stack.length-1][0],K.bucket.spend(1));e++){let[e,t]=this.stack.pop(),n=ft(e,t,this.playerCol,this.secondPlayerCol),o=ut(e,t);if(o===n||o!==this.fillingCol||!Je(e,t))continue;let s=this.check(e,t-1),i=this.check(e,t+1),a=this.check(e-1,t),r=this.check(e+1,t);s&&a&&this.check(e-1,t-1),s&&r&&this.check(e+1,t-1),i&&a&&this.check(e-1,t+1),i&&r&&this.check(e+1,t+1),De(e,t,n)}return this.stack.length?void 0:this.active=!1}}check(e,t){return ut(e,t)===this.fillingCol&&(this.stack.unshift([e,t]),!0)}}("floodfill","KeyF",tt);class Ft extends Xe{constructor(...e){super(...e),dt||this.on("down",this.down)}down(e){const t=ut(K.x,K.y);-1!==t&&(e.__alt?K.switchSecondColor(t):K.switchColor(t),Dt())}mobileDown(){this.downCord=[K.x,K.y],this.downTime=Date.now()}mobileUp(){K.x,K.y,Date.now(),this.downCord=null,this.downTime=null}}const Ot=new Ft("pipette","KeyC"),$t=new Ft("alt pipette","ALT+KeyC");$t.off("down",$t.down),$t.on("down",(e=>{e.__alt=!0,$t.down.call($t,e)}));const Bt=new class extends Xe{constructor(...e){super(...e),this.drawLength=JSON.parse((0,I.CJ)("drawLineLen",!1)),xt((()=>{this.handlers()}))}handlers(){let e,t,n,o,s,i,a,r=[],l=!1;function c(){l||(l=!0,e=[K.x,K.y],[s,i]=[K.color,K.secondCol],a=1,1!==K.brushSize&&(a=E.renderer.preRendered.brush.circle.length))}function d(o){if(l&&e){if(o.gesture)return l=!1,e=null;if(t=[K.x,K.y],-1!==K.color||-1!==K.secondCol){if(t[0]!=r[0]||t[1]!=r[1]){r=t;const o=u(...e,...t);n&&Et(n),n=new qe((e=>{e.globalAlpha=.5,o.forEach((([t,n])=>{const o=ft(t,n);e.fillStyle=h._D[o];let[s,i]=X(t,n);e.fillRect(s,i,P.zoom,P.zoom)})),e.strokeStyle="#000000",e.lineWidth=P.zoom/5;const t=X(...o[0]),n=X(...o[o.length-1]);if(e.beginPath(),e.lineCap="round",e.moveTo(...t.map((e=>e+P.zoom/2))),e.lineTo(...n.map((e=>e+P.zoom/2))),this.drawLength&&o.length>1){let[a,r]=t,[l,c]=n,h=Math.min(a,l),d=Math.min(r,c),u=Math.max(a,l),p=Math.max(r,c),[m,g]=[u-Math.abs(u-h)/2,p-Math.abs(p-d)/2];m+=.5*P.zoom,g+=.5*P.zoom;let f=(s=c-r,i=l-a,Math.atan2(s,i)*(180/Math.PI));f>90?f-=180:f<-90&&(f+=180);let v=f*(Math.PI/180),w=40*Math.sin(v),b=40*Math.cos(v);m+=w,g-=b,e.save(),e.globalAlpha=.7;const y=20;e.font=y+"px sans-serif",e.fillStyle="black",e.strokeStyle="white",e.textAlign="center",e.textBaseline="middle",e.lineWidth=y/6;const x=o.length,[k,C]=[m,g];e.strokeText(x,k,C),e.fillText(x,k,C),e.restore()}var s,i;return e.stroke(),e.globalAlpha=1,1})),Ct(n)}}else n&&Et(n)}}function u(e,t,n,o){let s=[[0,0]];1!==K.brushSize&&(s=E.renderer.preRendered.brush.circle);const i=h.w_,a=new Set,r=[],l=Ve.line(e,t,n,o);for(let e=l.length-1;e>=0;e--){const[t,n]=l[e];s.forEach((([e,o])=>{const s=t+e,l=n+o,c=s+l*i;a.has(c)||(a.add(c),r.push([s,l]))}))}return r.reverse()}function p(){this.off("tick",m),l&&e&&(l=!1,n&&n.remove(),t||(t=[K.x,K.y]),o=u(...e,...t),e=null,t=null,Dt(),this.on("tick",m))}function m(){-1===K.color&&-1===K.secondCol&&(o=null);let e=0;for(;;){if(!o||!o.length)return void this.off("tick",m);const[t,n]=o.pop(),r=ft(t,n,s,i);if(void 0===r||-1===r)return this.off("tick",m);if(vt(t,n)&&ut(t,n)!==r){if(!K.bucket.spend(1))return o.push([t,n]);if(De(t,n,r),e++,e>=a/2)return}}}c=c.bind(this),d=d.bind(this),p=p.bind(this),m=m.bind(this),this.on("down",c),E.toolManager.on("move",d),this.on("up",p)}}("line","ShiftLeft",nt),Nt=new Xe("coords to chat","KeyU");Nt.on("up",(function(){const e=ht("#coords").text();e.length&&(ne[0].value+=e+" ",ne.trigger("focus"))}));const zt=new Xe("swap colors","KeyX");zt.on("up",K.swapColors.bind(K));const Ut=new Xe("left color","KeyA");Ut.on("down",(function(){let e=K.color;--e<0&&(e=h._D.length-1),K.switchColor(e)}));const Wt=new Xe("right color","KeyS");Wt.on("down",(function(){let e=K.color;++e>=h._D.length&&(e=0),K.switchColor(e)}));const Gt=new Xe("toggle chat","KeyK");Gt.on("down",(function(){"none"===te.css("display")?(te.show(),te.css("left","")):(te.css("left",-te.width()-30),setTimeout((()=>te.hide()),500))}));const _t=new Xe("toggle menu","KeyL");_t.on("down",(function(){Ae()}));const Ht=new Xe("toggle everything","Semicolon");Ht.on("down",(function(){ye("#ui").fadeToggle(100),We()}));const jt=new class extends Xe{constructor(...e){super(...e),this.handlers()}handlers(){let e=!1;function t(){e=!1,this.off("tick",l),a=i,r=0}t=t.bind(this);const n=function(n){if(n.preventDefault(),n.stopPropagation(),n.gesture)return t();e||(e=!0,l(),this.on("tick",l))}.bind(this),o=function(e){e.gesture&&t()}.bind(this),s=function(){t()}.bind(this),i=500;let a=i,r=0;const l=function(){const e=Date.now()-r;if(e<a)return;let t=e/a|0;t<0&&(t=1),r=Date.now();do{const e=E.toolManager.altDown?.2:1;if(a=Math.max(a/1.5,50*e),K.placed.length>K.maxPlaced&&(K.placed=K.placed.slice(-K.maxPlaced)),!K.placed.length)return;if(!K.bucket.spend(1))return;const[t,n,o]=K.placed.pop();De(t,n,o,!1)}while(--t)}.bind(this);this.on("down",n),E.eventManager.on("mousemove",o),this.on("up",s)}}("ctrlZ","KeyZ",st),Kt=new class extends Xe{constructor(...e){super(...e),this.state=0,this.fx=null,this.isLight=JSON.parse((0,I.CJ)("lightGrid",!1)),this.pattern=null,P.on("zoom",(()=>{1==this.state&&this.tryRender()})),this.on("down",this.pressed.bind(this)),JSON.parse((0,I.CJ)("enableGrid",!1))&&this.show()}pressed(e){e.repeat||this.toggle()}drawGrid(e){let[t,n]=Y(0,0),[o,s]=X(t,n),{width:i,height:a}=e.canvas;const r=P.zoom;let l;e.fillStyle="rgb(127,127,127)",e.globalAlpha=.8,l=h.$t%16==0?16:h.$t%10==0?10:null,l=null;let c=1;for(t--,n--;o<i;o+=r)t++,c=.7,t%h.$t==0&&(c=1),e.fillRect(o,0,c,a);for(;s<a;s+=r)n++,c=.7,n%h.$t==0&&(c=1),e.fillRect(0,s,i,c);e.globalAlpha=1}tryRender(){this.fx&&!this.fx.removed||(this.fx=new qe(this.render.bind(this)),Ct(this.fx,2))}toggle(){0==this.state?this.show():this.hide(),(0,I.lx)("enableGrid",(!!this.state).toString())}show(){this.state=1,this.tryRender()}hide(){this.state=0,this.fx&&Et(this.fx)}render(e){if(P.zoom<=4)return 1;this.drawGrid(e)}}("grid","KeyG"),Yt=new class extends Xe{constructor(...e){super(...e),this.state=0,this.moveFX=null,this.drawInterval=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}async down(){if(0==this.state||1==this.state){this.state=1;try{const e=await this.getImage();this.startPlace(e)}catch{this.state=0}}else 2==this.state||3==this.state&&(this.state=0,this.stopDraw())}async getImage(){const e=document.createElement("input");return e.type="file",e.accept="image/png",e.click(),new Promise(((t,n)=>{e.onchange=()=>{if(e.onchange=null,!e.files.length||""==e.files[0])return n();const o=new FileReader;o.readAsDataURL(e.files[0]),o.onload=()=>{const e=new Image;e.src=o.result,e.onload=()=>{const n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0),t(n)},e.onerror=n},o.onerror=n}}))}startPlace(e){K.resetColors(),this.state=2;let t,n,o=K.x,s=K.y;function i(){let e=K.x,t=K.y;e==o&&t==s||(o=e,s=t)}Ct(this.moveFX=new qe((function(t){const[n,i]=X(o,s),a=P.zoom;t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=!1;const r=it(Math.sin(Date.now()/400),-1,1,.5,1);return t.globalAlpha=r,t.save(),t.scale(a,a),t.drawImage(e,n/a,i/a),t.restore(),t.globalAlpha=1,0})));let a=function(e){t=e.clientX,n=e.clientY},r=function(i){if(2==i.button)return this.state=0,this.stopPlace(),void l();let[a,r]=[i.clientX,i.clientY];Math.abs(a-t)>5||Math.abs(r-n)>5||(l(),this.stopPlace(),this.startDraw(e,o,s))};function l(){E.eventManager.off("mousedown",a),E.eventManager.off("mouseup",r),E.toolManager.off("move",i)}r=r.bind(this),E.eventManager.on("mousedown",a),E.eventManager.on("mouseup",r),E.toolManager.on("move",i)}stopPlace(){Et(this.moveFX),this.removeAllListeners("move")}startDraw(e,t,n){this.state=3;const o=e.getContext("2d"),{width:s}=e;let i=o.getImageData(0,0,e.width,e.height).data,a=-4;this.drawInterval=setInterval(function(){let e=Math.floor(K.bucket.allowance);if(0==e)return;let o=[],r=13106;for("polkovnik"===(0,I.TA)("ya",!1)&&(r=52441);e>0&&a<i.length-4&&o.length<13106;){a+=4;let r=[i[a],i[a+1],i[a+2],i[a+3]];if(r[3]<127)continue;let l=a/4;const c=t+l%s,d=n+(l/s|0);if(c<0||c>=h.w_||d<0||d>=h.G6)continue;const u=(0,ge.xV)(r,h.DG);E.chunkManager.getChunkPixel(c,d)!=u&&(e--,o.push([c,d,u]))}o.length&&(K.bucket.spend(o.length),E.socket.sendPixels(o)),a>=i.length-4&&(this.state=0,this.stopDraw())}.bind(this),50)}stopDraw(){clearInterval(this.drawInterval)}}("paste","CTRL+KeyV",null,M.MOD);let Xt=parseFloat((0,I.CJ)("template.opacity",.5,!0));const Vt=new Xe("template 0/N opaq","KeyO");Vt.on("down",(()=>{0==re.opacity?re.opacity=Xt:(Xt=re.opacity,re.opacity=0),Ee()}));const Jt=new Xe("template 1/N opaq","KeyP");Jt.on("down",(()=>{1==re.opacity?re.opacity=Xt:(Xt=re.opacity,re.opacity=1),Ee()}));const qt=new class extends Xe{constructor(...e){super(...e),this.handlers()}handlers(){let e,t,n,o,s,i,a=[],r=!1;function l(){r||(r=!0,e=[K.x,K.y],[s,i]=[K.color,K.secondCol],this.emit("move"))}function c(){if(r&&e&&(t=[K.x,K.y],t[0]!=a[0]||t[1]!=a[1])){a=t;const o=Ve.square(...e,...t);n&&Et(n),n=new qe((e=>{e.globalAlpha=.5;for(let[t,n]of o){const[o,s]=X(t,n),i=ft(t,n);e.fillStyle=h._D[i],e.fillRect(o,s,P.zoom,P.zoom)}return e.globalAlpha=1,1})),Ct(n)}}function d(){this.off("tick",u),r=!1,e&&(n&&n.remove(),t||(t=[K.x,K.y]),o=Ve.square(...e,...t),Dt(),o.length<=1||this.on("tick",u))}function u(){let e=K.bucket.allowance===1/0;if(this.lastTick||(this.lastTick=Date.now()),e&&Date.now()-this.lastTick<50)return;this.lastTick=Date.now();let t=0,n=[];for(;t<1e3;){if(!o||!o.length){this.off("tick",u);break}const[a,r]=o.pop(),l=ft(a,r,s,i);if(void 0===l||-1===l)return this.off("tick",u);if(vt(a,r)&&ut(a,r)!==l){if(!K.bucket.spend(1))return o.push([a,r]);t++,e?n.push([a,r,l]):De(a,r,l)}}n.length&&Ie(n,!0)}l=l.bind(this),c=c.bind(this),d=d.bind(this),u=u.bind(this),this.on("down",l),this.on("move",c),this.on("up",d)}}("square","KeyJ"),Zt=new Xe("+brush size","BracketRight");Zt.on("down",(()=>{if(!(K.brushSize>=100))return 1==K.brushSize?Te(4):void Te(K.brushSize+2)}));const Qt=new Xe("-brush size","BracketLeft");Qt.on("down",(()=>{if(K.brushSize<=4)return Te(1);Te(K.brushSize-2)}));const en=new class extends Xe{constructor(...e){super(...e),this.state=0,this.selectFX=null,this.initListeners()}initListeners(){this.on("down",this.down.bind(this))}down(e){if(this.state>0||Yt.state>0)return;if("Range"===window.getSelection().type)return;let t,n,o,s,i;e.preventDefault(),e.stopPropagation(),P.disableMove(),K.resetColors(),E.elements.mainCanvas.style.cursor="crosshair",this.state=1;let a=!1,r=!1,l=[];function c(e){"Alt"===e.key&&(a=!0)}function d(){console.log({altPressed:a}),a?(r=!0,l=[[K.x,K.y]]):(n=K.x,o=K.y)}function u(){if(r){let e=K.x,t=K.y;l.push([e,t])}else s=K.x+1,i=K.y+1}function p(){E.elements.mainCanvas.style.cursor="",Et(t),E.eventManager.off("keydown",c),E.eventManager.off("mousedown",d),E.eventManager.off("mousemove",u),E.eventManager.off("mouseup",p),this.state=0,P.enableMove(),function(){let e,t,a,c;if(r){e=t=l[0][0],a=c=l[0][1];for(let n=0;n<l.length;n++){const o=l[n];o[0]<e&&(e=o[0]),o[0]>t&&(t=o[0]),o[1]<a&&(a=o[1]),o[1]>c&&(c=o[1])}}else{if([n,o,s,i].some((e=>void 0===e)))return;e=Math.min(n,s),t=Math.max(n,s)+1,a=Math.min(o,i),c=Math.max(o,i)+1}e=Math.max(e,0),t=Math.min(t,h.w_),a=Math.max(a,0),c=Math.min(c,h.G6);const d=t-e,u=c-a,p=document.createElement("canvas");p.width=d,p.height=u;const m=p.getContext("2d"),g=m.createImageData(d,u);let f,v;if(r){f=new Array(l.length),v=new Array(l.length);for(let e=0;e<l.length;e++){const t=l[e];f[e]=t[0],v[e]=t[1]}}for(let t=0;t<d;t++)for(let n=0;n<u;n++){const o=4*(t+n*d),s=e+t,i=a+n;if(r&&!k(l.length,f,v,s,i))continue;const c=E.chunkManager.getChunkPixel(s,i),u=h.DG[c];g.data[o]=u[0],g.data[o+1]=u[1],g.data[o+2]=u[2],g.data[o+3]=255}m.putImageData(g,0,0),Yt.startPlace(p)}()}t=new qe((function(e){if(e.save(),e.strokeStyle="gray",e.lineWidth=2,e.setLineDash([3,3]),e.globalAlpha=1,r){e.beginPath();const t=X(l[0][0],l[0][1]);e.moveTo(...t);for(let t=1;t<l.length;t++){const n=l[t];e.lineTo(...X(...n))}e.closePath(),e.stroke()}else{const[t,a]=X(n,o),[r,l]=X(s,i);e.strokeRect(t,a,r-t,l-a)}return e.restore(),1})),Ct(t),c=c.bind(this),d=d.bind(this),u=u.bind(this),p=p.bind(this),E.eventManager.on("keydown",c),E.eventManager.on("mousedown",d),E.eventManager.on("mousemove",u),E.eventManager.on("mouseup",p)}}("copy","CTRL+KeyC",null,M.MOD),tn=new Xe("pixel info","KeyI");let nn=null,on=null;function sn(){nn&&(nn.remove(),nn=null),on&&(on.remove(),on=null)}E.eventManager.on("mouseup",sn),tn.on("up",(async()=>{sn();const[e,t]=[K.x,K.y],n=await xe(`/pixelInfo?canvas=${h.X1}&x=${e}&y=${t}`),o=await n.json();if(!o||!o.type)return;const s=ht('<div class="infoBubble"><span style="user-select:text"></span></div>');nn=s;const i=ht("<div>");i[0].style.cssText="position: absolute;\n    top: -7px;\n    left: 0;\n    width: 100%;\n    font-size: 14px;\n    font-weight: bold;\n    text-shadow: rgb(255 255 255) -1px 1px 0px, rgb(255 255 255) 1px 1px 0px, rgb(255 255 255) 1px -1px 0px, rgb(255 255 255) -1px -1px 0px;\n    text-align: center;",i.text(`(${e}, ${t})`),s.append(i);let a="";if("UID"===o.type){const e=y(o.placer.nick);a+="<b>UID</b>&nbsp;"+o.placer.id+"<br>",a+="<b>name</b>&nbsp;"+e}else a+=`<b>${o.type}</b>`,o.placer&&(a+="&nbsp;"+o.placer);ht("span",s).html(a),ht("body").append(s);const r=s[0].clientWidth,l=s[0].clientHeight;function c(){const[n,o]=X(e,t),i=n+P.zoom/2-r/2,a=o-l-11;return s.css("top",a).css("left",i),1}c(),on=new qe((()=>{c()})),Ct(on,2)}));class an{static defaultVSpacing=1;constructor(e,t){this.imagePath=e,this.infoPath=t,this.defaultWidth=null,this.defaultHeight=null,this.letters={},this.loaded=!1,this._isLoading=!1}async load(){if(!this._isLoading){this._isLoading=!0;try{const e=await new Promise(((e,t)=>{const n=new Image;n.onload=()=>{const t=document.createElement("canvas");t.width=n.width,t.height=n.height,t.getContext("2d").drawImage(n,0,0),e(t)},n.onerror=t,n.src=this.imagePath})),t=await fetch(this.infoPath),n=await t.json(),o=n.defaultWidth;this.defaultWidth=o;const s=n.fixedHeight;this.defaultHeight=s;const i=e.getContext("2d");this.letters={};let a=0;for(let e of n.letters){const{letter:t,width:n=o}=e,r=i.getImageData(a,0,n,s);this.letters[t]=r,a+=n+1}}catch(e){throw this._isLoading=!1,e}this._isLoading=!1,this.loaded=!0}}drawText(e,t="black"){if(!this.loaded)throw new Error("font not loaded");e=e.toUpperCase();const{width:n,height:o}=this.measureText(e),s=document.createElement("canvas"),i=document.createElement("canvas");s.width=i.width=n,s.height=i.height=o;const a=s.getContext("2d"),r=i.getContext("2d"),l=e.split("");let c=0,h=0;for(let e of l){if("\n"==e){h+=this.defaultHeight+an.defaultVSpacing,c=0;continue}if(" "==e){c+=this.defaultWidth;continue}let t=this.letters[e];t?(r.putImageData(t,c,h),c+=t.width+1):c+=this.defaultWidth}return a.fillStyle=t,a.fillRect(0,0,n,o),a.globalCompositeOperation="destination-atop",a.drawImage(i,0,0),s}measureText(e){if(!this.loaded)throw new Error("font not loaded");const t=(e=e.toUpperCase()).split("");let n=0,o=0,s=this.defaultHeight;for(let e of t)"\n"!=e?" "!=e?this.letters[e]&&(n+=(this.letters[e].width||this.defaultWidth)+1):n+=this.defaultWidth:(s+=this.defaultHeight+an.defaultVSpacing,o=Math.max(n,o),n=0);return{width:Math.max(n,o),height:s}}}const rn=new class extends Xe{constructor(...e){super(...e),this.fonts=[new an(at,rt)],this.fonts.forEach((e=>e.load())),this.miniWindow=null,this.on("down",this.down.bind(this))}down(e){if(this.miniWindow&&!this.miniWindow.closed)return;this.miniWindow=new ct("Draw text",2);const t=this.miniWindow.element;dt?t.css("left",0).css("top",0):t.css("left",window.screen.width/3).css("top",window.screen.height/3);const n=ht('\n            <textarea style="width: 100%;"></textarea>\n            <div style="display:flex; margin: 2px 0">\n                <div style="display: flex">\n                    <div>x:</div> <input type="number" class="textXCord" style="width: 100%">\n                </div>\n                <div style="display: flex; margin-left: 2px">\n                    <div>y:</div> <input type="number" class="textYCord" style="width: 100%">\n                </div>\n            </div>\n        ');this.miniWindow.bodyElement.css("max-width",200).css("display","flex").css("flex-direction","column"),this.miniWindow.bodyElement.append(n),document.body.appendChild(t[0]);const o=ht("textarea",this.miniWindow.bodyElement),s=ht(".textXCord",this.miniWindow.bodyElement),i=ht(".textYCord",this.miniWindow.bodyElement),a=[K.x,K.y];s.val(a[0]),i.val(a[1]);const r=this.fonts[0];let l=null,c=K.color,d=null;const u=new qe((e=>{const t=o.val();if(!t)return 0;if(!r.loaded)return 0;e.globalAlpha=it(Math.sin(Date.now()/400),-1,1,.2,.9);const n=s.val(),a=i.val();l===t&&c===K.color||(l=t,c=K.color,d=r.drawText(l,h._D[c]));const[u,p]=X(n,a);e.save(),e.scale(P.zoom,P.zoom),e.imageSmoothingEnabled=!1;const m=u/P.zoom,g=p/P.zoom;return~K.secondCol&&(e.fillStyle=h._D[K.secondCol],e.fillRect(m,g,d.width,d.height)),e.drawImage(d,m,g),e.restore(),0}));Ct(u),this.miniWindow.on("okClicked",(()=>{if(Et(u),!o.val()||!d)return;if(~K.secondCol){const e=d.getContext("2d");e.globalCompositeOperation="destination-over",e.fillStyle=h._D[K.secondCol],e.fillRect(0,0,d.width,d.height)}const e=+s.val(),t=+i.val();Yt.startDraw(d,e,t)})),this.miniWindow.on("cancelClicked",(()=>{Et(u)}))}}("text","KeyT",null,M.TRUSTED),ln={clicker:Rt,mover:Lt,floodfill:Tt,pipette:Ot,altPipette:$t,line:Bt,colorInc:Wt,colorDec:Ut,colorSwap:zt,chatOpac:Gt,menuOpac:_t,allOpac:Ht,ctrlZ:jt,protector:Pt,altProtector:Mt,grid:Kt,copy:en,paste:Yt,cordAdd:Nt,templateOp1:Vt,templateOp2:Jt,square:qt,incBrush:Zt,decBrush:Qt,pixelInfo:tn,text:rn},cn=n.p+"/img/user2.png",hn=n.p+"/img/arrow.svg";function dn(e){return e.replace(/[А-я\w]+/g,(function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))}var un=n(755);function pn(e=[]){const t=un('<table class="columnTable"></table>');return e.forEach((([e,n])=>{let o=un(`\n                <tr>\n                    ${void 0===n?`<td colspan="2">${e}</td>`:`<td>${e}</td>\n                        <td>${n}</td>`}\n                </tr>`);t.append(o)})),t}function mn(){const e=new W({title:dn((0,T.I)("account settings")),center:!0});if(!e.created)return;let t=pn([[(0,T.I)("role"),L[je.role].toUpperCase()],[(0,T.I)("change name"),'<input type="text" id="name" style="width:50%"><button id="changeName">yes</button>'],[`<button id="logout">${(0,T.I)("logout")}</button>`]]);un(e.body).append(t),un("#name").val(je.name),un("#changeName").on("click",(()=>{const e=un("#name").val();return je.registered?e.length<0||e.length>32?Ye().error("Name length is not 0 < length < 32","Name change"):je.name===e?Ye().error("Name is the same as was","Name change"):void fetch("/api/changename",{method:"POST",body:JSON.stringify({name:e}),headers:{"Content-Type":"application/json"}}).then((async e=>{const t=await e.json();t.errors.length?t.errors.map((e=>{Ye().error(e,"Name change error")})):(E.socket.close(),Ye().success("Name successfully changed"),ke())})):Ye().error("Hey wtf","0_o")})),un("#logout").on("click",(async()=>{if(je.registered){const e=await xe("/auth/logout");await e.json()?location.pathname="/":Ye().error("Can't log out")}}))}function gn(){const e=new W({title:dn((0,T.I)("toolbinds settings")),center:!0});if(!e.created)return;let t=pn();for(const e of Object.values(ln)){if(!e.key)continue;if(e.requiredRole>je.role)continue;const n=un(`<tr>\n            <td>${e.name}</td>\n            <td>\n                <span id="MODS-${e.name}"></span>\n                <input id="KEY-${e.name}" class="key" style="width:130px">\n            </td>\n        </tr>`);t.append(n);const o=un("input",n),s=un("span",n);o.on("keydown",(t=>{if(t.preventDefault(),!t.code||"ControlLeft"===t.code||"AltLeft"===t.code)return;const n=t.altKey,i=t.ctrlKey;let a="";s.text(""),n&&(s.text("ALT + "),a+="ALT+"),i&&(s.text(s.text()+"CTRL + "),a+="CTRL+"),a+=t.code,o.val(t.code);for(let t of Object.values(ln))e.name!=t.name&&t.key==a&&(un("#MODS-"+t.name).text(""),un("#KEY-"+t.name).val(""));E.toolManager.changeKey(e,a)})),o.on("keyup",(e=>{if(e.preventDefault(),!e.code||"ControlLeft"===e.code||"AltLeft"===e.code)return;let t={};for(const e of Object.values(ln))e.key&&(t[e.name]=e.key);(0,I.lx)("keyBinds",JSON.stringify(t))}));const i=w(e.key);s.text((i.alt?"ALT + ":"")+(i.ctrl?"CTRL + ":"")),o.val(i.code)}un(e.body).append(t)}function fn(){const e=new W({title:dn((0,T.I)("ui settings")),center:!0});if(!e.created)return;const t=pn([[(0,T.I)("colors size"),'<input type="range" min="16", max="64" step="1" id="colSize"><div style="width:50px;"><div>'],[(0,T.I)("hide emojis"),'<input type="checkbox" id="toggleEmojis">'],[(0,T.I)("emoji list"),'<input type="text" id="emojiList">'],[`<button id="moreEmojis">${(0,T.I)("super secret button")}</button>`],[(0,T.I)("show placed pixels"),'<input type="checkbox" id="togglePlaced">'],[(0,T.I)("show patterns over the palette"),'<input type="checkbox" id="showPatterns">']]);un(e.body).append(t);const n=(0,I.CJ)("colorSize",24,!0);un("#colSize").next().text(n),un("#colSize").val(n),un("#colSize").on("input",(function(){const e=un("#colSize").val();Se(e),un("#colSize").next().text(e+"px"),(0,I.lx)("colorSize",e,!0),We()})),un("#toggleEmojis")[0].checked=1==(0,I.TA)("hideEmojis"),un("#toggleEmojis").on("click",(e=>{const t=!e.target.checked;(0,I.lx)("hideEmojis",t?0:1),Me(t)})),un("#emojiList").val((0,I.CJ)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐")),un("#emojiList").on("change",(e=>{(0,I.lx)("emojis",e.target.value),Le(e.target.value.split(" "))})),un("#moreEmojis").on("click",(()=>{const e=new W((0,T.I)("more emojis!"));e.created&&(e.body.innerHTML="😁😂😃😄😅😆😉😊😋😌😍😏😒😓😔😖😘😚😜😝😞😠😡😢😣😤😥😨😩😪😫😭😰😱😲😳😵😷😸😹😺😻😼😽😾😿🙀🙅🙆🙇🙈🙉🙊🙋🙌🙍🙎🙏✂✅✈✉✊✋✌✏✒✔✖✨✳✴❄❇❌❎❓❔❕❗❤➕➖➗➡➰🚀🚃🚄🚅🚇🚉🚌🚏🚑🚒🚓🚕🚗🚙🚚🚢🚤🚥🚧🚨🚩🚪🚫🚬🚭🚲🚶🚹🚺🚻🚼🚽🚾🛀Ⓜ🅰🅱🅾🅿🆎🆑🆒🆓🆔🆕🆖🆗🆘🆙🆚🈁🈂🈚🈯🈲🈳🈴🈵🈶🈷🈸🈹🈺🉐🉑©®‼⁉™ℹ↔↕↖↗↘↙↩↪⌚⌛⏩⏪⏫⏬⏰⏳▪▫▶◀◻◼◽◾☀☁☎☑☔☕☝☺♈♉♊♋♌♍♎♏♐♑♒♓♠♣♥♦♨♻♿⚓⚠⚡⚪⚫⚽⚾⛄⛅⛎⛔⛪⛲⛳⛵⛺⛽⤴⤵⬅⬆⬇⬛⬜⭐⭕〰〽㊗㊙🀄🃏🌀🌁🌂🌃🌄🌅🌆🌇🌈🌉🌊🌋🌌🌏🌑🌓🌔🌕🌙🌛🌟🌠🌰🌱🌴🌵🌷🌸🌹🌺🌻🌼🌽🌾🌿🍀🍁🍂🍃🍄🍅🍆🍇🍈🍉🍊🍌🍍🍎🍏🍑🍒🍓🍔🍕🍖🍗🍘🍙🍚🍛🍜🍝🍞🍟🍠🍡🍢🍣🍤🍥🍦🍧🍨🍩🍪🍫🍬🍭🍮🍯🍰🍱🍲🍳🍴🍵🍶🍷🍸🍹🍺🍻🎀🎁🎂🎃🎄🎅🎆🎇🎈🎉🎊🎋🎌🎍🎎🎏🎐🎑🎒🎓🎠🎡🎢🎣🎤🎥🎦🎧🎨🎩🎪🎫🎬🎭🎮🎯🎰🎱🎲🎳🎴🎵🎶🎷🎸🎹🎺🎻🎼🎽🎾🎿🏀🏁🏂🏃🏄🏆🏈🏊🏠🏡🏢🏣🏥🏦🏧🏨🏩🏪🏫🏬🏭🏮🏯🏰🐌🐍🐎🐑🐒🐔🐗🐘🐙🐚🐛🐜🐝🐞🐟🐠🐡🐢🐣🐤🐥🐦🐧🐨🐩🐫🐬🐭🐮🐯🐰🐱🐲🐳🐴🐵🐶🐷🐸🐹🐺🐻🐼🐽🐾👀👂👃👄👅👆👇👈👉👊👋👌👍👎👏👐👑👒👓👔👕👖👗👘👙👚👛👜👝👞👟👠👡👢👣👤👦👧👨👩👪👫👮👯👰👱👲👳👴👵👶👷👸👹👺👻👼👽👾👿💀💁💂💃💄💅💆💇💈💉💊💋💌💍💎💏💐💑💒💓💔💕💖💗💘💙💚💛💜💝💞💟💠💡💢💣💤💥💦💧💨💩💪💫💬💮💯💰💱💲💳💴💵💸💹💺💻💼💽💾💿📀📁📂📃📄📅📆📇📈📉📊📋📌📍📎📏📐📑📒📓📔📕📖📗📘📙📚📛📜📝📞📟📠📡📢📣📤📥📦📧📨📩📪📫📮📰📱📲📳📴📶📷📹📺📻📼🔃🔊🔋🔌🔍🔎🔏🔐🔑🔒🔓🔔🔖🔗🔘🔙🔚🔛🔜🔝🔞🔟🔠🔡🔢🔣🔤🔥🔦🔧🔨🔩🔪🔫🔮🔯🔰🔱🔲🔳🔴🔵🔶🔷🔸🔹🔺🔻🔼🔽🕐🕑🕒🕓🕔🕕🕖🕗🕘🕙🕚🕛🗻🗼🗽🗾🗿😀😇😈😎😐😑😕😗😙😛😟😦😧😬😮😯😴😶🚁🚂🚆🚈🚊🚍🚎🚐🚔🚖🚘🚛🚜🚝🚞🚟🚠🚡🚣🚦🚮🚯🚰🚱🚳🚴🚵🚷🚸🚿🛁🛂🛃🛄🛅🌍🌎🌐🌒🌖🌗🌘🌚🌜🌝🌞🌲🌳🍋🍐🍼🏇🏉🏤🐀🐁🐂🐃🐄🐅🐆🐇🐈🐉🐊🐋🐏🐐🐓🐕🐖🐪👥👬👭💭💶💷📬📭📯📵🔀🔁🔂🔄🔅🔆🔇🔉🔕🔬🔭🕜🕝🕞🕟🕠🕡🕢🕣🕤🕥🕦🕧",e.body.style.userSelect="text")})),un("#togglePlaced")[0].checked=0==(0,I.CJ)("hidePlaced",1),un("#togglePlaced").on("click",(e=>{const t=e.target.checked;(0,I.lx)("hidePlaced",t?0:1),Fe(t)})),un("#showPatterns")[0].checked=E.showPatterns,un("#showPatterns").on("click",(e=>{const t=e.target.checked;E.showPatterns=t,(0,I.lx)("showPalettePatterns",t?"1":"0"),t?ze():Ue()}))}function vn(){const e=new W({title:dn((0,T.I)("game settings")),center:!0});if(!e.created)return;let t=je.role===M.ADMIN?20:je.role<M.USER?1:10;const n=pn([[(0,T.I)("show protected"),`<input type="checkbox" id="showProtected" ${h.H6.showProtected?"checked":""}>`],[(0,T.I)("brush size"),`<input type="checkbox" id="customBrushSize" ${K.brushSize>1?"checked":""}>\n            <input id="brushSize" type="range" value="${K.brushSize}" `+(1==K.brushSize?"disabled":"")+' min="2" '+`max="${t}" step="2">`+`<span id="brushSizeCounter">${K.brushSize-1}<span>`],[(0,T.I)("max saved pixels"),`<input id="savePixelsInp" type="number" min="0" value="${K.maxPlaced}" style="width:4rem">`],[(0,T.I)("disable chat colors"),`<input type="checkbox" id="disableChatColors" ${pe.colorsEnabled?"":"checked"}>`],[(0,T.I)("chat messages limit"),`<input type="number" id="chatLimit" value="${h.H6.chatLimit}" title="maximum messages in chat">`],[(0,T.I)("light grid"),`<input type="checkbox" id="lightGridCB" ${ln.grid.isLight?"checked":""} title="will grid be light?">`],[(0,T.I)("enable grid"),`<input type="checkbox" id="enableGridCB" ${1==ln.grid.state?"checked":""}>`],[(0,T.I)("draw line length"),`<input type="checkbox" id="drawLineLenCB" ${ln.line.drawLength?"checked":""} title="draw line length near it">`]]);un(e.body).append(n),un("#showProtected").on("change",(e=>{const t=e.target.checked;h.H6.showProtected=t,Re(t)})),un("#customBrushSize").on("change",(e=>{e.target.checked?(un("#brushSize").removeAttr("disabled"),Te(un("#brushSize").val())):(un("#brushSize").attr("disabled"),Te(1))})),un("#brushSize").on("input",(e=>{Te(e.target.value)})),un("#savePixelsInp").on("change",(e=>{+(e=e.target).value<0&&(e.value=0),K.maxPlaced=+e.value,(0,I.lx)("maxPlaced",K.maxPlaced)})),un("#disableChatColors").on("change",(e=>{const t=e.target.checked;(0,I.lx)("disableColors",t.toString()),pe.setColors(!t)})),un("#chatLimit").on("change",(e=>{const t=parseInt(e.target.value,10);isNaN(t)||t<1||((0,I.lx)("chatLimit",t.toString()),h.H6.chatLimit=t)})),un("#lightGridCB").on("change",(e=>{const t=e.target.checked;(0,I.lx)("lightGrid",t.toString()),ln.grid.isLight=t})),un("#enableGridCB").on("change",(e=>{const t=e.target.checked;(0,I.lx)("enableGrid",t.toString()),t?ln.grid.show():ln.grid.hide()})),un("#drawLineLenCB").on("change",(e=>{const t=e.target.checked;(0,I.lx)("drawLineLen",t.toString()),ln.line.drawLength=t}))}async function wn(){let e,t=new W({title:(0,T.I)("Captcha"),center:!0,closeable:!1});if(t.created){const[e,n,o]=un(`<div>${(0,T.I)("Case insensitive, 0/o i/l are same")}. <a href="#">${(0,T.I)("Can't recognize?")}</a></div><div class="captchaContainer"></div><input class="fullWidthInput" type="text"></input>`);e.children[0].onclick=wn;const[s]=un(`<div style="display:flex;justify-content:center">${(0,T.I)("Captcha").toUpperCase()}:&nbsp;&nbsp;</div>`);s.appendChild(o),t.body.appendChild(e),t.body.appendChild(n),t.body.appendChild(s),o.addEventListener("keydown",(async e=>{if("Enter"===e.key){if(0==o.value.length)return;let e=o.value;o.value="",await async function(e){const t=await xe("/captcha/solve",{method:"POST",body:{answer:e}}),n=await t.json();return void 0!==n.success&&n.success}(e)?t.close():wn()}}))}else t=t.oldWindow;try{e=await async function(){const e=await xe("/captcha/get");return await e.text()}()}catch(e){return console.error("error downloading captcha image: "+e),E.socket.close(),t.close()}e=e.replace('stroke="black"','stroke="white"'),un(".captchaContainer",t.body).html(e),t.moveToCenter(),un("input",t.body).trigger("focus")}function bn(){const e=new W({title:dn((0,T.I)("tools")),center:!0});if(!e.created)return;const t=[[`<a href="/convert" target="_blank">${(0,T.I)("convert image into palette")}</a>`],[`<button id="screenshot">${(0,T.I)("save canvas")}</button>`]];je.role>=M.MOD&&t.unshift([`<button id="searchUsersB">${(0,T.I)("search users")}</button>`]);const n=pn(t);un(e.body).append(n),un("#searchUsersB",n).on("click",(()=>{const e=new W({title:dn((0,T.I)("search users")),center:!0});if(!e.created)return;const t=pn([[`<input type="text" placeholder="nickname" id="userSearchText" max="32" style="width:250px"> ${(0,T.I)("OR")} <input type="text" placeholder="id" id="userSearchId" max="32" style="width:50px"><input type="checkbox" id="searchIsBanned"><label for="searchIsBanned">${(0,T.I)("banned?")}</label>`],['<div id="searchUsersBody">']]);console.log(t),un(e.body).append(t);const n=un("#userSearchText");function o(e){if(!e||!e.length)return void un("#searchUsersBody").html("");let t=document.createElement("table");t.className="innerTable",t.innerHTML+="<tr><th>NICK</th><th>ID</th><th>ROLE</th><th>&nbsp;</th></tr>";for(let n of e){const e=y(n.name),o=document.createElement("button");o.className="userInfoBtn",o.innerHTML=`<img src="${cn}">`,o.addEventListener("click",(async()=>{const e=await xe(`/userInfo?id=${n.id}`),t=await e.json();await Ln.CreateWindow(t)}));const s=un(`<tr>\n                        <td>${e}</td><td>${n.id}</td><td>${n.role}</td><td></td>\n                    </tr>`);s[0].lastElementChild.appendChild(o),t.appendChild(s[0])}un("#searchUsersBody").html(t)}async function s(e,t,n){if(!n&&!e&&!t)return;if(e&&t)return;e&&(e=encodeURIComponent(e));const o=await xe(`/admin/users/search?isBanned=${n?1:0}&${t?`id=${t}`:`t=${e}`}`);return await o.json()}un("#userSearchId").on("input",(async e=>{let t=e.target.value.trim();if(t=+t,isNaN(t)||t<1||t>Number.MAX_SAFE_INTEGER)return;const n=un("#searchIsBanned")[0].checked;o(await s(null,t,n))})),un("#userSearchText").on("input",(async e=>{let t=n.val().trim();t=t.slice(0,32);const i=un("#searchIsBanned")[0].checked;o(await s(t,null,i))}))})),un("#screenshot").on("click",Ne)}function yn(){const e=new W({title:dn((0,T.I)("LOG IN")),center:!0});if(!e.created)return;const t=pn([[`<a href="/api/auth/vk"><img src="${o}" class="authLogo">VK</a>`],[`<a href="/api/auth/discord"><img src="${s}" class="authLogo">DISCORD</a>`],[`<a href="/api/auth/facebook"><img src="${i}" class="authLogo">FACEBOOK</a>`]]);un("td",t).css("text-align","left"),un("a",t).css("margin-left","15px"),un(e.body).append(t)}function xn(e,t,n=!0){const o=un("<div>");o[0].style.cssText="width: 100%;\n    height: 30px;\n    background-color: #5f5f5f;\n    position: relative;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    user-select: none;\n    cursor: pointer",o.append(`<div style="font-size:20px;text-transform:uppercase;">${e}</div>`);const s=un("<div>");s[0].style.cssText=`position: absolute;\n    top: 50%;\n    transform: translate(0, -50%);\n    left: 5px;\n    background-image: url(${hn});\n    background-size: 100%;\n    background-repeat: no-repeat;\n    transition: transform .2s ease-in-out;\n    width: 20px;\n    height: 20px;`,o.append(s);const i=un("<div>");i[0].style.cssText="max-height: 0;\n    overflow: hidden;\n    transition: max-height 0.3s linear;\n    font-size: 20px;";const a=un("<div>");a[0].style.cssText="padding:8px",a.html(t),i.append(a);const r=un("<div>");r[0].style.cssText="margin-bottom: 1px;",r.append(o,i);let l=0;function c(){l?(s.css("transform","translate(0px, -50%) rotate(0deg)"),i.css("max-height",0)):(s.css("transform","translate(0px, -50%) rotate(180deg)"),i.css("max-height",un(i)[0].scrollHeight)),l=!l}return n||setTimeout(c),o.on("click",c),r}function kn(){const e=new W({title:(0,T.I)("help"),center:!0});if(!e.created)return;e.body.style.width="90vw",e.body.style.height="90vh";const t=xn((0,T.I)("intro.introHeader"),`<div style="width:100%;text-align:center;"><img src="./img/goroxels.png" style="vertical-align: middle;">${(0,T.I)("intro.desc")}</div><br><br>\n    ${(0,T.I)("intro.desc2")}<br>\n    ${(0,T.I)("intro.desc3")}`,!1),n=xn((0,T.I)("how to play?"),`<div style="display:inline-flex">\n            <div>${(0,T.I)("intro.howToPlayDecs")}</div>\n            <div style="padding-left: 10px;">\n                <video autoplay loop muted style="height:196px"><source src="./video/clickerMouse.webm" type="video/webm"></video>\n            </div>\n        </div>`,!1),o=xn((0,T.I)("tools"),`${(0,T.I)("intro.toolsDecs")}<br><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.toolsClicker")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/clicker.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.toolsAS")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/as.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.toolC")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/toolC.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.brush")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/brush2.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.line")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/line.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.flood")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/flood.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.grid")}<br><br></div>\n        <div class="desktop">\n            <img src="./img/unavailable.png" style="height:196px">\n        </div>\n    </div><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.ctrlZ")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/ctrlZ.webm" type="video/webm"></video>\n        </div>\n    </div><br>\n    ${(0,T.I)("intro.resetColors")}<br>`),s=xn((0,T.I)("intro.tools2header"),`<div style="width:100%;text-align:center;"><b>${(0,T.I)("intro.tools2desc")}</b></div><br><br>\n    ${(0,T.I)("intro.toolsHiders")}<br><br>\n    ${(0,T.I)("intro.multicol")}<br>\n    ${(0,T.I)("intro.multicol2")}<br>\n    ${(0,T.I)("intro.multicol3")}<br><br>\n    ${(0,T.I)("intro.sendCoords")}<br><br>\n    ${(0,T.I)("intro.templateTools")}<br>`),i=xn((0,T.I)("template"),`<div style="width:100%;text-align:center;"><b>${(0,T.I)("intro.templateIntro")}</b></div><br><br>\n    ${(0,T.I)("intro.templateDesc")}<br><br>\n    ${(0,T.I)("intro.templateDescConvert")}<br><br>\n    <div class="helpWithVideoCont">\n        <div>${(0,T.I)("intro.templateDescReminder")}<br><br></div>\n        <div class="desktop">\n            <video autoplay loop muted style="height:196px"><source src="./video/patternDemo.webm" type="video/webm"></video>\n        </div>\n    </div><br>`),a=xn((0,T.I)("intro.authorHeader"),`${(0,T.I)("intro.authorText")}<br>\n        ${(0,T.I)("intro.authorContacts")}<br>\n        <div style="text-align:center"><img src="./img/3rdcf.png" title="ТРЕТЬЯ КОНФА"></div>`);un(e.body).append(t,n,o,s,i,a)}const Cn=n.p+"/img/user.svg",En=n.p+"/img/mod-badge.svg",In=n.p+"/img/admin-badge.svg",Dn=(n.p,n.p+"/img/badge0.png"),An=n.p+"/img/badge1.png";var Rn=n(901);const Sn=n(755),Pn=[Dn,An],Mn=Sn("#usersTable");class Ln{static async CreateWindow(e,t){const n=new W({center:!0,title:`${e.name||(0,T.I)("PLAYER")+" "+(t||e.id)}`});if(e.ip&&e.cc&&"XX"!==e.cc){e._ip=e.ip;const t=e.cc;e.ip+=` [${t}]`,e.ip+=`<img src="${location.protocol}//www.countryflagicons.com/FLAT/16/${t}.png" style="margin-bottom:-5px;margin-left:1px;">`,delete e.cc}if(void 0!==e.role&&je.role===M.ADMIN&&je.id!==e.id){const t=e.role;let n="";Object.keys(M).forEach((e=>{n+=`<option ${e===t?"selected":""}>${e}</option>`})),e.role=`<select type="role">${n}<select>`}let o=Object.keys(e).map((t=>[t,e[t]])),s=[];o=o.filter((e=>!e[0].startsWith("_"))),je.role>=M.MOD&&(s=[['<input class="alertInput">',`<button class="sendAlert">${(0,T.I)("Send Alert")}</button>`],[`<button class="banByIp">${(0,T.I)("Ban by ip")}</button>`]]);let i=o.concat(s);Sn(n.body).append(pn(i)),Sn("select[type=role]",n.body).on("change",(async t=>{const n=t.target.value,o=e.id,s=await fetch("/api/admin/changerole",{method:"POST",body:JSON.stringify({id:o,role:n}),headers:{"Content-Type":"application/json"}}),i=await s.json();i.errors?i.errors.forEach((e=>{Rn.error(e,(0,T.I)("ERROR"))})):Rn.success((0,T.I)("Changed role to")+" "+n)})),Sn(".sendAlert",n.body).on("click",(()=>{const e=Sn(".alertInput",n.body).val();0!=e.length&&(Sn(".alertInput",n.body).val(""),E.socket.sendAlert(t,e))})),Sn(".banByIp",n.body).on("click",(async()=>{const t=e._ip||e.ip;if(!t)return Rn.error((0,T.I)("No ip!"));const n=await xe(`/admin/banPlayer?ip=${t}`);(await n.json()).success&&Rn.success((0,T.I)("Success"))}))}constructor(e,t,n,o,s,i){e||(e="ID "+t),this.name=e,this.id=t,this.userId=n,this.registered=o,this.role=s,this.conns=[t],this.badges=i;const a=y(this.name);let r=E.chat.parseColors(a).replace(/<[^>]*>/g,"");const l=this.getRoleBadgeAndTitle(),c=this.getAchieveBadgesHtml();this.element=Sn(`<tr class="tableRow">\n                <td title="id ${t}" class="user">\n                    ${l?`<img src="${l.icon}" title="${l.tooltip}" class="roleBadge">`:""}\n                    <button class="userInfoBtn minrole-trusted"><img style="height: 20px" src="${Cn}"></button>\n                    <span class="name">${r}</span>\n                    <span class="badges">${c}</span>\n                    <span class="xConns"></span>\n                </td>\n                <td></td>\n            </tr>`),this.nameEl=Sn(".name",this.element),this.coordsEl=Sn(this.element.children()[1]),this.nameEl.on("click",(function(){const e=this.innerText;E.elements.chatInput.value+=e+", ",E.elements.chatInput.focus()})),Sn(".userInfoBtn",this.element).on("click",(async()=>{const e=this.registered,t=e?this.userId:this.id,n=await fetch(`/api/userInfo?id=${t}${e?"":"&unreg=1"}`),o=await n.json();await Ln.CreateWindow(o,this.id)})),this.coordsEl.on("click",(()=>{const[e,t]=this.coordsEl.text().slice(1,-1).split(", ").map((e=>parseInt(e,10)));Number.isInteger(e)&&Number.isInteger(t)&&P.centerOn(e,t)})),Mn[0].appendChild(this.element[0]),je.updateRoleRelatedHtml()}getAchieveBadgesHtml(){if(!this.badges)return"";let e="";for(let t of this.badges)e+=`<img src="${Pn[t]}">`;return e}getRoleBadgeAndTitle(){if(!this.role)return null;let e,t;switch(this.role){case"MOD":e="mod",t=En;break;case"ADMIN":e="admin",t=In;break;default:return null}return{tooltip:e,icon:t}}updateCoords(e,t,n){this.coordsEl.css("color",h._D[e]),this.coordsEl.text(`(${t}, ${n})`)}close(e){this.conns.splice(this.conns.indexOf(e),1),0===this.conns.length?this.destroy():this.updateX(),delete E.users[e]}destroy(){this.element.remove()}newConnection(e){this.conns.push(e),this.updateX()}updateX(){const e=this.conns.length>1?`[x${this.conns.length}]`:"";Sn(".xConns",this.element).text(e)}}var Tn=n(901);class Fn extends(r()){constructor(e){super();const t=location.protocol.startsWith("https")?"wss":"ws",n=location.hostname||"localhost";this.url=`${t}://${n}:${e}`,this.pendingPixels={},this.connectedOnce=!1,this.connect()}get connected(){return this.socket&&this.socket.readyState===WebSocket.OPEN}connect(){this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.sendChatSubscribe("global",this.connectedOnce),this.sendChatSubscribe(h.Dv,this.connectedOnce),this.sendCanvas(h.X1),this.emit("opened"),console.log("Socket has been connected"),this.connectedOnce||(this.connectedOnce=!0)},this.socket.onmessage=this.onmessage.bind(this),this.socket.onclose=()=>{this.emit("closed"),Object.values(E.users).forEach((e=>e.close(e.id))),E.users={},E.chunkManager.clearLoadingChunks(),setTimeout((()=>{console.log("reconnect"),this.reconnect()}),1e3*Math.random())}}close(){this.socket.close()}reconnect(){this.socket.onmessage=null,this.socket.onopen=null,this.socket.onclose=null,this.connect()}onmessage({data:e}){if("string"==typeof e)this.onStringMessage(e);else{if(!e.byteLength)return;this.onBinaryMessage(e)}}onStringMessage(e){let t;try{t=JSON.parse(e)}catch(t){return void console.log("onStringMessage message decoding error: "+t,"message: "+e)}switch(t.c){case"u":{const{nick:e,userId:n,id:o,registered:s,role:i,badges:a}=t,r=a?.split("|").filter((e=>e.length)).map((e=>+e));let l;e&&(l=Object.values(E.users).find((t=>t.name===e))),l?(E.users[o]=l,l.newConnection(o)):E.users[o]=new Ln(e,o,n,s,i,r);break}case"l":{const e=t.id;E.users[e]&&E.users[e].close(e);break}case"e":t.errors.forEach((e=>{"error.captcha"===e&&(W.Exists("Captcha")||wn()),Tn.error(e,(0,T.I)("Error from the Socket:"),{preventDuplicates:!0})}));break;case"c":pe.addMessage(t);break;case"a":Tn.info(t.msg,"ALERT",{timeOut:3e5,extendedTimeOut:3e5});break;case"m":K.id=t.id;break;case"r":location.reload();break;case"rc":E.chunkManager.reloadChunks()}}onBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case 5:wn();break;case 0:{const e=t.getUint8(1),n=t.getUint8(2),o=c().inflate(t.buffer.slice(3));this.emit("chunk",e,n,o);break}case 1:{const e=t.getUint16(1),n=t.getUint16(3),o=t.getUint8(5),s=t.getUint32(5);this.onIncomingPixel([e,n,o],s);break}case 2:{const e=t.getUint16(1);this.emit("online",e);break}case 4:{const e=!!t.getUint8(1),n=t.getUint32(2,!1);let o,s,i;for(let a=6;a<t.byteLength;a+=5)o=t.getUint16(a),s=t.getUint16(a+2),i=t.getUint8(a+4),e?this.emit("protect",o,s,i):this.emit("place",o,s,i,n);const a=E.users[n];a&&a.updateCoords(i,o,s);break}case 6:this.socket.send(new Uint8Array([6]));break;case 7:{const e=9;(t.byteLength-1)/e%1!=0&&console.warn("TotalPixels length is not integer");for(let n=1;n<t.byteLength;n+=e){const e=t.getUint16(n),o=t.getUint16(n+2),s=t.getUint8(n+4),i=t.getUint32(n+5);this.onIncomingPixel([e,o,s],i)}break}}}onIncomingPixel([e,t,n],o){const s=E.users[o];s&&s.updateCoords(n,e,t);const i=e+","+t;let a=this.pendingPixels[i];a&&(clearTimeout(a),delete this.pendingPixels[i]),this.emit("place",e,t,n,o),o===K.id&&Oe(K.placedCount++)}requestChunk(e,t){let n=new DataView(new ArrayBuffer(3));n.setUint8(0,0),n.setUint8(1,e),n.setUint8(2,t),this.socket.send(n.buffer)}sendPixel(e,t,n){let o=new DataView(new ArrayBuffer(6));o.setUint8(0,1),o.setUint16(1,e),o.setUint16(3,t),o.setUint8(5,n),this.socket.send(o.buffer)}sendPixels(e,t=!1){let n=new DataView(new ArrayBuffer(6+5*e.length));n.setUint8(0,4),n.setUint8(1,t?1:0);for(let t=0;t<e.length;t++){let o=5*t+6;const[s,i,a]=e[t];n.setUint16(o,s),n.setUint16(o+2,i),n.setUint8(o+4,a)}this.socket.send(n.buffer)}sendCanvas(e){const t=new DataView(new ArrayBuffer(2));t.setUint8(0,3),t.setUint8(1,e),this.socket.send(t.buffer)}sendChatSubscribe(e,t){const n={c:"s",ch:e,reconnect:t};this.socket.send(JSON.stringify(n))}sendChatMessage(e,t,n=!1){const o={c:"c",msg:e,ch:t};n&&(o.whisper=n),this.socket.send(JSON.stringify(o))}sendChatWhisper(e,t,n){return this.sendChatMessage(e,t,n)}sendAlert(e,t){const n={c:"a",to:e,msg:t};this.socket.send(JSON.stringify(n))}}class On{constructor(){this.chunks=new Map,this.loadingChunks=new Set,E.socket.on("place",((e,t,n)=>{this.setChunkPixel(e,t,n),E.renderer.needRender=!0})),E.socket.on("protect",((e,t,n)=>{this.setProtect(e,t,n),E.renderer.needRender=!0}))}getChunkKey(e,t){return e<<4|t}reloadChunks(){this.test=!0;let e=[...this.chunks.values()];const t=setInterval((()=>{if(this.loadingChunks.size<3){const n=e.pop();if(!n)return clearInterval(t);this.loadChunk(n.x,n.y)}}),30)}loadChunk(e,t){let n=this.getChunkKey(e,t);E.socket.connected&&!this.loadingChunks.has(n)&&this.loadingChunks.size<5&&(this.loadingChunks.add(n),xe(`/getchunk?canvas=${h.X1}&x=${e}&y=${t}`).then((async n=>{let o=this.getChunkKey(e,t);this.loadingChunks.has(o)&&this.loadingChunks.delete(o);const s=await n.arrayBuffer();let i=new we(e,t,new Uint8Array(s));this.chunks.set(o,i),E.renderer.needRender=!0})))}clearLoadingChunks(){this.loadingChunks=new Set}hasChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)}getChunk(e,t){let n=this.getChunkKey(e,t);return this.chunks.has(n)?this.chunks.get(n):0}getChunkPixel(e,t){let[n,o,s,i]=V(e,t),a=this.getChunk(n,o);if(!a||e<0||t<0)return-1;let r=a.get(s,i);return h.Xv[r]}setChunkPixel(e,t,n){let[o,s,i,a]=V(e,t),r=this.getChunkKey(o,s);this.chunks.has(r)&&this.chunks.get(r).set(i,a,h.W7[n])}setProtect(e,t,n){let[o,s,i,a]=V(e,t),r=this.getChunkKey(o,s);this.chunks.has(r)&&this.chunks.get(r).setProtect(i,a,n)}getProtect(e,t){let[n,o,s,i]=V(e,t),a=this.getChunk(n,o);return a?a.getProtect(s,i):-1}dumpAll(){const e=document.createElement("canvas");e.width=h.w_,e.height=h.G6;const t=e.getContext("2d");return this.chunks.forEach((e=>{if(!e.canvas)return;const n=e.x*h.$t,o=e.y*h.$t;t.drawImage(e.canvas,n,o)})),e}}const $n=n.p+"/img/chunkPlaceholder.png",Bn=v();class Nn{constructor(e){this.ctx=e,this.canvas=this.ctx.canvas,this.chunkPlaceholderPattern=new fe($n),this.chunkPlaceholderPattern.onload=()=>{this.needRender=!0},this.needRender=!0,this.preRendered={brush:{canvas:void 0,ctx:void 0,imageData:void 0,circle:void 0}},this.preRender()}preRender(){this.preRenderBrush()}preRenderBrush(){const e=K.brushSize,t=P.zoom;if(t<1)return;const n=document.createElement("canvas");n.width=n.height=t*(e+1);const o=n.getContext("2d"),s=(o.getImageData(0,0,n.width,n.height).data,e/2),i=Ve.filledCircle(0,0,s);let a=[];for(let t=0;t<e+1;t++)a.push(new Array(e+1).fill(0));i.forEach((([e,t])=>{a[e+s][t+s]=1})),o.beginPath(),o.lineWidth=t/4,o.strokeStyle=h._D[K.color],o.lineCap="square",o.fillStyle="blue";for(let n=0;n<e;n++)for(let s=0;s<e;s++){if(r(n,s))continue;let e=r(n,s-1),i=r(n-1,s),a=r(n+1,s),l=r(n,s+1);e&&(o.moveTo(n*t,s*t),o.lineTo((n+1)*t,s*t)),i&&(o.moveTo(n*t,s*t),o.lineTo(n*t,(s+1)*t)),a&&(o.moveTo((n+1)*t,s*t),o.lineTo((n+1)*t,(s+1)*t)),l&&(o.moveTo((n+1)*t,(s+1)*t),o.lineTo(n*t,(s+1)*t))}function r(t,n){return t<0||t>=e||n<0||n>=e||!a[t][n]}o.stroke(),o.closePath(),this.preRendered.brush.canvas=n,this.preRendered.brush.ctx=n,this.preRendered.brush.imageData=n,this.preRendered.brush.circle=i}requestRender(){this.needRender&&(this.needRender=!1,this.render()),E.fxRenderer.render()}correctSmoothing(){Bn||(P.zoom<1?(this.ctx.imageSmoothingEnabled=!0,this.ctx.canvas.style.imageRendering="auto"):(this.ctx.imageSmoothingEnabled=!1,this.ctx.canvas.style.imageRendering="pixelated"))}render(){this.correctSmoothing();let e=function(){let[e,t]=Y(0,0),[n,o]=Y(window.innerWidth,window.innerHeight),s=e/h.$t|0,i=n/h.$t+1|0,a=t/h.$t|0,r=o/h.$t+1|0,l=[];for(let e=Math.max(s,0);e<Math.min(i,h.rT);e++)for(let t=Math.max(a,0);t<Math.min(r,h.El);t++)l.push([e,t]);return l}();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);let t=P.x+f[0]-(this.canvas.width>>1)/P.zoom,n=P.y+f[1]-(this.canvas.height>>1)/P.zoom,o=P.zoom;1===o&&(t=Math.floor(t),n=Math.floor(n)),this.ctx.save(),this.ctx.translate(Math.floor(-t*o),Math.floor(-n*o)),this.ctx.scale(o,o),e.forEach((e=>{let[t,n]=e,o=t*h.$t,s=n*h.$t;if(!E.chunkManager.hasChunk(t,n))return E.chunkManager.loadChunk(t,n),void(this.chunkPlaceholderPattern.loaded&&this.ctx.drawImage(this.chunkPlaceholderPattern.canvas,o,s,h.$t,h.$t));const i=E.chunkManager.getChunk(t,n);i.render(),this.ctx.drawImage(i.ctx.canvas,o,s)})),this.ctx.restore(),re.render()}}var zn=n(755),Un=n(901);const Wn=E.elements.coords;function Gn(e,t){let[n,o]=Y(e,t);n===K.x&&o===K.y||(K.x=n,K.y=o,Wn.innerText=`(${K.x}, ${K.y})`,-1!=K.color&&P.zoom>1&&(E.renderer.needRender=!0))}const _n=v();class Hn extends(r()){constructor(){super(),this.tools=ln,this.tool=ln.mover,this._keyBinds={},this._colorBinds={},this.activeTools={},this.addTools(),this.loadBinds(),this.initEvents(),this.ctrlDown=!1,this.altDown=!1,je.callOnLoaded(this.filterTools.bind(this))}filterTools(){Object.keys(this.tools).forEach((e=>{this.tools[e].requiredRole>je.role&&(delete this._keyBinds[this.tools[e].key],_n&&zn(`#tool_${e}`).remove())}))}addTools(){const e=document.getElementById("tools");Object.keys(this.tools).forEach((t=>{const n=this.tools[t];if(_n){if(!n.icon)return;let o=document.createElement("div");o.classList="toolContainer",o.id=`tool_${t}`;let s=document.createElement("img");function i(){let e=document.getElementsByClassName("toolContainer selected")[0];e&&(e.className="toolContainer"),o.classList=["toolContainer selected"],this.tool=n}s.className="toolIcon",s.src=n.icon,o.appendChild(s),e.appendChild(o),o.addEventListener("pointerdown",i.bind(this)),"mover"===n.name&&i.apply(this)}else K&&(this._keyBinds[n.key]=n)}))}initEvents(){let e=E.eventManager;function t(e){this.ctrlDown=e.ctrlKey,this.altDown=e.altKey}_n?(e.on("zoom",(e=>{P.zoom*=e+1,P.checkZoom(),E.renderer.needRender=!0,E.fxRenderer.needRender=!0})),e.on("mousedown",(e=>{Gn(e.clientX,e.clientY)})),e.on("mousemove",(e=>{Gn(e.clientX,e.clientY)})),[["mousedown","down"],["mousemove","move"],["mouseup","up"]].forEach((t=>{const[n,o]=t;e.on(n,(e=>{let t=this.tool;e&&e.gesture&&(this.tool.emit("_gesture"),t=this.tools.mover),t&&(t.emit(o,e),this.emit(o,e))}))}))):(e.on("mousedown",(e=>{this.tools.mover.emit("down",e)})),e.on("mouseup",(e=>{2===e.button&&(K.switchColor(-1),K.switchSecondColor(-1)),this.tools.mover.emit("up",e)})),e.on("mousemove",(e=>{(0===e.buttons||P.noMoving)&&Gn(e.clientX,e.clientY),this.tool.emit("move",e),this.emit("move",e)})),e.on("keydown",(e=>{let t=b(e);if(!t)return;const n=this._keyBinds[t];n&&(this.tool=n,n.emit("down",e))})),e.on("keyup",(e=>{let t=b(e);if(!t)return;const n=this._keyBinds[t];for(let t of Object.keys(this.tools)){const o=this.tools[t];o.key&&o!==n&&(w(o.key).code===e.code&&o.emit("up",e))}n&&(e.preventDefault(),e.stopPropagation(),n.emit("up",e))})),e.on("wheel",(e=>{const t=P.zoom;P.zoomTo(e.deltaY);const n=e.clientX-window.innerWidth/2,o=e.clientY-window.innerHeight/2;P.moveTo(n/t,o/t),P.moveTo(-n/P.zoom,-o/P.zoom),"yes"===localStorage.getItem("iHaveProblems")&&(P.x=Math.round(P.x),P.y=Math.round(P.y),E.renderer.needRender=!0)}))),e.on("keydown",t.bind(this)),e.on("keyup",t.bind(this)),e.on("tick",(e=>{Object.keys(this.tools).forEach((t=>{const n=this.tools[t];n.listenerCount("tick")>0&&n.emit("tick",e)}))}))}changeKey(e,t){const n=e.key;delete this._keyBinds[n],e.key=t,this._keyBinds[t]=e}loadBinds(){const e=(0,I.TA)("keyBinds");let t,n;try{if(t=JSON.parse(e),!t)return}catch{return Un.error("Error on parsing key binds from local storage"),void localStorage.removeItem("keyBinds")}for(let e of Object.keys(t))(n=this.findByName(e))&&this.changeKey(this.tools[n],t[e])}findByName(e){return Object.keys(this.tools).find((t=>this.tools[t].name===e))}initColorBinds(){}loadColorBinds(){}}var jn=n(755);(async()=>{await h.LR();const{elements:e}=E;window.onresize=()=>{e.mainCanvas.width=window.innerWidth,e.mainCanvas.height=window.innerHeight,e.fxCanvas.width=window.innerWidth,e.fxCanvas.height=window.innerHeight,t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.oImageSmoothingEnabled=!1,i.needRender=!0,E.mobile||function(){const e=g(".column",E.elements.topMenuContent),t=window.innerWidth/e.length;g(".column",E.elements.topMenuContent).css("width",t)}(),Be(),We()},window.oncontextmenu=function(e){e.target!==E.elements.mainCanvas&&"paletteColor"!==e.target.classList[0]&&"paletteColor"!==e.path[1].classList[0]||e.preventDefault()},P.init(),f=[h.w_/2,h.G6/2],h.DG.forEach(((t,n)=>{const o=document.createElement("div");o.style.backgroundColor=`rgb(${t.join(",")})`,o.classList=["paletteColor light"],o.id="col"+n;let s=0;var i=jn(o);i.on("pointerdown",(()=>{s=Date.now()})),i.on("pointerleave",(()=>{s=0})),o.onclick=e=>{let t=!1;0!=s&&(Date.now()-s>700&&(t=!0),s=0),(t?K.switchSecondColor:K.switchColor).call(K,n)},o.oncontextmenu=()=>{K.switchSecondColor(n)},e.palette.appendChild(o)}));const t=e.mainCanvas.getContext("2d");t.imageSmoothingEnabled=!1;const n="https:"===location.protocol?443:location.port||80,o=new Fn(n);E.socket=o;const s=new On;E.chunkManager=s;const i=window.renderer=new Nn(t);E.renderer=i;const a=new Ze;E.fxRenderer=a,E.toolManager=new Hn(document.getElementById("board")),E.player=K;const r=()=>{requestAnimationFrame((()=>{i.requestRender(),r()}))};r(),window.onresize(),o.on("opened",(()=>{})),o.on("online",(e=>{jn(".online").text(e)})),o.on("closed",(()=>{jn(".online").text("offline")})),window.globals=E,h.F_((()=>{if("nsfw"!==h.Dv)return;if("accepted"==(0,I.TA)("modal18"))return;const e=new _,t=jn(`<div style="margin:0;padding:5px;text-align:center;">\n                <h1>${(0,T.I)("WARNING")}</h1>\n                <p>${(0,T.I)("This canvas may contain illustrations, inappropriate for people under age of 18, including:")}\n                <br>${(0,T.I)("Gore, furry, porn, hate, anime and all possible variations of these.")}</p>\n                <p><b>${(0,T.I)("Are you 18 y.o. and fully understanding what are you doing?")}</b></p>\n                <button style="padding: 8px;">${(0,T.I)("I am 18 years old and I take responsibility for my psyche on myself")}</button>\n            </div>`);e.contEl.appendChild(t[0]),jn("button",t).on("click",(()=>{e.close(),(0,I.lx)("modal18","accepted")}))})),ke(),(0,T.S)(),function(){const e=(0,I.CJ)("template.url","https://i.imgur.com/4GQIMQ7.png",!0);q.val(e);const t=(0,I.CJ)("template.x",0,!0);Z.val(parseInt(t,10));const n=(0,I.CJ)("template.y",0,!0);Q.val(parseInt(n,10));const o=(0,I.CJ)("template.opac",.5,!0);ee.val(parseFloat(o))}(),q.on("input",Ee),Z.on("input",Ee),Q.on("input",Ee),ee.on("input",Ee),Ee(),ye("#accountSettings").on("click",mn),ye("#toolBinds").on("click",gn),ye("#uiSettings").on("click",fn),ye("#canvasSettings").on("click",vn),ye("#toolsB").on("click",bn),ye(".authBtn").on("click",yn),ye(document).on("keydown",(e=>{if("Enter"===e.key)if(ye("#chatInput").is(":focus")||E.mobile){const e=ne.val();if(!e.length)return ne.trigger("blur");ne.val(""),pe.handleMessage(e)}else ye("#chatInput").trigger("focus")})),ye("#chatChannels>div").on("click",(e=>{const t=e.target.dataset.channel;pe.switchChannel(t),(0,I.lx)("chatChannel",t)})),async function(){return h.ku?void 0:new Promise((e=>{const t=setInterval((()=>{h.ku&&(clearInterval(t),e())}),10)}))}().then((()=>{pe.loadChannelElements(),pe.switchChannel((0,I.TA)("chatChannel")||"global")})),function(){function e(){document.documentElement.style.setProperty("--gorox-chat-height",ye(window).height()+"px")}ye(window).on("resize",e),e()}(),ye(document).on("mousedown",(e=>{if(!e.ctrlKey)return;e.stopPropagation(),e.preventDefault();let t=Y(e.clientX,e.clientY).map((e=>0|e));function n(e){e.stopPropagation(),e.preventDefault();const n=Y(e.clientX,e.clientY);n[0]|=0,n[1]|=0;let[o,s]=n;o===t[0]&&s===t[1]||(Z.val(re.x-=t[0]-o),Q.val(re.y-=t[1]-s),re.render(),t=n,Ce())}ye(document).on("mousemove",n),ye(document).one("mouseup mouseleave",(()=>{ye(document).off("mousemove",n)}))})),ye("#modMenu .title").on("click",(e=>{const t=ye("#modMenu");"open"===t.data("state")?(t.data("state","close"),t.css("right","")):(t.data("state","open"),t.css("right",ye("#modMenu .body").css("width")))})),ye("#sendAlerts").on("click",(()=>{const e=ye("#sendAlertsText").val();0==e.length||e.length>2e3||(ye("#sendAlertsText").val(""),E.socket.sendAlert("all",e))})),ye(".showMenu,.hideMenu").on("click",Ae),Be(),Me(1!=(0,I.TA)("hideEmojis")),Le((0,I.CJ)("emojis","🙁 🤔 😀 😄 💚 😡 👋 👍 😐").split(" ")),Fe(!+(0,I.CJ)("hidePlaced",1)),Oe((0,I.TA)("placedCount",!0)),1==(0,I.TA)("showPalettePatterns")&&(ze(),E.showPatterns=!0),ye(".showChat").on("click",(()=>{ye(".showChat").removeClass("showChat-notify"),pe.mobileShow()})),ye("#hideChat").on("click",(()=>{ye(".showChat").removeClass("showChat-notify"),pe.mobileHide()})),ye(".helpBtn").on("click",(()=>{kn()})),K.init(),E.elements.coords.addEventListener("click",(function(){E.elements.chatInput.value+=this.innerText,E.elements.chatInput.focus()})),ye("#onlineColumn .columnHeader").on("click",(async()=>{let e;try{const t=await fetch("/api/online");e=await t.json()}catch(e){return void be.error(e)}!function(e){let t=new W({title:dn((0,T.I)("online")),center:!0,closeable:!0});t.created||(t=t.oldWindow),t.body.style.width="325px",t.moveToCenter();const n=[];Object.keys(e).forEach((o=>{if("TOTAL"===o)return void t.updateTitle((0,T.I)("online")+` (${e[o]})`,!0);const s=`<a href="/${o}" target="_shagorox"><h3>${o}<h3></a>`,i=`<h2>${e[o]}</h2>`;n.push([s,i])}));const o=pn(n);un("*",t.body).remove(),un(t.body).append(o)}(e)})),function(){const e=ye("#menuResizer"),t=ye("#resizingStripes");let n,o=+(0,I.TA)("columnHeight");isNaN(o)||0==o?o=123:o<0?o=0:o>=window.screen.height-250&&(o=window.screen.height-250),ye(".columnContent").css("height",o);let s=!1;function i(){e.css("height","7px"),e.css("background-color","#4c4c4c"),t.css("opacity","1")}function a(){clearTimeout(n),e.css("height",""),e.css("background-color",""),t.css("opacity","")}e.on("mouseover",(()=>{clearTimeout(n),n=setTimeout((()=>{i()}),500)})),e.on("mouseout",(()=>{s||a()})),e.on("mousedown",(function(){function e(e){o+=e.originalEvent.movementY,ye(".columnContent").css("height",o),(0,I.lx)("columnHeight",o)}s=!0,i(),ye(document).on("mousemove",e),ye(document).one("mouseup",(function(){ye(document).off("mousemove",e),s=!1,a()}))}))}(),(0,I.TA)("helpShown")||((0,I.lx)("helpShown","1"),kn())})()},815:(e,t,n)=>{function o(e,t,n){return 4278190080|n<<16|t<<8|e}function s(e){return e.toString(16).padStart(2,"0")}function i(e){return"#"+s(e[0])+s(e[1])+s(e[2])}function a(e,t){let n=-1,o=768;for(let s=0;s<t.length;s++){const i=t[s];let a=Math.abs(e[0]-i[0])+Math.abs(e[1]-i[1])+Math.abs(e[2]-i[2]);if(a<o&&(o=a,n=s),0==a)break}return n}function r(e,t,n){return 1-(.299*e+.587*t+.114*n)/255>.5}n.d(t,{CO:()=>i,jn:()=>r,xP:()=>o,xV:()=>a})},226:(e,t,n)=>{n.d(t,{CJ:()=>s,TA:()=>i,lx:()=>a});var o=n(914);function s(e,t,n=!1){return n&&(e=o.Dv+"."+e),localStorage.getItem(e)||t}function i(e,t=!1){return t&&(e=o.Dv+"."+e),localStorage.getItem(e)}function a(e,t,n=!1){return n&&(e=o.Dv+"."+e),localStorage.setItem(e,t)}}},n={};function o(e){var s=n[e];if(void 0!==s)return s.exports;var i=n[e]={exports:{}};return t[e].call(i.exports,i,i.exports,o),i.exports}o.m=t,o.amdD=function(){throw new Error("define cannot be used indirect")},e=[],o.O=(t,n,s,i)=>{if(!n){var a=1/0;for(h=0;h<e.length;h++){for(var[n,s,i]=e[h],r=!0,l=0;l<n.length;l++)(!1&i||a>=i)&&Object.keys(o.O).every((e=>o.O[e](n[l])))?n.splice(l--,1):(r=!1,i<a&&(a=i));if(r){e.splice(h--,1);var c=s();void 0!==c&&(t=c)}}return t}i=i||0;for(var h=e.length;h>0&&e[h-1][2]>i;h--)e[h]=e[h-1];e[h]=[n,s,i]},o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.p=".",(()=>{var e={757:0};o.O.j=t=>0===e[t];var t=(t,n)=>{var s,i,[a,r,l]=n,c=0;if(a.some((t=>0!==e[t]))){for(s in r)o.o(r,s)&&(o.m[s]=r[s]);if(l)var h=l(o)}for(t&&t(n);c<a.length;c++)i=a[c],o.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return o.O(h)},n=self.webpackChunkgoroxels_client=self.webpackChunkgoroxels_client||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var s=o.O(void 0,[216,163],(()=>o(995)));s=o.O(s)})();